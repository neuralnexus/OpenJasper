define(["require","jquery","underscore","bundle!all","jrs.configs","backbone","components.pickers","resource.base","text!scheduler/template/editor/outputTabTemplate.htm","bi/repository/dialog/resourceChooser/RepositoryChooserDialogFactory","bi/repository/enum/repositoryResourceTypes"],function(t){"use strict";var e=t("jquery"),o=t("underscore"),r=t("bundle!all"),s=t("jrs.configs"),n=t("backbone"),i=(t("components.pickers"),t("resource.base"),t("text!scheduler/template/editor/outputTabTemplate.htm")),a=t("bi/repository/dialog/resourceChooser/RepositoryChooserDialogFactory"),l=t("bi/repository/enum/repositoryResourceTypes");return n.View.extend({events:{"click .ftp-test":"testFTPConnection","click [name=outputRepositoryButton]":"outputRepositoryButtonClick","click [name=sshKeyPathButton]":"sshKeyPathButtonClick","change [name=outputRepository]":"fixUriInput","change [name=sshKeyPath]":"fixUriInput"},binding:[{attr:"baseOutputFilename",control:"baseOutputFilename"},{attr:"outputTimeZone",control:"timeZone"},{attr:"outputLocale",control:"outputLocale"},{attr:"outputFormats/outputFormat",control:"outputFormats"},{attr:"repositoryDestination/outputDescription",control:"outputDescription"},{attr:"repositoryDestination/overwriteFiles",control:"overwriteFiles"},{attr:"repositoryDestination/sequentialFilenames",control:"sequentialFilenames"},{attr:"repositoryDestination/timestampPattern",control:"timestampPattern"},{attr:"repositoryDestination",control:"timestampPattern",depends:"repositoryDestination/sequentialFilenames"},{attr:"repositoryDestination/saveToRepository",control:"outputToRepository"},{attr:"repositoryDestination",control:"outputRepository, outputRepositoryButton",depends:"repositoryDestination/saveToRepository"},{attr:"repositoryDestination/folderURI",control:"outputRepository"},{attr:"repositoryDestination",control:"outputHostFileSystem",depends:"repositoryDestination/outputLocalFolder",disabled:!("true"===s.enableSaveToHostFS||s.enableSaveToHostFS===!0)},{attr:"repositoryDestination/outputLocalFolder",control:"outputToHostFileSystem",getter:function(t){return!1===t?null:""},setter:function(t){return""===t||!!t}},{attr:"repositoryDestination/outputLocalFolder",control:"outputHostFileSystem"},{attr:"repositoryDestination/outputFTPInfo/enabled",control:"outputToFTPServer",getter:function(t){return t===!1&&this.$el.find("#ftpServerOutput").find(".error").removeClass("error"),t}},{attr:"repositoryDestination/outputFTPInfo",control:"ftpAddress, ftpDirectory, ftpUsername, ftpPassword, ftpTestButton, ftpPort, ftpProtocol, sshKeyEnabled, sshKeyPath, sshKeyPathButton, sshPassphrase",depends:"repositoryDestination/outputFTPInfo/enabled"},{attr:"repositoryDestination/outputFTPInfo/serverName",control:"ftpAddress"},{attr:"repositoryDestination/outputFTPInfo/folderPath",control:"ftpDirectory"},{attr:"repositoryDestination/outputFTPInfo/userName",control:"ftpUsername",setter:function(t){return"anonymous"==t?null:t}},{attr:"repositoryDestination/outputFTPInfo/password",control:"ftpPassword"},{attr:"repositoryDestination/outputFTPInfo/port",control:"ftpPort"},{attr:"repositoryDestination/outputFTPInfo/type",control:"ftpProtocol",setter:function(t){return this.$el.find(".control[data-ftp-type]").addClass("hidden"),t&&"sftp"===t&&this.$el.find(".control[data-ftp-type=sftp]").removeClass("hidden"),t}},{attr:"repositoryDestination/outputFTPInfo/sshKeyEnabled",control:"sshKeyEnabled"},{attr:"repositoryDestination/outputFTPInfo/sshKey",control:"sshKeyPath"},{attr:"repositoryDestination/outputFTPInfo/sshPassphrase",control:"sshPassphrase"},{attr:"repositoryDestination/outputFTPInfo",control:"sshKeyPath, sshKeyPathButton, sshPassphrase",depends:"repositoryDestination/outputFTPInfo/sshKeyEnabled",setter:function(t){return t&&!!this.$el.find("[name=outputToFTPServer]").filter(":checked").map(function(){return e(this).val()}).get()[0]}}],availableFormats:s.availableReportJobOutputFormats||[],initialize:function(t){this.options=o.extend({},t);var e=this;this.model.on("change:repositoryDestination",function(t,o){var r=t.get("repositoryDestination");e.$el.find("[name=ftpPort]").val(r.outputFTPInfo.port)})},isFormatAvailable:function(t){return o.contains(this.availableFormats,t)},getFolderChooserDialog:function(){if(this.folderChooserDialog)return this.folderChooserDialog;var t=this,e=a.getDialog("folder");return this.folderChooserDialog=new e,this.listenTo(this.folderChooserDialog,"close",function(){var e;this.folderChooserDialog.selectedResource&&this.folderChooserDialog.selectedResource.resourceUri&&(e=this.folderChooserDialog.selectedResource.resourceUri,t.$el.find("[name=outputRepository]").val(e).trigger("change"))}),this.folderChooserDialog.setDefaultSelectedItem(this.model.get("repositoryDestination").folderURI),this.folderChooserDialog},outputRepositoryButtonClick:function(){this.getFolderChooserDialog().open()},getSshKeyChooserDialog:function(){if(this.sshKeyChooserDialog)return this.sshKeyChooserDialog;var t=this,e=a.getDialog("item");this.sshKeyChooserDialog=new e({disableListTab:!0,resourcesTypeToSelect:[l.SECURE_FILE]}),this.listenTo(this.sshKeyChooserDialog,"close",function(){var e;this.sshKeyChooserDialog.selectedResource&&this.sshKeyChooserDialog.selectedResource.resourceUri&&(e=this.sshKeyChooserDialog.selectedResource.resourceUri,t.$el.find("[name=sshKeyPath]").val(e).trigger("change"))});var o=this.model.get("repositoryDestination").outputFTPInfo,r=(o||{}).sshKey;return this.sshKeyChooserDialog.setDefaultSelectedItem(r),this.sshKeyChooserDialog},sshKeyPathButtonClick:function(){this.getSshKeyChooserDialog().open()},fixUriInput:function(t){var r=e(t.currentTarget),s=r.val();if(this.model.isValidUri(s))return""===s||o.startsWith(s,"/")?o.startsWith(s,"//")?void r.val(s.substring(1,s.length)).trigger("change"):s.length>1&&o.endsWith(s,"/")?void r.val(s.substring(0,s.length-1)).trigger("change"):void 0:void r.val("/"+s).trigger("change")},render:function(){this._renderTemplate(),this._initializeBinding()},_renderTemplate:function(){var t=o.extend({},{_:o,i18n:r,availableFormats:this.availableFormats,timeZones:s.timeZones,locales:s.avaliableLocales,localesName:s.avaliableLocalesFullName},this.model.attributes);this.setElement(e(o.template(i,t)))},_initializeBinding:function(){var t=this;this.$el.find("[name=outputToHostFileSystem]").attr("disabled","true"===s.enableSaveToHostFS||s.enableSaveToHostFS===!0?!1:"disabled"),this.map=o.map(this.binding,o.clone),o.each(this.map,function(r){if(r.control=r.control.split(","),r.control=r.control.map(function(t){return"[name="+t+"]"}),r.control=t.$el.find(r.control.join(",")),r.attr&&(r.attr=r.attr.split("/")),r.depends&&"!"===r.depends[0]&&(r.invert=!0,r.depends=r.depends.substr(1)),r.depends&&!r.attr){r.depends=t.$el.find("[name="+r.depends+"]");var s=function(){var e=r.setter?r.setter.call(t,r.depends):r.depends.val(),o=r.disabled||(r.invert?!!e:!e);r.control.attr("disabled",o?"disabled":!1)};return r.depends.on("change",s),s()}t.model.on("change:"+r.attr[0],function(e,o){if(o=e.value(r.attr.join("/")),r.setter&&(o=r.setter.call(t,o)),r.depends){var s=e.value(r.depends);r.setter?s=r.setter.call(t,s):""===s&&(s=!0);var n=r.disabled||(r.invert?!!s:!s);return r.control.attr("disabled",n?"disabled":!1)}r.control.is("[type=checkbox]")&&1===r.control.length?r.control.prop("checked",o):r.control.is("[type=radio]")?r.control.filter("[value="+o+"]").prop("checked",!0):r.control.val(o)}),r.control.length&&!r.depends&&r.control.on("change",function(){var s,n,i,a;if(n=r.control.is("[type=checkbox]")?r.control.filter(":checked").map(function(){return e(this).val()}).get():r.control.val(),r.control.is("[type=checkbox]")&&1===r.control.length&&(n=!!n[0]),r.control.is("[type=radio]")&&(n=r.control.filter(":checked").val()),r.getter&&(n=r.getter.call(t,n,o.clone(t.model.value(r.attr.join("/"))))),r.attr.length>1){a=i=o.clone(t.model.get(r.attr[0]));for(var l=1,u=r.attr.length-1;u>l;l++)s=r.attr[l],a[s]=a[s]?o.clone(a[s]):{},a=a[s];a[r.attr[r.attr.length-1]]=n,"repositoryDestination/outputFTPInfo/type"===r.attr.join("/")&&(a.port=t.model.ftpPortDefaults[n])}t.model.update(r.attr[0],i||n)})})},testFTPConnection:function(){e("#ftpTestButton").addClass("disabled"),this.$el.find("#ftpServerOutput").find(".error").removeClass("error"),this.model.testFTPConnection(function(){e("#ftpTestButton").removeClass("disabled")})}})});