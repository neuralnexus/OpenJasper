define(["require","jquery","underscore","backbone","jrs.configs","scheduler/model/jobModel"],function(t){"use strict";var e=t("jquery"),o=t("underscore"),r=t("backbone"),n=t("jrs.configs"),s=t("scheduler/model/jobModel");return r.Collection.extend({model:s,initialize:function(t,e){this.options=o.extend({},e),this.initialAmountOfJobsToLoad=100,this.amountOfJobsToLoad=100,this.amountOfLoadedJobs=0},setSearchingTerm:function(t){this.searchingTerm=t},getSearchingTerm:function(){return this.searchingTerm},getReportUri:function(){return this.options.parentReportURI||this.options.reportUri},fetch:function(){if(this.urlsOfReportsToFetchJobs=[],this.options.masterViewMode)return void this.getJobsWithPagination();if(this.getReportUri()){if(this.urlsOfReportsToFetchJobs.push(this.getReportUri()),!n.isProVersion)return void this.getJobsOfAllReportsWeHave();var t=this;this.getReportOptions().always(function(){t.getJobsOfAllReportsWeHave()})}},getReportOptions:function(){var t=this,e=this.getReportUri();return this.request({url:n.contextPath+"/rest_v2/reports"+e+"/options"}).done(function(e){if(e=e.reportOptionsSummary)for(var o=0,r=e.length;r>o;o++)e[o].uri&&t.urlsOfReportsToFetchJobs.push(e[o].uri)}).fail(function(){})},getJobsOfAllReportsWeHave:function(){var t=this,e=[],r=0;o.each(this.urlsOfReportsToFetchJobs,function(o){t.getJobOfReport(o).done(function(o){e=e.concat(t.parse(o))}).fail(function(e){t.trigger("error",e)}).always(function(){r++,r===t.urlsOfReportsToFetchJobs.length&&t.reset(e)})})},getJobsFromBackend:function(t,o){var r=["sortType=SORTBY_REPORTURI"];if(t&&r.push("startIndex="+t),o&&r.push("numberOfRows="+o),this.searchingTerm){var s=encodeURI(this.searchingTerm);r.push("label="+s)}var i=this,a=e.Deferred(),u=n.contextPath+"/rest_v2/jobs?"+r.join("&");return this.request({url:u}).done(function(t){var e=i.parse(t);i.amountOfLoadedJobs+=e.length,a.resolve(e)}).fail(function(t){i.trigger("error",t),a.reject(t)}),a},getJobOfReport:function(t){var e=n.contextPath+"/rest_v2/jobs?reportUnitURI="+encodeURI(t);return this.request({url:e})},getJobsWithPagination:function(){this.amountOfLoadedJobs=0;var t=this;this.getJobsFromBackend(this.amountOfLoadedJobs,this.initialAmountOfJobsToLoad).done(function(e){t.reset(e)})},loadMoreJobs:function(){var t=this;this.getJobsFromBackend(this.amountOfLoadedJobs,this.amountOfJobsToLoad).done(function(e){t.add(e)})},parse:function(t){return t?t.jobsummary:[]},request:function(t){return t=t||{},t.cache=!1,r.sync.call(this,"read",new r.Model,t)},permission:function(t,e){return r.sync.call(this,"read",new r.Model,{url:n.contextPath+"/rest_v2/resources/"+t.replace(/\/[^\/]+$/,""),cache:!1,headers:{Accept:"application/repository.folder+json"},type:"GET",success:function(t,o){"function"==typeof e&&e(void 0,t.permissionMask)},error:function(t){"function"==typeof e&&e(t)}})}})});