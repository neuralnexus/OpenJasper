define(["require","jquery","underscore","backbone","encoding","jrs.configs","settings!globalConfiguration","xregexp","moment"],function(e){"use strict";var r=",",t="YYYY-MM-DD HH:mm",i=!1,o={},s={},n=e("jquery"),a=e("underscore"),d=e("backbone"),l=e("encoding"),u=e("jrs.configs"),g=e("settings!globalConfiguration"),p=e("xregexp"),c=e("moment"),f=function(e){var r,t=[{id:0,value:"dd",key:"day-of-month-2",result:"DD"},{id:1,value:"DD",key:"day-of-week",result:"dddd"},{id:2,value:"mm",key:"month-2",result:"MM"},{id:3,value:"MM",key:"month-name",result:"MMMM"},{id:4,value:"yy",key:"year-4",result:"YYYY"},{id:5,value:"d",key:"day-of-month-1",result:"D"},{id:6,value:"D",key:"day-of-week-abbr",result:"ddd"},{id:7,value:"m",key:"month-1",result:"M"},{id:8,value:"M",key:"month-name-abbr",result:"MMM"},{id:9,value:"y",key:"year-2",result:"YY"},{id:10,value:"oo",key:"day-of-year-2",result:"DDDD"},{id:11,value:"o",key:"day-of-year-1",result:"DDD"}];for(r=0;r<t.length;r++)e=e.replace(new RegExp(t[r].value,"g"),"{"+t[r].id+"}");for(r=0;r<t.length;r++)e=e.replace(new RegExp("\\{"+t[r].id+"\\}","g"),t[r].result);return e},h=f(u.calendar.timepicker.dateFormat),y=u.calendar.timepicker.timeFormat.replace(":ss",""),m=h+" "+y;return d.Model.extend({ftpPortDefaults:{ftp:"21",ftps:"990",sftp:"22"},urlRoot:u.contextPath+"/rest_v2/jobs",validateAll:function(e){var r=this,t=n.Deferred();return this.runServerValidationRequests().always(function(i){var o=r.isValid(e);i&&i.errorCode&&(o=!1,r.trigger("invalid",[i],{switchToErrors:!1})),o?t.resolve():t.reject()}),t},isValid:function(e){return!this.validate(this.attributes,{validate:!0,editMode:e}).length},validate:function(e,r){if(r=r||{},r.validate===!0){var t,i=[];e.trigger&&(2==e.trigger.startType&&(e.trigger.startDate?c(e.trigger.startDate,m,!0).isValid()?!r.editMode&&this.ifPastDate(e.trigger.startDate,e.trigger.timezone)&&i.push({field:"startDate",errorCode:"error.before.current.date.trigger.startDate"}):i.push({field:"startDate",errorCode:"error.invalid.date"}):i.push({field:"startDate",errorCode:"report.scheduling.job.edit.specify.startdate"})),"simple"===e.trigger.type?(this.isNumeric(e.trigger.recurrenceInterval)?this.isNumeric(e.trigger.recurrenceInterval,{minValue:-2147483648,maxValue:2147483647})||i.push({field:"recurrenceInterval",errorCode:"typeMismatch.java.lang.Integer"}):i.push({field:"recurrenceInterval",errorCode:"report.scheduling.job.edit.specify.recurrenceinterval"}),"numberOfTimes"===e.trigger.radioEndDate&&(this.isNumeric(e.trigger.occurrenceCount)?this.isNumeric(e.trigger.occurrenceCount,{minValue:-2147483648,maxValue:2147483647})||i.push({field:"occurrenceCount",errorCode:"typeMismatch.java.lang.Integer"}):i.push({field:"occurrenceCount",errorCode:"report.scheduling.job.edit.specify.numberoftimestorunreport"})),"specificDate"===e.trigger.radioEndDate&&(e.trigger.endDate?c(e.trigger.endDate,m,!0).isValid()?(this.ifPastDate(e.trigger.endDate,e.trigger.timezone)&&i.push({field:"simpleEndDate",errorCode:"error.before.current.date.trigger.endDate"}),2==e.trigger.startType&&e.trigger.startDate&&+new Date(e.trigger.startDate)>=+new Date(e.trigger.endDate)&&i.push({field:"simpleEndDate",errorCode:"error.before.start.date.trigger.endDate"})):i.push({field:"simpleEndDate",errorCode:"error.invalid.date"}):i.push({field:"simpleEndDate",errorCode:"report.scheduling.job.edit.specify.enddate"}))):"calendar"===e.trigger.type&&("selectedMonths"===e.trigger.radioWhichMonth&&0===e.trigger.months.month.length&&i.push({field:"monthSelector",errorCode:"report.scheduling.job.edit.specify.monthswhenjobshouldrun"}),e.trigger.endDate&&(c(e.trigger.endDate,m,!0).isValid()?(this.ifPastDate(e.trigger.endDate,e.trigger.timezone)&&i.push({field:"calendarEndDate",errorCode:"error.before.current.date.trigger.endDate"}),2==e.trigger.startType&&e.trigger.startDate&&+new Date(e.trigger.startDate)>=+new Date(e.trigger.endDate)&&i.push({field:"calendarEndDate",errorCode:"error.before.start.date.trigger.endDate"})):i.push({field:"calendarEndDate",errorCode:"error.invalid.date"})),"selectedDays"===e.trigger.radioWhichDay&&0===e.trigger.weekDays.day.length&&i.push({field:"daySelector",errorCode:"report.scheduling.job.edit.specify.dayswhenjobshouldrun"}),"datesInMonth"===e.trigger.radioWhichDay&&(t=this.parseIntervals(e.trigger.monthDays,"daysInMonth"),t||i.push({field:"datesInMonth",errorCode:"report.scheduling.job.edit.specify.whenjobshouldrun"})),this.parseIntervals(e.trigger.hours,"hours")||i.push({field:"hours",errorCode:"error.not.empty.trigger.hours"}),this.parseIntervals(e.trigger.minutes,"minutes")||i.push({field:"minutes",errorCode:"error.not.empty.trigger.minutesshould"})));var o=e.repositoryDestination;if(o.outputDescription&&o.outputDescription.length>250&&i.push({field:"outputDescription",errorCode:"report.scheduling.job.output.long.description"}),o.sequentialFilenames&&!o.timestampPattern&&i.push({field:"timestampPattern",errorCode:"report.scheduling.job.output.timestamppattern"}),e.baseOutputFilename||i.push({field:"baseOutputFilename",errorCode:"error.not.empty.baseOutputFilename"}),e.baseOutputFilename&&!this.isValidFileName(e.baseOutputFilename)&&i.push({field:"baseOutputFilename",errorCode:"error.invalid.chars.baseOutputFilename"}),e.outputFormats.outputFormat&&e.outputFormats.outputFormat.length||i.push({field:"outputFormats",errorCode:"error.report.job.no.output.formats"}),o.saveToRepository&&!o.folderURI&&i.push({field:"outputRepository",errorCode:"error.not.empty.folderURI"}),o.saveToRepository&&o.folderURI&&!this.isValidUri(o.folderURI)&&i.push({field:"outputRepository",errorCode:"error.report.job.invalid.chars.folderURI"}),a.isUndefined(o.outputLocalFolder)||""!==o.outputLocalFolder||i.push({field:"outputHostFileSystem",errorCode:"error.not.empty.folder"}),o.outputFTPInfo.enabled&&(o.outputFTPInfo.serverName?this.isHostName(o.outputFTPInfo.serverName)||i.push({field:"ftpAddress",errorCode:"error.report.scheduling.empty.ftp.server"}):i.push({field:"ftpAddress",errorCode:"error.report.scheduling.empty.ftp.server"}),o.outputFTPInfo.port&&this.isNumeric(o.outputFTPInfo.port)?(t=parseInt(o.outputFTPInfo.port,10),t>0&&65535>=t||i.push({field:"ftpPort",errorCode:"error.report.scheduling.empty.ftp.port"})):i.push({field:"ftpPort",errorCode:"error.report.scheduling.empty.ftp.port"}),"sftp"===o.outputFTPInfo.type&&o.outputFTPInfo.sshKeyEnabled&&(o.outputFTPInfo.sshKey&&""!==o.outputFTPInfo.sshKey?this.isValidUri(o.outputFTPInfo.sshKey)||i.push({field:"sshKey",errorCode:"error.report.job.invalid.chars.sshKey"}):i.push({field:"sshKey",errorCode:"error.not.empty.sshKey"}))),e.mailNotification){var s=e.mailNotification.toAddresses&&e.mailNotification.toAddresses.address||"",n=e.mailNotification.ccAddresses&&e.mailNotification.ccAddresses.address||"",d=e.mailNotification.bccAddresses&&e.mailNotification.bccAddresses.address||"",l=e.mailNotification.subject||"",u=e.mailNotification.messageText||"";s&&!this.validateEmails(s)&&i.push({field:"to_suc",errorCode:"error.invalid.mailNotification.invalidEmailaddresses"}),n&&!this.validateEmails(n)&&i.push({field:"cc_suc",errorCode:"error.invalid.mailNotification.invalidEmailaddresses"}),d&&!this.validateEmails(d)&&i.push({field:"bcc_suc",errorCode:"error.invalid.mailNotification.invalidEmailaddresses"}),(s||l)&&(s||i.push({field:"to_suc",errorCode:"error.invalid.mailNotification.specify.oneaddresses"}),l||i.push({field:"subject_suc",errorCode:"report.scheduling.job.edit.specify.messagesubject"})),u&&(s||i.push({field:"to_suc",errorCode:"error.invalid.mailNotification.specify.oneaddresses"}),l||i.push({field:"subject_suc",errorCode:"report.scheduling.job.edit.specify.messagesubject"}))}if(e.alert){var g=e.alert.toAddresses&&e.alert.toAddresses.address||"",p=e.alert.subject||"";e.alert.messageText||"",e.alert.messageTextWhenJobFails||"";g&&!this.validateEmails(g)&&i.push({field:"job_status_to",errorCode:"error.invalid.mailNotification.invalidEmailaddresses"}),(g||p)&&(g||i.push({field:"job_status_to",errorCode:"error.invalid.mailNotification.specify.oneaddresses"}),p||i.push({field:"job_status_subject",errorCode:"report.scheduling.job.edit.specify.messagesubject"})),(-1!==e.alert.jobState.indexOf("SUCCESS_ONLY")||-1!==e.alert.jobState.indexOf("ALL"))&&(g||i.push({field:"job_status_to",errorCode:"error.invalid.mailNotification.specify.oneaddresses"}),p||i.push({field:"job_status_subject",errorCode:"report.scheduling.job.edit.specify.messagesubject"})),(-1!==e.alert.jobState.indexOf("FAIL_ONLY")||-1!==e.alert.jobState.indexOf("ALL"))&&(g||i.push({field:"job_status_to",errorCode:"error.invalid.mailNotification.specify.oneaddresses"}),p||i.push({field:"job_status_subject",errorCode:"report.scheduling.job.edit.specify.messagesubject"}))}return this.trigger("clearAllErrors"),i.length?this.trigger("invalid",i):this.trigger("valid",[]),i}},update:function(e,r){if("object"==typeof r){r=a.extend({},this.get(e),r);for(var t in r)r.hasOwnProperty(t)&&void 0===r[t]&&delete r[t]}this.set(e,r)},value:function(e){var r=this.attributes;e=e.split("/");for(var t=0,i=e.length-1;i>t;t++){if(!r)return;r=r[e[t]]}if(r)return r[e[e.length-1]]},sync:function(e,r,t){return"update"===e?e="create":"create"===e&&(e="update"),t||(t={}),t.contentType="application/job+json",t.beforeSend=function(e){e.setRequestHeader("Accept","application/job+json")},t.cache=!1,d.sync(e,r,t)},parse:function(e){if(e.trigger&&("simpleTrigger"in e.trigger?e.trigger.type="simpleTrigger":"calendarTrigger"in e.trigger&&(e.trigger.type="calendarTrigger"),e.trigger.type&&(a.extend(e.trigger,e.trigger[e.trigger.type]),delete e.trigger[e.trigger.type]),"simpleTrigger"===e.trigger.type&&null===e.trigger.recurrenceInterval?e.trigger.type="none":"simpleTrigger"===e.trigger.type?e.trigger.type="simple":"calendarTrigger"===e.trigger.type?e.trigger.type="calendar":e.trigger.type="none","none"===e.trigger.type&&(e.trigger.occurrenceCount=""),"undefined"==typeof e.trigger.startType&&(e.trigger.startType=1),e.trigger.startDate&&(e.trigger.startDate=this.formatDate(e.trigger.startDate)),("undefined"==typeof e.trigger.timezone||null===e.trigger.timezone)&&(e.trigger.timezone=u.usersTimeZone||"America/Los_Angeles"),("simple"===e.trigger.type||"calendar"===e.trigger.type)&&("undefined"==typeof e.trigger.calendarName||null===e.trigger.calendarName)&&(e.trigger.calendarName=""),("undefined"==typeof e.trigger.recurrenceInterval||null===e.trigger.recurrenceInterval)&&(e.trigger.recurrenceInterval=1),("undefined"==typeof e.trigger.recurrenceIntervalUnit||null===e.trigger.recurrenceIntervalUnit)&&(e.trigger.recurrenceIntervalUnit="DAY"),("undefined"==typeof e.trigger.occurrenceCount||null===e.trigger.occurrenceCount)&&(e.trigger.occurrenceCount=""),"undefined"==typeof e.trigger.endDate||null===e.trigger.endDate?e.trigger.endDate="":e.trigger.endDate=this.formatDate(e.trigger.endDate),e.trigger.endDate?e.trigger.endDate&&(e.trigger.radioEndDate="specificDate",e.trigger.occurrenceCount=""):-1!=e.trigger.occurrenceCount&&e.trigger.occurrenceCount?e.trigger.radioEndDate="numberOfTimes":(e.trigger.radioEndDate="indefinitely",e.trigger.occurrenceCount=""),e.trigger.months||(e.trigger.months={}),a.isArray(e.trigger.months.month)||(e.trigger.months.month=[]),e.trigger.radioWhichMonth="everyMonth",0<e.trigger.months.month.length&&e.trigger.months.month.length<12?e.trigger.radioWhichMonth="selectedMonths":12==e.trigger.months.month.length&&(e.trigger.radioWhichMonth="everyMonth",e.trigger.months.month=[]),e.trigger.weekDays||(e.trigger.weekDays={}),a.isArray(e.trigger.weekDays.day)||(e.trigger.weekDays.day=[]),"undefined"==typeof e.trigger.monthDays||null===e.trigger.monthDays?e.trigger.monthDays="":e.trigger.monthDays=e.trigger.monthDays.toString().replace(/ /g,"").replace(/,/g,", "),"undefined"!=typeof e.trigger.daysType?"month"==e.trigger.daysType.toLowerCase()?(e.trigger.radioWhichDay="datesInMonth",e.trigger.weekDays.day=[]):"week"==e.trigger.daysType.toLowerCase()?(e.trigger.radioWhichDay="selectedDays",e.trigger.monthDays=""):(e.trigger.radioWhichDay="everyDay",e.trigger.weekDays.day=[],e.trigger.monthDays=""):0<e.trigger.weekDays.day.length&&e.trigger.weekDays.day.length<7?e.trigger.radioWhichDay="selectedDays":e.trigger.monthDays?e.trigger.radioWhichDay="datesInMonth":e.trigger.radioWhichDay="everyDay","undefined"==typeof e.trigger.hours||null===e.trigger.hours?e.trigger.hours="0":e.trigger.hours=e.trigger.hours.toString().replace(/ /g,"").replace(/,/g,", "),"undefined"==typeof e.trigger.minutes||null===e.trigger.minutes?e.trigger.minutes="0":e.trigger.minutes=e.trigger.minutes.toString().replace(/ /g,"").replace(/,/g,", ")),"undefined"==typeof e.repositoryDestination||null===e.repositoryDestination)e.repositoryDestination={overwriteFiles:!0,sequentialFilenames:!1,saveToRepository:!0,timestampPattern:"yyyyMMddHHmm",outputFTPInfo:{propertiesMap:{},type:"ftp",port:"21",implicit:!0,pbsz:0}};else{if("undefined"==typeof e.repositoryDestination.outputFTPInfo||null===e.repositoryDestination.outputFTPInfo)e.repositoryDestination.outputFTPInfo={};else{var t=e.repositoryDestination.outputFTPInfo;t.enabled=!!t.serverName&&!!t.userName,t.sshKeyEnabled=!!t.sshKey,t.enabled&&(e.repositoryDestination.outputFTPInfo.password=u.VALUE_SUBSTITUTION),t.sshKeyEnabled&&(e.repositoryDestination.outputFTPInfo.sshPassphrase=u.VALUE_SUBSTITUTION)}e.repositoryDestination.timestampPattern||(e.repositoryDestination.timestampPattern="yyyyMMddHHmm")}("undefined"==typeof e.repositoryDestination.outputFTPInfo.port||null===e.repositoryDestination.outputFTPInfo.port)&&(e.repositoryDestination.outputFTPInfo.port=this.ftpPortDefaults[e.repositoryDestination.outputFTPInfo.type]);var i="SEND";if(e.mailNotification=e.mailNotification||{toAddresses:{address:""},ccAddresses:{address:""},bccAddresses:{address:""},subject:"",messageText:"",resultSendType:i},e.alert=e.alert||{toAddresses:{address:""},subject:"",messageText:"",messageTextWhenJobFails:"",jobState:"NONE"},"undefined"==typeof e.mailNotification.resultSendType||null===e.mailNotification.resultSendType)e.mailNotification.resultSendType=i;else{var o=e.mailNotification.resultSendType;"SEND"!==o&&"SEND_ATTACHMENT"!==o&&"SEND_ATTACHMENT_NOZIP"!==o&&"SEND_EMBED"!==o&&"SEND_ATTACHMENT_ZIP_ALL"!==o&&"SEND_EMBED_ZIP_ALL_OTHERS"!==o&&(e.mailNotification.resultSendType=i)}var s,n=["toAddresses","ccAddresses","bccAddresses"];for(s=0;s<n.length;s++)"undefined"==typeof e.mailNotification[n[s]]||null===e.mailNotification[n[s]]?e.mailNotification[n[s]]={address:""}:("undefined"==typeof e.mailNotification[n[s]].address||null===e.mailNotification[n[s]].address)&&(e.mailNotification[n[s]].address=""),a.isArray(e.mailNotification[n[s]].address)&&e.mailNotification[n[s]].address.length>0?e.mailNotification[n[s]].address=e.mailNotification[n[s]].address.join(r+" "):e.mailNotification[n[s]].address="";return e.mailNotification.toAddresses.address||(e.mailNotification={toAddresses:{address:""},ccAddresses:{address:""},bccAddresses:{address:""},subject:"",messageText:"",resultSendType:i}),"undefined"==typeof e.alert.toAddresses||null===e.alert.toAddresses?e.alert.toAddresses={address:""}:("undefined"==typeof e.alert.toAddresses.address||null===e.alert.toAddresses.address)&&(e.alert.toAddresses.address=""),a.isArray(e.alert.toAddresses.address)&&e.alert.toAddresses.address.length>0?e.alert.toAddresses.address=e.alert.toAddresses.address.join(r+" "):e.alert={toAddresses:{address:""},subject:"",messageText:"",messageTextWhenJobFails:"",jobState:"NONE",includingReportJobInfo:!1,includingStackTrace:!1},e},toJSON:function(){var e=n.extend(!0,{},this.attributes),i={};if(e.trigger&&(e.trigger.startType=parseInt(e.trigger.startType,10),1===e.trigger.startType?e.trigger.startDate=null:e.trigger.startDate=c(e.trigger.startDate,m,!0).format(t),"none"===e.trigger.type?(e.trigger.type="simpleTrigger",e.trigger.endDate=null,e.trigger.occurrenceCount=1,e.trigger.recurrenceInterval=null,e.trigger.recurrenceIntervalUnit=null,delete e.trigger.hours,delete e.trigger.minutes,delete e.trigger.months,delete e.trigger.daysType,delete e.trigger.weekDays,delete e.trigger.monthDays,delete e.trigger.calendarName):"simple"===e.trigger.type?(e.trigger.type="simpleTrigger","numberOfTimes"==e.trigger.radioEndDate&&(e.trigger.endDate=null),"specificDate"==e.trigger.radioEndDate&&(e.trigger.occurrenceCount=-1,e.trigger.endDate=c(e.trigger.endDate,m,!0).format(t)),"indefinitely"==e.trigger.radioEndDate&&(e.trigger.occurrenceCount=-1,e.trigger.endDate=null),e.trigger.recurrenceInterval=parseInt(e.trigger.recurrenceInterval,10),e.trigger.recurrenceIntervalUnit=e.trigger.recurrenceIntervalUnit.toUpperCase(),""===e.trigger.calendarName&&(e.trigger.calendarName=null),delete e.trigger.hours,delete e.trigger.minutes,delete e.trigger.months,delete e.trigger.daysType,delete e.trigger.weekDays,delete e.trigger.monthDays):"calendar"===e.trigger.type&&(e.trigger.type="calendarTrigger","everyMonth"===e.trigger.radioWhichMonth&&(e.trigger.months.month=[1,2,3,4,5,6,7,8,9,10,11,12]),"everyDay"===e.trigger.radioWhichDay||7==e.trigger.weekDays.day.length?(e.trigger.daysType="ALL",e.trigger.weekDays.day=[],e.trigger.monthDays=""):"selectedDays"===e.trigger.radioWhichDay?(e.trigger.daysType="WEEK",e.trigger.monthDays=""):"datesInMonth"===e.trigger.radioWhichDay&&(e.trigger.daysType="MONTH",e.trigger.weekDays.day=[]),e.trigger.monthDays=e.trigger.monthDays.replace(/ /g,""),""===e.trigger.endDate?delete e.trigger.endDate:e.trigger.endDate=c(e.trigger.endDate,m,!0).format(t),e.trigger.hours=e.trigger.hours.replace(/ /g,""),e.trigger.minutes=e.trigger.minutes.replace(/ /g,""),""===e.trigger.calendarName&&(e.trigger.calendarName=null),delete e.trigger.occurrenceCount,delete e.trigger.recurrenceInterval,delete e.trigger.recurrenceIntervalUnit),delete e.trigger.radioEndDate,delete e.trigger.radioWhichMonth,delete e.trigger.radioWhichDay,e.trigger&&e.trigger.type&&(i[e.trigger.type]=e.trigger,delete i[e.trigger.type].type,e.trigger=i)),e.repositoryDestination&&(e.repositoryDestination.outputFTPInfo&&(e.repositoryDestination.outputFTPInfo.enabled||(e.repositoryDestination.outputFTPInfo={type:"ftp",port:21,folderPath:null,password:null,propertiesMap:{},serverName:null,userName:null,sshKey:null,sshPassphrase:null}),e.repositoryDestination.outputFTPInfo.password===u.VALUE_SUBSTITUTION&&delete e.repositoryDestination.outputFTPInfo.password,"sftp"===e.repositoryDestination.outputFTPInfo.type&&e.repositoryDestination.outputFTPInfo.sshKeyEnabled?e.repositoryDestination.outputFTPInfo.sshPassphrase===u.VALUE_SUBSTITUTION&&delete e.repositoryDestination.outputFTPInfo.sshPassphrase:(delete e.repositoryDestination.outputFTPInfo.sshKey,delete e.repositoryDestination.outputFTPInfo.sshPassphrase),"enabled"in e.repositoryDestination.outputFTPInfo&&delete e.repositoryDestination.outputFTPInfo.enabled,"sshKeyEnabled"in e.repositoryDestination.outputFTPInfo&&delete e.repositoryDestination.outputFTPInfo.sshKeyEnabled),e.repositoryDestination.sequentialFilenames||(e.repositoryDestination.timestampPattern=null)),e.mailNotification){var o,s=["toAddresses","ccAddresses","bccAddresses"];for(o=0;o<s.length;o++)if(e.mailNotification[s[o]]&&"undefined"!=typeof e.mailNotification[s[o]].address){if(!e.mailNotification[s[o]].address){delete e.mailNotification[s[o]];continue}e.mailNotification[s[o]].address=e.mailNotification[s[o]].address.replace(/ /g,"").split(r)}e.mailNotification.toAddresses&&"undefined"!=typeof e.mailNotification.toAddresses.address||delete e.mailNotification}return e.alert&&(e.alert.toAddresses&&"undefined"!=typeof e.alert.toAddresses.address&&(e.alert.toAddresses.address?e.alert.toAddresses.address=e.alert.toAddresses.address.replace(/ /g,"").split(r):delete e.alert.toAddresses.address),e.alert.toAddresses&&"undefined"!=typeof e.alert.toAddresses.address||delete e.alert),e},state:function(e){var r={jobId:[this.id],toJSON:function(){return this},trigger:function(){return this}};return this.get("state").value=e?"NORMAL":"PAUSED",this.trigger("change"),d.sync.call(this,"update",r,{url:u.contextPath+"/rest_v2/jobs/"+(e?"resume":"pause"),type:"POST"})},loadParameters:function(e){e=e||this.get("source").reportUnitURI;var r=this,t=u.contextPath+"/rest_v2/reports"+encodeURI(e)+"/inputControls/";return d.sync.call(this,"read",new d.Model,{url:t,type:"GET"}).done(function(e){if(e&&e.inputControl){for(var t={},i=e.inputControl,o=0;o<i.length;o++)t[i[o].id]=null;r.update("source",{parameters:{parameterValues:t}})}else r.trigger("failedToGet_IC")}).fail(function(){r.trigger("failedToGet_IC")})},checkSaveValidation:function(e){e=e||{};var r=n.Deferred(),t=0,i=function(){t++,3===t&&r.resolve()},o=function(){r.reject()};return this.testDates(e.editMode).done(i).fail(o),this.validateParametersIC().done(i).fail(o),this.testOutputHostFileSystemFolder().done(i).fail(o),r},testDates:function(e){var r=[],t=n.Deferred(),i=this.attributes.trigger;return!e&&2==i.startType&&i.startDate&&this.ifPastDate(i.startDate,i.timezone)&&r.push({field:"startDate",errorCode:"error.before.current.date.trigger.startDate"}),"simple"===i.type&&"specificDate"===i.radioEndDate&&i.endDate&&this.ifPastDate(i.endDate,i.timezone)?r.push({field:"simpleEndDate",errorCode:"error.before.current.date.trigger.endDate"}):"calendar"===i.type&&i.endDate&&this.ifPastDate(i.endDate,i.timezone)&&r.push({field:"calendarEndDate",errorCode:"error.before.current.date.trigger.endDate"}),r.length?(this.trigger("invalid",r,{switchToErrors:!0}),t.reject()):t.resolve()},testFTPConnection:function(e){if(i)return void("function"==typeof e&&e());var r=this.get("repositoryDestination");if(!(r&&r.outputFTPInfo&&r.outputFTPInfo.enabled))return void("function"==typeof e&&e());r=r.outputFTPInfo;var t=this,o={host:r.serverName,userName:r.userName,folderPath:r.folderPath,type:r.type,protocol:r.protocol,port:r.port,implicit:r.implicit,prot:r.prot,pbsz:r.pbsz,toJSON:function(){return this},trigger:function(){return this}};return this.get("id")&&(o.holder="job:"+this.get("id")),r.password!==u.VALUE_SUBSTITUTION&&(o.password=r.password),"sftp"===r.type&&r.sshKeyEnabled&&(o.sshKey=r.sshKey,r.sshPassphrase!==u.VALUE_SUBSTITUTION&&(o.sshPassphrase=r.sshPassphrase)),i=!0,n("#ftpTestButton").addClass("checking"),n("[data-field=ftpTest]").text(""),d.sync.call(this,"update",o,{url:u.contextPath+"/rest_v2/connections",contentType:"application/connections.ftp+json",headers:{Accept:"application/json"},type:"POST",success:function(r,o){i=!1,n("#ftpTestButton").removeClass("checking"),t.trigger("valid",[{field:"ftpTest",errorCode:"report.scheduling.connection.passed"}]),"function"==typeof e&&e(void 0)},error:function(r){i=!1,n("#ftpTestButton").removeClass("checking"),t.trigger("invalid",[{field:"ftpTest",errorCode:"report.scheduling.connection.failed"}]),"function"==typeof e&&e(r)}})},validateParametersIC:function(){var e=this,r=n.Deferred();return this.get("source")&&this.get("source").parameters?(this.controlsController.validate().then(function(t){t?r.resolve():(e.trigger("invalid",[{field:"parametersErrorNotifierStub",errorCode:"report.scheduling.list.state.5"}],{switchToErrors:!0}),r.reject())}),r):r.resolve()},runServerValidationRequests:function(){var e=n.Deferred(),r=0,t=function(){r++,2===r&&e.resolve()},i=function(r){e.reject(r)};return this.testOutputRepositoryFolder().done(t).fail(i),this.testSshKey().done(t).fail(i),e},testSshKey:function(){var e=n.Deferred(),r=this.get("repositoryDestination")?this.get("repositoryDestination").outputFTPInfo:null;if(!r||!r.enabled||!r.sshKeyEnabled)return e.resolve();var t=r.sshKey;return t&&""!==t&&this.isValidUri(t)?a.isUndefined(s[t])?(this.resource("file",t,function(r,i){r?(s[t]={field:"sshKey",errorCode:"error.report.job.report.inexistent.sshKey",errorArguments:[t]},e.reject(s[t])):(s[t]={},e.resolve())}),e):s[t].errorCode?e.reject(s[t]):e.resolve():e.resolve()},testOutputRepositoryFolder:function(){var e=n.Deferred();if(!this.get("repositoryDestination"))return e.resolve();if(!this.get("repositoryDestination").saveToRepository)return e.resolve();var r=this.get("repositoryDestination").folderURI;return r&&""!==r?this.isValidUri(r)?a.isUndefined(o[r])?(this.checkPermissionOnFolder(r,function(t,i){var s=null;t?s="error.report.job.report.inexistent.output":1!==i&&30!==i&&6!==i&&(s="error.report.job.output.folder.notwriteable"),s?(o[r]={field:"outputRepository",errorCode:s,errorArguments:[r]},e.reject(o[r])):(o[r]={},e.resolve())}),e):o[r].errorCode?e.reject(o[r]):e.resolve():e.reject({field:"outputRepository",errorCode:"error.report.job.invalid.chars.folderURI"}):e.reject({field:"outputRepository",errorCode:"error.not.empty.folder"})},testOutputHostFileSystemFolder:function(){var e=this,r=n.Deferred();if("false"===u.enableSaveToHostFS||u.enableSaveToHostFS===!1)return r.resolve();if(!this.get("repositoryDestination"))return r.resolve();var t=this.get("repositoryDestination").outputLocalFolder;if(a.isUndefined(t)||null===t)return r.resolve();if(!t)return this.trigger("invalid",[{field:"outputHostFileSystem",errorCode:"report.scheduling.output.localhostpath"}],{switchToErrors:!0}),r.reject();var i={path:this.get("repositoryDestination").outputLocalFolder,toJSON:function(){return this},trigger:function(){return this}};return d.sync.call(this,"update",i,{url:u.contextPath+"/rest_v2/connections",contentType:"application/connections.lfs+json",type:"POST",headers:{Accept:"application/json"}}).done(function(){r.resolve()}).fail(function(){e.trigger("invalid",[{field:"outputHostFileSystem",errorCode:"report.scheduling.output.localhostpath"}],{switchToErrors:!0}),r.reject()}),r},checkPermissionOnFolder:function(e,r){return"ja"==u.userLocale&&isIE8()&&(e=l.convert(e,{to:"SJIS",from:"UNICODE",type:"string"})),d.sync.call(this,"read",new d.Model,{url:u.contextPath+"/rest_v2/resources"+e,headers:{Accept:"application/repository.folder+json"},type:"GET",success:function(e,t){"function"==typeof r&&r(void 0,e.permissionMask)},error:function(e){try{e=JSON.parse(e.responseText)}catch(t){}"function"==typeof r&&r(e)}})},resource:function(e,r,t){return d.sync.call(this,"read",new d.Model,{url:u.contextPath+"/rest_v2/resources"+r,headers:{Accept:"application/repository."+e+"+json"},type:"GET",success:function(e,r){"function"==typeof t&&t(void 0,e)},error:function(e){"function"==typeof t&&t(e)}})},parseUri:function(e){var r;return"/"!==e[0]&&(e="/"+e),e&&(r=e.match(/^(.*)\/([^\/]+)$/))?(""===r[1]&&(r[1]="/"),{full:r[0],folder:r[1],file:r[2]}):{}},createFromUri:function(e){this.trigger("clearAllErrors"),this.clear({silent:!0}),e=this.parseUri(e);var r=a.extend({},u.reportJobEditorDefaults);this.set(this.parse({baseOutputFilename:e.file,outputFormats:{outputFormat:["PDF"]},source:{reportUnitURI:e.full},trigger:{timezone:u.usersTimeZone||"America/Los_Angeles"},outputTimeZone:u.usersTimeZone||"America/Los_Angeles",repositoryDestination:{overwriteFiles:!0,sequentialFilenames:!1,folderURI:"undefined"==typeof r["scheduler.job.repositoryDestination.folderURI"]?e.folder:r["scheduler.job.repositoryDestination.folderURI"],saveToRepository:!0,timestampPattern:"yyyyMMddHHmm",outputFTPInfo:{propertiesMap:{},type:"ftp",port:"21",implicit:!0,pbsz:0}}}))},formatDate:function(e){return e?c(e,t).format(m):""},parseIntervals:function(e,r){if(e=e||!1,!e)return!1;e=e.replace(/ /g,"");var t,i,o,s=e.split(","),n=[],a={};1==s.length&&(s=e.split("/"));var d=1,l=31;if("hours"===r&&(d=0,l=23),"minutes"===r&&(d=0,l=59),s.length<1)return!1;for(t=0;t<s.length;t++)if(-1!==s[t].indexOf("-")){if(o=s[t].split("-"),!this.isNumeric(o[0],{allowZero:!0}))return!1;if(!this.isNumeric(o[1],{allowZero:!0}))return!1;if(o[0]=parseInt(o[0],10),o[1]=parseInt(o[1],10),!(d<=o[0]&&o[0]<=l))return!1;if(!(d<=o[1]&&o[1]<=l))return!1;if(o[0]>=o[1])return!1;for(i=o[0];i<=o[1];i++)"undefined"==typeof a[i]&&(n.push(i),a[i]=1)}else{if(!this.isNumeric(s[t],{allowZero:!0}))return!1;if(s[t]=parseInt(s[t],10),!(d<=s[t]&&s[t]<=l))return!1;"undefined"==typeof a[s[t]]&&(n.push(s[t]),a[s[t]]=1)}return n},ifPastDate:function(e,r){if(!e||!r)return!1;var t,i,o,s,n;return t=getTZOffset(r),i=c().utcOffset()/60,o=i-t,s=+c().format("X"),n=+c(e,m,!0).add(1,"minute").format("X")+3600*o,s>n},isHostName:function(e){if(!e)return!1;var r=/^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$/;return r.test(e)},isEmail:function(e){if(!e)return!1;var r=new p(g.emailRegExpPattern,"g");return r.test(e)},isValidFileName:function(e){if(!e)return!1;var r=new RegExp(g.resourceIdNotSupportedSymbols,"g");return!r.test(e)},isValidUri:function(e){if(!e)return!1;var r=new RegExp(g.resourceIdNotSupportedSymbols,"g");return!r.test(e.replace(/\//g,""))},validateEmails:function(e){if(!e)return!1;e=e.split(new RegExp(" *"+r+" *"));for(var t=0;t<e.length;t++)if(!this.isEmail(e[t]))return!1;return!0},isNumeric:function(e,r){var t;if(!e)return!1;if(r=r||{},r.allowNegative=r.allowNegative||!1,r.allowZero=r.allowZero||!1,r.maxValue=r.maxValue||!1,r.minValue=r.minValue||!1,"string"==typeof e){if(e.match(/\D/))return!1;if(t=parseInt(e,10),a.isNaN(t))return!1}return r.allowNegative===!1&&0>t?!1:r.allowZero===!1&&0===t?!1:r.maxValue&&r.maxValue<t?!1:r.minValue&&t<r.minValue?!1:!0}})});