define(["require","jquery","underscore","backbone","bundle!all","common/component/dialog/AlertDialog","scheduler/saveDialog/SaveDialogView","scheduler/view/editor/scheduleTabView","scheduler/view/editor/parametersTabView","scheduler/view/editor/outputTabView","scheduler/view/editor/notificationsTabView","scheduler/util/schedulerUtils","text!scheduler/template/jobEditorViewTemplate.htm"],function(e){"use strict";var t=e("jquery"),i=e("underscore"),a=e("backbone"),r=e("bundle!all"),s=e("common/component/dialog/AlertDialog"),o=e("scheduler/saveDialog/SaveDialogView"),n=e("scheduler/view/editor/scheduleTabView"),l=e("scheduler/view/editor/parametersTabView"),d=e("scheduler/view/editor/outputTabView"),h=e("scheduler/view/editor/notificationsTabView"),c=(e("scheduler/util/schedulerUtils"),e("text!scheduler/template/jobEditorViewTemplate.htm"));return a.View.extend({editMode:!1,runNowMode:!1,events:{"mouseup [name=tabs] li":"tabChangeClickEvent","touchend [name=tabs] li":"tabChangeClickEvent","click [name=openSaveDialog]":"openSaveDialogClick","click [name=cancelJobCreation]":"cancelJobCreationClick"},initialize:function(e){this.options=i.extend({},e),this.tabs={},this.listenTo(this.model,"valid",this.validModelListener),this.listenTo(this.model,"invalid",this.invalidModelListener),this.listenTo(this.model,"clearAllErrors",this.clearAllValidationErrors),this.listenTo(this.model,"change:source",this.sourceKeyInModelChanged),this.listenTo(this.model,"failedToGet_IC",this.InputControlsNotLoaded),this._initializeTabs(e),this.listenTo(this.tabs.parametersTab,"IC_Displayed",this.InputControlsLoaded),this.listenTo(this.tabs.parametersTab,"failedToGet_IC",this.InputControlsNotLoaded)},_initializeTabs:function(e){var t={model:this.model,reportUri:e.reportUri,parentReportURI:e.parentReportURI};this.tabs.scheduleTab=new n(t),this.tabs.parametersTab=new l(t),this.tabs.outputTab=new d(t),this.tabs.notificationsTab=new h(t)},remove:function(){this.tabs.scheduleTab.remove(),this.tabs.parametersTab.remove(),this.tabs.outputTab.remove(),this.tabs.notificationsTab.remove(),a.View.prototype.remove.apply(this,arguments)},tabChangeClickEvent:function(e){var i=t(e.currentTarget),a=i.attr("data-tab");if(!i.hasClass("disabled")&&this.currentActiveTabName!==a){var r=this;this.model.validateAll(this.editMode).always(function(){var e=r.$el.find("[name="+r.currentActiveTabName+"]").find(".error");e.length||(r.changeActiveTab(a),r.clearAllValidationErrors())})}},openSaveDialogClick:function(){this.startSavingProcess()},cancelJobCreationClick:function(){this.trigger("cancelJobCreation")},renderCreateNewJobInterface:function(){this.editMode=!1,this._render(),this.options.runInBackgroundMode||this.runNowMode?this.changeActiveTab("outputTab"):this.changeActiveTab("scheduleTab"),this.prepareSaveOrSubmitButton()},prepareModelForCreatingNewJob:function(){this.model.clear({silent:!0}),this.model.unset("id"),this.dontReactOnModelChange=!0,this.model.createFromUri(this.options.reportUri),this.dontReactOnModelChange=!1,this.runNowMode&&this.model.set("label","Immediate Execution"),this.model.loadParameters(this.options.parentReportURI||!1)},editExistingJob:function(e){this.editMode=!0;var t=this;this.model.clear({silent:!0}),this._render(),this.changeActiveTab("scheduleTab"),this.model.set({id:e}),this.prepareSaveOrSubmitButton(),this.model._fetched?(this.model.set(this.model.parse(this.model._fetched)),this.setTitle(this.model.get("label")),this.model._fetched=void 0):this.model.fetch({success:function(){t.setTitle(t.model.get("label"))}})},prepareSaveOrSubmitButton:function(){var e=this.$el.find("[name=openSaveDialog]"),i=this.$el.find(".footer #cancel");e.attr("disabled","disabled").addClass("disabled"),i.attr("disabled",null).removeClass("disabled"),this.saveButtonReady=new t.Deferred,this.saveButtonReady.done(function(){e.attr("disabled",null).removeClass("disabled")})},InputControlsLoaded:function(){this.saveButtonReady.resolve()},InputControlsNotLoaded:function(){this.saveButtonReady.resolve(),this.toggleEnableTab("parametersTab",!1)},setRunNowMode:function(e){this.runNowMode=!!e},_render:function(){var e={i18n:r,reportUri:this.options.reportUri,runNowMode:this.runNowMode};this.setElement(t(i.template(c,i.extend({},e)))),this.runNowMode&&this.$el.find("li[data-tab=scheduleTab]").addClass("disabled"),this.tabs.outputTab.options.editMode=this.editMode,this.tabs.scheduleTab.render(),this.tabs.parametersTab.render(),this.tabs.outputTab.render(),this.tabs.notificationsTab.render(),this.$el.find("[name=scheduleTab]").append(this.tabs.scheduleTab.$el),this.$el.find("[name=parametersTab]").append(this.tabs.parametersTab.$el),this.$el.find("[name=outputTab]").append(this.tabs.outputTab.$el),this.$el.find("[name=notificationsTab]").append(this.tabs.notificationsTab.$el),this.currentActiveTabName=""},setTitle:function(e){this.$el.find(".header .title").text(e)},changeActiveTab:function(e){e&&("error"===e&&(e=this.$el.find("[name=tabHolder] > div").find(".error").first().parents(".tab").attr("name")),this.currentActiveTabName!==e&&(this.$el.find("[name=tabs] li").removeClass("selected").filter("[data-tab="+e+"]").addClass("selected"),this.$el.find("[name=tabHolder] > div").addClass("hidden").filter("[name="+e+"]").removeClass("hidden"),this.currentActiveTabName=e))},toggleEnableTab:function(e,t){var i=this.$el.find("[name=tabs] li").filter("[data-tab="+e+"]");i.attr("disabled",!t).toggleClass("disabled",!t),!t&&i.hasClass("selected")&&this.changeActiveTab(i.nextAll(":not(.disabled):first").data("tab"))},sourceKeyInModelChanged:function(e,t){var a;if(this.dontReactOnModelChange!==!0){t.parameters&&(a=1===i.keys(t.parameters.parameterValues).length,a&=!!t.parameters.parameterValues.REPORT_TIME_ZONE);var r=t.parameters&&!a;r||this.saveButtonReady.resolve(),this.toggleEnableTab("parametersTab",r),this.$el.find(".schedule_for").find(".path").text(t.reportUnitURI)}},_prepareSaveDialog:function(){this.saveDialog&&this.saveDialog.remove();var e=this;this.saveDialog=new o(i.extend({},this.options,{model:this.model,isEditMode:this.editMode,onSaveDone:i.bind(this._onSaveDone,this),onSaveFail:i.bind(this._onSaveFail,this)})),this.listenTo(this.saveDialog,"saveValidationFailed",function(){e.saveDialog.closeDialog()})},startSavingProcess:function(){var e=this;this.model.validateAll(this.editMode).done(function(){e._prepareSaveDialog(),e.saveDialog.startSaveDialog()}).fail(function(){e.changeActiveTab("error")})},_onSaveDone:function(){this.trigger("jobHasBeenCreated")},_onSaveFail:function(e,t,a){this.saveDialog.closeDialog();var o=this,n=!1,l=!1,d=!1;try{n=JSON.parse(t.responseText)}catch(h){}if(n.error&&(n=n.error),i.isArray(n)||(n=[n]),i.each(n,function(e){var t="",i="";if("mandatory.parameter.error"===e.errorCode&&(t=r["report.scheduling.saveDialog.parameterIsMissing"],e.parameters&&e.parameters[0]&&(i=e.parameters[0].substr(e.parameters[0].indexOf(".")+1))),"error.duplicate.report.job.output.filename"===e.errorCode&&(i="baseOutputFilename",t=r["error.duplicate.report.job.output.filename"].replace("{0}",e.errorArguments[0]).replace("{1}",e.errorArguments[1])),e.message&&-1!==e.message.indexOf("will never fire")&&(i="triggerWillNeverFire",t=r["error.report.job.trigger.no.fire"]),"error.pattern"===e.errorCode&&("trigger.hours"===e.field&&(i="hours",t=r["error.pattern.trigger.hours"]),"trigger.minutes"===e.field&&(i="minutes",t=r["error.pattern.trigger.minutes"]),"trigger.monthDays"===e.field&&(i="datesInMonth",t=r["error.pattern.trigger.monthDays"]),"contentRepositoryDestination.timestampPattern"===e.field&&(i="timestampPattern",t=r["error.pattern.contentRepositoryDestination.timestampPattern"])),"resource.not.found"===e.errorCode){var a=new s({modal:!0,additionalCssClasses:"schedulerJobRemovedAlertDialog"});return a.setMessage(r["report.scheduling.editing.jobHasBeenRemoved"]),o.listenTo(a,"close",function(){o.trigger("errorEditingJob")}),a.open(),void(l=!0)}""!==t&&(o.showValidationMessage("error",{field:i,message:t}),d=!0)}),l!==!0&&(d&&this.changeActiveTab("error"),d===!1)){var c=r["report.scheduling.editing.failedToSave"]+".";n[0]&&n[0].errorCode?c+="<br/>The reason is: "+n[0].errorCode:n.message&&(c+="<br/>The reason is: "+n.message),c+="<br/><br/>The full response from the server is: "+t.responseText,dialogs.errorPopup.show(c)}},clearAllValidationErrors:function(){this.$el.find(".error").removeClass("error")},validModelListener:function(e){var t=this;i.each(e,function(e){t.showValidationMessage("success",e)})},invalidModelListener:function(e,t){var a=this;i.each(e,function(e){a.showValidationMessage("error",e)}),t&&t.switchToErrors&&a.changeActiveTab("error")},showValidationMessage:function(e,t){if(t.field){"contentRepositoryDestination.folderURI"===t.field&&(t.field="contentRepositoryDestination.outputRepository"),t.field=t.field.replace("trigger.",""),t.field=t.field.replace("mailNotification.",""),t.field=t.field.replace("contentRepositoryDestination.","");var i=this.$el.find(".warning[data-field="+t.field+"]");i.parent().addClass("error"),i.removeClass("success").removeClass("error"),i.addClass(e);var a="";if(t.message)a=t.message;else if(t.errorCode){if(a=r[t.errorCode],!a)return;if(t.errorArguments)for(var s=0,o=t.errorArguments.length;o>s;s++)a=a.replace("{"+s+"}",t.errorArguments[s])}""!==a&&i.text(a)}}})});