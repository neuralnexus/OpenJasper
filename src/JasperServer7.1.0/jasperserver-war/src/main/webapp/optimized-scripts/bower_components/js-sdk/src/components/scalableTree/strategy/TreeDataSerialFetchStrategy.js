define(["require","jquery","underscore","../factory/getParentIdFactory","./trait/wrapResponseStrategyTrait","./trait/omitEmptyResponseStrategyTrait","./trait/injectLevelOptionsStrategyTrait","./trait/invokeFetchFunctionsStrategyTrait","./trait/processResponseStrategyTrait","./trait/constructFetchFunctionsStrategyTrait"],function(t){var e=t("jquery"),n=t("underscore"),i=t("../factory/getParentIdFactory"),r=t("./trait/wrapResponseStrategyTrait"),o=t("./trait/omitEmptyResponseStrategyTrait"),s=t("./trait/injectLevelOptionsStrategyTrait"),c=t("./trait/invokeFetchFunctionsStrategyTrait"),u=t("./trait/processResponseStrategyTrait"),a=t("./trait/constructFetchFunctionsStrategyTrait"),h="\\",p="/",F=function(t){this.initialize(t)};return n.extend(F.prototype,r,o,s,c,a,u,{initialize:function(t){t=t||{};var e=t.escapeCharacter||h,n=t.separator||p;this.getParentId=i.create(e,n),this.fetchFunction=t.fetchFunction,this.isLevelShouldBeFetched=t.isLevelShouldBeFetched||function(){return!0}},fetch:function(t,n){var i=new e.Deferred,r=this,o=this._constructFetchFunctionsGroups(t);return this._invokeFetchFunctionsGroups(o,function(t,e){t=r.wrapResponse(t),r.injectLevelOptions(t,e),t=r.omitEmptyResponse(t),t=r.processResponse(t),n&&n(t)}).done(function(){i.resolve()}),i},_constructFetchFunctionsGroups:function(t){var e=[],i=this.constructFetchFunctions(this.fetchFunction,t);return n.each(t,function(n){var r=n.id,o=this._getFetchFunctionsGroup(r,i,t);e.push(o)},this),e},_getFetchFunctionsGroup:function(t,e,n){for(var i=n.length,r=[],o=[],s=0;i>s;s++){var c=n[s],u=this.getParentId(c.id);t===u&&(o.push(e[s]),r.push(c))}return{functions:o,options:r}},_invokeFetchFunctionsGroups:function(t,n,i,r){var o=this;if(r=r||new e.Deferred,i=i||0,i>=t.length)return void r.resolve();var s=t[i];return s=this._filterFetchFunctionsGroup(s),s.functions.length?e.when.apply(e,this.invokeFetchFunctions(s.functions)).then(function(){var e=Array.prototype.slice.call(arguments,0);n&&n(e,s.options),i+=1,o._invokeFetchFunctionsGroups(t,n,i,r)}):(i+=1,o._invokeFetchFunctionsGroups(t,n,i,r)),r},_filterFetchFunctionsGroup:function(t){var e={functions:[],options:[]};return n.each(t.options,function(n,i){if(this.isLevelShouldBeFetched(n.id)){var r=t.functions[i];e.functions.push(r),e.options.push(n)}},this),e}}),F});