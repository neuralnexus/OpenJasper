define(["require","underscore"],function(e){var t=e("underscore"),i=["pos"],s=function(e){this.initialize(e)};return t.extend(s.prototype,{initialize:function(e){this.viewState=e.viewState,this.treeCache=e.treeCache},getLevelsToFetch:function(e){var i=[],s=this._getPotentialVisibleLevels(e);return t.each(s,function(s){var n,l=t.last(i);l&&e.offset?this._isLevelForFetchVisible(l,e)&&(n=this._calculateOffsetValueOnLevel(s,e)):n=this._calculateOffsetValueOnLevel(s,e),n>=0&&(this._setLevelOffset(s,n),i.push(s))},this),this._omitPrivateProperties(i).reverse()},_calculateOffsetValueOnLevel:function(e,t){var i=0,s=this.treeCache.getGlobalIndex(e.id),n=this.treeCache.getTotalsByLevelId(e.id);if(!n||s>=t.offset)return i;var l=this._calculateTotalOnLevelAboveBuffer(e,t);return i=t.offset-l-s,0>i?0:i},_calculateTotalOnLevelAboveBuffer:function(e,i){var s=this.treeCache,n=i.offset+i.limit;return t.reduce(this.treeCache.getExpandedLevelsWithinGivenLevel(e.id),function(e,t){var i=s.getGlobalIndex(t.id),l=s.getTotalsOnLevel(t.id),a=s.getTotalsByLevelId(t.id);return n>i+l+a?e+a:e+0},0)},_getPotentialVisibleLevels:function(e){for(var t=this.treeCache,i=[],s=e.offset+e.limit,n=this.viewState.getExpandedLevels().reverse(),l=0;l<n.length;l++){var a=n[l],r={},o=t.getTotalsByLevelId(a.id),f=t.getGlobalIndex(a.id),v=t.getTotalsOnLevel(a.id);r.id=a.id,r.pos={start:f,end:f},o?(r.pos.end=o+v+f,r.pos.start<=e.offset&&f+r.pos.end>=e.offset&&this._addPotentialVisibleLevel(i,r),r.pos.start>=e.offset&&r.pos.start<s&&this._addPotentialVisibleLevel(i,r)):this._addPotentialVisibleLevel(i,r)}return i},_addPotentialVisibleLevel:function(e,i){!t.find(e,function(e){return e.id===i.id})&&e.push(i)},_isLevelForFetchVisible:function(e,t){var i=t.offset+t.limit,s=e.pos.start,n=e.pos.end;return s>t.offset||i>n},_setLevelOffset:function(e,t){e.offset=t},_omitPrivateProperties:function(e){return t.map(e,function(e){return t.omit(e,i)})}}),s});