define(["require","jquery","underscore","components/scalableList/model/ListWithSelectionModel","components/scalableList/view/ScalableList"],function(e){"use strict";var t=e("jquery"),s=e("underscore"),i=e("components/scalableList/model/ListWithSelectionModel"),l=e("components/scalableList/view/ScalableList"),o=1,n={LEFT:"left",RIGHT:"right"},h=l.extend({ListModel:i,globalEvents:!0,initialize:function(e){return s.bindAll(this,"onGlobalMouseup","onGlobalMousemove","_autoScroll","fetch"),this.eventListenerPattern=e.eventListenerPattern||"li",this.markerClass=e.markerClass?e.markerClass:"",this.selectedClass=e.selectedClass?e.selectedClass:"jr-isSelected",this._initSelection(e.selection),l.prototype.initialize.call(this,e)},delegateEvents:function(){var e=l.prototype.delegateEvents.apply(this,arguments);return this.$el.on("mousedown",this.eventListenerPattern,s.bind(this.onMousedown,this)).on("mousemove",this.eventListenerPattern,s.bind(this.onMousemove,this)).on("dblclick",this.eventListenerPattern,s.bind(this.onMousedblclick,this)).on("contextmenu",this.eventListenerPattern,s.bind(this.onItemEvent,this,this.$el)).on("mouseout",this.eventListenerPattern,s.bind(this.onItemEvent,this,this.$el)).on("mouseover",this.eventListenerPattern,s.bind(this.onItemEvent,this,this.$el)),!this.globalEvents&&this.$el.on("mouseup",this.eventListenerPattern,this.onGlobalMouseup),e},undelegateEvents:function(){var e=l.prototype.undelegateEvents.apply(this,arguments);return this.$el.off("mouseup").off("mousedown").off("mousemove").off("dblclick").off("contextmenu").off("mouseout").off("mouseover"),e},_initSelection:function(e){e=s.extend({allowed:{}},e);var t=e.allowed,i=s.isObject(t)?t.left:t;this.selection={allowed:{left:"undefined"!=typeof i?i:!0,right:"undefined"!=typeof t.right?t.right:!1},multiple:"undefined"!=typeof e.multiple?e.multiple:!0}},initListeners:function(){l.prototype.initListeners.call(this),this.listenTo(this.model,"selection:clear",this.clearSelection,this),this.listenTo(this.model,"selection:add",this.selectValue,this),this.listenTo(this.model,"selection:addRange",this.selectRange,this),this.listenTo(this.model,"selection:remove",this.deselectValue,this),this.globalEvents&&t("body").on("mouseup",this.onGlobalMouseup).on("mousemove",this.onGlobalMousemove)},postProcessChunkModelItem:function(e,t){l.prototype.postProcessChunkModelItem.call(this,e,t),e.selected=this.model.selectionContains&&this.model.selectionContains(e.value,e.index)},onMousedblclick:function(e){if(!this.selection.multiple&&(this.selection.allowed.left||this.selection.allowed.right)&&!this.getDisabled()){var t=this._getDomItemData(e.currentTarget);this._singleSelect(e,t.value,t.index),this.selectionChanged&&(this._triggerSelectionChanged(),this._triggerDblclicked(),this.selectionChanged=!1)}},getItemByEvent:function(e){return this._getDomItemData(e.currentTarget).item},onItemEvent:function(e,t){var s=t.type,i=this.getItemByEvent(t);this.trigger("list:item:"+s,i,t)},onMousedown:function(e){if(!this.getDisabled()&&(this.selection.allowed.left&&1===e.which||this.selection.allowed.right&&3===e.which)){var t=1===e.which?n.LEFT:n.RIGHT;this.selection.multiple&&(this[t+"MouseButtonPressed"]=!0,this.mouseDownPos=this._getMousePos(e));var s=this._getDomItemData(e.currentTarget);this.selection.multiple?this._multiSelect(e,s.value,s.index):this._singleSelect(e,s.value,s.index)}},onMousemove:function(e){if(this._allowMouseMoveSelection()&&(this._stopAutoScroll(),this._mouseMoved(e,this.mouseDownPos))){this.mouseDownPos=this._getMousePos(e);var t=this._getDomItemData(e.currentTarget);this.model.selectionContains(t.value,t.index)||this.model.addRangeToSelection(t.value,t.index)}},onGlobalMouseup:function(e){var t=this;(this.leftMouseButtonPressed||this.rightMouseButtonPressed)&&(s.each(n,function(e){t[e+"MouseButtonPressed"]=!1}),delete this.mouseDownPos,this._stopAutoScroll(),this.selectionChanged&&(this._triggerSelectionChanged(),this.selectionChanged=!1))},onGlobalMousemove:function(e){this._allowMouseMoveSelection()&&(this.mousePosY=e.clientY,this.scrollInterval||(this.scrollInterval=setInterval(this._autoScroll,this.manualScrollInterval)))},clearSelection:function(){this.$el.find("li."+this.selectedClass+this.markerClass).removeClass(this.selectedClass),this.selectionChanged=!0},selectValue:function(e){this.$el.find("li"+this.markerClass+"[data-index='"+e.index+"']:not(."+this.selectedClass+")").addClass(this.selectedClass),this.selection.multiple?this.selectionChanged=!0:this._triggerSelectionChanged()},selectRange:function(e){var s=this,i=Math.max(this.model.get("bufferStartIndex"),e.start),l=Math.min(this.model.get("bufferEndIndex"),e.end);this.$el.find("li"+this.markerClass+":not(."+this.selectedClass+")").each(function(){var e=t(this),o=parseInt(e.attr("data-index"),10);if(o>=i&&l>=o){var n=s.model.get("items")[o-s.model.get("bufferStartIndex")];s.model.selectionContains(n.value,o)&&e.addClass(s.selectedClass)}}),this.selectionChanged=!0},deselectValue:function(e){this.$el.find("li[data-index='"+e.index+"']."+this.selectedClass+this.markerClass).removeClass(this.selectedClass),this.selection.multiple?this.selectionChanged=!0:this._triggerSelectionChanged()},_autoScroll:function(){var e,t=this.$el.offset().top,s=this.$el.scrollTop(),i="undefined"!=typeof this.scrollTop?this.scrollTop:s,l=!1;this.mousePosY<t?(e=i-3*this.itemHeight,l=s>e):this.mousePosY>t+this.viewPortHeight&&(e=i+3*this.itemHeight,l=e>s),l&&(this.$el.scrollTop(e),this.scrollTop=this.$el.scrollTop(),this._fetchVisibleData()),this._selectRangeOnAutoScroll(i,e)},_selectRangeOnAutoScroll:function(e,t){var s;if(t>e?s=this._getVisibleItems().bottom:e>t&&(s=this._getVisibleItems().top),s){var i=this.model.get("items")[s-this.model.get("bufferStartIndex")];i&&(this.model.selectionContains(i.value,s)||this.model.addRangeToSelection(i.value,s))}},_stopAutoScroll:function(){this.scrollInterval&&(clearInterval(this.scrollInterval),this.scrollInterval=void 0,this.scrollTop=void 0)},_multiSelect:function(e,t,s){e.shiftKey?this.model.addRangeToSelection(t,s):e.ctrlKey||e.metaKey?this._singleSelect(e,t,s):this.model.toggleSelection(t,s)},_singleSelect:function(e,t,s){this.model.clearSelection().addValueToSelection(t,s)},_triggerSelectionChanged:function(){this.trigger("selection:change",this.getValue())},_triggerDblclicked:function(){this.trigger("item:dblclick",this.getValue())},_getDomItemData:function(e){for(var s=t(e),i=s.attr("data-index");void 0===i;)s=s.parent(),i=s.attr("data-index");i=parseInt(i,10);var l=this.model.get("items")[i-this.model.get("bufferStartIndex")];return{item:l,value:l.value,index:i}},_mouseMoved:function(e,t){return Math.abs(t.x-e.clientX)+Math.abs(t.y-e.clientY)>=o},_getMousePos:function(e){return{x:e.clientX,y:e.clientY}},_allowMouseMoveSelection:function(){return(this.selection.allowed.left&&this.leftMouseButtonPressed||this.selection.allowed.right&&this.rightMouseButtonPressed)&&this.selection.multiple&&!this.getDisabled()},getValue:function(){return this.model.getSelection()},setValue:function(e,t){return t=t||{},t&&t.silent||t.modelOptions&&t.modelOptions.silent||this.model.once("selection:change",this._triggerSelectionChanged,this),t=t.modelOptions,this.model.select(e,t),this},selectAll:function(e){return e&&e.silent||this.model.once("selection:change",this._triggerSelectionChanged,this),this.model.selectAll(),this},selectNone:function(e){return this.setValue({},e)},invertSelection:function(e){return e&&e.silent||this.model.once("selection:change",this._triggerSelectionChanged,this),this.model.invertSelection(),this},setDisabled:function(e){return this.disabled=e,this.disabled?this.$el.addClass("disabled"):this.$el.removeClass("disabled"),this},getDisabled:function(){return this.disabled},remove:function(){return t("body").off("mouseup",this.onGlobalMouseup).off("mousemove",this.onGlobalMousemove),l.prototype.remove.call(this)}});return h});