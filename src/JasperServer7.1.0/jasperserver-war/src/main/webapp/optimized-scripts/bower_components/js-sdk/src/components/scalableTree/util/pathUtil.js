define(["require","underscore"],function(e){var n=e("underscore");return{_isDelimiter:function(e){return e%2},split:function(e,t,i,r){i=n.isArray(i)?i:[i],r=n.isUndefined(r)?!0:r;var u=this,c=0,s=0,a=[],l=e.length;return n.each(e,function(r,u){r===t?s+=1:-1!==n.indexOf(i,r)?0!==s&&this._isDelimiter(s)?s=0:(s=0,a.push(e.slice(c,u)),c=u+1):s=0,u+1===l&&a.push(e.slice(c,l))},this),n.map(a,function(e){return r?u.unescape(e,t):e})},unescape:function(e,t){var i=0,r="",u=e.length,c="";return n.each(e,function(n,s){n===t?r+=t:(r.length&&(c+=this._getReplacedSubString(e,r,t,s,i),i=s),r=""),s+1===u&&(c+=r.length?this._getReplacedSubString(e,r,t,s+1,i):e.slice(i,u))},this),c},_getReplacedSubString:function(e,n,t,i,r){var u=this._getReplaceSequence(n,t);return e.slice(r,i).replace(n,u)},_getReplaceSequence:function(e,n){var t;if(e.length%2)t=new Array((e.length-1)/2+1).join(n);else{var i=e.length/2;i=1===i?2:i,t=new Array(i).join(n)}return t},join:function(e,t,i){return n.map(e,function(e){return this.escape(e,t,[t,i])},this).join(i)},escape:function(e,n,t){var i=this._getEscapeRegexp(t);return null===e?"":e.replace(i,function(e){return n+e})},_getEscapeRegexp:function(e){return e=e.toString().replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&").split("\\,"),new RegExp(e.join("|"),"g")}}});