define(["require","underscore","jquery","./TreePlugin","jquery-ui/jquery.ui.draggable"],function(e){"use strict";var t=(e("underscore"),e("jquery")),r=e("./TreePlugin");return e("jquery-ui/jquery.ui.draggable"),r.extend({initialize:function(e){this.tree=e.tree,this.itemsSelectedMessage=e.itemsSelectedMessage||"items selected",this.appendTo=e.appendTo||t("body"),this.dragInProcess=!1,this.onDragStart=e.onDragStart,this.onDrag=e.onDrag,this.onDragStop=e.onDragStop,this.test=e.test||function(){return!0},this._initEvents(),r.prototype.initialize.apply(this,arguments)},beforeItemsRendered:function(){this._destroyDraggable()},_initEvents:function(){this.listenTo(this.tree,"selection:change",this._onTreeSelectionChange),this.listenTo(this.tree,"item:mouseover",this._onTreeItemMouseOver),this.listenTo(this.tree,"item:mouseout",this._onTreeItemMouseOut)},_initDraggable:function(e){var r=this;e.draggable({cursor:"move",appendTo:this.appendTo,cursorAt:{top:0,left:0},helper:function(e){return t('<div class="wrap button draggable dragging dragHelper"></div>')},start:function(e,a){e.originalEvent.preventDefault(),r.dragInProcess=!0;for(var i,n=t(this),s=n.attr("data-index");void 0===s;)n=n.parent(),s=n.attr("data-index");var o=r.tree.getSelection(),g=o.length;i=!r.tree.selection.multiple||1>=g?{items:o[0],label:o[0].label}:{label:g+" "+r.itemsSelectedMessage,items:o},a.helper.text(i.label).data("data",i.items),r.onDragStart&&r.onDragStart(i.items,e)},drag:function(e,t){r.onDrag&&r.onDrag(t.helper.data("data"),e)},stop:function(e,t){r.dragInProcess=!1,r.onDragStop&&r.onDragStop(t.helper.data("data"),e)}}),r.lastDraggableItem=e},_onTreeSelectionChange:function(e){e.length||this._destroyDraggable()},_onTreeItemMouseOver:function(e,r){var a,i=t(r.target),n=i.attr("data-index");this.dragInProcess||(i=this._getItem(i,n),a=i.data("id"),this.test(this.tree.getItem(a))&&this._initDraggable(i))},_onTreeItemMouseOut:function(e,r){var a=t(r.target),i=a.attr("data-index");this.dragInProcess||(a=this._getItem(a,i),this._destroyDraggable(a))},_getItem:function(e,t){for(;void 0===t;)e=e.parent(),t=e.attr("data-index");return e},_destroyDraggable:function(e){e=e||this.lastDraggableItem;try{e&&e.draggable("destroy")}catch(t){}this.lastDraggableItem=null}})});