define(["require","underscore","jquery","./factory/getLevelNestingFactory","./factory/coerceIdsToCommonLevelFactory"],function(e){function t(e){this.treeCache=e.treeCache,this.viewState=e.viewState;var t=e.escapeCharacter||"\\";this.getLevelNesting=i.create(t,n),this.coerceIdsToCommonLevel=a.create(t,n)}var r=e("underscore"),o=e("jquery"),i=e("./factory/getLevelNestingFactory"),a=e("./factory/coerceIdsToCommonLevelFactory"),n="/";return r.extend(t.prototype,{getListItems:function(e,t){var r,i=new o.Deferred;return r=this._convertTreeData(e),t.total=this.treeCache.getTotals(),r=r.slice(t.offset,t.offset+t.limit),i.resolve(r,t)},_convertTreeData:function(e){var t=[];return r.each(e,function(e){var o=e.options.id,i=this.treeCache.getGlobalIndex(o),a=i+e.options.offset;r.each(e.data,function(e,i){var n,c=r.cloneDeep(e);this._setExpandedFlag(c),n=this._getTotalAboveNode(o,c),t[a+n+i]=c},this)},this),t},_setExpandedFlag:function(e){this.viewState.isExpanded(e.id)&&(e.expanded=!0)},_getTotalAboveNode:function(e,t){var o=this,i=this.treeCache.getExpandedLevelsWithinGivenLevel(e);return r.reduce(i,function(e,r){var i,a={firstId:r.id},n=o.getLevelNesting(r.id),c=o.getLevelNesting(t.id);return r.id!==t.id&&(n>c&&(a=o.coerceIdsToCommonLevel(r.id,t.id)),i=o.treeCache.getLevelIndex(a.firstId),i<t.index&&(e+=o.treeCache.getTotalsByLevelId(r.id))),e},0)}}),t});