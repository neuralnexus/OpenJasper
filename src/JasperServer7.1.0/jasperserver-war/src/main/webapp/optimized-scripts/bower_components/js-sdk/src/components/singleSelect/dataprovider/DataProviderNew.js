define(["require","underscore","jquery"],function(e){"use strict";var t=e("underscore"),a=e("jquery"),i=999,r=50,s=50,h="criteria",o=2147483647,l=function(e){t.bindAll(this,"getData"),e=e||{},this.dataCache=[],this.dataCacheTotal=null,this.dataCachePages=[],this.pageSize=e.pageSize||i,this.criteriaKey=e.searchKey||h,this.maxSearchCacheSize=e.maxSearchCacheSize||r,this.getDataByCriteriaHolder={},this.controlGetTotal="undefined"!=typeof e.controlGetTotal?e.controlGetTotal:!1,this.dataConverter=e.dataConverter,this.saveLastCriteria="undefined"!=typeof e.saveLastCriteria?e.saveLastCriteria:!1,this.lastCriteria=null,this.serialRequestsDelay="undefined"!=typeof e.serialRequestsDelay?e.serialRequestsDelay:s,this.serialRequestsDelayedPromise=null,this.request=e.request};return t.extend(l.prototype,{getData:function(e){if(e=e||{},e[this.criteriaKey])return this._getDataByCriteria(e[this.criteriaKey])(e);if("undefined"==typeof e[this.criteriaKey]&&this.saveLastCriteria&&this.lastCriteria)return this._getDataByCriteria(this.lastCriteria)(e);this.lastCriteria=null;var t=a.Deferred(),i=this._getPagesToLoad(e);return i?this._requestData(e,i,t):this._resolveDeferredUsingDataFromCache(t,e),t.promise()},clear:function(){this.dataCache=[],this.dataCacheTotal=null,this.dataCachePages=[],this.getDataByCriteriaHolder={},this.lastCriteria=null},_requestData:function(e,a,i){var r=(a[a.length-1]-a[0]+1)*this.pageSize,s=t.extend({},e,{offset:a[0]*this.pageSize,limit:r});this.controlGetTotal&&(s.skipGetTotal=!0),r>=o/this.pageSize*this.pageSize&&delete s.limit,this.controlGetTotal&&"number"!=typeof this.dataCacheTotal&&delete s.skipGetTotal,this.serialRequestsDelay>0?(clearTimeout(this.deferredTimeout),this.deferredTimeout=setTimeout(t.bind(this._requestDataDeferred,this,e,s,i),this.serialRequestsDelay)):this._requestDataDeferred(e,s,i)},_requestDataDeferred:function(e,a,i){var r=this._getPagesToLoad(e);r?this.serialRequestsDelayedPromise&&t.isEqual(a,this.serialRequestsDelayedPromise.query)?this.serialRequestsDelayedPromise.promise.done(i.resolve).fail(i.reject):(this.serialRequestsDelayedPromise={promise:i.promise(),query:a},this.request(a).done(t.bind(this._requestDone,this,e,a,i)).fail(i.reject)):this._resolveDeferredUsingDataFromCache(i,e)},_requestDone:function(e,t,a,i){this._putDataToCache(t,i),this.serialRequestsDelayedPromise=null,this._resolveDeferredUsingDataFromCache(a,e)},_resolveDeferredUsingDataFromCache:function(e,t){var a=this._getDataFromCache(t);e.resolve({total:this.dataCacheTotal,data:a})},_getPagesToLoad:function(e){var t,a=this._convertLimitOffsetToFirstLast(e),i=this._findPageIndex(a.first),r=this._findPageIndex(a.last),s=[];for(t=i;r>=t;t++)if(!this.dataCachePages[t]){s.push(t);break}for(t=r;t>=i;t--)if(!this.dataCachePages[t]){s.push(t);break}return s.length>0?s:null},_findPageIndex:function(e){return Math.floor(e/this.pageSize)},_convertLimitOffsetToFirstLast:function(e){var t=e&&e.offset?e.offset:0,a=e&&e.limit?t+e.limit-1:this.dataCacheTotal?this.dataCacheTotal-1:o;return this.dataCacheTotal&&a>this.dataCacheTotal-1&&(a=this.dataCacheTotal-1),{first:t,last:a}},_getDataFromCache:function(e){e=t.defaults(e,{offset:0,limit:o});var a=Math.max(0,e.offset),i=Math.min(a+e.limit,this.dataCacheTotal);return this.dataCache.slice(a,i)},_putDataToCache:function(e,t){var a;for("undefined"!=typeof t.total&&(this.dataCacheTotal=t.total),e.limit=e.limit||o,a=0;a<t.data.length;a++)this.dataCache[a+e.offset]=this.dataConverter?this.dataConverter(t.data[a]):t.data[a];var i=e.offset/this.pageSize,r=Math.floor((Math.min(e.limit,t.data.length)+e.offset-1)/this.pageSize);for(a=i;r>=a;a++)this.dataCachePages[a]=!0},_getDataByCriteria:function(e){if(!this.getDataByCriteriaHolder[e]){var t,a=Number.MAX_VALUE,i=0,r=0;for(var s in this.getDataByCriteriaHolder)if(this.getDataByCriteriaHolder.hasOwnProperty(s)){r+=1;var h=this.getDataByCriteriaHolder[s];h.index<a&&(a=h.index,t=s),h.index>i&&(i=h.index)}r>=this.maxSearchCacheSize&&delete this.getDataByCriteriaHolder[t],this.getDataByCriteriaHolder[e]={getData:this._createDataProviderForCriteria(e),index:i+1}}return this.lastCriteria=e,this.getDataByCriteriaHolder[e].getData},_createDataProviderForCriteria:function(e){var a=this.request,i=this,r=new l({pageSize:this.pageSize,dataConverter:this.dataConverter,serialRequestsDelay:this.serialRequestsDelay,searchKey:this.criteriaKey,controlGetTotal:this.controlGetTotal,request:function(r){var s=t.extend({},r);return s[i.criteriaKey]=e,a(s)}}),s=r.getData;return r.getData=function(e){var a=t.extend({},e);return delete a[i.criteriaKey],s.call(r,a)},r.getData}}),l});