define(["require","backbone","underscore","./OptionView"],function(t){"use strict";function e(t){if(!t||o.isEmpty(t))throw new Error("Init options must be specified");if(!t.options||!t.options.length)throw new Error("Option views descriptors must be specified");if(!t.mainTemplate&&!t.el)throw new Error("Option container must have a template");if(!t.optionTemplate)throw new Error("Option container must have an option template")}var i=t("backbone"),o=t("underscore"),n=t("./OptionView");return i.View.extend({el:function(){return o.template(this.template)()},constructor:function(t){e(t),this.contextName=t.contextName||"option",this.contentContainer=t.contentContainer?t.contentContainer:t.el||".content > ul",this.toggle=!!t.toggle,this.toggleClass=t.toggleClass||"active",this.options=[],this.collection=t.collection||new i.Collection,delete t.collection,t.options&&this.collection.reset(t.options),this.hasGroups=this.collection.models[0]&&this.collection.models[0].get("groupId")?!0:!1,this.defalutOptionView=this.hasGroups?this.collection.where({"default":!0}):[this.collection.findWhere({"default":!0})],this.listenTo(this.collection,"select",this._selectOption),this.listenTo(this.collection,"update reset",this.render),this.template=t.mainTemplate,this.optionTemplate=t.optionTemplate,i.View.apply(this,arguments)},setElement:function(t){var e=i.View.prototype.setElement.apply(this,arguments);return this.$contentContainer=this.contentContainer?this.$(this.contentContainer).andSelf().filter(this.contentContainer):this.$el,e},initialize:function(){this.render(),this.toggle&&this.defalutOptionView&&o.each(this.defalutOptionView,function(t){t&&this.getOptionView(t.get("action")).addSelection()},this)},render:function(){var t=this;o.each(this.options,function(e){t.stopListening(e,"mouseover"),t.stopListening(e,"mouseout"),e.remove()}),this.options=[],this.collection.forEach(function(e){var i=new n({template:t.optionTemplate,model:e,toggleClass:t.toggleClass});t.listenTo(i,"mouseover",function(e,i){t.trigger("mouseover",e,t,i)}),t.listenTo(i,"mouseout",function(e,i){t.trigger("mouseout",e,t,i)}),t.options.push(i),t.$contentContainer.append(i.$el)})},_onKeyDown:function(t){var e=this.getOptionView(t.keyCode,"triggerOnKeyCode");e&&!e.isDisabled()&&e.select()},_selectOption:function(t,e){if(this.toggle){var i=e.get("groupId"),n=this.hasGroups?o.where(this.options,function(t){return t.model.get("groupId")===i}):this.options;o.each(n,function(t){t.removeSelection()},this),t.addSelection()}this.trigger("selection",t,e),this.trigger(this.contextName+":"+e.get("action"),t,e)},getOptionView:function(t,e){return o.find(this.options,function(i){return i.model.get(e||"action")===t})},resetSelection:function(t,e){t=t||[],this.toggle&&(this.hasGroups?(t.length<this.defalutOptionView.length&&o.each(this.defalutOptionView,function(e){var i={groupId:e.get("groupId")},n=o.findWhere(t,i);!n&&e&&t.push(o.extend(i,{action:e.get("action")}))}),t=o.pluck(t,"action")):!t.length&&this.defalutOptionView[0]&&t.push(this.defalutOptionView[0].get("action")),o.each(this.options,function(i){t.length&&o.contains(t,i.model.get("action"))?e?this._selectOption(i,i.model):i.addSelection():i.removeSelection()},this))},select:function(){var t=Array.prototype.slice.call(arguments,0);this.toggle&&o.each(this.options,function(e){!t.length||o.contains(t,e.model.get("action"))?e.addSelection():e.removeSelection()},this)},deselect:function(){var t=Array.prototype.slice.call(arguments,0);this.toggle&&o.each(this.options,function(e){(!t.length||o.contains(t,e.model.get("action")))&&e.removeSelection()},this)},getSelection:function(){return o.chain(this.options).filter(function(t){return t.model.get("selected")}).map(function(t){return t.model.get("action")}).value()},show:function(){return o.each(this.options,function(t){var e=t.model.get("test");e&&!e()?t.hide():t[t.model.get("hidden")?"hide":"show"]()}),this.$el.show(),this.trigger("show",this),this},hide:function(){return this.$el.hide(),this.trigger("hide",this),this},enable:function(t){var e=Array.prototype.slice.call(arguments);o.each(this.options,function(t){(!e.length||o.contains(e,t.model.get("action")))&&t.enable()})},disable:function(t){var e=Array.prototype.slice.call(arguments);o.each(this.options,function(t){(!e.length||o.contains(e,t.model.get("action")))&&t.disable()})},addOptions:function(t,e){this.collection.add(t,o.extend(e||{},{silent:!0})),this.collection.reset(this.collection.toJSON())},removeOptions:function(t){var e=this.collection.filter(function(e){return!o.contains(t,e.get("action"))});e.length<this.collection.length&&this.collection.reset(e)},remove:function(){o.invoke(this.options,"remove"),i.View.prototype.remove.apply(this,arguments)}})});