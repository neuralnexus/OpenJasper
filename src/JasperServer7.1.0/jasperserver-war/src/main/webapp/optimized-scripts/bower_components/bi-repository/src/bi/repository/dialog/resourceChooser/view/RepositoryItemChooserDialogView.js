define(["require","underscore","jquery","bundle!all","jrs.configs","common/component/dialog/Dialog","common/component/dialog/AlertDialog","common/component/tree/Tree","common/component/tree/TreeDataLayer","common/component/panel/trait/tabbedPanelTrait","common/component/tree/plugin/SearchPlugin","common/component/tree/plugin/TooltipPlugin","common/component/tree/plugin/InfiniteScrollPlugin","common/component/tree/plugin/NoSearchResultsMessagePlugin","jrs.configs","bi/repository/enum/repositoryResourceTypes","common/util/browserDetection","text!../template/itemDialog/resourceDialogTemplate.htm","text!../template/itemDialog/sidebarTreeLeafTemplate.htm","text!../template/itemDialog/tabPanelButtonTemplate.htm","text!../template/itemDialog/treeTooltipTemplate.htm"],function(e){"use strict";function t(e){switch(e.value.resourceType){case g.REPORT_UNIT:e.cssClass="report";break;case g.DOMAIN_TOPIC:e.cssClass="domain topic";break;case g.SEMANTIC_LAYER_DATA_SOURCE:e.cssClass="domain";break;case g.ADHOC_DATA_VIEW:e.cssClass="adhocDataView";break;case g.OLAP_CUBE:e.cssClass="olap";break;default:e.cssClass="adhocDataView"}return e}var i=e("underscore"),s=e("jquery"),o=e("bundle!all"),r=e("jrs.configs"),n=e("common/component/dialog/Dialog"),l=e("common/component/dialog/AlertDialog"),a=e("common/component/tree/Tree"),c=e("common/component/tree/TreeDataLayer"),h=e("common/component/panel/trait/tabbedPanelTrait"),u=e("common/component/tree/plugin/SearchPlugin"),p=e("common/component/tree/plugin/TooltipPlugin"),d=e("common/component/tree/plugin/InfiniteScrollPlugin"),m=e("common/component/tree/plugin/NoSearchResultsMessagePlugin"),T=e("jrs.configs").contextPath,g=e("bi/repository/enum/repositoryResourceTypes"),f=e("common/util/browserDetection"),_=e("text!../template/itemDialog/resourceDialogTemplate.htm"),b=e("text!../template/itemDialog/sidebarTreeLeafTemplate.htm"),y=e("text!../template/itemDialog/tabPanelButtonTemplate.htm"),D=e("text!../template/itemDialog/treeTooltipTemplate.htm"),C=!1,v=22,R="list",S="tree",w=5e3,L=T+"/rest_v2/api/resources?{{= id != '@fakeRoot' ? 'folderUri=' + id : ''}}",O="&offset={{= offset }}&limit={{= limit }}&forceTotalCount=true&forceFullPage=true",V=L+"&recursive=false&containerType="+g.FOLDER+O,E=L+"&recursive=true"+O,I=T+"/flow.html?_flowId=searchFlow&method=getNode&provider=repositoryExplorerTreeFoldersProvider&uri=/&depth=1";return n.extend({constructor:function(e){e||(e={}),this.options=e,this.options.disableListTab===!0&&(C=!0),this.options.resourcesTypeToSelect&&this.options.resourcesTypeToSelect.length||(this.options.resourcesTypeToSelect=[g.REPORT_UNIT]),this.options.resourcesTypeToSelectTree&&this.options.resourcesTypeToSelectTree.length||(this.options.resourcesTypeToSelectTree=this.options.resourcesTypeToSelect),this._dfdRenderSerachFormTo=s.Deferred();var l={treeNodeProcessor:{processItem:function(e){return e._node=i.contains([g.FOLDER],e.value.resourceType),e}},filterPublicFolderProcessor:{processItem:function(e){return"/public"!==e.value.uri?e:void 0}},filterTempFolderProcessor:{processItem:function(e){return-1===e.value.uri.indexOf("/temp")?e:void 0}},filterEmptyFoldersProcessor:{processItem:function(e){return"folder"!==e.value.resourceType||""!==e.value._links.content?e:void 0}},cssClassItemProcessor:{processItem:e.cssClassItemProcessor||t}};this.resourcesTreeView=a.use(d).use(p,{i18n:o,attachTo:this.$el,contentTemplate:D}).create().instance({type:"tree",itemsTemplate:b,listItemHeight:v,selection:{allowed:!0,multiple:!1},rootless:!0,collapsed:!0,lazyLoad:!0,bufferSize:w,additionalCssClasses:"folders",dataUriTemplate:this.prepareChooserDialogUrl(V,this.options.resourcesTypeToSelectTree),levelDataId:"uri",customDataLayers:{"/":i.extend(new c({dataUriTemplate:I,processors:i.chain(l).omit("filterPublicFolderProcessor").values().value(),getDataArray:function(e){e=JSON.parse(s(e).text());var t=[{id:"@fakeRoot",label:e.label,uri:"/",resourceType:"folder",_links:{content:"@fakeContentLink"}}];if(r.isProVersion){var o=i.find(e.children,function(e){return"/public"===e.uri}).label;t.push({id:"/public",label:o,uri:"/public",resourceType:"folder",_links:{content:"@fakeContentLink"}})}return t}}),{accept:"text/html",dataType:"text"})},processors:i.values(l),getDataArray:function(e,t,i){return e&&e[g.RESOURCE_LOOKUP]?e[g.RESOURCE_LOOKUP]:[]},getDataSize:function(e,t,i){return+i.getResponseHeader("Total-Count")}}),this.resourcesListView=a.use(m).use(p,{i18n:o,attachTo:this.$el,contentTemplate:D}).use(u,{dfdRenderTo:this._dfdRenderSerachFormTo}).create().instance({type:"list",rootLevelHeight:i.bind(this._getContentHeight,this),itemsTemplate:b,listItemHeight:v,selection:{allowed:!0,multiple:!1},rootless:!0,collapsed:!0,lazyLoad:!0,dataUriTemplate:this.prepareChooserDialogUrl(E,this.options.resourcesTypeToSelect),levelDataId:"uri",cache:{searchKey:"searchString",pageSize:100},processors:[l.cssClassItemProcessor,l.filterTempFolderProcessor],getDataArray:function(e,t,i){return e&&e[g.RESOURCE_LOOKUP]?e[g.RESOURCE_LOOKUP]:[]},getDataSize:function(e,t,i){return+i.getResponseHeader("Total-Count")}}),n.prototype.constructor.call(this,{template:_,modal:!0,resizable:!0,additionalCssClasses:"sourceDialogNew"+(C?" listDisabled":""),title:o["Repository.ItemSelectDialog.dialogTitle"],traits:[h],tabHeaderContainerSelector:".tabHeaderContainer",tabContainerClass:"tabContainer control groupBox treeBox",optionTemplate:y,toggleClass:"down",tabs:[{label:o["Repository.ItemSelectDialog.foldersTab"],action:S,content:this.resourcesTreeView,exposeAction:!0,additionalCssClasses:"action square small",i18n:o},{label:o["Repository.ItemSelectDialog.listTab"],action:R,content:this.resourcesListView,exposeAction:!0,additionalCssClasses:"action square small",i18n:o}],buttons:[{label:o["Repository.ItemSelectDialog.okButton"],action:"apply",primary:!0},{label:o["Repository.ItemSelectDialog.cancelButton"],action:"cancel",primary:!1}]})},prepareChooserDialogUrl:function(e,t){return e+"&"+i.map(t,function(e){return"type="+e}).join("&")},initialize:function(e){this.listenTo(this.resourcesTreeView,"selection:change",this._selectionListener),this.listenTo(this.resourcesTreeView,"levelRenderError",this._onLevelRenderError),this.listenTo(this.resourcesTreeView,"item:dblclick",this._onOkButtonClick),this.listenTo(this.resourcesListView,"selection:change",this._selectionListener),this.listenTo(this.resourcesListView,"levelRenderError",this._onLevelRenderError),this.listenTo(this.resourcesListView,"item:dblclick",this._onOkButtonClick),this.listenTo(this.resourcesListView.searchForm,"search",this._onSearch),this.listenTo(this.resourcesListView.searchForm,"clear",this._resetTreeAndList),this.listenTo(this,"button:apply",i.bind(this._onOkButtonClick,this)),this.listenTo(this,"button:cancel",i.bind(this._onCancelButtonClick,this)),this.listenTo(this,"tab:tree tab:list",this._tabChangedEvent),n.prototype.initialize.apply(this,arguments),this._haveBeenOpened=!1,this._isOpened=!1,this.selectedResource=null,this._lastSelectedResource=null},events:{resize:"_onResize"},render:function(){return n.prototype.render.apply(this,arguments),this._dfdRenderSerachFormTo.resolve(this.$tabHeaderContainer),this},open:function(){this._openDialog()},close:function(){this._closeDialog()},remove:function(){this._closeDialog(),this.resourcesTreeView.remove(),this.resourcesListView.remove(),n.prototype.remove.apply(this,arguments)},setDefaultSelectedItem:function(e){this._defaultSelectedItem=e},_onOkButtonClick:function(){this.selectedResource&&(this._closeDialog(),this._lastSelectedResource=this.selectedResource)},_onCancelButtonClick:function(){this.selectedResource=null,this._lastSelectedResource&&(this.selectedResource=this._lastSelectedResource),this._closeDialog()},_openDialog:function(){if(!this._isOpened){var e=this;this._resizableContainerShiftHeight=6-(C?40:0),this._haveBeenOpened===!1?(this._initialDialogWidth=this.$el.css("width"),this._initialDialogHeight=this.$el.css("height"),this._haveBeenOpened=!0):this.$el.css({width:this._initialDialogWidth,height:this._initialDialogHeight}),n.prototype.open.apply(this,arguments);var t=i.bind(function(){this.$contentContainer.find(".tabContainer").css({height:"inherit","overflow-y":"auto"})},this);f.isIE8()||f.isIE9()?setTimeout(t,1):t(),this.$el.children().not(".subcontainer").not(".ui-resizable-e").not(".ui-resizable-se").each(function(){e._resizableContainerShiftHeight+=e.$(this).outerHeight(!0)}),this.$contentContainer.height(this.$el.height()-this._resizableContainerShiftHeight),this.resourcesListView.searchForm.clearSilently(),this._resetTreeAndList(),this.disableButton("apply"),this.resourcesTreeView._onceVisible=new s.Deferred,this.resourcesListView._onceVisible=new s.Deferred,this._preselectItem(),this._openTab(C?S:R),this._isOpened=!0}},_closeDialog:function(){this._isOpened&&(this.resourcesTreeView._onceVisible.reject(),this.resourcesListView._onceVisible.reject(),n.prototype.close.apply(this,arguments),this._isOpened=!1)},_selectionListener:function(e){var t=Object.keys(e),s=e&&(i.isArray(e)||i.isObject(e))&&e[t[0]],o=s?s.uri:void 0,r=s?s.resourceType:void 0;return s||o||r?(r===g.FOLDER?this.$(".itemDescription").empty():this.$(".itemDescription").text(s.description||""),i.contains(i.union([g.FOLDER]),r)?(this.selectedResource=null,void this.disableButton("apply")):(this.selectedResource={resourceUri:o,event:this._getAdHocFlowEvent(r)},void this.enableButton("apply"))):(this.disableButton("apply"),void this.$(".itemDescription").empty())},_resetTreeAndList:function(){this.resourcesTreeView.collapse("@fakeRoot",{silent:!0}),this.resourcesTreeView.collapse("/public",{silent:!0}),this.resourcesTreeView.resetSelection(),this.resourcesListView.resetSelection(),this.$(".itemDescription").empty()},_preselectItem:function(){var e=!1;if(this._lastSelectedResource?e=this._lastSelectedResource.resourceUri:this._defaultSelectedItem&&(e=this._defaultSelectedItem),e){var t=this.resourcesTreeView.$el.parent();this.resourcesTreeView._onceVisible.done(i.bind(function(){this.resourcesTreeView._selectTreeNode(e,t)},this));s(this.resourcesListView.$el.find("div.subcontainer")[0]);this.resourcesListView._onceVisible.done(i.bind(function(){},this))}},_onResize:function(){this.$contentContainer.height(this.$el.height()-this._resizableContainerShiftHeight),this.resourcesListView.rootLevel.list.$el.height(this.$el.height()-this._resizableContainerShiftHeight-6),this.resourcesTreeView.rootLevel.list.$el.css("height","100%")},_getContentHeight:function(){return this.$el.height()-this._resizableContainerShiftHeight-6},_onSearch:function(){this._openTab(R),this.disableButton("apply")},_tabChangedEvent:function(){this.selectedTab===S?this.resourcesTreeView._onceVisible.resolve():this.selectedTab===R&&this.resourcesListView._onceVisible.resolve()},_openTab:function(e){this.openTab.apply(this,arguments)},_getAdHocFlowEvent:function(e){var t="";return e==g.REPORT_UNIT||e==g.DOMAIN_TOPIC?t="startAdHocWithTopic":e==g.SEMANTIC_LAYER_DATA_SOURCE&&(t="startQueryBuilder"),t},_getErrorDialog:function(){return this.errorDialog?this.errorDialog:this.errorDialog=new l},_onLevelRenderError:function(e,t,i){t=JSON.parse(t);var s=this._getErrorDialog();s.setMessage(t.parameters[0].substring(t.parameters[0].indexOf(": ")+2,t.parameters[0].indexOf("\n"))),s.open(),i.$el.removeClass(i.loadingClass).addClass(i.openClass)}})});