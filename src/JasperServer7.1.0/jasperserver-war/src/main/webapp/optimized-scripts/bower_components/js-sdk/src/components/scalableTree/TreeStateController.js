define(["require","underscore"],function(e){function t(e,t,n){a.each(t,function(t){e.getItem(t)&&n&&n(t)})}var a=e("underscore"),n=function(e){this.initialize(e)};return a.extend(n.prototype,{initialize:function(e){this.viewState=e.viewState,this.treeCache=e.treeCache},expand:function(e){var n,i=this.viewState,d=this.treeCache;e=a.isArray(e)?e:[e],t(d,e,function(e){!i.isExpanded(e)&&d.isNode(e)&&(i.addToggledLevel(e),i.markToggledLevelExpanded(e),n=d.calculateGlobalIndex(e),d.setGlobalIndex(e,n),i.markLevelAsRecentlyExpanded(e))})},collapse:function(e){var n,i=this.viewState,d=this.treeCache;e=a.isArray(e)?e:[e],t(d,e,function(e){i.isExpanded(e)&&d.isNode(e)&&(i.markToggledLevelCollapsed(e),n=d.getSummaryTotals(e),d.decrementTotalsOnExpandedLevels(e,n),d.decrementExpandedLevelsGlobalIndexes(e,n))})},select:function(e){this.viewState.selectItems(e)},deselect:function(e){this.viewState.deselectItems(e)},resetSelection:function(e){this.viewState.resetSelection(e)},addItemToCache:function(e){this.treeCache.setLevelIndex(e.id,e.index),this.treeCache.addItemToCache(e.id,e)},updateState:function(e,t){var a=this.treeCache.getTotalsByLevelId(t.id),n=a!==t.total||this.viewState.isLevelRecentlyExpanded(t.id);if(n){var i=this._calculateIndexesAndTotalsDeltaForStateUpdate(t),d=this._shouldIncrementIndexesAndTotals(t);this.treeCache.setTotals(t.id,t.total),d?(this.treeCache.incrementTotalsOnExpandedLevels(t.id,i),this.treeCache.incrementExpandedLevelsGlobalIndexes(t.id,i)):(this.treeCache.decrementTotalsOnExpandedLevels(t.id,i),this.treeCache.decrementExpandedLevelsGlobalIndexes(t.id,i))}this.viewState.removeRecentlyExpandedLevel(t.id)},clearState:function(){this.viewState.clear(),this.treeCache.clear()},_calculateIndexesAndTotalsDeltaForStateUpdate:function(e){var t,n=this.treeCache.getTotalsByLevelId(e.id),i=this.treeCache.getTotalsOnLevel(e.id);return t=a.isUndefined(n)||n===e.total?e.total+i:n>e.total?n-e.total:e.total-n},_shouldIncrementIndexesAndTotals:function(e){var t=!0,n=this.treeCache.getTotalsByLevelId(e.id);return a.isUndefined(n)||n===e.total||n>e.total&&(t=!1),t}}),n});