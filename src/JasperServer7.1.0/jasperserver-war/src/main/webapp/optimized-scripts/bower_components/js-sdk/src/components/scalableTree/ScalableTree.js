define(["require","underscore","jquery","backbone","components/scalableTree/util/pathUtil","components/scalableList/trait/nativeMultiSelectionTrait","components/scalableList/view/ListWithSelection","./factory/listModelFactory","./factory/getLevelNestingFactory","text!./template/defaultItemsTemplate.htm","./processor/paddingProcessor","./processor/valueProcessor","./processor/selectionProcessor","./enum/treeDataFetchStrategyEnum","./factory/treeDataFetchStrategyFactory","./strategy/TreeDataParallelFetchStrategy","./strategy/TreeDataSerialFetchStrategy","./TreeDataConverter","./TreeViewState","./TreeStateController","./TreeCache","./TreeListDataProvider","./TreeLevelsToFetchProvider"],function(e){function t(e){i.each(this.plugins,function(t){t[e]&&t[e]()},this)}var i=e("underscore"),r=e("jquery"),s=e("backbone"),n=e("components/scalableTree/util/pathUtil"),o=e("components/scalableList/trait/nativeMultiSelectionTrait"),a=e("components/scalableList/view/ListWithSelection"),l=e("./factory/listModelFactory"),c=e("./factory/getLevelNestingFactory"),h=e("text!./template/defaultItemsTemplate.htm"),u=e("./processor/paddingProcessor"),d=e("./processor/valueProcessor"),p=e("./processor/selectionProcessor"),g=e("./enum/treeDataFetchStrategyEnum"),f=e("./factory/treeDataFetchStrategyFactory"),S=(e("./strategy/TreeDataParallelFetchStrategy"),e("./strategy/TreeDataSerialFetchStrategy"),e("./TreeDataConverter")),v=e("./TreeViewState"),m=e("./TreeStateController"),C=e("./TreeCache"),_=e("./TreeListDataProvider"),T=e("./TreeLevelsToFetchProvider"),E="/",L="\\",y=5e3,D={SELECT:"select",EXPAND:"expand",COLLAPSE:"collapse",CLEAR_SELECTION:"clearSelection"},P={TREE_INITIALIZED:"treeInitialized",BEFORE_ITEMS_RENDERED:"beforeItemsRendered",ITEMS_RENDERED:"itemsRendered",REMOVE:"treeRemoved"},I={collapser:".jr-jTreeCollapser"},w=s.View.extend({className:"scalableTree",initialize:function(e){e=e||{},this._collapserWasClicked=!1,this.fetchStrategy=e.fetchStrategy||g.PARALLEL_FETCH_STRATEGY,this.lazy=e.lazy||!1,this.processors=e.processors||[],this.nodePadding=i.isUndefined(e.nodePadding)?10:e.nodePadding,this.itemsTemplate=e.itemsTemplate||h,this.listItemHeight=e.listItemHeight,this.selection=e.selection||{},this.collapser=i.isUndefined(e.collapser)?I.collapser:e.collapser,this._initTreeViewState(e),this._initTreeCache(e),this._initTreeLevelsToFetchProvider(e),this._initTreeDataConverter(e),this._initTreeListDataProvider(e),this._initTreeStateController(e),this._initDefaultProcessors(e),this._initList(e),this._initEvents(),this._initPlugins(),this.lazy||this.fetch()},getItem:function(e){return this.treeCache.getItem(e)},isExpanded:function(e){return this.treeViewState.isExpanded(e)},getSelection:function(){var e=this,t=[];return i.each(this.treeViewState.getSelection(),function(i,r){var s=e.treeCache.getItem(r);s&&t.push(s)}),t},expand:function(e,t){this.treeStateController.expand(e,t),this._triggerFetchWithEvent(D.EXPAND,t,e)},expandPath:function(e){var t=this,i=this._getLevelsToExpandByPath(e);i&&this._expandLevels(i).done(function(){t.fetch()})},collapse:function(e,t){this.treeStateController.collapse(e,t),this._triggerFetchWithEvent(D.COLLAPSE,t,e)},select:function(e,t){e=i.isArray(e)?e:[e],t=t||{},this.clearSelection({silent:!0}),this.treeStateController.select(e),this.list.setValue(e,{silent:!0}),!t.silent&&this.trigger(D.SELECT,e)},clearSelection:function(e){e=e||{},this.treeStateController.resetSelection(),this.listModel.clearSelection(),!e.silent&&this.trigger(D.CLEAR_SELECTION)},setElement:function(){return s.View.prototype.setElement.apply(this,arguments),this.list&&this.list.setElement(this.$el),this},render:function(){return this},remove:function(){return t.call(this,P.REMOVE),this.list.remove(),this.processors=[],this.plugins=[],s.View.prototype.remove.apply(this,arguments)},fetch:function(e,t){e=e||{};var i,s=[],n=this,o=r.Deferred();e.clear?(i=this.treeViewState.getExpandedLevels(),e.keepSelection&&(s=this._collectCurrentSelectedItemIds()),this.clearSelection({silent:!0}),this.treeStateController.clearState(),e.keepExpanded?this._expandLevels(i).done(function(){n.treeStateController.select(s),o.resolve()}):(n.treeStateController.select(s),o.resolve())):o.resolve(),o.done(function(){n.list.fetch(t,{keepPosition:!0})})},_getLevelsToExpandByPath:function(e){e=e||"";var t,i=n.split(e,L,E).filter(function(e){return e});return i.length>0&&(t=i.reduce(function(e,t,i){var r,s=e[i-1];return r=s?s.id+E+t:E+t,e.push({id:r}),e},[])),t},_collectCurrentSelectedItemIds:function(){return i.map(this.treeViewState.getSelection(),function(e,t){return t})},_getFetchStrategy:function(e){var t=this;return f(this.fetchStrategy,{fetchFunction:e.getData,escapeCharacter:e.escapeCharacter,isLevelShouldBeFetched:function(e){return"/"===e||t.treeCache.getItem(e)}})},_initTreeViewState:function(e){this.treeViewState=e.treeViewState||new v({escapeCharacter:e.escapeCharacter})},_initTreeCache:function(e){this.treeCache=e.treeCache||new C({viewState:this.treeViewState,escapeCharacter:e.escapeCharacter})},_initTreeLevelsToFetchProvider:function(e){this.treeLevelsToFetchProvider=new T({viewState:this.treeViewState,treeCache:this.treeCache})},_initTreeDataConverter:function(e){this.treeDataConverter=new S({treeCache:this.treeCache,viewState:this.treeViewState,escapeCharacter:e.escapeCharacter})},_initTreeListDataProvider:function(e){var t=this,i=this._getFetchStrategy(e);this.treeListDataProvider=e.treeListDataProvider||new _({processors:this.processors,itemIdGenerationStrategy:e.itemIdGenerationStrategy,escapeCharacter:e.escapeCharacter,fetchStrategy:i,treeDataConverter:this.treeDataConverter,processLevelItem:function(e){t.treeStateController.addItemToCache(e)},onLevelFetched:function(e,i){t.treeStateController.updateState(e,i)},treeLevelsToFetchProvider:this.treeLevelsToFetchProvider})},_initTreeStateController:function(e){this.treeStateController=e.treeStateController||new m({treeCache:this.treeCache,viewState:this.treeViewState})},_initList:function(e){l=e.listModelFactory||l,this.listModel=l.create({bufferSize:e.bufferSize,getData:i.bind(this.treeListDataProvider.getData,this.treeListDataProvider)}),this.selection.multiple&&(a=a.extend(o)),this.list=e.list||new a({el:this.$el,itemsTemplate:this.itemsTemplate,listItemHeight:this.listItemHeight,lazy:!0,selection:this.selection,model:this.listModel,selectedClass:e.selectedClass})},_initEvents:function(){this.listenTo(this.list,"before:render:data",this._onBeforeRenderData),this.listenTo(this.list,"render:data",this._onRenderData),this.listenTo(this.list,"selection:change",this._onListSelectionChange),this.listenTo(this.list,"item:dblclick",this._onItemDblClick),this.listenTo(this.list,"list:item:contextmenu",this._onContextMenu),this.listenTo(this.list,"list:item:click",this._onClick),this.listenTo(this.list,"list:item:mouseover",this._onItemMouseOver),this.listenTo(this.list,"list:item:mouseout",this._onItemMouseOut)},_triggerFetchWithEvent:function(e,t){t=t||{};var i=Array.prototype.slice.call(arguments,2),r=this;!t.silent&&this.fetch(t,function(){i.unshift(e),r.trigger.apply(r,i)})},_onBeforeRenderData:function(){this.trigger("before:render:items"),t.call(this,P.BEFORE_ITEMS_RENDERED)},_onRenderData:function(){this._collapserWasClicked=!1,this.trigger("render:items"),t.call(this,P.ITEMS_RENDERED)},_initDefaultProcessors:function(e){var t=this._getOverriddenPaddingProcessor(e),i=this._getOverriddenSelectionProcessor();this.processors.unshift(i),this.processors.unshift(t),this.processors.unshift(d)},_getOverriddenPaddingProcessor:function(e){var t=c.create(e.escapeCharacter,E);return{processItem:i.partial(u.processItem,t,this.nodePadding)}},_getOverriddenSelectionProcessor:function(){return{processItem:i.partial(p.processItem,this.treeViewState,this.treeStateController)}},_initPlugins:function(){this.plugins=[],i.each(this._plugins,function(e){var r=e.constr;this.plugins.push(new r(i.extend({},{tree:this},e.options))),t.call(this,P.TREE_INITIALIZED)},this)},_onCollapserClick:function(e){this._collapserWasClicked=!0;var t=r(e.target).parents("li").first().data("id");t&&this._toggleLevel(t)},_onListSelectionChange:function(e){this.treeStateController.resetSelection(e),this.trigger("selection:change",this.getSelection())},_onItemDblClick:function(e){var t=e&&e[0];t&&!this._collapserWasClicked&&(this._toggleLevel(t),this.trigger("item:dblclick",this.getSelection()))},_onContextMenu:function(e,t){this.trigger("item:contextmenu",e,t)},_onItemMouseOver:function(e,t){this.trigger("item:mouseover",e,t)},_onItemMouseOut:function(e,t){this.trigger("item:mouseout",e,t)},_isCollapserEventTarget:function(e){return r(e.target).is(this.collapser)},_onClick:function(e,t){this._isCollapserEventTarget(t)&&this._onCollapserClick(t),this.trigger("item:click",e,t)},_toggleLevel:function(e){this.treeViewState.isExpanded(e)?this.collapse(e):this.expand(e)},_expandLevels:function(e){var t=this,i=this.treeListDataProvider.getLevelsOptions(e,{limit:y});return this.treeListDataProvider.fetchTreeLevels(i,function(e,i){t.treeStateController.expand(i.id),t.treeStateController.updateState(e,i)})}},{instance:function(e){return new this(e)}});return{use:function(e,t){return function(e){return{use:function(t,i){return e.prototype._plugins.push({constr:t,options:i}),this},create:function(){return e}}}(w.extend({_plugins:[{constr:e,options:t}]}))},create:function(){return w},Selectors:I}});