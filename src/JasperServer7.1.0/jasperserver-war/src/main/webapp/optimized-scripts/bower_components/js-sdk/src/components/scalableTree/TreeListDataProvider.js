define(["require","underscore","jquery","./strategy/TreeItemIdAutoGenerationStrategy","./util/pathUtil"],function(e){function t(e,t){var n,i;return r.each(this.processors,function(s){n=[],r.each(e,function(e,r){if(i=s.processItem(e,t,r),!i)throw new Error("Processor should return an item");n.push(i)},this),e=n},this),e}var r=e("underscore"),n=e("jquery"),i=e("./strategy/TreeItemIdAutoGenerationStrategy"),s=(e("./util/pathUtil"),"\\"),o=function(e){this.initialize(e)};return r.extend(o.prototype,{initialize:function(e){e=e||{},this.fetchStrategy=e.fetchStrategy,this.treeLevelsToFetchProvider=e.treeLevelsToFetchProvider,this.onLevelFetched=e.onLevelFetched,this.processLevelItem=e.processLevelItem,this.itemIdGenerationStrategy=e.itemIdGenerationStrategy||new i,this.escapeCharacter=e.escapeCharacter||s,this.processors=e.processors,this.treeDataConverter=e.treeDataConverter},getData:function(e){var r=this,i=new n.Deferred,s=this.onLevelFetched,o=this.treeLevelsToFetchProvider.getLevelsToFetch(e),a=this.getLevelsOptions(o,e);return this.fetchTreeLevels(a,s).then(function(t){return r.treeDataConverter.getListItems(t,e)}).then(function(e,n){e=t.call(r,e,n),i.resolve({data:e,total:n.total})}),i},fetchTreeLevels:function(e,t){var r=new n.Deferred,i=this,s=[];return this.fetchStrategy.fetch(e,function(e){s.push.apply(s,e),i._onLevelsFetched(e,t)}).done(function(){r.resolve(s)}),r},getLevelsOptions:function(e,t){return r.map(e,function(e){return{id:e.id,offset:e.offset||0,limit:t.limit}})},_setIdGenerationStrategyInitialIndex:function(e){this.itemIdGenerationStrategy.setInitialIndex&&this.itemIdGenerationStrategy.setInitialIndex(e)},_onLevelsFetched:function(e,t){this.onLevelFetched&&r.each(e,function(e){this._processResponseData(e.data,e.options),t&&t(e.data,e.options)},this)},_processResponseData:function(e,t){var r,n=e.length;for(r=0;n>r;r++){var i=e[r];this._setItemId(i,t),this._setItemIndex(i,r,t),this.processLevelItem&&this.processLevelItem(i)}},_setItemId:function(e,t){var r=t.id,n=this.itemIdGenerationStrategy.getId(e,r);e.id||(e.id=n)},_setItemIndex:function(e,t,r){e.index=t+r.offset}}),o});