define(["require","jquery","underscore","backbone","backbone.validation","jrs.configs","bundle!ImportExportValidationBundle","common/util/i18nMessage","common/model/BaseModel","../model/ResourcesModel","tenantImportExport/export/factory/exportModelAttributesFactory","tenantImportExport/export/enum/exportTypesEnum"],function(e){function t(e){var t,r,s=[];return e.get("everything")?(s.push("everything"),e.get("includeAccessEvents")&&s.push("include-access-events")):(t=n(e)&&e.get("includeRepositoryPermissions")&&!o.isEmpty(e.get("uris")),r=!e.get("includeAttributeValues")||!e.get("includeAttributes"),e.get("userForRoles")&&s.push("role-users"),e.get("rolesForUser")&&s.push("users-roles"),t&&s.push("repository-permissions"),!e.get("includeSubOrganizations")&&s.push("skip-suborganizations"),e.get("includeAttributes")&&s.push("include-attributes"),r&&s.push("skip-attribute-values"),e.get("includeServerSettings")&&s.push("include-server-settings"),(!n(e)||!e.get("includeDependentObjects"))&&s.push("skip-dependent-resources")),e.get("includeAuditEvents")&&s.push("include-audit-events"),e.get("includeMonitoringEvents")&&s.push("include-monitoring-events"),e.get("encryptFile")&&s.push("encrypted"),s}function r(e){var t=[],r=new i.Deferred;return!e.get("everything")&&n(e)?e.resources.fetch().done(function(n){for(var s in v)e.get(s)&&t.push(n[v[s]]);r.resolve(o.flatten(t))}):r.resolve(null),r}function n(e){var t=o.keys(v);return o.filter(t,function(t){return e.get(t)}).length}function s(e){var t=a.organizationsFolderUri||"/organizations",r=a.orgTemplateFolderUri||"/org_template",n=new RegExp("^("+t+"(?!"+r+")/([^/]+))+");return n.exec(e)}var i=e("jquery"),o=e("underscore"),u=e("backbone"),l=e("backbone.validation"),a=e("jrs.configs"),c=e("bundle!ImportExportValidationBundle"),d=e("common/util/i18nMessage").extend({bundle:c}),p=e("common/model/BaseModel"),h=e("../model/ResourcesModel"),g=e("tenantImportExport/export/factory/exportModelAttributesFactory"),m=e("tenantImportExport/export/enum/exportTypesEnum"),f=256,v={includeReports:"report",includeDomains:"domain",includeAdHocViews:"adhocDataView",includeDataSources:"dataSource",includeDashboards:"dashboard",includeOtherResourceFiles:"others"},b=p.extend({defaults:{uris:["/"],fileName:"export.zip",encryptFile:!1,includeRepositoryPermissions:!0,includeScheduledReportJobs:!0,includeDependencies:!0,includeFullResourcePath:!0},validation:{fileName:[{required:!0,msg:new d("export.file.name.empty")},{maxLength:f,msg:new d("export.file.name.too.long",f)},{fn:function(e){return/[\\/?*%:|"<>]/g.test(e)?new d("export.file.name.contains.not.supported.characters"):/^[\.]{1,2}$/g.test(e)?new d("export.file.name.not.valid"):void 0}}],uris:[{fn:function(){var e=this.toExportTask();return!(e.uris||e.roles||e.users||o.filter(e.parameters,function(e){return"role-users"!==e&&"users-roles"!==e}).length)}}]},initialize:function(){p.prototype.initialize.call(this),o.bindAll(this),this.resources=new h},url:function(){return"rest_v2/export"},save:function(){var e=new i.Deferred,t=new u.Model,n=this;t.url=this.url;var s={};return r(this).done(function(r){r&&(s.resourceTypes=r),t.save(o.extend(n.toExportTask(),s)).done(function(t){e.resolve(t)}).fail(function(t){e.reject(t),n.trigger("error",n,t)})}),e},cancel:function(){var e=this.url()+"/"+this.id;this.destroy({url:e})},toExportTask:function(){var e=this.get("everything"),r=this.get("roles"),i=this.get("users"),u=o.clone(this.get("uris")),l=e||this.get("includeReports")&&this.get("includeScheduledReportJobs"),a={uris:u,scheduledJobs:this.get("includeScheduledReportJobs")?u:null,parameters:[]};this.get("includeRepositoryPermissions")&&a.parameters.push("repository-permissions"),!this.get("includeDependencies")&&a.parameters.push("skip-dependent-resources");var c=s(u&&u[0]);c&&!this.get("includeFullResourcePath")&&(a.organization=c.last(),a.parameters.push("skip-suborganizations","skip-attribute-values"),a.uris=o.map(u,function(e){return e.replace(c.first(),"")}),a.scheduledJobs=this.get("includeScheduledReportJobs")?a.uris:null);var d={uris:n(this)?u:null,roles:o.isEmpty(r)?null:r,users:o.isEmpty(i)?null:i,scheduledJobs:l?u:null,organization:this.get("organization"),parameters:t(this)};return this.type!==m.REPOSITORY?d:a},reset:function(e,t){this.type=t;var r=o.extend({},this.defaults,g(t));this.clear().set(o.extend({},r,e))}});return o.extend(b.prototype,l.mixin),b});