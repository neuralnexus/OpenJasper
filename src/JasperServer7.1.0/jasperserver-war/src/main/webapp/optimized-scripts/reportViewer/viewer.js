define(["require","jasperreports-report","jquery","csslink!jive.vm.css","common/util/browserDetection","jquery-ui/jquery.ui.draggable","text!jive.i18n.tmpl"],function(require){var JReport=require("jasperreports-report"),$=require("jquery"),css=require("csslink!jive.vm.css"),browserDetection=require("common/util/browserDetection");require("jquery-ui/jquery.ui.draggable");var jivei18nText=require("text!jive.i18n.tmpl"),jivei18n=JSON.parse(jivei18nText),i18n={get:function(e){return jivei18n.hasOwnProperty(e)?jivei18n[e]:e}},Viewer=function(e){var t=this;if(t.reportInstance=null,t.jive=null,t.isUndoRedo=!1,t.config={at:null,reporturi:null,async:!0,page:0,toolbar:!0},t.dfds={"jive.inactive":null},t.loading=!1,t.loaded=!1,t.search={currentIndex:0,results:[]},t.tabs={maxCount:null,maxLabelLength:null},$.extend(t.config,e),t.container=t._getContainer(),t.hyperlinkHandlers={},t.stateStack.newState(),$("body").on({"jive.initialized":function(e,r){t.jive=r},"jive.inactive":function(){t.dfds["jive.inactive"]&&t.dfds["jive.inactive"].resolve()}}),t.zoomAdhocViewDfd=null,t.features={zoom:{options:[],optionType:"toggle",selectedKeys:["1","fit_actual"],onClick:function(e){t.saveCurrentLevel(),t.processZoomOption(e),"fit_actual"===e||"1"===e?t.features.zoom.selectedKeys=["1","fit_actual"]:t.features.zoom.selectedKeys=[e],t.zoomChanged()},levels:{previous:{value:null,literal:null},current:{value:1,literal:null},dflt:null},containerWidth:$("div#reportContainer").width(),localZoomChange:!1},search:{options:[],optionType:"select",selectedKeys:[],config:{caseSensitive:!1,wholeWordsOnly:!1},onClick:function(e){var r,o=t.features.search.config;o[e]=!o[e],t.features.search.selectedKeys=[];for(r in o)o.hasOwnProperty(r)&&o[r]&&t.features.search.selectedKeys.push(r)}}},$("script#reportZoomText").size()>0&&(t.features.zoom.options=JSON.parse($("script#reportZoomText").html()),$("button#zoom_in").on("click",function(e){t.saveCurrentLevel(),t.zoomIn(),t.zoomChanged()}),$("button#zoom_out").on("click",function(e){t.saveCurrentLevel(),t.zoomOut(),t.zoomChanged()}),$("button#zoom_value_button").on("click",function(e){var r=$(this),o=$("input#zoom_value").offset(),a=t.getOptionsMenu("zoom"),n=a.data("openFor")||"";a.is(":visible")&&"zoom"==n?(a.hide(),a.data("openFor",null)):(a.is(":visible")&&"zoom"!=n&&a.hide(),a.show().offset({left:o.left,top:o.top+r.height()}),a.data("openFor","zoom"))}),$(window).on("resize",function(){var e=t.features.zoom,r=$.extend({},e.levels.current);t.processZoomOption(1),e.containerWidth=$("div#reportContainer").width(),t.processZoomOption(r.literal?r.literal:r.value)})),$("script#reportSearchText").size()>0){t.features.search.options=JSON.parse($("script#reportSearchText").html()),$("input#search_report").on("keyup",function(e){13==e.which&&(this.value.length?t.reportInstance.search({searchString:this.value,caseSensitive:t.features.search.config.caseSensitive,wholeWordsOnly:t.features.search.config.wholeWordsOnly}):dialogs.errorPopup.show("Search string cannot be empty!"))}),$("button#search_report_button").on("click",function(e){$("input#search_report").trigger($.Event("keyup",{which:13}))}),$("button#search_options").on("click",function(e){var r=$(this),o=$("input#search_report").offset(),a=t.getOptionsMenu("search"),n=a.data("openFor")||"";a.is(":visible")&&"search"==n?(a.hide(),a.data("openFor",null)):(a.is(":visible")&&"search"!=n&&a.hide(),a.show().offset({left:o.left,top:o.top+r.height()}),a.data("openFor","search"))});var r=$("button#search_next"),o=$("button#search_previous");r.on("click",function(e){var r,o,a,n=$(".jr_search_result"),s=t.reportInstance.currentpage,i=null,l=0;for(r=0,o=t.search.results.length;o>r;r++)if(s==t.search.results[r].page-1&&(l=t.search.results[r].hitCount),s<t.search.results[r].page-1){i=t.search.results[r].page-1;break}null==i&&(i=t.search.results[0].page-1),t.search.currentIndex<l-1?(n.eq(t.search.currentIndex).removeClass("highlight"),a=n.eq(++t.search.currentIndex),a.addClass("highlight"),t.scrollElementIntoView(a[0]),t.search.currentPage=s):i==s?(n.eq(t.search.currentIndex).removeClass("highlight"),t.search.currentIndex=0,a=n.eq(t.search.currentIndex),a.addClass("highlight"),t.scrollElementIntoView(a[0]),t.search.currentPage=s):(t.disableSearchButtons(),t.reportInstance.gotoPage(i).then(function(e){t.enableSearchButtons();var r=$(".jr_search_result:first");r.addClass("highlight"),t.scrollElementIntoView(r[0]),t.search.currentIndex=0,t.search.currentPage=e.currentpage}))}),o.on("click",function(e){var r,o,a=$(".jr_search_result"),n=t.reportInstance.currentpage,s=null,i=0,l=0;for(r=t.search.results.length-1;r>=0;r--)if(n==t.search.results[r].page-1&&(l=t.search.results[r].hitCount),n>t.search.results[r].page-1){s=t.search.results[r].page-1,i=t.search.results[r].hitCount;break}null==s&&(s=t.search.results[t.search.results.length-1].page-1,i=t.search.results[t.search.results.length-1].hitCount),t.search.currentIndex>0?(a.eq(t.search.currentIndex).removeClass("highlight"),o=a.eq(--t.search.currentIndex),o.addClass("highlight"),t.scrollElementIntoView(o[0]),t.search.currentPage=n):s==n?(a.eq(t.search.currentIndex).removeClass("highlight"),t.search.currentIndex=l-1,o=a.eq(t.search.currentIndex),o.addClass("highlight"),t.scrollElementIntoView(o[0]),t.search.currentPage=n):(t.disableSearchButtons(),t.reportInstance.gotoPage(s).then(function(e){t.enableSearchButtons();var r=$(".jr_search_result:last");r.addClass("highlight"),t.scrollElementIntoView(r[0]),t.search.currentIndex=i-1,t.search.currentPage=e.currentpage}))})}t.bookmarksContainer=null,$("button#bookmarksDialog").on("click",function(){t.bookmarksContainer&&t.bookmarksContainer.show().offset({left:10,top:95})})};return Viewer.privateMethods={prepareBookmarks:function(e){var t,r,o=this,a=$("div#jr_bookmarks");a.length&&a.find(".jrbookmark").size()>0||(a.length||(a=$("<div id='jr_bookmarks' class='panel dialog overlay moveable sizeable' style='width: 250px; height: 600px; z-index: 2000; display: none'><div class='sizer diagonal ui-resizable-handle ui-resizable-se'></div><div class='content hasFooter'><div class='header mover'><div class='closeIcon'></div><div class='title'>"+i18n.get("bookmarks.dialog.title")+"</div></div><div class='body' style='top: 29px; bottom: 24px; padding: 0'></div><div class='footer' style='height: 24px'></div></div></div>").appendTo("body"),a.on("click","a.jrbookmark",function(e){e.preventDefault();var t=$(this),r=t.data("pageindex"),a=t.text();o.reportInstance.currentpage==r?window.location.hash=a:o.reportInstance.gotoPage(r).then(function(){window.location.hash=a})}),a.on("click","div.closeIcon",function(){a.hide()}),a.on("click","b.icon",function(){var e,t=$(this);t.is(".noninteractive")||(e=t.closest("li.subtree"),e.is(".open")?e.removeClass("open").addClass("closed"):e.removeClass("closed").addClass("open"))}),a.draggable({handle:".mover"}),a.resizable({handles:{se:".sizer"}}),o.bookmarksContainer=a),t=a.find(".body"),t.empty(),r="<ul class='list collapsible type_basic'>",$.each(e,function(e,t){r+=o.exportBookmark(t)}),r+="</ul>",t.html(r))},exportBookmark:function(e){var t=this,r="",o="JR_BKMRK_0_"+e.pageIndex+"_"+e.elementAddress,a=e.label||o;return e.bookmarks&&e.bookmarks.length?(r+="<li class='node open subtree'><p class='wrap button'><b class='icon'></b><a href='"+o+"' data-pageindex='"+e.pageIndex+"' class='jrbookmark'>"+a+"</a></p>",r+="<ul class='list collapsible'>",$.each(e.bookmarks,function(e,o){r+=t.exportBookmark(o)}),r+="</ul>"):r+="<li class='leaf'><p class='wrap button'><b class='icon noninteractive'></b><a href='"+o+"' data-pageindex='"+e.pageIndex+"' class='jrbookmark'>"+a+"</a></p>",r+="</li>"},cleanupBookmarks:function(){this.bookmarksContainer&&this.bookmarksContainer.find(".body").empty()},prepareReportParts:function(e,t){var r=this,o=$("div#reportPartsContainer"),a=$("div#reportPartsNavigation"),n="";o.length&&o.find("div.reportPart").size()>0&&!t||(r.initializedPartsContainer||(o.parent().show(),o.on("click","div.reportPart",function(e){e.preventDefault();var t=$(this),a=t.data("pageindex");r.reportInstance.currentpage!=a&&(o.find("div.reportPart.active").removeClass("active"),t.addClass("active"),r.reportInstance.gotoPage(a))}),a.on("click","button#part_prev",function(e){var t,a=o.find("div.reportPart.active"),n=a.prev();n.length||(t=r.getPreviousPart(a),o.find("div.reportPart:last").remove(),n=$(r.exportPart(t)),o.prepend(n)),$(this).prop("disabled",!0),n.trigger("click")}),a.on("click","button#part_next",function(e){var t,a=o.find("div.reportPart.active"),n=a.next();n.length||(t=r.getNextPart(a),o.find("div.reportPart:first").remove(),n=$(r.exportPart(t)),o.append(n)),$(this).prop("disabled",!0),n.trigger("click")}),r.reportPartsContainer=o,r.initializedPartsContainer=!0),o.empty(),r.partsStartIndex=[],$.each(e,function(e,t){e<r.tabs.maxCount&&(n+=r.exportPart(t)),r.partsStartIndex.push(t.idx)}),o.html(n),r.markActiveReportPart())},exportPart:function(e){var t=this,r=e.name;return e.name.length>t.tabs.maxLabelLength&&(r=e.name.substring(0,t.tabs.maxLabelLength)+"..."),"<div class='reportPart' role='button' tabindex='0' js-navtype='button' data-pageindex='"+e.idx+"'><span aria-label='"+r+"'>"+r+"</span></div>"},getNextPart:function(e){var t=this,r=t.getReportParts(),o=t.partsStartIndex.indexOf(e.data("pageindex"));return r[o+1]},getPreviousPart:function(e){var t=this,r=t.getReportParts(),o=t.partsStartIndex.indexOf(e.data("pageindex"));return r[o-1]},getReportParts:function(){var e=this,t=e.reportInstance.components.reportparts[0].config.parts;return e.reportInstance.reportComponents&&e.reportInstance.reportComponents.reportparts&&e.reportInstance.reportComponents.reportparts[0].config.parts.length>t.length&&(t=e.reportInstance.reportComponents.reportparts[0].config.parts),t},markActiveReportPart:function(){var e,t,r,o,a,n=this,s=-1,i=-1,l=n.tabs.maxCount;if(n.reportPartsContainer&&($.each(n.partsStartIndex,function(e,t){n.reportInstance.currentpage>=t&&(s=e,i=t)}),-1!=s)){if(n.reportPartsContainer.find("div.reportPart.active").removeClass("active"),r=n.reportPartsContainer.find("div.reportPart[data-pageindex='"+i+"']"),!r.length){n.reportPartsContainer.empty(),o=n.getReportParts(),a="";var c,u,p,h=0;for(0!==s&&(h=parseInt(parseInt(s/l)*l),p=o.slice(h,h+l),p.length<l&&h-(l-p.length)>0&&(h-=l-p.length)),u=Math.min(o.length,h+l),c=h;u>c;c++)a+=n.exportPart(o[c]);n.reportPartsContainer.html(a),r=n.reportPartsContainer.find("div.reportPart[data-pageindex='"+i+"']")}r.addClass("active"),e=n.reportPartsContainer.parent().find("#part_prev"),t=n.reportPartsContainer.parent().find("#part_next"),0===s?e.prop("disabled",!0):e.prop("disabled",!1),s<n.partsStartIndex.length-1?t.prop("disabled",!1):t.prop("disabled",!0)}},cleanupParts:function(){this.reportPartsContainer&&this.reportPartsContainer.find(".body").empty(),this.partsStartIndex=[]},enableSearchButtons:function(){$("button#search_next").prop("disabled",!1),$("button#search_previous").prop("disabled",!1)},disableSearchButtons:function(){$("button#search_next").prop("disabled",!0),$("button#search_previous").prop("disabled",!0)},resetSearch:function(e){var t=this;t.search={currentIndex:0,results:[]},!e&&$("input#search_report").val(""),$("button#search_next").prop("disabled",!0),$("button#search_previous").prop("disabled",!0)},restoreLastActiveSearchHighlight:function(){var e,t=this;t.search.results.length&&t.reportInstance.currentpage==t.search.currentPage&&(e=$(".jr_search_result"),e.eq(t.search.currentIndex).addClass("highlight"))},getOptionsMenu:function(e){var t,r,o,a,n=this,s=n.features[e],i=s.options,l=$("div#templateElements > div#reportViewerMenuHolder > div#vwroptions > div.menu"),c=!1;for(0===l.size()&&(a="<div id ='reportViewerMenuHolder'><div id='vwroptions'><div class='menu vertical dropDown fitable' style='display: none; z-index: 99999'><div class='content'><ul>",a+="</ul></div></div></div></div>",l=$("div#templateElements").append(a).find("div#vwroptions div.menu"),l.on("mouseleave",function(e){$(this).hide()})),t=l.find("ul"),t.empty(),l.off("click","p"),r=0;r<i.length;r++)o=i[r],o.key.startsWith("fit_")&&!c&&(c=!0,t.append("<li class='leaf separator'></li>")),s.selectedKeys.length&&-1!=$.inArray(o.key,s.selectedKeys)?t.append("<li class='leaf'><p class='wrap toggle button down' data-val='"+o.key+"'><span class='icon'></span>"+o.value+"</p></li>"):t.append("<li class='leaf'><p class='wrap toggle button' data-val='"+o.key+"'><span class='icon'></span>"+o.value+"</p></li>");return l.on("click","p",function(e){var t=$(this),r=t.attr("data-val");"select"==s.optionType?(t.closest("ul").find("p").removeClass("down"),t.addClass("down")):"toggle"==s.optionType&&t.toggleClass("down"),s.onClick.apply(null,[r]),l.hide()}),l},getZoomByValue:function(e){var t,r=this.features.zoom,o=$("div#reportViewFrame div.body:first"),a=$("table.jrPage");if(o.length||(o=$("#reportContainer")),"fit_width"===e)t=r.containerWidth/a.width();else if("fit_height"===e)t=o.height()/a.height();else if("fit_page"===e){var n=o.height(),s=r.containerWidth,i=a.height(),l=a.width();t=Math.min(s/l,n/i)}else t="fit_actual"===e?1:parseFloat(e);return t},processZoomOption:function(e){var t,r,o=this;o.features.zoom.levels;"string"==typeof e?(t=o.getZoomByValue(e),0===e.indexOf("fit_")&&(r=e)):t=e,t=parseFloat(t.toFixed(2)),$("#zoom_value").val((100*t).toFixed(0)+"%"),o.zoomTo(t,r)},propagateZoom:function(e){var t,r,o;this.reportInstance&&this.reportInstance.components&&(t=this.reportInstance.components,$.each(t,function(t,a){a.length>0&&(o=a[0].config.uimodule,require.defined(o)&&(r=require(o),r.zoom&&r.zoom(e)))}))},zoomIn:function(e,t){var r,o=this,a=o.features.zoom.levels.current.value,e=e||.1,n=$("table.jrPage"),s=n.width(),i=s*a,l=o.features.zoom.containerWidth,c={};r=parseFloat((a+e).toFixed(2)),1===r?o.features.zoom.selectedKeys=["1","fit_actual"]:t?o.features.zoom.selectedKeys=[t]:o.features.zoom.selectedKeys=[""+r],l>i&&s*r>l?(n.css("margin-left",0),o.applyScaleTransform(n,r,"0 0"),c.overflow=!0):i>=l?(o.applyScaleTransform(n,r,"0 0"),c.overflow=!0):(o.applyScaleTransform(n,r),c.overflow=!1),c.level=r,t?o.features.zoom.levels.current.literal=t:o.features.zoom.levels.current.literal=null,o.features.zoom.levels.current.value=r,o.reportInstance.zoom=c,$("#zoom_value").val((100*r).toFixed(0)+"%"),o.propagateZoom(c)},zoomOut:function(e,t){var r,o=this,a=o.features.zoom.levels.current.value,e=e||.1,n=$("table.jrPage"),s=n.width(),i=s*a,l=o.features.zoom.containerWidth,c={};r=parseFloat((a-e).toFixed(2)),0>=r&&(r=.1),1===r?o.features.zoom.selectedKeys=["1","fit_actual"]:t?o.features.zoom.selectedKeys=[t]:o.features.zoom.selectedKeys=[""+r],i>l&&l>s*r?(n.css("margin-left","auto"),o.applyScaleTransform(n,r),c.overflow=!1):l>=i?(o.applyScaleTransform(n,r),c.overflow=!1):(o.applyScaleTransform(n,r,"0 0"),c.overflow=!0),c.level=r,t?o.features.zoom.levels.current.literal=t:o.features.zoom.levels.current.literal=null,o.features.zoom.levels.current.value=r,o.reportInstance.zoom=c,$("#zoom_value").val((100*r).toFixed(0)+"%"),o.propagateZoom(c)},zoomTo:function(e,t){var r,o=this,a=o.features.zoom.levels.current.value;e>a?(r=parseFloat((e-a).toFixed(2)),o.zoomIn(r,t)):a>e?(r=parseFloat((a-e).toFixed(2)),o.zoomOut(r,t)):(o.features.zoom.levels.current.literal=t||null,o.reportInstance&&o.reportInstance.zoom&&(o.reportInstance.zoom.level=e),1===e?o.features.zoom.selectedKeys=["1","fit_actual"]:t?o.features.zoom.selectedKeys=[t]:o.features.zoom.selectedKeys=[""+e])},saveCurrentLevel:function(){this.features.zoom.levels.previous.value=this.features.zoom.levels.current.value,this.features.zoom.levels.previous.literal=this.features.zoom.levels.current.literal},zoomChanged:function(){var e=this.features.zoom.levels.current,t=this.features.zoom.levels.previous;(e.value!=t.value||e.literal!=t.literal)&&(this.features.zoom.localZoomChange=!0,this.reportInstance.saveZoom(e.literal||e.value))},applyScaleTransform:function(e,t,r){var o="scale("+t+")",r=r||"50% 0",a={"-webkit-transform":o,"-webkit-transform-origin":r,"-moz-transform":o,"-moz-transform-origin":r,"-ms-transform":o,"-ms-transform-origin":r,"-o-transform":o,"-o-transform-origin":r,transform:o,"transform-origin":r};e.css(a)},scrollElementIntoView:function(e){this.reportInstance.eventManager.triggerEvent("beforeSearchAdvance"),e.scrollIntoView(!1)},render:function(htmlOutput){var it=this,topOfThePageControls=jQuery("#inputControlsForm.topOfPage");topOfThePageControls.length&&topOfThePageControls.detach(),it.container.html(htmlOutput),topOfThePageControls.length&&topOfThePageControls.insertBefore(jQuery("#reportContainer").children()[0]),$("table.jrPage").prop("tabindex",'"0"'),$("table.jrPage").attr("role","grid"),$("table.jrPage tr").attr("role","row"),$("table.jrPage tbody tr").attr("role","row"),$("table.jrPage tr th").attr("role","columnheader"),$("table.jrPage tbody tr th").attr("role","columnheader"),$("table.jrPage tr td").attr("role","gridcell"),$("table.jrPage tbody tr td").attr("role","gridcell");try{var scripts=[];it.container.find("[name='_evalScript']").each(function(){var e=jQuery(this);scripts.push(e.html()),e.remove()}),$.each(scripts,function(i,v){var $=window.$;eval(v),it.reportInstance.loader.jasperPrintName!=Report.jasperPrintName&&(it.reportInstance.loader.jasperPrintName=Report.jasperPrintName)})}catch(ex){alert(ex)}},_getContainer:function(){var e=this.config.at,t=$(e),r="_jr_report_container_";return t.length||(t=$("#"+e),t.length||(t=$("."+e))),!t.hasClass(r)&&t.addClass(r),t},setupEventsForReport:function(e){var t=this;e.on("reportHtmlReady",function(){var r=this.html;t.renderReportLater=!1;var o=r.match(/flowExecutionKeyOutput = ["|'](\w+)["|']/);if(o[1]&&(Report.flowExecutionKeyOutput=o[1]),t.dfds["jive.inactive"]=new $.Deferred,t.jive)if(!t.jive.active||t.isUndoRedo){t.isUndoRedo&&t.jive.hide();var a=$(r).filter(function(){return 1===this.nodeType});t.render(a.removeClass("hidden").html()),$("table.jrPage").css({"margin-left":"auto","margin-right":"auto"}),t.dfds["jive.inactive"].resolve(),$("table.jrPage").prop("tabindex",'"0"'),$("table.jrPage").attr("role","grid"),$("table.jrPage tr").attr("role","row"),$("table.jrPage tbody tr").attr("role","row"),$("table.jrPage tr th").attr("role","columnheader"),$("table.jrPage tbody tr th").attr("role","columnheader"),$("table.jrPage tr td").attr("role","gridcell"),$("table.jrPage tbody tr td").attr("role","gridcell")}else t.renderReportLater=!0;else t.render($(r).removeClass("hidden").html()),$("table.jrPage").css({"margin-left":"auto","margin-right":"auto"}),$("table.jrPage").prop("tabindex",'"0"'),$("table.jrPage").attr("role","grid"),$("table.jrPage tr").attr("role","row"),$("table.jrPage tbody tr").attr("role","row"),$("table.jrPage tr th").attr("role","columnheader"),$("table.jrPage tbody tr th").attr("role","columnheader"),$("table.jrPage tr td").attr("role","gridcell"),$("table.jrPage tbody tr td").attr("role","gridcell"),t.dfds["jive.inactive"].resolve();var n,s=t.features.zoom.levels,i=$.extend({},s.current);t.features.zoom.localZoomChange||null==e.status.defaultZoom||(s.dflt=n=e.status.defaultZoom,isNaN(n)?"string"==typeof n&&0===n.indexOf("fit_")&&(i.literal=n):(i.value=parseFloat(n).toFixed(2),i.literal=null)),s.current.value=1,t.zoomAdhocViewDfd=new $.Deferred,t.zoomAdhocViewDfd.then(function(){t.processZoomOption(i.literal?i.literal:i.value)}),$(r).find("div.highcharts_parent_container").length||t.zoomAdhocViewDfd.resolve(),t.restoreLastActiveSearchHighlight(),!t.tabs.maxCount&&e.status.tabs&&(t.tabs=e.status.tabs),t.markActiveReportPart()}),e.on("beforeAction",function(e){var r=$("div#reportViewFrame .body");r.scrollLeft(0),r.scrollTop(0),e.type&&"search"==e.type||t.resetSearch(),t.cleanupBookmarks(),t.cleanupParts(),this.cancelStatusUpdates(),t.features.zoom.localZoomChange=!1}),e.on("error",function(e){e.data&&e.data.error&&e.data.message&&(console&&console.log&&"function"==typeof console.log&&console.log(e.data.error),dialogs.errorPopup.show(e.data.message)),e.type&&"highchartsInternalError"===e.type&&(buttonManager.disable($("#fileOptions")[0]),buttonManager.disable($("#export")[0]))}),e.on("undo",function(){t.isUndoRedo=!0,t.stateStack.prevState(),t.stateStack.hasNext()&&buttonManager.enable($("#redo")[0]),t.stateStack.hasPrevious()||(buttonManager.disable($("#undo")[0]),buttonManager.disable($("#undoAll")[0])),this.refreshPage(0)}),e.on("redo",function(){t.isUndoRedo=!0,t.stateStack.nextState(),buttonManager.enable($("#undo")[0]),buttonManager.enable($("#undoAll")[0]),t.stateStack.hasNext()||buttonManager.disable($("#redo")[0]),this.refreshPage(0)}),e.on("undoall",function(){t.isUndoRedo=!0,t.stateStack.firstState(),buttonManager.enable($("#redo")[0]),buttonManager.disable($("#undo")[0]),buttonManager.disable($("#undoAll")[0]),this.refreshPage(0)}),e.on("action",function(){t.isUndoRedo=!1,t.stateStack.newState(),buttonManager.enable($("#undo")[0]),buttonManager.enable($("#undoAll")[0]),buttonManager.disable($("#redo")[0]),this.refreshPage(0)}),e.on("search",function(e){var r=e.data;if(t.isUndoRedo=!1,r&&r.result.actionResult.searchResults&&r.result.actionResult.searchResults.length){var o,a,n=r.result.actionResult.searchResults,s=n[0].page-1,i=t.reportInstance.currentpage;for(n.sort(function(e,t){return e.page-t.page}),t.search.results=n,o=0,a=n.length;a>o;o++)if(i==n[o].page-1){s=i;break}this.gotoPage(s).then(function(){var e=$(".jr_search_result:first");e.addClass("highlight"),t.scrollElementIntoView(e[0]),t.search.currentPage=s,n.length>1||1==n.length&&n[0].hitCount>1?($("button#search_next").prop("disabled",!1),$("button#search_previous").prop("disabled",!1)):($("button#search_next").prop("disabled",!0),$("button#search_previous").prop("disabled",!0))})}else r&&r.result.actionResult.searchString&&(dialogs.errorPopup.show('Jaspersoft has finished searching the document. No matches were found for: "'+t.encodeString(r.result.actionResult.searchString)+'"!'),t.resetSearch(!0),this.gotoPage(0))}),e.on("saveZoom",function(){t.isUndoRedo=!1,t.stateStack.newState(),buttonManager.enable($("#undo")[0]),buttonManager.enable($("#undoAll")[0]),buttonManager.disable($("#redo")[0])}),e.on("pageModified",function(){this.gotoPage(this.currentpage)}),e.on("reportFinished",function(){this.status.pageFinal?(t.handleReportBookmarks(this.reportComponents),t.handleReportParts(this.reportComponents),Report.snapshotSaveStatus=this.status.originalStatus.snapshotSaveStatus,Report.lastPageIndex=this.status.originalStatus.lastPageIndex,Report.reportRefreshed()):this.gotoPage(this.currentpage)}),e.on("componentsRegistered",function(){function e(){if(window.location.href.indexOf("viewAsDashboardFrame=true")>-1)try{for(var e,r=parent.jQuery("iframe"),o=0;o<r.length;o++)if(r[o].contentWindow===window){e=r[o];break}if(e)return $(e).parent().height()-i.position().top}catch(a){return $(document).height()?$(document).height()-i.position().top:400}return Math.max(400,t.container.height()-i.position().top)}var r,o=!1,a=t.reportInstance.components,n=[];if(t.loading=!1,t.loaded=!0,$.each(a,function(e,t){t.length>0&&(r=t[0].config.uimodule,r&&n.push(r))}),t.dfds["jive.inactive"].then(function(){t.renderReportLater&&t.render($(t.reportInstance.html).removeClass("hidden").html()),n.length&&require(n,function(){$.each(arguments,function(e,r){r.init(t.reportInstance)})})}),t.reportInstance.components&&t.reportInstance.components.chart&&t.reportInstance.components.chart.length&&"adhocHighchartsSettingService"==t.reportInstance.components.chart[0].config.hcinstancedata.services[0].service){o=!0,t.container.css({position:"absolute",top:0,right:0,bottom:0,left:0});var s=$("table.jrPage"),i=s.find("div.highcharts_parent_container"),l=s.width(),c=i.closest("tr"),u=s.find("tr"),p=u.index(c);i.css({"font-size":"11px"}),s.find("tr:first td").each(function(e,t){var r=$(t);r.css("width",r.width()/l*100+"%")}),c.css("height","100%"),u.each(function(e,t){e>p&&$(t).height(0)}),s.css({width:"100%",height:"100%"}),i.css("height",e()+"px"),delete t.reportInstance.components.chart[0].hcConfig.chart.height,delete t.reportInstance.components.chart[0].hcConfig.chart.width;var h=null;$(window).on("resize",function(){h&&clearTimeout(h),h=setTimeout(function(){$(window).trigger("customResizeEnd")},500)}),$(window).on("customResizeEnd",function(){i.css("height",e()+"px"),$.each(t.reportInstance.components.chart,function(){this.render()})})}if(t.zoomAdhocViewDfd.resolve(),a.chart&&$.each(a.chart,function(){var e=$("#"+this.config.hcinstancedata.renderto).length,r=this;o?e&&t.container.height()&&setTimeout(function(){r.render()},1):e&&setTimeout(function(){r.render()},1)}),a.hyperlinks&&a.hyperlinks.length){var d=a.hyperlinks[0].config.hyperlinks,f={};$.each(d,function(e,t){f[t.type]||(f[t.type]=[]),f[t.type].push(t)}),$.each(f,function(e,r){require(["jr."+e],function(o){var a=new o(r);a.reportInstance=t.reportInstance,a.reportContainer=t.container,a.register(),t.hyperlinkHandlers[e]=a},function(t){var r=t.requireModules&&t.requireModules[0];r&&console&&console.error&&"function"==typeof console.error&&console.error("Failed to load module: '"+r+"' for handling hyperlinks of type: '"+e+"'!")})})}if(t.handleReportParts(a),t.handleReportBookmarks(a),a.webfonts&&a.webfonts.length){var g,v=a.webfonts[0].config.webfonts,m=[],b={paths:{}};$.each(v,function(e,t){g="webfont_"+t.id,m.push("csslink!"+g),b.paths[g]=t.path}),requirejs.config(b),require(m,function(){if(/msie/i.test(navigator.userAgent)){var e=document.querySelectorAll("link.jrWebFont");setTimeout(function(){if(e)for(var t=0;t<e.length;t++)e.item(t).href=e.item(t).href},0)}})}Report.reportRefreshed();try{browserDetection.isIE9()&&window.location.href.indexOf("viewAsDashboardFrame=true")>-1&&a.chart&&setTimeout(function(){$(window).resize()},1)}catch(k){}}),e.on("hyperlinkInteraction",function(e){var r=e.data.hyperlink.type;r&&t.hyperlinkHandlers[r]&&t.hyperlinkHandlers[r].handleInteraction(e)})},handleReportBookmarks:function(e){var t=this;e.bookmarks&&e.bookmarks.length?(t.prepareBookmarks(e.bookmarks[0].config.bookmarks),$("button#bookmarksDialog").show()):($("button#bookmarksDialog").hide(),t.bookmarksContainer&&t.bookmarksContainer.hide())},handleReportParts:function(e){var t=this;if(e.reportparts&&e.reportparts.length){var r=e.reportparts[0].config.parts,o=!0;t.partsStartIndex&&t.partsStartIndex.length==r.length&&(o=!1),t.prepareReportParts(r,o),t.reportPartsContainer&&t.reportPartsContainer.show()}},setLocation:function(e){document.location=e},encodeString:function(e){return $("<div/>").text(e).html()}},Viewer.publicMethods={loadReport:function(){var e=this;return e.loading=!0,e.reportInstance=new JReport({reporturi:e.config.reporturi,async:e.config.async,page:e.config.page,contextPath:e.config.contextPath,postProcess:function(){this.html.indexOf('id="emptyReportMessageHolder"')>0?this.status={isComponentMetadataEmbedded:!1,pageTimestamp:0,totalPages:-1}:(this.loader.jasperPrintName=this.status.jasperPrintName,this.loader.contextid=this.status.contextid)},container:e.container}),e.setupEventsForReport(e.reportInstance),e.reportInstance.init()},exit:function(){var e=new $.Deferred;return e.resolve(),this.reportInstance?this.reportInstance.loader.exit():e}},Viewer.actionStateCounter={stateStack:{counter:0,states:[],position:-1},currentState:function(){return this.stateStack.currentState()}},$.extend(Viewer.actionStateCounter.stateStack,{newState:function(){this.position+2<this.states.length&&this.states.splice(this.position+2,this.states.length-this.position-2),++this.position,++this.counter,this.states[this.position]=this.counter},prevState:function(){this.position>0&&--this.position},firstState:function(){this.position=0},nextState:function(){this.position+1<this.states.length&&++this.position},hasPrevious:function(){return this.position>0},hasNext:function(){return this.position+1<this.states.length},currentState:function(){return this.states[this.position]}}),$.extend(Viewer.prototype,Viewer.privateMethods),$.extend(Viewer.prototype,Viewer.publicMethods),$.extend(Viewer.prototype,Viewer.actionStateCounter),Viewer});