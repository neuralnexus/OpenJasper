define(["require","dataSource/view/dialog/BaseDialog","underscore","jquery","common/transport/AjaxFormSubmitter","components.dialogs","request","bundle!jasperserver_messages","text!dataSource/template/dialog/uploadJdbcDriverDialogTemplate.htm","text!dataSource/template/dialog/fileUploadTemplate.htm","utils.common"],function(e){"use strict";var r=e("dataSource/view/dialog/BaseDialog"),t=e("underscore"),a=e("jquery"),i=e("common/transport/AjaxFormSubmitter"),s=e("components.dialogs"),o=(e("request"),e("bundle!jasperserver_messages")),n=e("text!dataSource/template/dialog/uploadJdbcDriverDialogTemplate.htm"),l=e("text!dataSource/template/dialog/fileUploadTemplate.htm");return e("utils.common"),r.extend({TITLE:o["resource.dataSource.jdbc.selectDriverTitle"],PRIMARY_BUTTON_LABEL:o["button.upload"],SECONDARY_BUTTON_LABEL:o["button.cancel"],events:function(){return t.extend({},r.prototype.events,{"change input[type='file']":"onFileChange"})},initialize:function(e){this.driverClass=e.driverClass,this.driverAvailable=e.driverAvailable,this.fileIndex=0,r.prototype.initialize.apply(this,arguments)},onFileChange:function(e){var r=a(e.target),i=r.next(".message.warning");if(i.parent().removeClass("error"),r.val().match(/.jar$/)){if(r.is(this.$("input[type='file']:last-of-type"))){var s=0,n=this.$("input[type='file']");t.each(n,function(e,r){s+=r+1}),s>=n.length&&this.addFileInput(),this.$("button.primary").removeClass("disabled").attr("disabled",null)}}else i.text(o["resource.dataSource.jdbc.upload.wrongExtension"]).parent().addClass("error")},render:function(){var e=this;return this.$(".body").html(t.template(n,{className:this.driverClass,i18n:o})),t.defer(function(){e.addFileInput(),e.driverAvailable?e.$(".warningMessageContainer").removeClass("hidden").find(".message").text(o["resource.dataSource.jdbc.upload.overwriteWarning"]):e.$(".warningMessageContainer").addClass("hidden").find(".message").text("")}),this.$("button.primary").addClass("disabled").attr("disabled","disabled"),this},onSuccessCallback:function(e){this.trigger("driverUpload",e),this.hide(),s.systemConfirm.show(o["resource.dataSource.jdbc.upload.driverUploadSuccess"]),t.defer(t.bind(this.remove,this))},onErrorCallback:function(e){var r;e=e.responseJSON?e.responseJSON:e,"illegal.parameter.value.error"===e.errorCode&&e.parameters&&e.parameters.length&&"className"===e.parameters[0]?r=o["resource.dataSource.jdbc.classNotFound"].replace("{0}",this.driverClass):e.message?r=e.message:(r=e.errorCode,"error.invalid.response"===r&&(r="The required driver class ("+this.driverClass+") is not found in uploaded files")),this.$(".errorMessageContainer").addClass("error").find(".message").text(r)},addFileInput:function(){this.$("ul").append(t.template(l,{fileIndex:this.fileIndex})),this.fileIndex++},primaryButtonOnClick:function(){this.$(".errorMessageContainer").removeClass("error").find(".message").text("");var e=this.$("form"),r=this;new i(e[0]).submit().done(function(e){e.errorCode?r.onErrorCallback(e):r.onSuccessCallback(e)}).fail(function(e){r.onErrorCallback(e)})},secondaryButtonOnClick:function(){this.hide(),t.defer(t.bind(this.remove,this))}})});