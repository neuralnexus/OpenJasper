define(["require","jquery","underscore","bundle!all","common/enum/javaTypeMapper","dataSource/fileDataSource/enum/javaTypes","jrs.configs","dataSource/fileDataSource/SimpleDomainModel","common/component/dialog/DialogWithModelInputValidation","dataSource/saveDialog/DomainSaveDialogView","text!common/templates/standardConfirm.htm","text!dataSource/fileDataSource/template/simpleDomainDialogTemplate.htm"],function(e){"use strict";var a=e("jquery"),t=e("underscore"),o=e("bundle!all"),i=e("common/enum/javaTypeMapper"),n=e("dataSource/fileDataSource/enum/javaTypes"),l=e("jrs.configs"),s=e("dataSource/fileDataSource/SimpleDomainModel"),r=e("common/component/dialog/DialogWithModelInputValidation"),c=e("dataSource/saveDialog/DomainSaveDialogView"),d=e("text!common/templates/standardConfirm.htm"),u=e("text!dataSource/fileDataSource/template/simpleDomainDialogTemplate.htm");return r.extend({hasChanges:!1,modelIsValid:!0,theDialogIsOpen:!1,constructor:function(e){e||(e={}),this.options=e,this.dataSource=e.dataSource?e.dataSource:{};var a="resource.datasource.createDomain.save",i="resource.datasource.createDomain.cancel";this.model=new s({},e),r.prototype.constructor.call(this,{modal:!0,model:this.model,width:400,additionalCssClasses:"dataSourceCreateNewDomainDialog",title:o["resource.datasource.createDomain.dialogTitle"],content:"",buttons:[{label:o[a],action:"save",primary:!0},{label:o[i],action:"cancel",primary:!1}]}),this.on("button:save",t.bind(this._onSaveButtonClick,this)),this.on("button:cancel",t.bind(this._onCancelButtonClick,this)),this.model.on("validationPassed",t.bind(this.clearValidationErrors,this)),this.model.on("validationFailed",t.bind(this.validationFailed,this))},initialize:function(e){r.prototype.initialize.apply(this,arguments)},updateModelProperty:function(e){var t,i,n=a(e.target),l=n.attr("type"),s=n.attr("name"),r=n.parents("tr").attr("data-fieldId");i="checkbox"===l||"radio"===l?n.is(":checked"):a.trim(n.val()),t=this.model.get("columns"),t[r][s]=i,this.model.set("columns",t),this.model.validate("columns"),this.hasChanges===!1&&this.changeButtonLabel("save",o["resource.datasource.createDomain.applyAndSave"]),this.hasChanges=!0},startDialog:function(){var e=this;this.theDialogIsOpen||(this.bindValidation(),this.model.fetchMetadata(this.dataSource).done(function(){r.prototype.open.apply(e,arguments);var a=t.template(u,{i18n:o,javaTypes:n,columns:e.model.get("columns"),javaTypeMapper:i});e.setContent(a),e._center()}),this.theDialogIsOpen=!0)},fieldIsValid:function(){},fieldIsInvalid:function(e){},clearValidationErrors:function(){this.$el.find(".error").removeClass("error"),this.modelIsValid=!0},validationFailed:function(e){var i=this;this.clearValidationErrors(),this.modelIsValid=!1,t.each(e,function(e){var t=a(i.$el.find("table tr").get(e.rowId+1));t.find("[name="+e.name+"]").parent().addClass("error"),t.find(".message").text(o["resource.datasource.createDomain.validation.missing.label"])})},_closeDialog:function(){this.theDialogIsOpen&&(this.unbindValidation(),this.clearValidationErrors(),r.prototype.close.apply(this,arguments),this.theDialogIsOpen=!1)},_onCancelButtonClick:function(){var e=this,t=o["resource.datasource.createDomain.cancelMessage"],i=a(d);i.find(".body").html(t),dialogs.popupConfirm.show(i.get(0),!0,{okButtonSelector:"[name=buttonOK]",cancelButtonSelector:"[name=buttonCancel]"}).done(function(){e._closeDialog(),e.options.cancel&&e.options.cancel()})},_onSaveButtonClick:function(){this.modelIsValid&&(this._closeDialog(),this.saveDialog=new c(t.extend({},this.options,{model:this.model,success:function(){redirectToUrl(l.contextPath+"/flow.html?_flowId=repositoryConfirmFlow&resourceType=dataSource&resourceType=domain")}})),this.saveDialog.startSaveDialog())}})});