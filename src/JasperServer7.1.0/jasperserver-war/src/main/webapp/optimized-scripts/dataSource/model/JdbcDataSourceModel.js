define(["require","dataSource/model/BaseDataSourceModel","dataSource/model/JdbcDriverModel","dataSource/collection/JdbcDriverCollection","settings!dataSourcePatterns","dataSource/enum/connectionTypes","underscore","jquery","xregexp","bundle!jasperserver_messages","bi/repository/enum/repositoryResourceTypes","bundle!jasperserver_config"],function(e){"use strict";var t=e("dataSource/model/BaseDataSourceModel"),r=e("dataSource/model/JdbcDriverModel"),s=e("dataSource/collection/JdbcDriverCollection"),i=e("settings!dataSourcePatterns"),n=e("dataSource/enum/connectionTypes"),o=e("underscore"),a=e("jquery"),l=e("xregexp"),u=l(i.forbidWhitespacesPattern),c=e("bundle!jasperserver_messages"),d=e("bi/repository/enum/repositoryResourceTypes"),v=e("bundle!jasperserver_config"),h=function(){var e={};return o.extend(e,t.prototype.validation,{connectionUrl:[{required:!0,msg:c["ReportDataSourceValidator.error.not.empty.reportDataSource.connectionUrl"]},{fn:function(e,t,r){var s=this.drivers.getDriverByClass(r.selectedDriverClass).get("allowSpacesInDbName");return s||u.test(e)?void 0:c["ReportDataSourceValidator.error.invalid.chars.reportDataSource.connectionUrl"]}}]}),e}();return t.extend({JDBC_BUNDLE_PREFIX:"resource.dataSource.jdbc.",otherDriverIsPresent:!0,type:d.JDBC_DATA_SOURCE,defaults:function(){var e={};return o.extend(e,t.prototype.defaults,{driverClass:"",selectedDriverClass:"",username:"",password:"",timezone:"",connectionUrl:"",isOtherDriver:!1,connectionType:n.JDBC}),e}(),validation:function(){return o.extend({},h)}(),initialize:function(e,r){t.prototype.initialize.apply(this,arguments),this.initialization=a.Deferred(),this.drivers=new s([],this.options);var i=this;this.fetchDrivers().then(function(){i.isNew()?i.setCustomAttributesDefaultValues(i.drivers.getDefaultDriver()):(i.set("selectedDriverClass",i.get("driverClass")),i.set(i.getCustomAttributeValuesFromConnectionUrl()),i.set("password",v["input.password.substitution"]),i.extendValidation());var e=o.map(i.drivers.getAllPossibleCustomAttributes(),function(e){return"change:"+e}).join(" ");i.on(e,i.setConnectionUrlFromCustomAttributes),i.on("change:connectionUrl",i.setCustomAttributesFromConnectionUrl),i.on("change:selectedDriverClass",i.changeSelectedDriver),i.initialization.resolve()})},fetchDrivers:function(){var e=this;return this.drivers.fetch({reset:!0}).done(function(){var t=o.groupBy(e.drivers.models,function(e){return e.attributes.available});o.each(t,function(e,r){t[r]=o.sortBy(e,function(e){return e.attributes.label})});var s=[];t["true"]&&(s=s.concat(t["true"])),t["false"]&&(s=s.concat(t["false"])),e.drivers.models=s,e.drivers.driverUploadEnabled&&e.otherDriverIsPresent&&e.drivers.add({defaultValues:{},jdbcDriverClass:r.OTHER_DRIVER,label:c["resource.dataSource.jdbc.otherDriver"],available:!1,"default":!1,jdbcUrl:"",uploaded:!1})})},getCurrentDriver:function(){return this.drivers.getDriverByClass(this.get("selectedDriverClass"))},changeSelectedDriver:function(){var e=this.drivers.getDriverByClass(this.get("selectedDriverClass"));e&&(this.setCustomAttributesDefaultValues(e),this.setConnectionUrlFromCustomAttributes(),this.trigger("driverClassChange",this))},setCustomAttributesFromConnectionUrl:function(){var e=this.getCustomAttributeValuesFromConnectionUrl();this.set(e,{silent:!0}),this.trigger("customAttributesUpdate",this)},setConnectionUrlFromCustomAttributes:function(){var e=this.getCurrentDriver(),t=e.getCustomAttributes(),r=this.pick(t),s=this.replaceConnectionUrlTemplatePlaceholdersWithValues(e.get("jdbcUrl"),r);this.set("connectionUrl",s,{silent:!0}),this.trigger("connectionUrlUpdate",this)},getAttributeValueFromUrl:function(e,t){var r=t.exec(e);return[].slice.call(r||[],1)},getCustomAttributeValuesFromConnectionUrl:function(){var e,t=this.getCurrentDriver(),r=this.get("connectionUrl"),s=l(t.convertUrlTemplateToRegex()),i=t.getCustomAttributes(),n={};return e=this.getAttributeValueFromUrl(r,s),o.each(e,function(e,t){n[i[t]]=e}),n},setCustomAttributesDefaultValues:function(e){this.unsetCustomAttributes();var t={};e.isOtherDriver()?(t.selectedDriverClass=e.get("jdbcDriverClass"),t.driverClass="",t.isOtherDriver=!0):(o.extend(t,e.get("defaultValues")),t.selectedDriverClass=e.get("jdbcDriverClass"),t.driverClass=e.get("jdbcDriverClass"),t.isOtherDriver=!1,t.connectionUrl=this.replaceConnectionUrlTemplatePlaceholdersWithValues(e.get("jdbcUrl"),e.get("defaultValues"))),this.set(t,{silent:!0}),this.extendValidation()},unsetCustomAttributes:function(){var e=this;o.each(this.drivers.getAllPossibleCustomAttributes(),function(t){e.unset(t,{silent:!0})})},replaceConnectionUrlTemplatePlaceholdersWithValues:function(e,t){var r=this.getRegExpFieldGroupsFromConnectionUrlTemplate(e);return o.each(r,function(r){e=e.replace(r[0],o.isUndefined(t[r[1]])?"":t[r[1]])}),e},getRegExpFieldGroupsFromConnectionUrlTemplate:function(e){for(var t,s=[];!o.isNull(t=r.FIELD_TEMPLATE_REGEXP.exec(e));)o.isArray(t)&&2===t.length&&s.push(t);return s},extendValidation:function(){var e=this,t={},s=this.getCurrentDriver().getCustomAttributes();o.extend(t,h),o.each(s,function(s){t[s]=[{xRegExpPattern:r.VALIDATION_PATTERNS[s],msg:c[e.JDBC_BUNDLE_PREFIX+"invalidField"].replace("{0}",c[e.JDBC_BUNDLE_PREFIX+s])}]}),this.validation=t},toJSON:function(){var e=t.prototype.toJSON.apply(this,arguments);return this.options.isEditMode&&e.password===v["input.password.substitution"]&&(e.password=null),e}})});