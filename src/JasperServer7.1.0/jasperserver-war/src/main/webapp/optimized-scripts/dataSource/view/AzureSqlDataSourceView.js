define(["require","underscore","common/component/dialog/AlertDialog","dataSource/view/JdbcDataSourceView","dataSource/view/BaseDataSourceView","dataSource/model/AzureSqlDataSourceModel","dataSource/view/dialog/UploadJdbcDriverDialog","dynamicTree.utils","core.events.bis","bundle!jasperserver_messages","bundle!jsexceptions_messages","text!dataSource/template/azureSqlSpecificTemplate.htm","text!common/templates/components.pickers.htm","settings!awsSettings","resource.locate","dataSource/util/settingsUtility"],function(e){"use strict";var t=e("underscore"),r=e("common/component/dialog/AlertDialog"),a=e("dataSource/view/JdbcDataSourceView"),o=e("dataSource/view/BaseDataSourceView"),i=e("dataSource/model/AzureSqlDataSourceModel"),s=(e("dataSource/view/dialog/UploadJdbcDriverDialog"),e("dynamicTree.utils")),n=(e("core.events.bis"),e("bundle!jasperserver_messages")),c=e("bundle!jsexceptions_messages"),d=e("text!dataSource/template/azureSqlSpecificTemplate.htm"),u=e("text!common/templates/components.pickers.htm"),l=(e("settings!awsSettings"),e("resource.locate"));e("dataSource/util/settingsUtility");return a.extend({PAGE_TITLE_NEW_MESSAGE_CODE:"resource.datasource.aws.page.title.new",PAGE_TITLE_EDIT_MESSAGE_CODE:"resource.datasource.aws.page.title.edit",modelConstructor:i,events:function(){var e={};return t.extend(e,a.prototype.events),e["click #updateDatabaseTree"]="updateDatabaseTree",e},initialize:function(e){o.prototype.initialize.apply(this,arguments),this.listenTo(this.model,"change",this.onModelChange)},onModelChange:function(){var e=t.keys(this.model.changedAttributes()),r=["serverName","dbName","connectionUrl"],a=this;t.each(t.intersection(e,r),function(e){a.$("[name='"+e+"']").val(a.model.get(e))})},updateDatabaseTree:function(e){e.preventDefault(),this.showAzureSqlDsTree("/")},render:function(){return this.$el.empty(),this.renderTimezoneSection(),this.renderAzureSqlSpecificSection(),this.renderTestConnectionSection(),this.initDataSourceTree(),this.options.isEditMode&&this.showAzureSqlDsTree(this.model.getFullDbTreePath()),this},showAzureSqlDsTree:function(e){this.model.validate({subscriptionId:this.model.get("subscriptionId"),keyStorePassword:this.model.get("keyStorePassword"),keyStoreUri:this.model.get("keyStoreUri")}),this.model.isValid("keyStorePassword")&&this.model.isValid("subscriptionId")&&this.azureSqlDataSourceTree.showTreePrefetchNodes(e||"/")},renderAzureSqlSpecificSection:function(){this.$el.append(t.template(d,this.templateData())),this.browseButton=l.initialize({i18n:n,template:u,resourceInput:this.$el.find("[name=keyStoreUri]")[0],browseButton:this.$el.find("[name=repositoryBrowserButton]")[0],providerId:"fileResourceBaseTreeDataProvider",dialogTitle:n["resource.Add.Files.Title"],selectLeavesOnly:!0,onChange:t.bind(function(e){this.model.set("keyStoreUri",e),this.model.validate({keyStoreUri:e})},this)})},initDataSourceTree:function(){var e=this.options.isEditMode,t=this,a={hideLoader:!0,bShowRoot:!1,treeId:"azureSqlDataSourceTree",providerId:"azureSqlDataSourceTreeDataProvider",selectLeavesOnly:!0,additionalParams:function(){return{subscriptionId:t.model.get("subscriptionId"),keyStorePassword:t.model.get("keyStorePassword"),keyStoreUri:t.model.get("keyStoreUri"),datasourceUri:t.model.get("uri")}}};this.azureSqlDataSourceTree=s.createRepositoryTree("azureSqlDataSourceTree",a),this.azureSqlDataSourceTree.httpErrorHandler=function(e){var t,a,o=!1,i=["azure.exception.datasource.recovery.public.ip.not.provided","azure.exception.datasource.recovery.firewall.rule.name.not.provided","azure.exception.datasource.recovery.server.name.not.provided","azure.exception.datasource.recovery.subscription.id.not.provided","azure.exception.datasource.recovery.key.store.file.not.provided","azure.exception.datasource.recovery.key.store.type.not.provided","azure.exception.datasource.key.error","azure.exception.datasource.auth.error","azure.exception.datasource.cannot.retrieve.database.list","azure.exception.datasource.cannot.ensure.firewall.rule","azure.exception.datasource.cannot.recover.datasource"];for(a=0;a<i.length;a++){var s=i[a];if(-1!==e.responseText.indexOf(s)){o=c[s];break}}return o?(t=new r({modal:!0}),t.setMessage(o),t.open(),!0):!1},this.azureSqlDataSourceTree.observe("leaf:selected",function(r){var a=r.memo.node.param;if("leaf"===a.type&&!e){var o=a.extra;t.model.set({serverName:o.serverName,dbName:o.dBName,connectionUrlTemplate:o.jdbcTemplate,driverClass:o.jdbcDriver})}}),this.azureSqlDataSourceTree.observe("tree:loaded",function(){t.model.getFullDbTreePath()&&t.azureSqlDataSourceTree.openAndSelectNode(t.model.getFullDbTreePath(),function(){e=!1;var r=t.azureSqlDataSourceTree.getSelectedNode();r&&r.param&&r.param.extra&&t.model.set({connectionUrlTemplate:r.param.extra.jdbcTemplate,dbHost:r.param.extra.dnsAddress,dbPort:r.param.extra.dbPort})})})},remove:function(){this.azureSqlDataSourceTree&&this.azureSqlDataSourceTree.stopObserving(),a.prototype.remove.apply(this,arguments)}})});