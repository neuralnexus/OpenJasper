define(["require","underscore","dataSource/view/BaseDataSourceView","dataSource/model/VirtualDataSourceModel","dataSource/model/SubDataSourceModel","dynamicTree.utils","components.dependent.dialog","common/util/featureDetection","bundle!jasperserver_messages","text!dataSource/template/virtualSpecificTemplate.htm","text!dataSource/template/dialog/dependenciesTemplate.htm","dataSource/view/SubDataSourcesListView"],function(e){"use strict";var t=e("underscore"),a=e("dataSource/view/BaseDataSourceView"),s=e("dataSource/model/VirtualDataSourceModel"),r=e("dataSource/model/SubDataSourceModel"),o=e("dynamicTree.utils"),i=e("components.dependent.dialog"),u=(e("common/util/featureDetection"),e("bundle!jasperserver_messages")),d=e("text!dataSource/template/virtualSpecificTemplate.htm"),c=e("text!dataSource/template/dialog/dependenciesTemplate.htm"),n=e("dataSource/view/SubDataSourcesListView");return a.extend({PAGE_TITLE_NEW_MESSAGE_CODE:"resource.datasource.virtual.page.title.new",PAGE_TITLE_EDIT_MESSAGE_CODE:"resource.datasource.virtual.page.title.edit",hasDependedResources:!1,modelConstructor:s,events:{"keyup input[type='text'][class!='dataSourceID'], textarea":"updateModelProperty","change input[type='text'][class!='dataSourceID'], textarea, select":"updateModelProperty","click [name=toRight]":"chooseTreeNodes","click [name=toLeft]":"removeSelectedSubDataSources","click [name=allToLeft]":"removeAllSubDataSources"},initialize:function(e){this.dependentResources=e.dependentResources,this._subDataSourcesHiddenNodes={},this.dependentResources&&this.dependentResources.length>0&&(this.hasDependedResources=!0),a.prototype.initialize.apply(this,arguments),this.showDependentResources(),this.listenTo(this.model.subDataSources,"reset",this.updateAllToLeftButtonState)},chooseTreeNodes:function(e){e.preventDefault(),this.$("[name=toRight]").attr("disabled","disabled").removeClass("over");var a=this.subDataSourcesTree.selectedNodes,s=t.compact(t.map(a,function(e){return e?new r({name:e.name,id:e.param.id,uri:e.param.uri,readOnly:!1}):null}));this.model.subDataSources.reset(this.model.subDataSources.models.concat(s));var o=t.map(a,function(e){return e.param.uri});this._hideAvailableSubDataSources(o)},removeAllSubDataSources:function(e){if(e.preventDefault(),!this.hasDependedResources){this.subDataSourcesTree._deselectAllNodes();var t=this;this.model.subDataSources.forEach(function(e){t._unhideAvailableSubDataSources(e.get("uri"))}),this.model.subDataSources.reset([]),this.updateRightButtonState()}},removeSelectedSubDataSources:function(e){e.preventDefault(),this.subDataSourcesTree._deselectAllNodes();var a=this.selectedSubDataSourcesList.getSelectedModels(),s=this,r=[];t.each(a,function(e){s._unhideAvailableSubDataSources(e.get("uri"))}),this.model.subDataSources.forEach(function(e){t.include(a,e)||r.push(e)}),this.model.subDataSources.reset(r),this.updateRightButtonState()},updateAllToLeftButtonState:function(){this.hasDependedResources||0===this.selectedSubDataSourcesList.getListLength()?this.$("[name=allToLeft]").attr("disabled","disabled").removeClass("over"):this.$("[name=allToLeft]").removeAttr("disabled")},updateRightButtonState:function(){for(var e=this.$("[name=toRight]"),t=this.subDataSourcesTree.selectedNodes,a=!1,s=!1,r=0;r<t.length;r++){if(t[r].isParent()||this.model.subDataSources.where({uri:t[r].param.uri}).length){s=!0;break}a=!0}a&&!s?e.removeAttr("disabled"):e.attr("disabled","disabled").removeClass("over")},updateLeftButtonState:function(){var e=this.selectedSubDataSourcesList.getSelectedModels(),t=this.$("[name=toLeft]");e.length>0?t.removeAttr("disabled"):t.attr("disabled","disabled").removeClass("over")},render:function(){return this.$el.empty(),this.renderVirtualSpecificSection(),this.updateAllToLeftButtonState(),this},showDependentResources:function(){this.hasDependedResources&&i.show(this.dependentResources,{},{canSave:!1,okOnly:!0,topMessage:u["resource.dataSource.virtual.dependencies.top.message"],bottomMessage:u["resource.dataSource.virtual.dependencies.bottom.message"]})},renderVirtualSpecificSection:function(){var e=this;this.$el.append(t.template(d,this.templateData())),this.$el.append(t.template(c,this.templateData())),this.selectedSubDataSourcesList=new n({collection:this.model.subDataSources}),this.listenTo(this.selectedSubDataSourcesList,"item:unselected item:selected",t.bind(this.updateLeftButtonState,this)),this.selectedSubDataSourcesList.render(),this.subDataSourcesTree=o.createRepositoryTree("subDataSourcesTree",{treeId:"subDataSourcesTree",providerId:"joinableDsTreeDataProvider",selectLeavesOnly:!0,multiSelectEnabled:!0}),this.subDataSourcesTree.observe("leaf:dblclick",t.bind(this.chooseTreeNodes,this)),this.subDataSourcesTree.observe("node:selected",t.bind(this.updateRightButtonState,this)),this.subDataSourcesTree.observe("node:unselected",t.bind(this.updateRightButtonState,this)),this.subDataSourcesTree.observe("leaf:selected",t.bind(this.updateRightButtonState,this)),this.subDataSourcesTree.observe("leaf:unselected",t.bind(this.updateRightButtonState,this));var a=[];this.model.subDataSources.length&&(a=this.model.subDataSources.map(function(e){return e.get("uri")})),this.subDataSourcesTree.showTreePrefetchNodes(a.join(","),function(t){e._hideAvailableSubDataSources(a)})},_hideAvailableSubDataSources:function(e){var a=this;if(t.isArray(e))t.each(e,function(e){a._hideAvailableSubDataSources(e)});else{var s=this.subDataSourcesTree.findLastLoadedNode(e);this._subDataSourcesHiddenNodes[e]={parent:s.parent,child:s};var r=s.parent;r.removeChild(s),r.resortChilds()}},_unhideAvailableSubDataSources:function(e){function a(e,t){e.processNodePath(t,function(t){t.parent&&e.rootNode!=t.parent&&e.getState(t.parent.id)==o.TreeNode.State.CLOSED&&t.parent.handleNode()})}var s=this;if(t.isArray(e))t.each(e,function(e){s._unhideAvailableSubDataSources(e)});else{var r=this._subDataSourcesHiddenNodes[e];r&&(r.parent.addChild(r.child),r.parent.resortChilds(),r.parent.refreshNode(),a(this.subDataSourcesTree,e),r.child.select())}},remove:function(){this.selectedSubDataSourcesList&&this.selectedSubDataSourcesList.remove(),a.prototype.remove.apply(this,arguments)}})});