JRS.Controls=function(t,e,r,s){function n(t){var n;try{try{n=e.parseJSON(t.responseText)}catch(o){}if(n&&n.error)r.each(n.error,function(t){var e=s.getViewModel(),r=t.inputControlUri.replace("repo:",""),n=e.find({uri:r});t.errorCode?n.set({error:t.errorCode}):t.defaultMessage&&n.set({error:t.defaultMessage})});else if(t.getResponseHeader("LoginRequested")||401===t.status)document.location=__jrsConfigs__.urlContext;else if(500==t.status||t.getResponseHeader("JasperServerError")&&!t.getResponseHeader("SuppressError")){var i="";i=n?Mustache.to_html("<div><b>{{message}}</b></div><p>{{#parameters}}<div>{{.}}</div>{{/parameters}}</p>",n):statusText,dialogs.errorPopup.show(i)}}catch(o){}}return r.extend(s,{DataTransfer:s.Base.extend({CONTROLS_STRUCTURE_TEMPLATE_URI:__jrsConfigs__.contextPath+"/rest_v2/reports{{reportUri}}/inputControls/{{controlIds}}",INITIAL_CONTROLS_VALUES_TEMPLATE_URL:__jrsConfigs__.contextPath+"/rest_v2/reports{{reportUri}}/inputControls/values",CONTROLS_VALUES_TEMPLATE_URL:__jrsConfigs__.contextPath+"/rest_v2/reports{{reportUri}}/inputControls/{{controlIds}}/values",constructor:function(t){this.dataConverter=t.dataConverter,this.initialize(t)},initialize:function(t){},setReportUri:function(t){this.currentReportUri=t},buildUrl:function(t,e,n){return e=r.isArray(e)?e.join(";"):e||"",s.TemplateEngine.renderUrl(n,{reportUri:t,controlIds:e})},sendRequest:function(s,o,i){var a={url:s,type:"GET",dataType:"json",cache:!1};r.isEmpty(o)||r.extend(a,{type:"POST",processData:!1,data:t.stringify(o),contentType:"application/json"});var u=r.defaults(i||{},a);return u.headers||(u.headers={}),r.defaults(u.headers,{"X-Suppress-Basic":"true","Accept-Language":__jrsConfigs__.userLocale.replace(/_/g,"-")}),e.ajax(u).fail(n)},fetchControlsStructure:function(t,e){var n=this.buildUrl(this.currentReportUri,t,this.CONTROLS_STRUCTURE_TEMPLATE_URI),o=this.sendRequest(n,e).then(r.bind(this.dataConverter.structureFormater,this.dataConverter));return s.Utils.showLoadingDialogOn(o,null,!0),o},updateControlsStructure:function(t,e){var s=this.buildUrl(e||this.currentReportUri,null,this.CONTROLS_STRUCTURE_TEMPLATE_URI);return this.sendRequest(s,t,{type:"PUT"}).then(r.bind(this.dataConverter.structureFormater,this.dataConverter))},fetchInitialControlValues:function(t,e){var r=this.buildUrl(t,null,this.INITIAL_CONTROLS_VALUES_TEMPLATE_URL),n=this.sendRequest(r,e).then(this.dataConverter.convertResponseToControlsState);return s.Utils.showLoadingDialogOn(n,null,!0),n},fetchControlsUpdatedValues:function(t,n){var o=this.buildUrl(this.currentReportUri,t,this.CONTROLS_VALUES_TEMPLATE_URL),i=this.dataConverter;this.fullUpdateDeferred&&"pending"==this.fullUpdateDeferred.state()&&this.fullUpdateDeferred.reject();var a=new e.Deferred,u=s.Utils.wait(s.DataTransfer.FREQUENT_CHANGES_MIN_DELAY);return u.done(r.bind(function(){this.sendRequest(o,n).then(i.convertResponseToControlsState).done(function(t){"pending"==a.state()&&a.resolve(t)}).fail(function(){a.reject(this,arguments)})},this)),a.fail(function(){u.reject()}),s.Utils.showLoadingDialogOn(a,null,!0),this.fullUpdateDeferred=a,a}},{CONTROLS_STRUCTURE_TEMPLATE_URI:__jrsConfigs__.contextPath+"/rest_v2/reports{{reportUri}}/inputControls/{{controlIds}}",INITIAL_CONTROLS_VALUES_TEMPLATE_URL:__jrsConfigs__.contextPath+"/rest_v2/reports{{reportUri}}/inputControls/values",CONTROLS_VALUES_TEMPLATE_URL:__jrsConfigs__.contextPath+"/rest_v2/reports{{reportUri}}/inputControls/{{controlIds}}/values",FREQUENT_CHANGES_MIN_DELAY:400})})}(JSON,jQuery,_,JRS.Controls);