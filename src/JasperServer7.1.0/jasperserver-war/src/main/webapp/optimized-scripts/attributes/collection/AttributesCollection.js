define(["require","underscore","jquery","backbone","request","components.templateengine","serverSettingsCommon/enum/serverSettingGroupsEnum","attributes/enum/levelIdEnum"],function(e){var t=e("underscore"),n=e("jquery"),r=e("backbone"),i=e("request"),a=e("components.templateengine"),s=e("serverSettingsCommon/enum/serverSettingGroupsEnum"),o=e("attributes/enum/levelIdEnum"),u={TENANT:"tenant:/",USER:"user:/"},c=r.Collection.extend({initialize:function(e,t){t=t||{};var n="rest_v2/attributes?_embedded=permission",r=n+"&group="+s.CUSTOM,i=t.context||{};this.urlGETTemplate=i.urlGETTemplate||r,this.urlPUTTemplate=i.urlPUTTemplate||n},parse:function(e){return e&&e.attribute?e.attribute:[]},setContext:function(e,r){e=e||{urlGETTemplate:this.urlGETTemplate,urlPUTTemplate:this.urlPUTTemplate};var i=new n.Deferred;return t.isEqual(this.context,e)&&!r?i.resolve():(this.context=e,this.fetch({cache:!1,reset:!0,headers:{Accept:"application/attributes.collection.hal+json"}}).done(i.resolve)),i},getContext:function(){return this.context},url:function(e){var n=t.extend({},this.context),r="PUT"===e?this.urlPUTTemplate:this.urlGETTemplate;return t.each(o,function(e){n[e]&&(n[e]=this.escapeLevelId(n[e]))},this),a.renderUrl(r,n,!1)},escapeLevelId:function(e){return encodeURIComponent(e).replace(/'/g,"%27")},save:function(e,t){var n="PUT",r=this._modelsToJSON(t,!0),a="application/hal+json";return i({url:this.url(n)+this._concatNames(e),type:"PUT",cache:!1,contentType:a,headers:{Accept:a},data:JSON.stringify({attribute:r})})},validateSearch:function(e,n,r,i){var a="&recursive=true",s=i&&this._concatGroups();return this.search(e,n,a,r,s).done(t.bind(this._successSearchCallback,this,e,n))},filterInheritedAttributes:function(e){var n=e&&e.attribute;return e?t.filter(n,function(e){return e.inherited&&!this.findWhere({name:e.name,inherited:!0})},this):null},search:function(e,t,n,r,a){n=n||"",a=a||"";var s="application/attributes.collection.hal+json";return i({url:this.url()+this._concatNames(e,r)+n+a,type:"GET",dataType:"json",cache:!1,contentType:s,headers:{Accept:s}})},getHolder:function(){return this.context.id?u.TENANT+this.context.id:this.context.tenantId?u.USER+this.context.tenantId+"/"+this.context.userName:u.TENANT},addItemsToCollection:function(e){!t.isArray(e)&&(e=[e]),t.each(e,function(e){this.addNew(e)},this)},addNew:function(e){e=e||{};var t=new this.model(e);return this.add(t),t},_modelsToJSON:function(e,n){return t.map(e,function(e){return e.toJSON({omitValue:n})})},_successSearchCallback:function(e,n,r){e=t.isArray(e)?e:[e],n=this._modelsToJSON(n);var i,a,s=this.getHolder();t.each(e,function(e){a=s?s:e.holder,e.holder=a,r&&r.attribute.length&&(e.attr=r.attribute),n&&t.where(n,{name:e.get("name"),inherited:!1}).length>1&&(i={holder:a},e.attr?e.attr.push(i):e.attr=[i])},this)},_concatGroups:function(){var e="";return t.each(t.omit(s,"CUSTOM"),function(t){e+="&group="+t}),e},_concatNames:function(e,n){e=t.isArray(e)?e:[e];var r,i="",a=this,s=function(e){return"&name="+a.escapeLevelId(e)};return t.each(e,function(e){r=e.get("id"),!n&&e.isRenamed()&&r&&(i+=s(r)),i+=s(e.get("name"))},this),i}});return c});