define(["require","underscore","jquery","backbone","bundle!AttributesBundle","serverSettingsCommon/enum/confirmDialogTypesEnum","attributes/enum/attributesTypesEnum","attributes/enum/permissionMasksEnum","attributes/factory/confirmationDialogFactory","attributes/factory/tableTemplatesFactory","attributes/factory/errorFactory","attributes/view/AttributesViewer","common/component/notification/Notification","common/component/dialog/AlertDialog"],function(e){var t=e("underscore"),i=e("jquery"),n=e("backbone"),s=e("bundle!AttributesBundle"),o=e("serverSettingsCommon/enum/confirmDialogTypesEnum"),r=e("attributes/enum/attributesTypesEnum"),a=(e("attributes/enum/permissionMasksEnum"),e("attributes/factory/confirmationDialogFactory")),d=e("attributes/factory/tableTemplatesFactory"),l=e("attributes/factory/errorFactory"),h=e("attributes/view/AttributesViewer"),c=e("common/component/notification/Notification"),u=e("common/component/dialog/AlertDialog"),f=h.extend({className:"attributesDesigner",ui:{addNewBtn:".addNewItem"},events:{"click @ui.addNewBtn":"_addNewChildView","mousedown .filterItems, .actions.table-column button, .permission.table-column select, .secure.table-column input":"_checkCurrentAttribute","focus .filterItems, .actions.table-column button, .permission.table-column select, .secure.table-column input":"_checkCurrentAttribute"},childEvents:{active:"_activeChildView",changed:"_saveChildViewToChangedList","open:confirm":"_openConfirm",validate:"_validateChildView"},initialize:function(e){e=e||{};var i={type:e.type};this.notification=new c,this.alertDialog=new u,this.model=new n.Model,this.changedModels=[],this.overriddenInheritedModels=[],h.prototype.initialize.apply(this,arguments),this.childViewOptions=t.extend({},e.childViewOptions,i),this.emptyViewOptions=t.extend({},e.emptyViewOptions,i),this._initConfirmationDialogs(),this._initFilters&&this._initFilters(e),!t.isEmpty(e.buttons)&&e.buttonsContainer&&this._initButtons&&this._initButtons(e),this._initEvents()},render:function(e){return h.prototype.render.apply(this,arguments),this._renderFilters&&this._renderFilters(e),this},hide:function(){this._resetFilters&&this._resetFilters(),h.prototype.hide.apply(this,arguments)},saveChildren:function(){var e=this,n=this._filterChangeList("isDeleted"),s=t.difference(this.changedModels,n);return this.saveDfD=new i.Deferred,this._validateNotAcceptedChildView().done(function(){e.containsUnsavedItems()?e.collection.save(e.changedModels,s).done(t.bind(e._successAjaxCallback,e)).fail(t.bind(e._errorAjaxCallback,e)):e.saveDfD.resolve()}).fail(function(){e.saveDfD.reject()}),this.saveDfD},_validateNotAcceptedChildView:function(){var e=new i.Deferred;return this.currentChildView?this.currentChildView.runValidation(null,{dfd:e}):e.resolve(),e},revertChanges:function(){this.revertDfd=new i.Deferred;var e,t=this,n=new i.Deferred;return this.currentChildView?this.currentChildView.toggleActive().done(n.resolve):n.resolve(),n.done(function(){for(var i=t.changedModels.length,n=i-1;n>=0;n--)e=t.changedModels[n],e.isDeleted?t.revertViewRemoval(e):e.isNew()?t._removeModel(e):e.reset().setState("confirmedState",e.getState());t._resetChangedList(),t.revertDfd.resolve()}),this.revertDfd},getTemplate:function(){return t.template(d())},containsUnsavedItems:function(){return!!this.changedModels.length},removeView:function(e){var t=this._findChildrenByModel(e);e.isDeleted={index:this.collection.indexOf(e)},e.get("inherited")?this._saveRemovedOverriddenInheritedModelToList(e):this._saveChildViewToChangedList(t,!e.isNew()),this._removeModel(e)},revertViewRemoval:function(e){var i=e.isDeleted&&e.isDeleted.index,n=t.isNumber(i)?i:this.collection.models.length;this._deleteViewFromChangedList(e),e.reset(),this.collection.add(e,{at:n}),delete e.isDeleted},remove:function(){i(window).off("beforeunload",this._onPageLeave),this._removeConfirmationDialogs(),this.notification&&this.notification.remove(),this.alertDialog&&this.alertDialog.remove(),h.prototype.remove.apply(this,arguments)},_initEvents:function(){i(window).on("beforeunload",t.bind(this._onPageLeave,this))},_initConfirmationDialogs:function(){this.confirmationDialogs={},t.each(o,function(e){this.confirmationDialogs[e]=a(e)},this),this.listenTo(this.confirmationDialogs[o.DELETE_CONFIRM],"button:yes",this._onDeleteConfirm),this.listenTo(this.confirmationDialogs[o.NAME_CONFIRM],"button:yes",this._onNameConfirm),this.listenTo(this.confirmationDialogs[o.NAME_CONFIRM],"button:no",t.bind(this._revertChangedModelProperty,this,"name")),this.listenTo(this.confirmationDialogs[o.CANCEL_CONFIRM],"button:yes",this.revertChanges),this.listenTo(this.confirmationDialogs[o.EDIT_CONFIRM],"button:yes",this._onEditConfirm),this._initPermissionConfirmEvents&&this._initPermissionConfirmEvents()},_removeConfirmationDialogs:function(){t.each(this.confirmationDialogs,function(e){e.remove()},this)},_successAjaxCallback:function(e){this.notification.show({message:s["attributes.notification.message.saved"],type:"success"}),this._sendSearchRequest()?this._searchForInherited(t.union(this.deletedModels,this.renamedModels)).then(this.saveDfD.resolve,this.saveDfD.reject):this.saveDfD.resolve(),e&&this._postProcessItems(e),this._resetChangedList()},_sendSearchRequest:function(){return!this._isServerLevel()&&this._searchForInherited&&this._deletedRenamedModels()},_deletedRenamedModels:function(){return this.deletedModels=this._filterChangeList("isDeleted"),this.renamedModels=this._filterChangeList("isRenamed"),this.deletedModels.length||this.renamedModels.length},_filterChangeList:function(e){var i;return t.compact(t.filter(this.changedModels,function(n){return i=n[e],n.get("inherited")?void 0:t.isFunction(i)?n[e]():i}))},_postProcessItems:function(e){var i,n=e.attribute;t.each(n,function(e){i=this._findChildrenByModel(e.name),i&&i._onSaveSuccess()},this)},_errorAjaxCallback:function(e){this.alertDialog.setMessage(l(e)),this.alertDialog.open(),this.saveDfD.reject()},_toggleAddNewItemButton:function(e){var t=i(this.ui.addNewBtn);e?t.show():t.hide()},_checkCurrentAttribute:function(e){this.currentChildView&&(e.preventDefault(),this.confirmationDialogs[o.EDIT_CONFIRM].open())},_onPageLeave:function(e){return this.containsUnsavedItems()?((e||window.event).returnValue=s["attributes.dialog.unsaved.changes"],s["attributes.dialog.unsaved.changes"]):void 0},_onEditConfirm:function(){this.currentChildView.cancel()},_onNameConfirm:function(){this.validateDfD&&this.validateDfD.resolve()},_onDeleteConfirm:function(){var e=this.model.get("changedChildView"),t=e.model,i=t.get("name");e.isInherited()&&!t.isRenamed()?t.reset():(this.removeView(t),this._revertInheritedRemoval&&this._revertInheritedRemoval(i))},_isServerLevel:function(){return this.type===r.SERVER||null===this.collection.getContext().id},_revertChangedModelProperty:function(e){var t=this.model.get("changedChildView")||this.currentChildView;t.model.reset(e,"confirmedState")},_addNewChildView:function(){var e=this.collection.addNew(),t=this._findChildrenByModel(e);this._saveChildViewToChangedList(t,!0),t.toggleActive()},_scrollToChildView:function(e){var t=this.$el.closest(".body"),i=t.height(),n=e.$el,s=n.height(),o=n.position(),r=i<o.top+s&&{scrollTop:t.scrollTop()+(o.top+s-i)};r&&t.animate(r,900)},_successValidationCallback:function(e,t,i){var n=this,s=e.model;this._filterInheritedViews&&this._filterInheritedViews(i),e.validateIfSecure(),e.toggleIfModelIsValid().done(function(){n._removeInheritedView&&n._removeInheritedView(s),n._addInheritedView&&n._addInheritedView(s),n._showPermissionConfirm&&n._showPermissionConfirm(e),n._resetFilters&&n._resetFilters(),t.resolve()})},_deleteViewFromChangedList:function(e){var i=t.indexOf(this.changedModels,e);-1!==i&&this.changedModels.splice(i,1)},_removeModel:function(e){this.collection.remove(e)},_findModelsWhere:function(e){return this.collection.findWhere(e)},_findChildrenByModel:function(e){return e=t.isString(e)?this._findModelsWhere({name:e}):e,e&&this.children.findByModel(e)},_resetChangedList:function(){this.changedModels.length=0,this.overriddenInheritedModels.length=0,this._triggerChangeEvent()},_triggerChangeEvent:function(){this.toggleButtons&&this.toggleButtons(),this.trigger("change")},_activeChildView:function(e,t,i){this._setCurrentChildView(t?e:null),this._scrollToChildView(e),i&&i.resolve()},_saveChildViewToChangedList:function(e,i){var n=e.model;t.contains(this.changedModels,n)?!i&&this._deleteViewFromChangedList(n):i&&this.changedModels.push(n),e.invokeFiltration()&&this._resetFilters&&this._resetFilters(),this._triggerChangeEvent()},_saveRemovedOverriddenInheritedModelToList:function(e){!t.contains(this.overriddenInheritedModels,e)&&this.overriddenInheritedModels.push(e)},_openConfirm:function(e,i,n){this.validateDfD=n.dfd,this.model.set("changedChildView",e);var r=this.confirmationDialogs[i],a=i!==o.CANCEL_CONFIRM?!0:this.containsUnsavedItems();switch(i){case o.DELETE_CONFIRM:r.setContent(t.template(s["attributes.confirm.delete.dialog.text"],{name:e.model.get("name")}));break;case o.PERMISSION_CONFIRM:r.setContent(s["attributes.confirm.permission.dialog.text"])}a&&r.open()},_validateChildView:function(e,n){n=n||{};var s=e.model,o=n.dfd?n.dfd:new i.Deferred,r=!s.isOriginallyInherited(),a=t.bind(this._successValidationCallback,this,e,o),d=this._isServerLevel();return e.getChangedProperties("name")&&!this._sendValidateSearchRequest(s)?this.collection.validateSearch(s,this.changedModels,r,d).then(a):a(),o},_sendValidateSearchRequest:function(e){var i=this._filterChangeList("isDeleted"),n=t.filter(i,function(t){return e.get("name")===t.get("name")}).length,s=t.filter(this.changedModels,function(t){return e.get("name")===t.get("name")}).length;return n&&!e.isDeleted&&2>=s},_setCurrentChildView:function(e){this._toggleAddNewItemButton(!e);var t=this.currentChildView;if(t){var i=t.model,n=i.isNew()&&!t.isStateConfirmed();n&&this.removeView(i)}this.currentChildView=e}});return f});