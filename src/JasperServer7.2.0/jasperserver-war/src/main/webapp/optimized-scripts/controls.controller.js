!function(t,e,r){function i(e){var r=t.url.parse(location.href).params;return r&&r[e]}e.extend(r,{Controller:r.Base.extend({constructor:function(i){e.bindAll(this,"fetchControlsStructure","detectReportUri","getReportUri","getDataTransfer","getViewModel","updateControlsValues","reset","update","validate"),this.viewModel=i&&i.viewModel?i.viewModel:new r.ViewModel,this.dataTransfer=i&&i.dataTransfer?i.dataTransfer:new r.DataTransfer({dataConverter:new r.DataConverter}),this.initialize(i),r.listen({"viewmodel:selection:changed":e.bind(function(t,e,r,i){e&&i&&this.updateControlsValues(e,r)},this),"reportoptions:selection:changed":e.bind(function(t,e){var r=e&&e.reportOption,i=e&&e.selectedData;this.reset(r&&r.uri,i)},this)}),r.getController=e.bind(function(){return this},this),t(document).trigger("controls:initialized",[this.getViewModel()])},initialize:function(t){this.dataTransfer.setReportUri(this.detectReportUri(t))},fetchControlsStructure:function(t,r){var i=this.dataTransfer,n=this.viewModel,o=r&&!e.isEmpty(t)?e.keys(t):[];return i.fetchControlsStructure(o,t).done(function(t){t&&n.set({structure:t.structure,state:t.state})})},detectReportUri:function(t){if(this.reportUri=t&&t.reportUri||i("reportUnitURI"),!this.reportUri)throw Error("Can't initialize without reportUri");return this.reportOptionUri=t&&t.reportOptionUri||i("reportOptionsURI"),this.getReportUri()},getReportUri:function(){return this.reportOptionUri||this.reportUri},getDataTransfer:function(){return this.dataTransfer},getViewModel:function(){return this.viewModel},updateControlsValues:function(t,r){var i=this.getDataTransfer(),n=this.getViewModel(),o=r||e.map(n.getControls(),function(t){return t.id});return i.fetchControlsUpdatedValues(o,t).done(function(t){n.set(t)})},reset:function(t,e){var r=this;return this.getDataTransfer().fetchInitialControlValues(t||this.getReportUri(),e).done(function(t){r.getViewModel().set(t)})},update:function(t){return t||(t=this.getViewModel().get("selection")),this.updateControlsValues(t)},validate:function(){var t=this.getDataTransfer(),r=this.getViewModel(),i=e.map(r.getControls(),function(t){return t.id}),n=r.get("selection");return t.fetchControlsUpdatedValues(i,n).then(function(t){var i=e(t.state).reduce(function(t,e,r){return t[r]={error:e.error},t},{});r.set({state:i})}).then(function(){return r.areAllControlsValid()})}})})}(jQuery,_,JRS.Controls);