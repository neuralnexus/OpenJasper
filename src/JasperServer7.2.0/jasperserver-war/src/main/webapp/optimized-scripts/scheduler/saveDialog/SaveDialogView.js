define(["require","underscore","bundle!all","bi/repository/model/RepositoryResourceModel","common/component/dialog/DialogWithModelInputValidation","text!scheduler/saveDialog/template/saveDialogTemplate.htm"],function(e){"use strict";var o=e("underscore"),i=e("bundle!all"),t=e("bi/repository/model/RepositoryResourceModel"),a=e("common/component/dialog/DialogWithModelInputValidation"),n=e("text!scheduler/saveDialog/template/saveDialogTemplate.htm"),l={};return a.extend({theDialogIsOpen:!1,saveDialogTemplate:n,constructor:function(e){e||(e={}),l=o.extend({},e);var t=this.extendModel(e.model),n=this._getLabelForSaveButton(t);a.prototype.constructor.call(this,{skipLocation:!!l.skipLocation,modal:!0,model:t,resizable:!0,additionalCssClasses:"schedulerSaveDialog jr-uWidth-425px jr-uHeight-275px",title:i["report.scheduling.saveDialog.save"],content:o.template(this.saveDialogTemplate,{i18n:i,model:o.extend({},t.attributes),skipLocation:!!l.skipLocation,isEmbedded:l.isEmbedded,isEditMode:l.isEditMode}),buttons:[{label:i[n],action:"save",primary:!0},{label:i["report.scheduling.saveDialog.cancel"],action:"cancel",primary:!1}]}),this.on("button:save",o.bind(this._onSaveDialogSaveButtonClick,this)),this.on("button:cancel",o.bind(this._onSaveDialogCancelButtonClick,this))},initialize:function(){a.prototype.initialize.apply(this,arguments)},restoreModel:function(){this.originalModelValidation&&(this.model.validation=this.originalModelValidation)},extendModel:function(e){return this.originalModelValidation=e.validation,e.validation=o.extend({},t.prototype.validation,{name:null,parentFolderUri:null,label:[{required:!0,msg:i["report.scheduling.saveDialog.validation.not.empty.label"]},{maxLength:t.LABEL_MAX_LENGTH,msg:i["report.scheduling.saveDialog.validation.too.long.label"]}],description:[{required:!1},{maxLength:t.DESCRIPTION_MAX_LENGTH,msg:i["report.scheduling.saveDialog.validation.too.long.description"]}]}),e},startSaveDialog:function(){this._openDialog()},closeDialog:function(){this.restoreModel(),this._closeDialog()},_openDialog:function(){this.theDialogIsOpen||(this.bindValidation(),a.prototype.open.apply(this,arguments),this.$contentContainer.find("[name=label]").focus(),this.theDialogIsOpen=!0)},_closeDialog:function(){this.theDialogIsOpen&&(this.unbindValidation(),this.clearValidationErrors(),a.prototype.close.apply(this,arguments),this.theDialogIsOpen=!1)},_getLabelForSaveButton:function(){return"report.scheduling.saveDialog.save"},_onDialogResize:function(){var e=this,o=0,i=this.$contentContainer.find("textarea"),t=this.$contentContainer.closest(".jr-mDialog > .jr-mDialog-body");this.$contentContainer.children().not(i).each(function(){o+=e.$(this).outerHeight(!0)}),i.height(t.outerHeight(!0)-o-60)},_onSaveDialogCancelButtonClick:function(){this.restoreModel(),this._closeDialog()},_onSaveDialogSaveButtonClick:function(){this.model.isValid(!0)&&this.performSave()},performSave:function(){var e=this;this.model.checkSaveValidation({editMode:l.isEditMode}).done(function(){e.model.save({},{success:o.bind(e._saveSuccessCallback,e),error:o.bind(e._saveErrorCallback,e)})}).fail(function(){e.trigger("saveValidationFailed")})},_saveSuccessCallback:function(e,i){this._closeDialog(),o.isFunction(l.onSaveDone)&&l.onSaveDone()},_saveErrorCallback:function(e,t,a){var n=this,r=!1,s=!1;try{r=JSON.parse(t.responseText)}catch(e){}r.error&&(r=r.error),o.isArray(r)||(r=[r]),o.each(r,function(e){if("label"===e.field){var o="";"error.not.empty"===e.errorCode&&(o=i["error.not.empty.label"]),"version.not.match"===e.errorCode&&(o=i["report.scheduling.resource.exists"]),"mandatory.parameter.error"===e.errorCode&&(o=i["report.scheduling.saveDialog.parameterIsMissing"]),""!==o&&(n.invalidField("[name=label]",o),s=!0)}}),!1===s&&o.isFunction(l.onSaveFail)&&l.onSaveFail(e,t,a)}})});