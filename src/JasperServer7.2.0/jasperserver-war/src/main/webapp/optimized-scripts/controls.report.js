var Controls=function(e,o,t,n){var r,s,l=null;return require(["settings!inputControls","common/component/dialog/ConfirmationDialog","components/overlay/Overlay"],function(e,o,t){l=e,r=o,s=t}),o.extend(t,{_messages:{},layouts:{LAYOUT_POPUP_SCREEN:1,LAYOUT_SEPARATE_PAGE:2,LAYOUT_TOP_OF_PAGE:3,LAYOUT_IN_PAGE:4},controlDialog:null,reportOptionsDialog:null,inputControlsLocation:null,toggleControlsOn:!1,controller:null,hideControls:null,selectionChanged:!0,initialize:function(){this.controller=new JRS.Controls.Controller({reportUri:n.reportUnitURI,reportOptionUri:n.reportOptionsURI});var r=o.extend(n.getAllRequestParameters(),n.reportParameterValues);this.controller.fetchControlsStructure(r).always(function(r){var s=t.controller.getViewModel(),l=s.areAllControlsValid(),i=!o.isUndefined(o.find(n.parametersWithoutDefaultValues,function(e){return!o.contains(o.keys(n.getAllRequestParameters()),e)}));n.hasInputControls&&((n.reportForceControls||i)&&o.isEmpty(n.reportParameterValues)||!l)?((!r||"number"!=typeof r.status||r.status<300)&&t.show(),n&&n.nothingToDisplay&&(n.nothingToDisplay.removeClassName(layoutModule.HIDDEN_CLASS),centerElement(n.nothingToDisplay,{horz:!0,vert:!0}),e("#"+n.DATA_REFRESH_BUTTON).attr(layoutModule.DISABLED_ATTR_NAME,layoutModule.DISABLED_ATTR_NAME)),t.lastSelection=s.get("selection")):t.refreshReport(),JRS.Controls.listen({"viewmodel:selection:changed":function(){t.selectionChanged=!0},"reportoptions:selection:changed":function(e,o){t.selectionChanged=!0}})}),this.viewModel=t.controller.getViewModel(),this.initializeOptions(),this.buttonActions={"button#ok":o.bind(t.applyInputValues,t,!0),"button#apply":o.bind(t.applyInputValues,t),"button#cancel":o.bind(t.cancel,t),"button#reset":t.resetToInitial,"button#save":t.save,"button#remove":t.remove};var s={"button#ok":o.bind(t.applyInputValues,t,!0),"button#cancel":o.bind(t.cancel,t),"button#reset":t.resetToInitial,"button#apply":o.bind(t.applyInputValues,t),"button#save":t.save,"button#remove":t.remove};$(ControlsBase.INPUT_CONTROLS_DIALOG)&&(this.controlDialog=new ControlDialog(s)),$(ControlsBase.INPUT_CONTROLS_FORM)&&$(ControlsBase.INPUT_CONTROLS_FORM).observe("click",function(e){var o=e.element();for(var t in this.buttonActions)if(matchAny(o,[t],!0))return this.buttonActions[t](),void e.stop()}.bindAsEventListener(this)),this.inputControlsLocation=$(ControlsBase.INPUT_CONTROLS_CONTAINER)?$(ControlsBase.INPUT_CONTROLS_CONTAINER):$(ControlsBase.INPUT_CONTROLS_FORM),$(ControlsBase.TOOLBAR_CONTROLS_BUTTON)&&(this.toggleControlsOn=$(ControlsBase.TOOLBAR_CONTROLS_BUTTON).hasClassName("down"))},initializeOptions:function(){function s(){var o;(o=e(t.layouts.LAYOUT_POPUP_SCREEN==n.reportControlsLayout?"#"+ControlsBase.INPUT_CONTROLS_DIALOG:"#"+ControlsBase.INPUT_CONTROLS_FORM))&&o.length>0&&o.addClass("showingSubHeader")}function l(){var o;(o=e(t.layouts.LAYOUT_POPUP_SCREEN==n.reportControlsLayout?"#"+ControlsBase.INPUT_CONTROLS_DIALOG:"#"+ControlsBase.INPUT_CONTROLS_FORM))&&o.length>0&&o.removeClass("showingSubHeader")}if(isProVersion()){var i;i=this.layouts.LAYOUT_POPUP_SCREEN==n.reportControlsLayout?"#"+ControlsBase.INPUT_CONTROLS_DIALOG+" .sub.header":(this.layouts.LAYOUT_TOP_OF_PAGE,n.reportControlsLayout,"#"+ControlsBase.INPUT_CONTROLS_FORM+" .sub.header");var a=new JRS.Controls.ReportOptions;a.fetch(n.reportUnitURI,n.reportOptionsURI).done(function(){e(i).append(a.getElem()),t.lastReportOptionsSelection=a.get("selection")}).fail(function(){e(i).addClass("hidden")}).always(function(){t.lastReportOptionsSelection||(t.lastReportOptionsSelection=a.get("defaultOption"))}),a.updateWarningMessage=function(){t.reportOptionsDialog.showWarning(this.error)},JRS.Controls.listen({"viewmodel:selection:changed":function(){var e=a.find({uri:n.reportUnitURI});a.set({selection:e},!0)},"viewmodel:order:changed":o.bind(function(e,t){n.newIcOrder=o.pluck(t,"id").join(";")},this)});var p={"button#saveAsBtnSave":function(){var o=t.reportOptionsDialog.input.getValue(),r=t.viewModel.get("selection"),l=o===t.reportOptionsDialog.optionNameToOverwrite;a.add(n.reportUnitURI,o,r,l).done(function(){t.reportOptionsDialog.hideWarning(),dialogs.systemConfirm.show(ControlsBase.getMessage("report.options.option.saved")),s();var o=a.getElem().parent();o.length>0?o.removeClass("hidden"):(e(i).removeClass("hidden"),e(i).append(a.getElem())),t.layouts.LAYOUT_TOP_OF_PAGE==n.reportControlsLayout&&e("#"+ControlsBase.INPUT_CONTROLS_FORM+" .header").removeClass("hidden"),t.reportOptionsDialog.hide(),delete t.reportOptionsDialog.optionNameToOverwrite}).fail(function(e){if(e)try{"report.options.dialog.confirm.message"===JSON.parse(e.responseText).errorCode&&!l&&(t.reportOptionsDialog.optionNameToOverwrite=o)}catch(e){}})},"button#saveAsBtnCancel":function(){t.reportOptionsDialog.hide(),delete t.reportOptionsDialog.optionNameToOverwrite}};$(ControlsBase.SAVE_REPORT_OPTIONS_DIALOG)&&(this.reportOptionsDialog=new OptionsDialog(p)),this.remove=function(){var o=a.get("selection").label,s=new r({text:ControlsBase.getMessage("report.options.option.confirm.remove",{option:o})});s.on("button:yes",function(){a.removeOption(n.reportUnitURI,a.get("selection").id).done(function(){if(!a.get("values")){l();var o=a.getElem().parent();o.length>0?o.addClass("hidden"):(e(i).addClass("hidden"),e(i).html("")),t.layouts.LAYOUT_TOP_OF_PAGE==n.reportControlsLayout&&e("#"+ControlsBase.INPUT_CONTROLS_FORM+" .header").addClass("hidden")}a.enableRemoveButton(!1),dialogs.systemConfirm.show(ControlsBase.getMessage("report.options.option.removed"))}),s.remove()}),s.on("button:no",function(){s.remove()}),s.open()},t.reportOptions=a}},cancel:function(){n.reportControlsLayout==t.layouts.LAYOUT_SEPARATE_PAGE&&t.separatePageICLayoutFirstShow?n.goBack():t.controller.update(t.lastSelection).always(function(){n.reportControlsLayout==t.layouts.LAYOUT_POPUP_SCREEN?t.controlDialog.hide():n.reportControlsLayout==t.layouts.LAYOUT_SEPARATE_PAGE&&t.showReport(),t.reportOptions&&t.lastReportOptionsSelection&&t.reportOptions.set({selection:t.lastReportOptionsSelection},!0)})},getLastSelection:function(){return this.lastSelection},save:function(){t.selectionChanged?t.controller.validate().then(t.showOptionDialog):t.showOptionDialog()},refreshReport:function(r){var s=new e.Deferred,l=s.promise(),i=t.viewModel.get("selection");if(r){if(!JRS.Controls.ViewModel.isSelectionChanged(t.lastSelection,i))return s.resolve(),l()}try{i&&!o.isEmpty(i)?(l=n.refreshReport(null,null,ControlsBase.buildSelectedDataUri(i)),t.lastSelection=i):(l=n.refreshReport(),t.lastSelection={})}catch(e){alert(e),s.reject(e)}return l},applyInputValues:function(r){var l=t.viewModel;t.selectionChanged?t.controller.validate().then(function(l){if(l){var i,a=t.lastSelection;t.reportOptions&&(i=t.lastReportOptionsSelection),viewer&&viewer.jive&&viewer.jive.hide(),t.refreshReport().then(function(){t.selectionChanged=!1},function(){var l=new s({zIndex:dialogs.errorPopup.getZIndex()-1});e("body").append(l.$el),l.show(),t.lastSelection=a,t.lastReportOptionsSelection=i,dialogs.errorPopup.onClose=function(){t.lastSelection&&!o.isEmpty(t.lastSelection)?n.refreshReport(null,null,ControlsBase.buildSelectedDataUri(t.lastSelection)):n.refreshReport(),l.remove()},r&&(t.cancel(),t.selectionChanged=!1)}),t.reportOptions&&(t.lastReportOptionsSelection=t.reportOptions.get("selection")),r&&t.hide()}}):l.areAllControlsValid()&&r&&t.hide()},resetToInitial:function(){t.selectionChanged=!0;var e=t.reportOptions;if(e){var r=e.find({uri:n.reportOptionsURI?n.reportOptionsURI:n.reportUnitURI});if(r)return void e.set({selection:r})}var s=null;"true"===l.useUrlParametersOnReset&&(s=o.extend(n.getAllRequestParameters(),n.reportParameterValues)),t.controller.reset(null,s)},show:function(){switch(n.reportControlsLayout){case 2:t.showControls();break;case 3:t.toggleControls();break;case 4:break;default:t.showDialog()}},hide:function(){switch(n.reportControlsLayout){case 2:t.showReport();break;case 3:case 4:break;default:t.controlDialog.hide()}},toggleControls:function(){t.toggleControlsOn?($(ControlsBase.TOOLBAR_CONTROLS_BUTTON).removeClassName("down").addClassName("up"),$$(".panel.pane.inputControls")[0].addClassName(layoutModule.HIDDEN_CLASS),triggerNativeEvent("resize")):($(ControlsBase.TOOLBAR_CONTROLS_BUTTON).removeClassName("up").addClassName("down"),$$(".panel.pane.inputControls")[0].removeClassName(layoutModule.HIDDEN_CLASS)),t.toggleControlsOn=!t.toggleControlsOn,isIPad()&&n.touchController.reset(),e("#"+ControlsBase.INPUT_CONTROLS_FORM).show().height()},showDialog:function(){t.controlDialog&&t.controlDialog.show()},showReport:function(){$(layoutModule.PAGE_BODY_ID).removeClassName(layoutModule.CONTROL_PAGE_CLASS).addClassName(layoutModule.ONE_COLUMN_CLASS)},showControls:function(){$(layoutModule.PAGE_BODY_ID).removeClassName(layoutModule.ONE_COLUMN_CLASS).addClassName(layoutModule.CONTROL_PAGE_CLASS),document.getElementById(ControlsBase.INPUT_CONTROLS_FORM)&&e("#"+ControlsBase.INPUT_CONTROLS_FORM).show()},showOptionDialog:function(){JRS.Controls.Utils.wait(200).then(function(){t.viewModel.areAllControlsValid()&&(t.reportOptionsDialog.show(),selectAndFocusOn(t.reportOptionsDialog.input))})}})}(jQuery,_,{},Report);