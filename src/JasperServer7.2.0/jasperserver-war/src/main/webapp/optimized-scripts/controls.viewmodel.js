JRS.Controls=function(t,e,n){var i=!1;require(["common/util/browserDetection"],function(t){i=t.isIE()});var o=function(){var e,n=(new Date).getTime();return function(){var i=(new Date).getTime(),o=this;i-n>400&&(n=i,t(this).trigger("scrollstart")),clearTimeout(e),e=setTimeout(function(){t(o).trigger("scrollstop")},300)}}(),r=n.Base.extend({constructor:function(t){this.containerSelector=t&&t.containerSelector||n.ViewModel.DEFAULT_CONTAINER,this.controls={},n.getViewModel=e.bind(function(){return this},this),e.bindAll(this,"registerEvents","onControlChange","_getAllSlaveControlIds","_getParentControlIds"),this.registerEvents()},registerEvents:function(){n.ignore("changed:control",this.onControlChange),n.listen({"changed:control":this.onControlChange})},onControlChange:function(i,o){var r,s,a=o.slaveDependencies&&o.slaveDependencies.length;if(a){s=this._getAllSlaveControlIds(o.id);var l=this._getParentControlIds(s),c=e.union(s,l);r=this.get("selection"),e.isEmpty(c)||e.each(r,function(t,n){-1===e.indexOf(c,n)&&delete r[n]})}else r=this.get("selection");t(document).trigger(n.ViewModel.CHANGE_SELECTION,[r,s,a]),a||t(document).trigger(n.ViewModel.CHANGE_VALUES,[this.state])},_getAllSlaveControlIds:function(t){var n=[],i=this.findControl({id:t});return i&&!e.isEmpty(i.slaveDependencies)&&e.each(i.slaveDependencies,function(t){n.push(t),n.push.apply(n,this._getAllSlaveControlIds(t))},this),e.uniq(n)},_getParentControlIds:function(t){var n=[];return e.each(t,function(t){var e=this.findControl({id:t});n.push.apply(n,e.masterDependencies)},this),e.uniq(n)}},{DEFAULT_CONTAINER:"#inputControlsContainer",CHANGE_VALUES:"viewmodel:values:changed",CHANGE_SELECTION:"viewmodel:selection:changed",CHANGE_ORDER:"viewmodel:order:changed",isSelectionChanged:function(t,n){var i=t?e(t).keys():[],o=n?e(n).keys():[];if(e.union(i,o).length===i.length){var r=t?e.flatten(e(t).values()):[],s=n?e.flatten(e(n).values()):[];return e.difference(r,s).length>0||e.difference(s,r).length>0}return!0}}),s={getControls:function(){return this.controls},instantiate:function(t){this.controls={},e.each(t,this.createControl,this)},createControl:function(t){var e=function(t){for(var e in n)if(t.toLowerCase()===e.toLowerCase())return n[e]}(t.type);if(!e)throw new Error("Can not find implementation of the control type: "+t.type);return this.controls[t.id]=new e(t),this.controls[t.id]},removeControl:function(t){delete this.controls[t]},reorderControl:function(e,i){if(1!=this.structure.length){for(var o,r=e<i?1:-1,s=e<i?Math.min(e,i):Math.max(e,i),a=e<i?Math.max(e,i):Math.min(e,i),l=s;l!=a;l+=r)o=this.structure[l],this.structure[l]=this.structure[l+r],this.structure[l+r]=o;t(document).trigger(n.ViewModel.CHANGE_ORDER,[this.structure])}},set:function(i,o){if(i){if(e.extend(this,i),void 0!==i.structure){var r=i.structure;this.instantiate(r),this.draw(r)}if(void 0!==i.state){var s=i.state;this.update(s),!o&&t(document).trigger(n.ViewModel.CHANGE_VALUES,[i.state])}}},get:function(t){if(t){if("selection"===t){var n={};return e.each(this.getControls(),function(t){var i=t.get("selection");i instanceof Array?n[t.id]=i:e.isUndefined(i)||(n[t.id]=[i])}),n}return this[t]}},findControl:function(t){var n=e.keys(t)[0],i=e.values(t)[0];return e.find(this.getControls(),function(t){return t[n]===i})},pluck:function(t){return e.pluck(this.getControls(),t)}},a={draw:function(t){var n=this.getContainer();if(n.empty(),i&&(n.attr("js-stdnav","false"),n.attr("js-navtype","none")),e.each(t,function(t){if(t.visible){var e=this.findControl({id:t.id});e.makeResizable&&e.makeResizable(),n.append(e.getElem())}},this),window.Report&&window.Report.icReorderEnabled){var o=window.Controls.layouts.LAYOUT_TOP_OF_PAGE==Report.reportControlsLayout;/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)||this._initSortable({container:n,horizontalLayout:o})}},update:function(t){e.each(t,function(t,e){this.findControl({id:e}).set({values:t.values,error:t.error})},this)},getContainer:function(){return this.container&&1==this.container.length?this.container:(this.container=t(this.containerSelector),this.container)},removeValidationMessages:function(){e.each(this.getControls(),function(t){t.set({error:null})})},areAllControlsValid:function(){return e.isEmpty(e.filter(this.getControls(),function(t){return!t.isValid()}))},setContainer:function(e){this.container=t(e)},reloadContainer:function(){return this.container=t(this.containerSelector),this.container},disable:function(){e.each(this.getControls(),function(t){t.set({disabled:!0})})},enable:function(){e.each(this.getControls(),function(t){t.set({disabled:!1})})},_initSortable:function(n){var r=n.container,s=n.horizontalLayout,a=!1,l=this,c=t(r).sortable({delay:200,placeholder:s?"verticalPlaceholder":"horizontalPlaceholder",axis:s?"x":"y",items:"> .leaf",cancel:"input,textarea,button,select,option,.list.inputSet,.jr-mSizer",start:function(t,e){e.item.data("oldIndex",e.item.index()),a=!0},stop:e.bind(function(t,e){var n=e.item.data("oldIndex"),i=e.item.index();n!=i&&this.reorderControl(n,i),a=!1},this)});if(i){var u=n.parent||c.parent();u.off("scroll",o),u.off("scrollstart"),u.off("scrollstop"),u.on("scroll",o),u.on("scrollstart",function(){if(!a)try{c.sortable("destroy")}catch(t){}}),u.on("scrollstop",function(){!a&&l._initSortable({parent:u,container:r,horizontalLayout:s})})}}};return e.extend(r.prototype,s,a),e.extend(n,{ViewModel:r})}(jQuery,_,JRS.Controls);