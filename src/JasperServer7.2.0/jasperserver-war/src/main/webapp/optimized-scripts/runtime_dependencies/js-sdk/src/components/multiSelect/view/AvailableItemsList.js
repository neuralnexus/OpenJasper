define(["require","jquery","backbone","underscore","common/util/browserDetection","bundle!js-sdk/ScalableInputControlsBundle","common/util/xssUtil","components/singleSelect/manager/KeyboardManager","components/scalableList/view/ListWithNavigation","components/scalableList/model/ListWithSelectionModel","components/scalableList/util/domAndCssUtil","components/scalableList/model/listWithNavigationModelTrait","components/scalableList/model/ListWithSelectionAsObjectHashModel","../mixin/scalableListItemHeightCalculationTrait","text!../templates/availableItemsTemplate.htm","text!../templates/availableItemsTemplate_IE10_11.htm","text!../templates/listTemplate.htm"],function(e){"use strict";var t=e("jquery"),i=e("backbone"),s=e("underscore"),n=e("common/util/browserDetection"),l=e("bundle!js-sdk/ScalableInputControlsBundle"),o=(e("common/util/xssUtil"),e("components/singleSelect/manager/KeyboardManager")),a=e("components/scalableList/view/ListWithNavigation"),h=(e("components/scalableList/model/ListWithSelectionModel"),e("components/scalableList/util/domAndCssUtil").doCalcOnVisibleNodeClone),c=e("components/scalableList/model/listWithNavigationModelTrait"),r=e("components/scalableList/model/ListWithSelectionAsObjectHashModel"),d=e("../mixin/scalableListItemHeightCalculationTrait"),u=e("text!../templates/availableItemsTemplate.htm"),m=e("text!../templates/availableItemsTemplate_IE10_11.htm"),g=e("text!../templates/listTemplate.htm"),f=[{selector:".jr-jSelectAll",strings:[l["sic.multiselect.selectAll"],l["sic.multiselect.all"],""]},{selector:".jr-jSelectNone",strings:[l["sic.multiselect.deselectAll"],l["sic.multiselect.none"],""]},{selector:".jr-jInvert",strings:[l["sic.multiselect.inverse"],""]}];return i.View.extend({className:"jr-mMultiselect-listContainer jr-isActive jr",events:function(){return{"keydown input.jr-mInput-search":this.keyboardManager.onKeydown,"focus input.jr-mInput-search":"onFocus","blur input.jr-mInput-search":"onBlur","click .jr-jSelectAll":"onSelectAll","click .jr-jSelectNone":"onSelectNone","click .jr-jInvert":"onInvertSelection","click input.jr-mInput-search":"onClickOnInput","touchend input.jr-mInput-search":"onClickOnInput",mousedown:"onMousedown",mouseup:"onMouseup"}},keydownHandlers:s.extend({65:"onAKey"},o.prototype.keydownHandlers),initialize:function(e){s.bindAll(this,"onGlobalMouseup","onGlobalMousedown","onResize","onGlobalMousemove","onMousedown","onMouseup","onEscKey","onSelectAll","onSelectNone","onInvertSelection"),this._debouncedOnResize=s.debounce(this.onResize,500),this.model||(this.model=new i.Model),this.model.set("criteria","",{silent:!0}),(n.isIE10()||n.isIE11())&&(u=m),this.label=e.label,this.template=s.template(e.availableItemsTemplate||u),this.keyboardManager=new o({keydownHandlers:this.keydownHandlers,keydownTimeout:e.keydownTimeout,context:this,deferredKeydownHandler:this.processKeydown,immediateHandleCondition:this.immediateHandleCondition,immediateKeydownHandler:this.immediateKeydownHandler,stopPropagation:!0}),this.listViewModel=this._createListViewModel(e),this.setValue(e.value,{silent:!0}),this.listView=this._createListView(e),this.render(),this.initListeners()},_createListViewModel:function(e){this.getData=e.getData;var t=r.extend(c);return e.listViewModel||new t({getData:e.getData,bufferSize:e.bufferSize,loadFactor:e.loadFactor})},_createListView:function(e){var i=e.listView||new a({el:e.listElement||t(g),model:this.listViewModel,chunksTemplate:e.chunksTemplate,itemsTemplate:e.itemsTemplate,scrollTimeout:e.scrollTimeout,lazy:!0,selectedClass:"jr-isSelected",selection:{allowed:!0,multiple:!0}});return s.extend(i,d),i},initListeners:function(){this.listenTo(this.listView,"active:changed",this.activeChange,this),this.listenTo(this.listView,"mousedown",this.onMousedown,this),this.listenTo(this.listView,"render:data",this.onRenderData,this),this.listenTo(this.listView,"listRenderError",this.listRenderError,this),this.listenTo(this.listViewModel,"change",this.onListViewModelChanged,this),this.listenTo(this.listViewModel,"selection:clear",this.selectionClear,this),this.listenTo(this.listViewModel,"selection:add",this.selectionAdd,this),this.listenTo(this.listViewModel,"selection:addRange",this.selectionAddRange,this),this.listenTo(this.listViewModel,"selection:remove",this.selectionRemove,this),this.listenTo(this.model,"change:totalValue",this.onChangeTotalValue,this),this.listenTo(this.model,"change:value",this.changeValue,this),this.listenTo(this.model,"change:disabled",this.changeDisabled,this),this.listenTo(this.model,"change:criteria",this.changeFilter,this),t("body").on("mousedown",this.onGlobalMousedown).on("mouseup",this.onGlobalMouseup).on("mousemove",this.onGlobalMousemove),t(window).on("resize",this._debouncedOnResize)},render:function(){return this.$el.empty(),this.$el.append(t(this.template(this.getModelForRendering()))),this.listView.undelegateEvents(),this.$el.find(".jr-mMultiselect-list").append(this.listView.el),this.listView.render(),this.listView.fetch(s.bind(this.listView.resize,this.listView)),this.listView.delegateEvents(),this._tuneCSS(),this.setBulkSelectionText(),this},_tuneCSS:function(){var e=this;this._paddingHeightsSet||(h({el:this.$el,css:{width:"500px"},classes:"jr "+(n.isIPad()?"ipad":""),callback:function(t){e.searchBarHeight=Math.round(t.find(".jr-mMultiselect-search").outerHeight()),e.buttonsContainerHeight=Math.round(t.find(".jr-mMultiselect-buttonContainer").outerHeight())}}),this._paddingHeightsSet=!0),this.$el.find(".jr-mMultiselect-list").css({height:"100%","padding-top":this.searchBarHeight,"padding-bottom":this.buttonsContainerHeight})},renderData:function(){return this.listView.renderData(),this},activeChange:function(e){e&&(this.activeChangedWithShift&&(delete this.activeChangedWithShift,this.listViewModel.addRangeToSelection(e.value,e.index)),this.listView.scrollTo(e.index))},selectionAdd:function(e){this.model.get("value")[e.value]=!0,this.model.trigger("change:value")},selectionAddRange:function(e){var t=e.selection,i=this.model.get("value"),s=0,n=t.length;for(s;s<n;s+=1)i[t[s]]=!0;this.model.trigger("change:value")},selectionRemove:function(e){delete this.model.get("value")[e.value],this.model.trigger("change:value")},selectionClear:function(){this.model.attributes.value={}},onSelectAll:function(){this.model.get("disabled")||(this.listView.once("selection:change",this.processSelectionThroughApi,this),this.clearFilter(s.bind(this.listView.selectAll,this.listView)))},onSelectNone:function(){this.model.get("disabled")||(this.listView.once("selection:change",this.processSelectionThroughApi,this),this.clearFilter(s.bind(this.listView.selectNone,this.listView)))},onInvertSelection:function(){this.model.get("disabled")||(this.listView.once("selection:change",this.processSelectionThroughApi,this),this.clearFilter(s.bind(this.listView.invertSelection,this.listView)))},onRenderData:function(){this.trigger("render:data")},listRenderError:function(e,t){this.trigger("listRenderError",e,t)},onListViewModelChanged:function(){if(void 0===this.model.get("totalValues")){var e=this.listViewModel.get("total");s.isNumber(e)&&!s.isNaN(e)&&this.model.set("totalValues",e)}},onChangeTotalValue:function(){this.listView.resize()},setBulkSelectionText:function(){if(this.$el.is(":visible")){var e=this.$el.outerWidth();if(e!==this._componentWidth){this._componentWidth=e;var t=this.$el.find(".jr-mMultiselect-buttonContainer"),i=t.outerWidth();h({el:t,css:{left:0-2*i+"px",width:i+"px"},classes:"jr "+(n.isIPad()?"ipad":""),alwaysClone:!0,callback:function(e){s.each(f,function(i){var n=!1;s.each(i.strings,function(s){if(!n){var l=e.find(i.selector),o=l.find(".jr-mItemselector-button-label span").text(s);(l[0].getBoundingClientRect().right-o[0].getBoundingClientRect().right>=3||""===s)&&(n=!0,t.find(i.selector+" .jr-mItemselector-button-label span").text(s))}})})}})}}},changeValue:function(){this.trigger("selection:change",this.getValue())},changeDisabled:function(){var e=this.model.get("disabled");e?this.$el.find("input[type='text']").attr("disabled","disabled"):this.$el.find("input[type='text']").removeAttr("disabled"),this.listView.setDisabled(e)},onClickOnInput:function(){this.onFocus()},onFocus:function(){var e=this.$el.find("input");e.val()==e.attr("placeholder")&&(e.val(""),e.removeClass("jr-mMultiselect-input-placeholder"))},onBlur:function(){var e=this.$el.find("input");if(""!==e.val()&&e.val()!==e.attr("placeholder")||(e.addClass("jr-mMultiselect-input-placeholder"),e.val(e.attr("placeholder"))),this.preventBlur)return!1},onMousedown:function(){n.isIPad()||(this.preventBlur=!0)},onMouseup:function(){this.preventBlur&&(delete this.preventBlur,this.$el.find("input.jr-mInput-search").focus())},onGlobalMousedown:function(e){this.preventBlur&&e.target!==this.el&&0===this.$el.find(e.target).length&&(delete this.preventBlur,this.onBlur())},onGlobalMouseup:function(){this.onMouseup()},onGlobalMousemove:function(e){this.preventBlur&&e.stopPropagation()},onResize:function(){this.resize()},onUpKey:function(e){var t=this;this._onUpDownNavigation(e,function(){t.listView.activatePrevious()},function(){t.listView.activateLast()})},onDownKey:function(e){var t=this;this._onUpDownNavigation(e,function(){t.listView.activateNext()},function(){t.listView.activateFirst()})},_onUpDownNavigation:function(e,t,i){var s,n=this.listView.getActiveValue();n?(e.shiftKey&&(this.activeChangedWithShift=!0),t(),s=this.listView.getActiveValue(),s.index===n.index&&i()):i()},onEnterKey:function(e){e.preventDefault();var t=this.listView.getActiveValue();t&&(e.shiftKey?this.listViewModel.addRangeToSelection(t.value,t.index):e.ctrlKey||e.metaKey?(this.listViewModel.clearSelection(),this.listViewModel.addValueToSelection(t.value,t.index)):this.listViewModel.toggleSelection(t.value,t.index))},onEscKey:function(){},onHomeKey:function(e){e.shiftKey&&(this.activeChangedWithShift=!0),this.listView.activateFirst()},onEndKey:function(e){e.shiftKey&&(this.activeChangedWithShift=!0),this.listView.activateLast()},onPageUpKey:function(e){e.shiftKey&&(this.activeChangedWithShift=!0),this.listView.pageUp()},onPageDownKey:function(e){e.shiftKey&&(this.activeChangedWithShift=!0),this.listView.pageDown()},onTabKey:function(){},onAKey:function(e){e.ctrlKey||e.metaKey?(e.stopPropagation(),this.onSelectAll()):this.keyboardManager.deferredHandleKeyboardEvent(e)},processKeydown:function(){this.model.set("criteria",this.$el.find("input.jr-mInput-search").val())},changeFilter:function(e){var t=this,i=this.model.get("criteria");void 0!==i&&""!==i||this.model.unset("totalValues",{silent:!0}),this.listView.scrollTo(0),t.listView.activate(null,{silent:!0}),this.getData({criteria:i,offset:0,limit:1}).done(function(){t.listViewModel.once("change",e&&"function"==typeof e?e:function(){t.listView.setValue(s.keys(t.model.get("value")),{silent:!0}),t.listView.activate(0)}),t.listView.fetch()})},clearFilter:function(e){this.model.get("criteria")?(this.$el.find("input").val(""),this.model.set("criteria","",{silent:!0}),this.changeFilter(e)):(this.model.unset("totalValues",{silent:!0}),e&&e())},processSelectionThroughApi:function(e,t){var i={},s=0,n=e.length;for(this.selectionClear(),s;s<n;s+=1)i[e[s]]=!0;this.model.attributes.value=i,t&&t.silent||this.model.trigger("change:value")},convertSelectionForListViewModel:function(e){return e},getModelForRendering:function(){return{label:this.label,isIPad:n.isIPad(),disabled:this.model.get("disabled"),i18n:l}},fetch:function(e,t){var i=this.model.get("criteria");void 0!==i&&""!==i||this.model.unset("totalValues",{silent:!0}),this.listView.fetch(e,t)},resize:function(){this.listView.resize(),this.setBulkSelectionText()},reset:function(e){var t=this;this.clearFilter(function(){t.listView.reset(e)})},getValue:function(){return s.keys(this.model.get("value"))},setValue:function(e,t){t=t||{},this.listViewModel.once("selection:change",function(){this.selectionClear();var e=this.listViewModel.getSelection(),i=0,s=e.length;for(i;i<s;i++)this.model.attributes.value[e[i]]=!0;t&&t.silent||this.changeValue()},this),s.isArray(e)||"string"==typeof e||(e=this.convertSelectionForListViewModel(e)),this.listViewModel.select(e,t.modelOptions)},setDisabled:function(e){this.model.set("disabled",e)},getDisabled:function(){return this.model.get("disabled")},remove:function(){this.listView.remove(),i.View.prototype.remove.call(this),t("body").off("mousedown",this.onGlobalMousedown).off("mouseup",this.onGlobalMouseup).off("mousemove",this.onGlobalMousemove),t(window).off("resize",this._debouncedOnResize)}})});