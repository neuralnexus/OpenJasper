define(["require","underscore","jquery","backbone","./TreePlugin","text!../template/searchPluginTemplate.htm"],function(e){"use strict";var t=e("underscore"),r=e("jquery"),n=e("backbone"),i=e("./TreePlugin"),a=e("text!../template/searchPluginTemplate.htm"),s=n.View.extend({template:t.template(a),el:function(){return this.template()},events:{"click .button.search":"clickHandler","click .button.searchClear":"clear","keydown input[type=text]":"keyHandler"},initialize:function(e){this.owner=e.owner,this.$searchInput=this.$el.find("input[type=text]")},search:function(e){var r=this.$searchInput.val();this.owner.refresh(t.extend({searchString:r},e)),r?this.$el.find(".button.searchClear").addClass("up"):this.$el.find(".button.searchClear").removeClass("up")},clearInput:function(){this.$searchInput.val("")},clear:function(){this.clearInput(),this.clickHandler(),this.trigger("clear",this)},clearSilently:function(){this.clearInput(),delete this.owner.context.searchString,this.owner.refresh(t.extend({searchString:""},this.owner.context)),this.$el.find(".button.searchClear").removeClass("up")},clickHandler:function(){delete this.owner.context.searchString,this.search(this.owner.context),this.trigger("search",this.owner.context)},keyHandler:function(e){13===e.which&&this.clickHandler()},setSearchString:function(e){this.$searchInput.val(e)}});return i.extend({initialize:function(e){this.searchParameter=e&&e.searchParameter||"q",this.additionalParams=e&&e.additionalParams},dataLayerObtained:function(e){var n=this;if(!e.__searchPluginExtended){var i=e.getDataUri,a=this.searchParameter;e.getDataUri=function(e){var s=i.apply(this,arguments),c={};return e.searchString&&(c[a]=e.searchString),n.additionalParams&&t.extend(c,n.additionalParams,t.pick(e,t.keys(n.additionalParams))),s+=(-1===s.indexOf("?")?"?":"&")+r.param(c,!0)},e.__searchPluginExtended=!0}}},{treeInitialized:function(e){e=e||{};var t=this;this.searchForm=new s({owner:this}),e.dfdRenderTo?e.dfdRenderTo.done(function(e){e.prepend(t.searchForm.render().el)}):this.$el.prepend(this.searchForm.render().el)},treeRemoved:function(){this.searchForm.remove()}})});