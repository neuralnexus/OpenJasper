define(["require","jquery","underscore","common/model/BaseModel","backbone.validation","bundle!js-sdk/RepositoryResourceBundle","common/util/i18nMessage","common/enum/httpStatusCodes","request"],function(e){"use strict";function t(e,t,r,n,i){return u({type:t,dataType:"json",url:e.contextPath+"/rest_v2/resources"+r+"?overwrite="+n+"&createFolders="+i,headers:{Accept:"application/json","Content-Location":e.get("uri")}}).done(function(t){e.set("uri",t.uri)})}var r=e("jquery"),n=e("underscore"),i=e("common/model/BaseModel"),o=e("backbone.validation"),s=e("bundle!js-sdk/RepositoryResourceBundle"),a=e("common/util/i18nMessage").extend({bundle:s}),u=(e("common/enum/httpStatusCodes"),e("request")),c={LABEL_MAX_LENGTH:100,NAME_MAX_LENGTH:100,DESCRIPTION_MAX_LENGTH:250,NAME_NOT_SUPPORTED_SYMBOLS:"~!#\\$%^|\\s`@&*()\\-+={}\\[\\]:;\"'\\<\\>,?/\\|\\\\"},d=/application\/repository\.([^\+]+)\+json/,l=i.extend({idAttribute:"uri",type:void 0,urlRoot:function(){return(this.contextPath||"")+"/rest_v2/resources"},defaults:{name:void 0,parentFolderUri:void 0,uri:void 0,label:void 0,description:void 0,permissionMask:void 0,creationDate:void 0,updateDate:void 0,version:void 0},validation:{name:function(e,t,r){return e&&e.length>c.NAME_MAX_LENGTH?new a("error.field.max.length","name",c.NAME_MAX_LENGTH):e&&new RegExp("["+c.NAME_NOT_SUPPORTED_SYMBOLS+"]","g").test(e)?new a("error.field.bad.symbols","name",c.NAME_NOT_SUPPORTED_SYMBOLS):void 0},label:function(e,t,r){return n.isEmpty(e)?new a("error.field.required","label"):e.length>c.LABEL_MAX_LENGTH?new a("error.field.max.length","label",c.LABEL_MAX_LENGTH):void 0},description:function(e,t,r){if(e&&e.length>c.DESCRIPTION_MAX_LENGTH)return new a("error.field.max.length","description",c.DESCRIPTION_MAX_LENGTH)},parentFolderUri:[{required:!0,msg:new a("error.field.required","parentFolderUri")}]},url:function(){return this.isNew()?this.urlRoot()+encodeURI(this.get("parentFolderUri")):this.urlRoot()+encodeURI(this.id)},constructor:function(e,t){t||(t={}),n.defaults(t,{parse:!0}),i.call(this,e,t)},initialize:function(e,t){this.contextPath=t.contextPath,t.type&&(this.type=t.type),this.on("change:parentFolderUri change:name",this._updateUri),this.on("change:uri",this._updateNameAndParentFolderUri),i.prototype.initialize.apply(this,arguments)},clone:function(){return new this.constructor(this.attributes,{contextPath:this.contextPath})},parse:function(e){return void 0!==e.uri?(e.name=l.getNameFromUri(e.uri),e.parentFolderUri=l.getParentFolderFromUri(e.uri)):e.parentFolderUri&&e.name&&(e.uri=l.constructUri(e.parentFolderUri,e.name)),e},toJSON:function(){var e=this.serialize();return delete e.name,delete e.parentFolderUri,e},_updateUri:function(){var e=this.get("name"),t=this.get("parentFolderUri"),r=l.constructUri(t,e);r&&this.set("uri",r)},_updateNameAndParentFolderUri:function(){var e=this.get("uri"),t=l.getNameFromUri(e),r=l.getParentFolderFromUri(e);this.set({name:t,parentFolderUri:r})},fetch:function(e){return n.defaults(e||(e={}),{headers:{Accept:"application/json"}}),e.url=this.url()+"?expanded="+(!0===e.expanded),delete e.expanded,i.prototype.fetch.call(this,e)},sync:function(e,t,r){if("read"===e){var n=r.success,o=this;r.success=function(e,t,r){var i=r.getResponseHeader("Content-Type"),s=d.exec(i);if(!s||!s[1])throw new Error("Unsupported response content type: "+i);o.type=s[1],n&&n(e,t,r)}}return i.prototype.sync.call(this,e,t,r)},save:function(e,t,r){var o;if(n.isUndefined(e)||n.isNull(e)||n.isObject(e)?(o=e||{},r=t):(o={})[e]=t,!this.type)throw new Error("Resource type is unspecified. It's not possible to save a resource without it's type specified");return n.defaults(r||(r={}),{headers:{Accept:"application/json","Content-Type":"application/repository."+this.type+"+json; charset=UTF-8"}}),r=this._getSaveUrlOptions(r),i.prototype.save.call(this,o,r)},_getSaveUrlOptions:function(e){var t=this.url()+"?createFolders="+(!0===e.createFolders);return t+="&overwrite="+(!0===e.overwrite),t+="&expanded="+(!0===e.expanded),t+="&dry-run="+(!0===e.dryRun),e=n.omit(e,["createFolders","overwrite","expanded","dryRun"]),e=n.extend({},e,{url:t})},isWritable:function(){var e=this.get("permissionMask"),t=!1;return n.isUndefined(e)||(t=1===e||4&e),t},checkLabelExistenceOnServer:function(){var e=this.get("label"),t=this.get("parentFolderUri");return this.operationInProgress=r.Deferred(),u({type:"GET",dataType:"json",url:this.contextPath+"/rest_v2/resources?folderUri="+t+"&q="+encodeURIComponent(e)+"&recursive=false",headers:{Accept:"application/json"}}).done(this._checkLabelExistenceOnServerDone.bind(this)).fail(this._checkLabelExistenceOnServerFail.bind(this)),this.operationInProgress},_checkLabelExistenceOnServerDone:function(e,t,r){var n=[];e&&e.resourceLookup&&e.resourceLookup.length>0&&(n=e.resourceLookup),this.operationInProgress.resolve({foundResources:n})},_checkLabelExistenceOnServerFail:function(e){404===e.status?this.operationInProgress.resolve({foundResources:[]}):this.operationInProgress.reject(e)},copyTo:function(e,r,n){return t(this,"POST",e,!!r,arguments.length<3||n)},moveTo:function(e,r,n){return t(this,"PUT",e,!!r,arguments.length<3||n)}},{settings:c,getNameFromUri:function(e){if(e){var t=e.split("/");return t[t.length-1]}},getParentFolderFromUri:function(e){if(e){var t=e.split("/");return 2===t.length&&""!==t[1]?"/":t.slice(0,t.length-1).join("/")}},constructUri:function(e,t){if(t&&e)return-1!==e.indexOf("/",e.length-1)?e+t:e+"/"+t},generateResourceName:function(e){var t="";return e&&(t=e.replace(new RegExp("["+l.settings.NAME_NOT_SUPPORTED_SYMBOLS+"]","g"),"_")),t}});return n.extend(l.prototype,o.mixin),l});