define(["require","common/component/tree/Tree","jquery","underscore","bundle!CommonBundle","common/component/tree/TreeDataLayer","bi/repository/dialog/processor/factory/processorFactory","common/component/tree/plugin/TooltipPlugin","bi/repository/enum/repositoryResourceTypes","bi/repository/enum/olapConnectionTypesEnum","text!../dialog/resourceChooser/template/repositoryFolderChooserDialogTooltipTemplate.htm","text!../dialog/resourceChooser/template/repositoryFoldersTreeLevelTemplate.htm","settings/generalSettings","jrs.configs"],function(e){"use strict";function t(e){var t=m.extend({},{i18n:y,contentTemplate:L},e.tooltipOptions);return e.constr||p.use(T,t).create()}function r(e){e=e||{};var r=e.processors=m.map(e.processors,function(e){return f(e)});return t(e).instance({listItemHeight:O,bufferSize:e.treeBufferSize||b,additionalCssClasses:"folders",collapserSelector:e.collapserSelector,openClass:e.openClass,closedClass:e.closedClass,levelDataId:"uri",itemsTemplate:e.treeItemsTemplate||C,collapsed:!0,lazyLoad:!0,rootless:!0,getDataUri:m.partial(l,{containerType:e.containerType,types:e.types,isList:!1}),selection:{allowed:!0,multiple:!1},customDataLayers:{"/":s(e)},processors:r,getDataArray:function(e){if(e&&e[g.RESOURCE_LOOKUP]){e=e[g.RESOURCE_LOOKUP];var t=this.levelDataId;return m.first(e)[t].match(/^\/public/)||(e=m.map(e,function(e){return e.uri="/root"+e[t],e})),e}return[]},getDataSize:function(e,t,r){return+r.getResponseHeader("Total-Count")},getDataLayer:i})}function o(e){var t=[],r=f("filterPublicFolderProcessor");return m.each(e,function(e){e!==r&&t.push(e)}),t}function s(e){var t=e.processors,r=o(t);return m.extend(new d({dataUriTemplate:e.contextPath+"/flow.html?_flowId=searchFlow&method=getNode&provider=repositoryExplorerTreeFoldersProvider&uri=/&depth=1",processors:r,getDataArray:function(e){e=JSON.parse(u(e).text());var t=m.find(e.children,function(e){return"/public"===e.uri}),r=[{id:"/root",label:e.label,uri:"/",resourceType:"folder",permissionMask:c(e.extra),_links:{content:"@fakeContentLink"}}];return t&&r.push({id:"/public",label:t.label,uri:"/public",resourceType:"folder",permissionMask:c(t.extra),_links:{content:"@fakeContentLink"}}),r}}),{accept:"text/html",dataType:"text"})}function a(e){var r=n(),o=e.processors;return t(e).instance({itemsTemplate:e.treeItemsTemplate||C,listItemHeight:O,selection:{allowed:!0,multiple:!1},rootless:!0,collapsed:!0,lazyLoad:!0,getDataUri:m.partial(l,{containerType:e.containerType,types:e.types,isList:!0}),levelDataId:"uri",cache:{searchKey:"searchString",pageSize:100},processors:o,customDataLayers:{olapDataLayer:r},getDataLayer:i,getDataArray:function(e){return e&&e[g.RESOURCE_LOOKUP]?e[g.RESOURCE_LOOKUP]:[]},getDataSize:function(e,t,r){return+r.getResponseHeader("Total-Count")}})}function n(){return new d({requestType:"POST",dataUriTemplate:D.contextPath+"/rest_v2/connections",processors:[f("i18nItemProcessor"),f("cssClassItemProcessor")],levelDataId:"uri",getDataArray:function(e){return e&&e[g.RESOURCE_LOOKUP]?e[g.RESOURCE_LOOKUP]:[]}})}function i(e){var t;if(e=e.item?e:this.getLevel(e.id)){if(t=e.item.value.resourceType,m.contains(h,t)){var r=m.clone(this.customDataLayers.olapDataLayer);return m.extend(r,{accept:"application/repository."+t+".metadata+json",contentType:"application/repository."+t+"+json",data:JSON.stringify(t)}),r}return this.customDataLayers&&this.customDataLayers[e.id]?this.customDataLayers[e.id]:this.defaultDataLayer}}function l(e,t){var r,o,s=D.contextPath+"/rest_v2/api/resources?";return r=t.id.match(/^\/root/)?t.id.replace("/root",""):t.id,r&&(s+="folderUri="+r),o=e.isList?R:P,e.containerType&&(o=o+"&containerType="+e.containerType),s+o+"&type="+e.types.join("&type=")+m.template(S)(t)}function c(e){var t=2;return e.isWritable&&(t|=4),e.isRemovable&&(t|=16),e.isAdministrable&&(t=1),t}var p=e("common/component/tree/Tree"),u=e("jquery"),m=e("underscore"),y=e("bundle!CommonBundle"),d=e("common/component/tree/TreeDataLayer"),f=e("bi/repository/dialog/processor/factory/processorFactory"),T=e("common/component/tree/plugin/TooltipPlugin"),g=e("bi/repository/enum/repositoryResourceTypes"),h=e("bi/repository/enum/olapConnectionTypesEnum"),L=e("text!../dialog/resourceChooser/template/repositoryFolderChooserDialogTooltipTemplate.htm"),C=e("text!../dialog/resourceChooser/template/repositoryFoldersTreeLevelTemplate.htm"),v=e("settings/generalSettings"),D=e("jrs.configs"),O=22,b=5e3,S="&offset={{= offset }}&limit={{= limit }}&forceTotalCount=true&forceFullPage=true",P="&recursive=false",R="&recursive=true",U=function(e){if(e=e||{},!e.types)throw"Resources types required";return e.listView?a(e):r(e)};return U.settings=v,U});