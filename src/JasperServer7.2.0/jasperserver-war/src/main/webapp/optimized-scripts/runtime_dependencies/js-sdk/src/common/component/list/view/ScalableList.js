define(["require","jquery","backbone","underscore","common/component/list/model/ScalableListModel","text!common/component/list/templates/viewPortChunksTemplate.htm","text!common/component/list/templates/itemsTemplate.htm"],function(t){"use strict";var e=t("jquery"),i=t("backbone"),s=t("underscore"),h=t("common/component/list/model/ScalableListModel"),n=t("text!common/component/list/templates/viewPortChunksTemplate.htm"),o=t("text!common/component/list/templates/itemsTemplate.htm");return i.View.extend({ListModel:h,listItemSelector:"li",events:{scroll:"onScroll",touchmove:"onScroll"},attributes:{style:"overflow-y: auto; height: 100px"},initialize:function(t){return s.bindAll(this,"_fetchVisibleData"),this.model=t.model||new this.ListModel(t),this.chunksTemplate=s.template(t.chunksTemplate||n),this.itemsTemplate=s.template(t.itemsTemplate||o),this.defaultChunkHeight=this.chunkHeight=t.chunkHeight||1e6,this.scrollTimeout=void 0!==t.scrollTimeout?t.scrollTimeout:50,this.manualScrollInterval=t.manualScrollInterval||50,this.lazy=t.lazy,this.defaultItemHeight=t.listItemHeight||21,this.listItemSelector=t.listItemSelector||this.listItemSelector,this.render(),this.initListeners(),this.lazy||this.model.fetch(),this},initListeners:function(){this.listenTo(this.model,"change",this.onModelChange,this),this.listenTo(this.model,"fetchFailed",this.onFetchFailed,this)},render:function(){return this},onScroll:function(t){this.scrollTimeout>0?(clearTimeout(this.scrollTimer),this.scrollTimer=setTimeout(this._fetchVisibleData,this.scrollTimeout)):this._fetchVisibleData()},onModelChange:function(){this.renderData()},onFetchFailed:function(t,e){this.trigger("listRenderError",t,e)},postProcessChunkModelItem:function(t,i){t.index=this.model.get("bufferStartIndex")+i,void 0===t.label&&(t.label=t.value),t.label=e.trim(t.label)},_renderItems:function(){var t=this.model.get("bufferStartIndex"),i=this.model.get("bufferEndIndex"),s=this.itemsPerChunk?Math.ceil((t+1)/this.itemsPerChunk):1,h=this.itemsPerChunk?Math.ceil((i+1)/this.itemsPerChunk):1,n=this;this.$el.find(".j-view-port-chunk").each(function(o,l){var r=n._getChunkModel({index:o+1,firstChunkWithData:s,lastChunkWithData:h,bufferStart:t,bufferEnd:i,total:n.totalItems,itemsPerChunk:n.itemsPerChunk,itemHeight:n.itemHeight,chunkHeight:n.chunkHeight,model:n.model}),a=r?n.itemsTemplate(r):"";e(l).html(a)})},_renderViewChunks:function(t){(this.totalItems!==this.model.get("total")||t)&&(this.totalItems=this.model.get("total"),this.$el.html(this.chunksTemplate({_:s,chunks:this._getViewChunksModel()})),this.$firstViewChunk=this.$el.find(".j-view-port-chunk:first"))},_getViewChunksModel:function(){for(var t=this.itemsPerChunk?Math.ceil(this.totalItems/this.itemsPerChunk):1,e=t>0?this.itemHeight?this.totalItems*this.itemHeight-(t-1)*this.chunkHeight:this.chunkHeight:1,i=[],s=1;s<t;s++)i.push({height:this.chunkHeight});return i.push({height:e}),i},_calcViewPortConstants:function(t){t=t||{},this.viewPortConstantsInitialized||(this.itemHeight=this.defaultItemHeight,this.$firstViewChunk&&(this.itemHeight=this.$el.find(this.listItemSelector+":first").outerHeight(!0),!this.itemHeight||this.itemHeight<=2?(this.itemHeight=this.defaultItemHeight,this.viewPortConstantsInitialized=!1):this.viewPortConstantsInitialized=!0),this._calcViewPortHeight(),this.itemsPerChunk=Math.floor(this.defaultChunkHeight/this.itemHeight),this.chunkHeight=this.itemsPerChunk*this.itemHeight,this._renderViewChunks(!0),this._renderItems())},_calcViewPortHeight:function(){this.viewPortHeight=this.$el.height(),this.itemsPerView=Math.floor(this.viewPortHeight/this.itemHeight)-1},_getItemsPerView:function(){return this._renderData(),this.itemsPerView},_getChunkModel:function(t){var e=t.index;if(e<t.firstChunkWithData||e>t.lastChunkWithData)return null;var i=t.itemsPerChunk?Math.max(t.bufferStart,t.itemsPerChunk*(e-1)):t.bufferStart,h=t.itemsPerChunk?Math.min(t.bufferEnd,t.itemsPerChunk*e-1):t.bufferEnd,n=t.itemHeight?i*t.itemHeight-(e-1)*t.chunkHeight:0,o=Array.prototype.slice.call(t.model.get("items"),i-t.bufferStart,h-t.bufferStart+1);return s.each(o,function(e,s){this.postProcessChunkModelItem(e,s+(i-t.bufferStart))},this),{top:n,items:o}},_fetchVisibleData:function(){var t=this._getVisibleItems();this.model.fetch({top:t.top,bottom:t.bottom})},_getVisibleItems:function(){var t=this._getScrollPos(),e=this.model.get("total"),i=Math.min(e-this.itemsPerView,Math.floor(t/this.itemHeight));return{top:i,bottom:Math.min(e-1,i+this.itemsPerView+1)}},_getScrollPos:function(){this._renderData();var t=0;if(this.$firstViewChunk){var e=this.$el.offset(),i=this.$firstViewChunk.offset();e&&i&&(t=e.top-i.top)}return t},renderData:function(){return!this.lazy&&this.model.has("bufferStartIndex")&&this.model.has("bufferEndIndex")?this._renderData():(this.lazy=null,this.model.fetch()),this},_renderData:function(){this.trigger("before:render:data"),this._renderViewChunks(),this._renderItems(),this._calcViewPortConstants(),this.trigger("render:data")},resize:function(){if(this.$el.is(":visible")){var t=this.$el.outerHeight();t!==this._componentHeight&&(this._componentHeight=t,this.viewPortConstantsInitialized=!1,this._renderData())}},fetch:function(t,e){this.lazy=!1,e=e||{};var i;e.keepPosition?i=this.$el.get(0).scrollTop:this.reset({silent:!0,lazy:!1}),this.model.once("change",function(){e.keepPosition&&this.$el.scrollTop(i),t&&t.apply(this,arguments)},this).fetch({force:!0})},reset:function(t){t=s.defaults(t||{},{lazy:!0}),this.$el.scrollTop(0),this.lazy=t.lazy,this.model.reset(t)},scrollTo:function(t){if("number"==typeof t){var e=this._getScrollPos();if(this.viewPortConstantsInitialized){this._calcViewPortHeight();var i=null,s=t*this.itemHeight;s<e?i=s:s+this.itemHeight>e+this.viewPortHeight&&(i=s+this.itemHeight-this.viewPortHeight),null!==i&&this.$el.scrollTop(i)}}}})});