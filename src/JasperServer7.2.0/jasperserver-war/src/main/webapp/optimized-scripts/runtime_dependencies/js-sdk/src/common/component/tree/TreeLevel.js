define(["require","underscore","common/component/panel/Panel","common/component/panel/trait/collapsiblePanelTrait","common/component/list/view/ListWithSelection","common/component/tree/trait/addToSelectionModelTrait","common/component/list/model/ListWithSelectionModel","common/component/tree/plugin/TooltipPlugin","./dataprovider/DataProviderWithSearchCache"],function(t){"use strict";function e(){this.$el.removeClass(this.loadingClass).addClass(this.openClass),r.invoke(this.plugins,"itemsRendered",this.list.model,this.list);var t=this.list.$("> .j-view-port-chunk > ul > li").addClass(this.cid).length,e=r.isFunction(this.levelHeight)?this.levelHeight():this.levelHeight;e&&t*this.listItemHeight>e?this.list.$el.css({height:e+"px","overflow-y":"auto"}):this.list.$el.css({height:"auto",overflow:"auto"}),this.list._calcViewPortHeight(),this._isReady=!0,this.trigger("ready",this)}function i(t,e){this.listRenderError=!0,this.trigger("listRenderError",t,e,this)}function s(t){var e=[];r.chain(t).keys(t).each(function(i){e.push(t[i])}),this.selection.multiple||a(this),this.trigger("selection:change",e,this,[])}function n(t){var e=[];r.chain(t).keys(t).each(function(i){e.push(t[i])}),this.selection.multiple||a(this),this.trigger("item:dblclick",e)}function o(t,e){for(var i=0;i<e.length;i++)if(e[i]===t)return!0}function l(t,e,i,s){i&&i.exclude&&r.isArray(i.exclude)&&o(t,i.exclude)||(void 0===s||s>0)&&r.chain(t.items).keys().each(function(n){i&&i.exclude&&r.isArray(i.exclude)&&o(t.items[n],i.exclude)||e.call(t.items[n],i),l(t.items[n],e,i,void 0===s?s:--s)})}function a(t,e){e=e&&{exclude:e.exclude},l(t,function(t){this.list.clearSelection(),this.list.model.selection=[]},e)}var r=t("underscore"),h=t("common/component/panel/Panel"),c=t("common/component/panel/trait/collapsiblePanelTrait"),d=t("common/component/list/view/ListWithSelection"),u=t("common/component/tree/trait/addToSelectionModelTrait"),p=t("common/component/list/model/ListWithSelectionModel").extend(u),m=(t("common/component/tree/plugin/TooltipPlugin"),t("./dataprovider/DataProviderWithSearchCache"));return h.extend({constructor:function(t){t||(t={}),r.extend(t,{traits:[c]}),h.prototype.constructor.call(this,t)},initialize:function(t){t||(t={}),this._isReady=!1,this.item=t.item||{},this.id=this.item.id,this.owner=t.owner,this.parent=t.parent,this.itemsTemplate=t.itemsTemplate,this.listItemHeight=t.listItemHeight,this.levelHeight=t.levelHeight,this.lazyLoad=!!t.lazyLoad,this.selection=t.selection||{allowed:!1,multiple:!1},this.resource=this.item.value,this.bufferSize=t.bufferSize,this.cache=void 0!==t.cache&&t.cache,this.allowMouseDownEventPropagation=t.allowMouseDownEventPropagation,this.items={},this.plugins=[];for(var e={el:this.el,model:this.model},i=0,s=t.plugins.length;i<s;i++){var n=t.plugins[i].constr;this.plugins.push(new n(r.extend({},e,t.plugins[i].options)))}this.dataLayer=this.owner.getDataLayer(this),r.invoke(this.plugins,"dataLayerObtained",this.dataLayer),h.prototype.initialize.apply(this,arguments)},render:function(){var t=new p({bufferSize:this.bufferSize,getData:this._getDataProvider(this.cache)});return this.list=new d({markerClass:"."+this.cid,eventListenerPattern:"."+this.cid+":not(.readonly) > p",el:this.$contentContainer,itemsTemplate:this.itemsTemplate,listItemHeight:this.listItemHeight,lazy:!0,selection:this.selection,allowMouseDownEventPropagation:this.allowMouseDownEventPropagation,model:t}),this.list.on("render:data",r.bind(e,this)),this.list.on("listRenderError",r.bind(i,this)),this.list.on("selection:change",r.bind(s,this)),this.list.on("item:dblclick",r.bind(n,this)),this.lazyLoad?this.on("open",this._onOpen,this):this.list.renderData(),this},_getDataProvider:function(t){var e=this,i=r.bind(function(t){return this.obtainData(t,e)},this.dataLayer),s={};return t&&("object"==typeof t&&(s=r.extend(s,t)),s.request=s.request||i,this.dataProvider=new m(s),i=this.dataProvider.getData),function(t){return t||(t={offset:0,limit:100}),t.id=e.id,i(r.extend({},e.owner.context,t),e)}},_onOpen:function(){this.$el.removeClass(this.openClass).addClass(this.loadingClass),this.list.renderData()},setElement:function(t){var e=h.prototype.setElement.apply(this,arguments);return this.list&&(this.list.setElement(this.$contentContainer),this.list.totalItems=-1),r.each(this.plugins,function(e){e.setElement(t)}),this.lazyLoad||this.list&&this.list.renderData(),this.collapsed||(this.open({silent:!0,depth:0}),this.lazyLoad&&this.list.renderData()),e},open:function(t){l(this,h.prototype.open,t,t?t.depth:0),h.prototype.open.call(this,t)},close:function(t){h.prototype.close.call(this,t),l(this,h.prototype.close,t,t?t.depth:void 0),a(this)},getLevel:function(t){return r(this.items).reduce(function(e,i){return e||(i.id===t?i:i.getLevel(t))},!1)},refresh:function(t){this.listRenderError||(this.lazyLoad&&!this.collapsed||!this.lazyLoad?(this.once("ready",r.bind(l,this,this,this.refresh,t,1)),this.list.model.fetch({top:0,bottom:this.list.model.bufferSize,force:!0}),this.list.scrollTo(0)):(this.list.model.set("bufferStartIndex",void 0,{silent:!0}),this.list.model.set("bufferEndIndex",void 0,{silent:!0}),this.list.model.set("total",void 0,{silent:!0}),l(this,this.refresh,t)))},fetch:function(t,e){this.list.fetch(e,t)},recalcConstraints:function(){this.list.resize()},fetchVisibleData:function(){this.list._fetchVisibleData()},resetSelection:function(t){a(this,t),t&&t.silent||this.trigger("selection:change",[])},hasItems:function(){return!!this.$("> .subcontainer > .j-view-port-chunk > ul > li").length},clearCache:function(){r.each(this.items,function(t){t.clearCache()}),this.dataProvider&&this.dataProvider.clear()},remove:function(){var t=this,e=-1;if(r.forEach(r.keys(this.items),function(e){t.items[e].remove()}),this.dataProvider&&this.dataProvider.clear(),this.list.remove(),this.parent){var i=this.parent.id,s=this.owner.getDataLayer(i);if(s&&s.predefinedData&&s.predefinedData[i]&&r.isArray(s.predefinedData[i])){for(var n=0;n<s.predefinedData[i].length;n++)if(s.predefinedData[i][n].id===this.id){e=n;break}e>-1&&(s.predefinedData[i].splice(e,1),delete s.predefinedData[this.id])}delete this.parent.items[this.id]}h.prototype.remove.apply(this,arguments)},isReady:function(){return this._isReady}})});