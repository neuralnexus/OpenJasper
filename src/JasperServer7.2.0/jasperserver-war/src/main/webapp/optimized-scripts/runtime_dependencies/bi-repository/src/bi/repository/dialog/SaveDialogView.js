define(["require","underscore","bundle!CommonBundle","bundle!RepositoryResourceBundle","common/component/dialog/DialogWithModelInputValidation","common/component/dialog/ConfirmationDialog","bi/repository/factory/repositoryTreeFactory","bi/repository/enum/repositoryResourceTypes","text!./resourceChooser/template/saveDialogTemplate.htm","../util/errorHandling","common/component/notification/Notification"],function(e){"use strict";var o=e("underscore"),t=e("bundle!CommonBundle"),i=e("bundle!RepositoryResourceBundle"),s=e("common/component/dialog/DialogWithModelInputValidation"),n=e("common/component/dialog/ConfirmationDialog"),r=e("bi/repository/factory/repositoryTreeFactory"),l=e("bi/repository/enum/repositoryResourceTypes"),a=e("text!./resourceChooser/template/saveDialogTemplate.htm"),c=e("../util/errorHandling").mapXhrErrorToMessage,h=e("common/component/notification/Notification"),d={};return s.extend({constructor:function(e){e||(e={}),d=o.extend({},e),this.isDialogOpened=!1,this.errorMessages=e.errorMessages||{};var n=e.additionalCssClasses||"",r=e.title||i["dialog.saveDialog.title"],l=e.label||i["dialog.saveDialog.label"],c=e.description||i["dialog.saveDialog.description"];this.showNotification=e.showNotification||!0,this.notificationSuccessMessage=e.notificationSuccessMessage||i["dialog.saveDialog.notification.successMessage"],this.confirmationDialogTitle=e.confirmationDialogTitle||i["dialog.saveDialog.confirm.title"],this.confirmationDialogText=e.confirmationDialogText||i["dialog.saveDialog.confirm.conflict"];var h=e.folderTreeOptions||{};s.prototype.constructor.call(this,{modal:!0,resizable:!0,handles:e.handles,minWidth:e.minWidth||440,minHeight:e.minHeight||520,maxHeight:e.maxHeight||574,originalModel:e.model,defaultSelectedFolder:e.defaultSelectedFolder,additionalCssClasses:n+" saveAs",folderTreeOptions:h,title:e.title||i["dialog.saveDialog.title"],template:e.template,dialogButtonTemplate:e.dialogButtonTemplate,content:o.template(e.dialogContentTemplate||a)({title:r,label:l,description:c}),buttons:[{label:t["button.save"],action:"save",primary:!0},{label:t["button.cancel"],action:"cancel",primary:!1}]}),this.on("button:save",o.bind(this._saveButtonClick,this)),this.on("button:cancel",o.bind(this._cancelButtonClick,this))},initialize:function(e){var t=this;s.prototype.initialize.apply(this,arguments),this.originalModel=e.originalModel,this.mapXhrErrorToMessage=e.mapXhrErrorToMessage||c,e.tooltipOptions&&(e.tooltipOptions.attachTo=this.$el),this._defaultSelectedFolder=e.defaultSelectedFolder,this.foldersTree=r({treeBufferSize:e.folderTreeOptions.treeBufferSize,treeItemsTemplate:e.folderTreeOptions.treeItemsTemplate,collapserSelector:e.folderTreeOptions.collapserSelector,openClass:e.folderTreeOptions.treeNodeIsOpenedClass,closedClass:e.folderTreeOptions.treeNodeIsClosedClass,processors:["folderTreeProcessor","treeNodeProcessor","i18nItemProcessor","filterPublicFolderProcessor","cssClassItemProcessor","fakeUriProcessor"],types:[l.FOLDER],tooltipOptions:{attachTo:this.$el}}),this.notification=new h,this.listenTo(this.foldersTree,"selection:change",function(e){var i,s=Object.keys(e)[0];e&&s&&o.isArray(e)&&e[s]&&e[s].uri&&(i=e[s].uri),t.model.set("parentFolderUri",i),t.enableButton("save")});var i=e.folderTreeOptions.treeContainerClass||".control.groupBox .body";this.$contentContainer.find(i).append(this.foldersTree.render().el),this.confirmationDialog=new n({title:this.confirmationDialogTitle,text:this.confirmationDialogText}),this.listenTo(this.confirmationDialog,"button:yes",this._yesButtonConfirmationDialogClick),this.listenTo(this.confirmationDialog,"button:no",this._noButtonConfirmationDialogClick)},save:function(){this.setTitle(d.title||i["dialog.saveDialog.title"]),this.model=this.getResourceOnSave(this.originalModel),this.model.isNew()?this._openDialog():this._saveModelOnServer()},saveAs:function(){this.setTitle(d.titleSaveAs||i["dialog.saveAsDialog.title"]),this._openDialog()},close:function(){this._closeDialog()},remove:function(){this._closeDialog(),this.notification.remove(),this.foldersTree.remove(),this.confirmationDialog.remove(),s.prototype.remove.apply(this,arguments)},_openDialog:function(){!0!==this.isDialogOpened&&(this.model=this.getResourceOnSaveAs(this.originalModel),this.bindValidation(),this.model&&o.each(this.model.attributes,function(e,o){this.$("[name="+o+"]").val(e)}.bind(this)),this._clearCommonErrorMessageOnDialog(),s.prototype.open.apply(this,arguments),this.disableButton("save"),this._preselectFolder(),this.isDialogOpened=!0)},_closeDialog:function(){!1!==this.isDialogOpened&&(this.foldersTree&&(this.foldersTree.collapse("/root",{silent:!0}),this.foldersTree.collapse("/public",{silent:!0}),this.foldersTree.resetSelection()),this.unbindValidation(),this.clearValidationErrors(),s.prototype.close.apply(this,arguments),this.model=void 0,this.isDialogOpened=!1)},_onDialogResize:function(){var e=this,o=0,t=this.$contentContainer.find(".control.groupBox.treeBox"),i=this.$contentContainer.closest(".jr-mDialog > .jr-mDialog-body");this.$contentContainer.children().not(t).each(function(){o+=e.$(this).outerHeight(!0)}),t.height(i.outerHeight(!0)-o-20)},_preselectFolder:function(){var e=!1;if(this._lastSelectedFolder?e=this._lastSelectedFolder:this._defaultSelectedFolder&&(e=this._defaultSelectedFolder),e){var o=this.foldersTree.$el.parent();this.foldersTree._selectTreeNode(e,o),this.model.set("parentFolderUri",e)}},_showNotification:function(e){var o=e.type||"success",t=e.message;this.showNotification&&t&&this.notification.show({message:t,type:o})},_showCommonErrorMessageOnDialog:function(e){var o=this.$("[name=commonErrorMessage]");o.addClass("error"),o.find("span").text(e)},_clearCommonErrorMessageOnDialog:function(){var e=this.$("[name=commonErrorMessage]");e.removeClass("error"),e.find("span").text("")},_findNameOfTheLabel:function(e){var t,i=this.model.get("label");return t=o.find(e,function(e){return e.label===i}),o.isUndefined(t)?null:t},_saveButtonClick:function(){this._clearCommonErrorMessageOnDialog(),this.model.validate(),this.model.isValid()&&(this._lastSelectedFolder=this.model.get("parentFolderUri"),this.disableButton("save"),this.disableButton("cancel"),this._checkIfLabelExistsOnServer())},_cancelButtonClick:function(){this._closeDialog()},_yesButtonConfirmationDialogClick:function(){this._saveModelOnServer({useExistingResource:!0})},_noButtonConfirmationDialogClick:function(){this.enableButton("save"),this.enableButton("cancel")},_checkIfLabelExistsOnServer:function(){return this._resourceOnTheServerWithTheSameLabel=null,this.model.checkLabelExistenceOnServer().done(this._checkIfLabelExistsOnServerDone.bind(this)).fail(this._checkIfLabelExistsOnServerFail.bind(this))},_checkIfLabelExistsOnServerDone:function(e){if(0===e.foundResources.length)return void this._saveModelOnServer({createNewResource:!0});var o=this._findNameOfTheLabel(e.foundResources);return null===o?void this._saveModelOnServer({createNewResource:!0}):o.uri===this.model.get("uri")?void this._saveModelOnServer():(this._resourceOnTheServerWithTheSameLabel=o,void this.confirmationDialog.open())},_checkIfLabelExistsOnServerFail:function(){this._showCommonErrorMessageOnDialog(i["error.unknown.error"]),this.enableButton("save"),this.enableButton("cancel")},_saveModelOnServer:function(e){var o;return e=e||{createNewResource:!1,useExistingResource:!1},this._clonedModelForSaving=this.model.clone(),this._clonedModelForSaving.type=this.model.type,!0===e.useExistingResource&&this._resourceOnTheServerWithTheSameLabel&&this._clonedModelForSaving.set({uri:this._resourceOnTheServerWithTheSameLabel.uri,version:this._resourceOnTheServerWithTheSameLabel.version},{silent:!0}),!0===e.createNewResource&&(this._clonedModelForSaving.set({version:""},{silent:!0}),this._clonedModelForSaving.unset("uri",{silent:!0})),o=this._getSaveOptions(e),this._clonedModelForSaving.save({},o)},_getSaveOptions:function(e){return{createFolders:!1,expanded:!0,overwrite:!0,success:this._saveModelOnServerDone.bind(this),error:this._saveModelOnServerFail.bind(this)}},_saveModelOnServerDone:function(e,o){this.model.set(this._clonedModelForSaving.attributes,{silent:!0}),this._clonedModelForSaving=void 0,this._showNotification({message:this.notificationSuccessMessage}),this.trigger("save",this,o),this._closeDialog()},_saveModelOnServerFail:function(e,o,t){this._clonedModelForSaving=void 0,this._openDialog(),this.enableButton("save"),this.enableButton("cancel");var i=this.mapXhrErrorToMessage(o,this.errorMessages);this._showCommonErrorMessageOnDialog(i),this.trigger("error",this,i)},getResourceOnSave:function(e){throw"This method should be overridden"},getResourceOnSaveAs:function(e){throw"This method should be overridden"}})});