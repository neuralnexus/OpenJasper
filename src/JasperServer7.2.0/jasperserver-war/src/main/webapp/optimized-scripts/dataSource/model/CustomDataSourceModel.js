define(["require","dataSource/model/BaseDataSourceModel","underscore","jquery","jrs.configs","requestSettings","dataSource/enum/connectionTypes","bi/repository/enum/repositoryResourceTypes","components.dialogs","bundle!all","bundle!jasperserver_config","text!common/templates/dialogErrorPopupTemplate.htm"],function(e){"use strict";var t=e("dataSource/model/BaseDataSourceModel"),i=e("underscore"),s=e("jquery"),o=e("jrs.configs"),r=e("requestSettings"),n=e("dataSource/enum/connectionTypes"),a=e("bi/repository/enum/repositoryResourceTypes"),u=e("components.dialogs"),p=e("bundle!all"),d=e("bundle!jasperserver_config"),l=e("text!common/templates/dialogErrorPopupTemplate.htm"),c=t.extend({type:a.CUSTOM_DATA_SOURCE,constructor:function(e,s){this.defaults=i.extend({},this.defaults,{dataSourceName:s.dataSourceType,connectionType:n.CUSTOM}),t.prototype.constructor.apply(this,arguments)},initialize:function(e,i){var o=t.prototype.initialize.apply(this,arguments);return this.customFields=[],this.testable=!1,this.queryTypes=null,this.initialization=s.Deferred(),this.getCustomFieldsDefinition(),o},getCustomFieldsDefinition:function(){var e={};return i.extend(e,r,{Accept:"application/json"}),s.ajax({type:"GET",headers:e,url:o.contextPath+"/rest_v2/customDataSources/"+this.get("dataSourceName")}).done(i.bind(this.getCustomFieldsDefinitionDone,this)).fail(i.bind(this.getCustomFieldsDefinitionFail,this))},getCustomFieldsDefinitionDone:function(e){var t=this;e&&e.propertyDefinitions&&i.isArray(e.propertyDefinitions)&&(this.resetValidation(),this.testable=!!e.testable,this.queryTypes=e.queryTypes?e.queryTypes:null,i.each(e.propertyDefinitions,function(e){var s={};e.properties&&(e.properties=i(e.properties).reduce(function(e,t){return e[t.key]=t.value,e},{})),t.customFields.push(e),t.defaults[e.name]=e.defaultValue,t.options.isEditMode||t.set(e.name,e.defaultValue),"password"===e.name&&t.options.isEditMode&&!t.isNew()&&t.set("password",d["input.password.substitution"]),e.properties&&e.properties.mandatory&&(s[e.name]={required:!0,msg:p[t.get("dataSourceName")+"."+e.name+".required"]||p["required.field.specify.value"]},i.extend(t.validation,s))})),this.options.isEditMode||this.set(this.parse(this.attributes),{silent:!0}),this.initialization.resolve()},getCustomFieldsDefinitionFail:function(e){var t=!1;try{t=JSON.parse(e.responseText)}catch(e){}var s=i.template(l,{message:"Failed to load custom data source definition. ",errorCode:t&&t[0]?t[0].errorCode:null,errorMsg:t&&t.message,respText:e.responseText});u.errorPopup.show(s)},parse:function(e){var s=t.prototype.parse.apply(this,arguments);return s=i.extend(s,this.parseProperties(e.properties)),delete e.properties,s},parseProperties:function(e){var t={};return i.isEmpty(e)||i.each(e,function(e){t[e.key]="password"===e.key?d["input.password.substitution"]:e.value}),t},toJSON:function(){var e=t.prototype.toJSON.apply(this,arguments);return this.customFieldsToJSON(e,this.customFields)},customFieldsToJSON:function(e,t){return i.isEmpty(t)||(e.properties=[],i.each(t,function(t){var s=e[t.name],o="password"===t.name;i.isUndefined(s)||(!o||o&&s!==d["input.password.substitution"])&&(e.properties.push({key:t.name,value:s}),delete e[t.name])})),e},resetValidation:function(){this.validation=i.clone(c.prototype.validation)}});return c});