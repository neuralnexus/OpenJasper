define(["require","backbone","underscore","jquery","bundle!all","dataSource/model/BaseDataSourceModel","touchcontroller","common/util/featureDetection","util/historyHelper","dataSource/factory/dataSourceViewFactory","dataSource/enum/dataSourceResourceTypes","dataSource/factory/saveDialogViewFactory","text!dataSource/template/dataSourceMainTemplate.htm","text!common/templates/dialogErrorPopupTemplate.htm","jrs.configs","dataSource/collection/CustomDataSourceCollection","settings!awsSettings","dataSource/util/settingsUtility"],function(e){"use strict";var t=e("backbone"),a=e("underscore"),o=e("jquery"),r=e("bundle!all"),i=e("dataSource/model/BaseDataSourceModel"),s=e("touchcontroller"),n=e("common/util/featureDetection"),c=e("util/historyHelper"),d=e("dataSource/factory/dataSourceViewFactory"),u=e("dataSource/enum/dataSourceResourceTypes"),l=e("dataSource/factory/saveDialogViewFactory"),h=e("text!dataSource/template/dataSourceMainTemplate.htm"),p=e("text!common/templates/dialogErrorPopupTemplate.htm"),S=e("jrs.configs"),m=e("dataSource/collection/CustomDataSourceCollection"),v=e("settings!awsSettings"),f=e("dataSource/util/settingsUtility"),g=a.template(S.contextPath+"/domaindesigner.html?dataSource={{-resourceUri}}");return t.View.extend({dataSourceType:!1,dataSourceView:!1,saveDialog:!1,events:{"change select[name='dataSourceType']":"onDataSourceTypeChange","click #saveBtn, #createDomainBtn":"onSaveClick","click #cancelBtn":"onCancelClick"},historyBackToken:"DataSourceControllerHistory",constructor:function(e){e=o.extend(!0,{},e),arguments[0]=e,this.isEditMode=e.isEditMode,t.View.apply(this,arguments)},initialize:function(e){this.options=e,this.dataSourceType=void 0,n.supportsTouch&&this.initSwipeScroll(),c.saveReferrer(this.historyBackToken),this.fetchingCustomDataSourcesDeferred=o.Deferred(),this.fetchingTheModelDeferred=o.Deferred(),this.customDataSourceCollection=new m,this.customDataSourceCollection.fetch().done(a.bind(function(){this.renderDataSourceContainer()},this));var t=f.deepDefaults(e,{awsSettings:v});if(this.options.resourceUri){var r=this,s=new i({uri:this.options.resourceUri});s.fetch().then(function(e,t,a){r.dataSource=s.attributes,r.dataSourceType=d.getViewType(a.getResponseHeader("Content-Type"),r.dataSource),r.fetchingTheModelDeferred.resolve()})}else this.options.dataSource&&this.options.dataSourceClientType?(this.dataSource=this.options.dataSource,this.dataSourceType=d.getViewType(this.options.dataSourceClientType,this.options.dataSource),this.fetchingTheModelDeferred.resolve()):(t.awsSettings.productTypeIsEc2&&(this.dataSourceType=d.getViewType(u.AWS,null)),this.fetchingTheModelDeferred.resolve())},renderDataSourceContainer:function(){var e={AZURE_SQL:"AzureSql",AWS:"Aws",BEAN:"Bean",JDBC:"JDBC",JNDI:"JNDI",VIRTUAL:"Virtual"},t=a.chain(e).map(function(e,t){return{value:u[t].toLowerCase(),label:r["resource.dataSource.dstype"+e]}}).value();this.customDataSourceCollection.forEach(function(e){var a=e.get("id");t.push({value:a,label:r[a+".name"]?r[a+".name"]:a})}),t=a.sortBy(t,function(e){return e.label.toLowerCase()}),this.$el.append(a.template(h,{dataSourceTypeOptions:t,i18n:r,supportsTouch:n.supportsTouch,isEditMode:this.isEditMode})),this.fetchingCustomDataSourcesDeferred.resolve()},initSwipeScroll:function(){var e=this.$("#stepDisplay");e.length&&new s(e.parent()[0],e.parent().parent()[0],{})},render:function(){o.when(this.fetchingCustomDataSourcesDeferred,this.fetchingTheModelDeferred).done(a.bind(function(){this._render()},this))},_render:function(){var e={};return this.dataSourceView&&(e={label:this.dataSourceView.model.get("label"),name:this.dataSourceView.model.get("name"),description:this.dataSourceView.model.get("description")}),this.dataSourceView&&this.dataSourceView.remove(),delete this.dataSourceView,0===this.$(".row.inputs .body:eq(0)").length&&this.$(".row.inputs > .column > .content").append("<div class='body dataSourceBody'></div>"),this.dataSourceType||(this.dataSourceType=u.JDBC.toLowerCase()),this.dataSourceView=d.getView(a.extend(this.options,{dataSourceType:this.dataSourceType,dataSource:a.extend({},this.dataSource,e),el:this.$(".row.inputs .body:eq(0)")})),this.$(".dataSourceBody").attr("dstype",this.dataSourceType.toLowerCase()),this.$("select[name='dataSourceType']").val(this.dataSourceType),this},onDataSourceTypeChange:function(e){var t=o(e.target).val();this.dataSourceType!=t&&(this.dataSourceType=t,this.render())},_prepareSaveDialog:function(e){this.saveDialog&&this.saveDialog.remove();var t=l.getView(this.dataSourceType);this.saveDialog=new t(a.extend({},this.options,{model:this.dataSourceView.model,saveFn:this.options.saveFn,success:a.bind(e?this._onSaveAndCreateDomainDone:this._onSaveDone,this),error:a.bind(this._onSaveFail,this)}))},onSaveClick:function(e){if(this.dataSourceView.model.isValid(!0)){var t=this,o=e&&"createDomainBtn"==e.currentTarget.id,r=function(){t._prepareSaveDialog(o),t.saveDialog.startSaveDialog()};return a.isUndefined(this.dataSourceView.model.validationMethodOnSaveClick)?a.isUndefined(this.dataSourceView.validationMethodOnSaveClick)?void r():void this.dataSourceView.validationMethodOnSaveClick(r):void this.dataSourceView.model.validationMethodOnSaveClick(r)}},_onSaveDone:function(){redirectToUrl(S.contextPath+"/flow.html?_flowId=repositoryConfirmFlow&resourceType=dataSource")},_onSaveAndCreateDomainDone:function(e){redirectToUrl(g({resourceUri:e.get("uri")}))},_onSaveFail:function(e,t){this.saveDialog&&(this.saveDialog.close(),this.saveDialog.remove());var o=this,i=!1,s=!1;try{i=JSON.parse(t.responseText)}catch(e){}if(a.isArray(i)||(i=[i]),a.each(i,function(e){var t=!1,a=!1;e&&("mandatory.parameter.error"===e.errorCode?e.parameters&&e.parameters[0]&&(a=r["resource.datasource.saveDialog.parameterIsMissing"],t=e.parameters[0].substr(e.parameters[0].indexOf(".")+1)):"illegal.parameter.value.error"===e.errorCode&&e.parameters&&e.parameters[0]&&(t=e.parameters[0].substr(e.parameters[0].indexOf(".")+1),a=r["resource.datasource.saveDialog.parameterIsWrong"]),"ConnectionUrl"===t&&(t="connectionUrl"),a&&t&&(o.dataSourceView.invalidField("[name="+t+"]",a),s=!0))}),!1===s){var n=a.template(p,{message:"Failed to save data source.",errorCode:i[0]?i[0].errorCode:null,errorMsg:i.message,respText:t.responseText});dialogs.errorPopup.show(n)}},onCancelClick:function(){this.options.cancelFn?this.options.cancelFn():c.restore(this.historyBackToken)}})});