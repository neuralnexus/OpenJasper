define(["require","underscore","bundle!jasperserver_messages","jrs.configs","request","dataSource/fileDataSource/enum/characterEncodings","dataSource/fileDataSource/enum/delimitersTextDataSource","dataSource/fileDataSource/FileDataSourceModel"],function(e){"use strict";var i=e("underscore"),r=e("bundle!jasperserver_messages"),t=e("jrs.configs"),l=e("request"),n=e("dataSource/fileDataSource/enum/characterEncodings"),o=e("dataSource/fileDataSource/enum/delimitersTextDataSource"),d=e("dataSource/fileDataSource/FileDataSourceModel");return d.extend({fileTypes:["txt","csv"],validation:function(){var e={};return i.extend(e,d.prototype.validation,{fieldDelimiterOther:[{fn:function(e,t,l){return"other"===l.fieldDelimiter&&(i.isNull(e)||i.isUndefined(e)||i.isString(e)&&""===e)?r["fillParameters.error.enter.field.delimiter"]:null}}],rowDelimiterOther:[{fn:function(e,t,l){return"other"===l.rowDelimiter&&(i.isNull(e)||i.isUndefined(e)||i.isString(e)&&""===e)?r["fillParameters.error.enter.row.delimiter"]:null}}]}),e}(),constructor:function(e,r){this.defaults=i.extend({},this.defaults,{fileSourceType:"repository",ftpsPort:"990",fieldDelimiter:"comma",rowDelimiter:"newLineWin",encodingType:"utf8",useFirstRowAsHeader:!0,prepareDataForReporting:!0}),d.prototype.constructor.apply(this,[e,r])},parse:function(){var e,r=d.prototype.parse.apply(this,arguments);return r.fieldDelimiterRegex="",r.fieldDelimiterPlugin="",r.fieldDelimiterOther="",e=i.find(o,function(e){return e.dbValue===r.fieldDelimiter}),i.isUndefined(e)?r.fieldDelimiter?(r.fieldDelimiterOther=r.fieldDelimiter,r.fieldDelimiter="other"):r.fieldDelimiter=this.defaults.fieldDelimiter:r.fieldDelimiter=e.value,r.rowDelimiterRegex="",r.rowDelimiterPlugin="",r.rowDelimiterOther="",e=i.find(o,function(e){return e.dbValue===r.recordDelimiter}),i.isUndefined(e)?r.fieldDelimiter?(r.rowDelimiterOther=r.recordDelimiter,r.rowDelimiter="other"):r.rowDelimiter=this.defaults.rowDelimiter:r.rowDelimiter=e.value,delete r.recordDelimiter,e=i.find(n,function(e){return e.dbValue===r.encoding}),r.encodingType=e?e.value:this.defaults.encodingType,delete r.encoding,r},customFieldsToJSON:function(e,r){return"other"===e.fieldDelimiter?e.fieldDelimiter=e.fieldDelimiterOther:e.fieldDelimiter=i.find(o,function(i){return i.value===e.fieldDelimiter}).dbValue,delete e.fieldDelimiterRegex,delete e.fieldDelimiterPlugin,delete e.fieldDelimiterOther,"other"===e.rowDelimiter?e.recordDelimiter=e.rowDelimiterOther:e.recordDelimiter=i.find(o,function(i){return i.value===e.rowDelimiter}).dbValue,delete e.rowDelimiter,delete e.rowDelimiterRegex,delete e.rowDelimiterPlugin,delete e.rowDelimiterOther,e.encoding=i.find(n,function(i){return i.value===e.encodingType}).dbValue,delete e.encodingType,d.prototype.customFieldsToJSON.call(this,e,r)},validationMethodOnSaveClick:function(e){var r=this,n=JSON.stringify(i.extend({},this.toJSON(),{uri:"/ignore"}));l({type:"POST",url:t.contextPath+"/rest_v2/connections",dataType:"json",data:n,headers:{"Content-Type":"application/repository.customDataSource+json",Accept:"application/table.metadata+json"}}).done(function(){r.trigger("sourceFileIsOK"),i.isFunction(e)&&e()}).fail(function(){r.trigger("sourceFileCantBeParsed")})}})});