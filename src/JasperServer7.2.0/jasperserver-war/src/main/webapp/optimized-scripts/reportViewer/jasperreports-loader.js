define(["require","jquery","jrs.configs"],function(e){"use strict";function r(e,r,o){var n=new a.Deferred;return a.ajax(e.url+(e.urlParams?"?"+e.urlParams:""),{type:"POST",dataType:r,data:e.params,beforeSend:function(e){"undefined"!=typeof ajax&&ajax.csrfRequestHeaders&&ajax.csrfRequestHeaders.each(function(r){e.setRequestHeader(r.key,r.value)})},success:function(e,r,a){t(a,o)?(Report&&Report.hideAjaxDialog&&Report.hideAjaxDialog(),n.reject(a,r)):n.resolve(e,r,a)},error:function(e,r,s){if(!t(e,o)&&e.status>=400){var i="<p>HTML response error code: "+e.status+", "+r+"</p>";if(e.responseText.indexOf('id="errorPageContent"')>=0)i+=a(e.responseText).find("#errorPageContent .body").html();else if(e.responseText.indexOf('{"result":{"msg":"')>=0){var c=JSON.parse(e.responseText);c.result.devmsg.indexOf("<#_#>")?(i="",a.each(c.result.devmsg.split("<#_#>"),function(){i+="<p>"+this+"</p>"})):i="<p>"+c.result.devmsg+"</p>"}else i+="<p>HTML response was: "+e.responseText+"</p>";var d=a("body"),l=d.hasClass("dashboardViewFrame"),h={reportUri:o,type:"responseError"};l&&window.reportFrameWidth&&window.reportFrameHeight&&(h.width=window.reportFrameWidth<parseInt(p,10)?window.reportFrameWidth-20+"px":p,h.height=window.reportFrameHeight<parseInt(u,10)?window.reportFrameHeight-20+"px":u,d.css({width:window.reportFrameWidth+"px",height:window.reportFrameHeight+"px"})),showErrorPopup(i,h),l&&!isIPad()&&d.css({width:"auto",height:"auto"})}Report&&Report.hideAjaxDialog&&Report.hideAjaxDialog(),n.reject(e,r)}}),n.promise()}function t(e,r){return e.getResponseHeader("LoginRequested")?(showErrorPopup("Login requested.",{reportUri:r,type:"sessionError"}),viewer&&viewer.setLocation&&viewer.setLocation("."),!0):e.getResponseHeader("reportError")?(showErrorPopup(e.responseText,{reportUri:r,type:"reportError"}),!0):!!e.getResponseHeader("JasperServerError")&&(e.getResponseHeader("reportPageNonExisting")&&showErrorPopup("Page does not exist",{reportUri:r,type:"reportPageNonExistingError"}),e.getResponseHeader("SuppressError")||(1==a(".dashboardViewFrame").length?(a(document.body).html(e.responseText),a("#"+JRS.fid,window.parent.document).removeClass("hidden").show()):(showErrorPopup(e.responseText,{reportUri:r,type:"JasperserverError"}),o(e.responseText)&&setTimeout(function(){var e=a("#standardAlert"),r=a(".dimmer"),t=e.find("button");r.removeClass("hidden").css("z-index",parseInt(e.css("z-index"),10)-1),t.on("click",function(){buttonManager.disable(a("#redo")[0]),viewer.stateStack.states.pop(),n=!0,viewer.reportInstance.undo(),viewer.reportInstance.components&&viewer.reportInstance.components.chart&&viewer.reportInstance.components.chart[0]&&(a("[data-hcname]").removeClass("selected"),a("[data-hcname='"+viewer.reportInstance.components.chart[0].config.charttype+"']").addClass("selected")),r.addClass("hidden"),t.off("click")})},0))),!0)}function o(e){for(var r=!1,t=0;t<Report.chartTypeChangeErrorMessages.length;t++)if(e.indexOf(Report.chartTypeChangeErrorMessages[t])>-1){r=!0;break}return r}var n,a=e("jquery"),s=e("jrs.configs"),i=s.contextPath,p="546px",u="350px",c={reportcontexturl:null,reportoutputurl:i+"/flow.html",reportactionurl:i+"/runReportAction.html",reportcomponentsurl:i+"/getReportComponents.html",reportpagestatusurl:i+"/viewReportPageUpdateCheck.html",cancelExecutionUrl:i+"/viewReportCancel.html",cancelAsyncExecutionUrl:i+"/viewReportAsyncCancel.html"},d=function(e){this.config={reporturi:null,async:!0},a.extend(this.config,e),this.jasperPrintName=null,this.contextid=null};return d.prototype={getHtmlForPage:function(e,t,o){if(n){n=!1,Report&&Report.hideAjaxDialog&&Report.hideAjaxDialog();var s=new a.Deferred;return s.reject(),s}var i={_flowExecutionKey:Report.reportExecutionKey(this.config.reporturi),_flowId:"viewReportFlow",_eventId:t?"navigate":"refreshReport",pageIndex:e,decorate:"no",confirm:"true",decorator:"empty",ajax:"true"};return Report&&Report.requestedInputParameters&&(o=Report.requestedInputParameters),r({url:c.reportoutputurl,urlParams:a.param(i),params:o},"html",this.config.reporturi)},cancelExecution:function(e){return r({url:e?c.cancelAsyncExecutionUrl+"?jasperPrintName="+this.jasperPrintName:c.cancelExecutionUrl+"?_flowExecutionKey="+Report.reportExecutionKey(this.config.reporturi)},"json")},getStatusForPage:function(e,t){return r({url:c.reportpagestatusurl,params:{jasperPrintName:this.jasperPrintName,pageIndex:e,pageTimestamp:t}},"json")},getComponentsForPage:function(e){return r({url:c.reportcomponentsurl,params:{jasperPrintName:this.jasperPrintName||Report.jasperPrintName,pageIndex:e}},"json")},runAction:function(e){var t=this;(null==e.showAjaxDialog||e.showAjaxDialog)&&Report&&Report.showAjaxDialog&&Report.showAjaxDialog();try{return r({url:c.reportactionurl,params:{jr_ctxid:t.contextid,jr_action:JSON.stringify(e.action)}},"json",t.config.reporturi)}catch(e){alert(e)}},save:function(e){var t=e.folder&&e.name?"saveReportAs":"saveReport",o={_flowExecutionKey:Report.reportExecutionKey(this.config.reporturi),_eventId:t};"saveReportAs"==t&&(o.folder=e.folder,o.name=e.name,o.description=e.description||"",o.overwrite=!!e.overwrite);try{return r({url:c.reportoutputurl,params:o},"json",this.config.reporturi)}catch(e){alert(e)}},exit:function(){var e={_flowExecutionKey:Report.reportExecutionKey(),_eventId:"end"};return r({url:c.reportoutputurl,urlParams:a.param(e)},"html")},setPageUpdateStatus:function(e){this.lastPageUpdateStatus=e.result,this.config.eventManager.triggerEvent("pageUpdateAvailable")}},d.UrlManager=c,d});