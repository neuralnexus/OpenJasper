define(["require","exports","module","underscore"],function(e,t,i){function n(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,n)}return i}function o(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?n(i,!0).forEach(function(t){r(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):n(i).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function r(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var l=e("underscore"),s={element:null,svgElement:null,getTextRectPool:{},findFontSizePool:{}},a=function(e){var t=[];return l.each(e,function(e,i){t.push(i+":"+e)}),t.join("_")},f=function(e,t){var i=t.fontSize,n=t.sizeUnits,o=t.fontWeight,r=t.lineHeight,l=a({t:e,s:i,u:n,w:o,h:r});if(s.getTextRectPool[l])return s.getTextRectPool[l];if(!s.element){var f=document.createElement("span");f.innerText="some text",f.style.fontFamily='"Lucida Grande", "Lucida Sans Unicode", Arial, Helvetica, sans-serif',f.style.fontSize="12px",f.style.fontWeight="normal",f.style.lineHeight="normal",f.style.opacity="0",f.style.position="absolute",f.style.top="-9999px",f.style.left="-9999px",document.body.appendChild(f),s.element=f}var h=s.element;h.innerText=e,h.style.fontSize=i+n,h.style.fontWeight=o,h.style.lineHeight=r;var d={width:Math.ceil(h.offsetWidth),height:Math.ceil(h.offsetHeight)};return s.getTextRectPool[l]=d,d},h=function(e){if(!s.svgElement){var t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("version","1.1"),t.setAttribute("xlink","http://www.w3.org/1999/xlink"),t.setAttribute("width","600"),t.setAttribute("height","600"),t.setAttribute("viewBox","0 0 600 600"),t.style.opacity="0",t.style.position="absolute",t.style.top="-99999px",t.style.left="-99999px",t.style.fontFamily='"Lucida Grande", "Lucida Sans Unicode", Arial, Helvetica, sans-serif',t.style.fontSize="12px",t.style.fontWeight="normal",t.style.lineHeight="normal";var i=document.createElementNS("http://www.w3.org/2000/svg","text");i.setAttribute("x","0"),i.setAttribute("y","0"),t.appendChild(i),document.body.appendChild(t),s.svgElement=t}for(var n=s.svgElement,o=n.childNodes[0];o.childNodes.length;)o.removeChild(o.childNodes[0]);l.each(e,function(e,t){var i=document.createElementNS("http://www.w3.org/2000/svg","tspan");i.setAttribute("x","0");var n=0===t?"y":"dy";i.setAttribute(n,e.y||"0"),i.style.fontSize=e.fontSize+e.sizeUnits,i.style.fontWeight=e.fontWeight,i.style.lineHeight=e.lineHeight,i.textContent=e.text,o.appendChild(i)});var r;return r=o.getBBox?o.getBBox():{width:o.offsetWidth,height:o.offsetHeight},{width:Math.ceil(r.width),height:Math.ceil(r.height)}},d=function(e){var t=e.text,i=e.sizeUnits,n=e.fontWeight,r=e.lineHeight,s=e.minimalFontSize,a=e.fontCheckingStrategy,f=e.widthAvailable,h=e.heightAvailable,d={makesSenseToContinue:!1,fontSize:12,lineHeight:g(12),sizeUnits:"px"};return l.isUndefined(t)?d:(t=t.toString(),l.isUndefined(h)&&l.isUndefined(f)?d:(l.isUndefined(h)&&(h=-1),l.isUndefined(f)&&(f=-1),l.isUndefined(s)?s=1:(s=parseInt(s),l.isNaN(s)&&(s=1),s=Math.max(1,s)),l.isUndefined(a)&&(a="basedOnActualSize"),l.isUndefined(i)&&(i="px"),l.isUndefined(n)&&(n="normal"),l.isUndefined(r)&&(r="normal"),o({},d,{makesSenseToContinue:!0,text:t,sizeUnits:i,fontWeight:n,lineHeight:r,minimalFontSize:s,fontCheckingStrategy:a,widthAvailable:f,heightAvailable:h})))},c=function(e){var t=d(e),i=t.makesSenseToContinue,n=t.text,r=t.fontSize,l=t.fontWeight,h=t.lineHeight,c=t.sizeUnits,u=t.minimalFontSize,p=t.fontCheckingStrategy,y=t.widthAvailable,m=t.heightAvailable,S={fontSize:r,sizeUnits:c};if(!i)return S;var v=a({t:n.length,w:y,h:m,c:p});if(s.findFontSizePool[v])return s.findFontSizePool[v];var w,b,z,x,P,U=function(e,t){var i=!0,n={width:0,height:0};return"basedOnActualSize"!==p&&-1===y||(n=f(e,t)),"basedOnFontHeight"===p?(g(t.fontSize)>m&&(i=!1),n.width>y&&(i=!1)):(-1!==m&&n.height>m&&(i=!1),-1!==y&&n.width>y&&(i=!1)),{fits:i,width:n.width,height:n.height}},A={sizeUnits:c,fontWeight:l,lineHeight:h};if(w=U(n,o({},A,{fontSize:u})),!w.fits)return S.fontSize=u,s.findFontSizePool[v]=S,S;z=u+10,x=u,P=0;do{if(w=U(n,o({},A,{fontSize:z})),w.fits&&(x=z,z=Math.ceil(z+(z-u)/2)),P++>100)return s.findFontSizePool[v]=S,S}while(w.fits);P=0;do{if(z-x==1)break;if(b=Math.ceil((z+x)/2),w=U(n,o({},A,{fontSize:b})),w.fits?x=b:z=b,P++>100)return s.findFontSizePool[v]=S,S}while(z>x);return S.fontSize=x,s.findFontSizePool[v]=S,S},g=function(e){return e<24?e+3:1.2*e},u=function(e){return Math.round(.8*g(e))};i.exports={getTextRect:f,getSVGTextRect:h,findFontSize:c,getFontHeight:g,getFontBaseline:u}});