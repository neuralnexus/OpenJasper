define(["require","exports","module","prototype","underscore","../util/utils.common","jquery","runtime_dependencies/js-sdk/src/common/util/xssUtil","../core/core.layout"],function(t,e,i){function s(t,e){if(t){if(this.srcElement=t,e&&(this.label=e.label,this.text=e.text,this.offsets=e.offsets,this.showBelow=!!e.showBelow,this.templateId=e.templateId,this.loadTextCallback=e.loadTextCallback,this.loadTextExecuted=!1),this.disabled=!1,this.removed=!1,this.templateId)this._toAttribute(this.TOOLTIP_TEMPLATE,this.templateId);else{var i=this._fromAttribute(this.TOOLTIP_TEMPLATE);this.templateId=i&&i.length>0?i:this.TOOLTIP_TEMPLATE_ID}this.label?this._toAttribute(this.TOOLTIP_LABEL,this.label):this.label=this._fromAttribute(this.TOOLTIP_LABEL),this.text?this._toAttribute(this.TOOLTIP_TEXT,this.text):this.text=this._fromAttribute(this.TOOLTIP_TEXT),this.label&&(this.label=this._escapeText(this.label)),this.text&&(this.text=this._escapeText(this.text)),this.srcElement.jsTooltip=this,p.tooltips.push(this)}}var l=t("prototype"),o=l.$,h=t("underscore"),a=t("../util/utils.common"),n=a.isArray,r=a.getBoxOffsets,d=a.getScrollLeft,c=a.getScrollTop,u=t("jquery"),T=t("runtime_dependencies/js-sdk/src/common/util/xssUtil"),m=t("../core/core.layout");s.addVar("SEPARATOR","@@"),s.addVar("TOOLTIP_LABEL","tooltiplabel"),s.addVar("TOOLTIP_TEXT","tooltiptext"),s.addVar("TOOLTIP_TEMPLATE","tooltiptemplate"),s.addVar("TOOLTIP_TEMPLATE_ID","jsTooltip"),s.addVar("LABEL_PATTERN",".message.label"),s.addVar("TEXT_PATTERN",".message:not(.label)"),s.addMethod("_toAttribute",function(t,e){this.srcElement&&(e=T.hardEscape(e),this.srcElement.writeAttribute(t,n(e)?e.join(this.SEPARATOR):e))}),s.addMethod("_fromAttribute",function(t){if(this.srcElement&&this.srcElement.hasAttribute(t)){var e=this.srcElement.readAttribute(t);return e.include(this.SEPARATOR)?e.split(this.SEPARATOR):e}return null}),s.addMethod("_setValues",function(t,e){t.each(function(t,i){(h.isString(e[i])||h.isNumber(e[i]))&&t.update(T.hardEscape(e[i]))})}),s.addMethod("_calculateZIndex",function(t){function e(t){return parseInt(u(t).css("z-index"))}var i=e(t);h.isNumber(i)&&!h.isNaN(i)||(i=1e3);var s=h.flatten([this.srcElement,u(this.srcElement).parents().toArray()]);return h.reduce(s,function(t,i){var s=e(i);return h.isNumber(s)&&!h.isNaN(s)&&(t=Math.max(t,s)),t},i)+1}),s.addMethod("_escapeText",function(t){return h.isArray(t)?h.map(t,function(t){return T.hardEscape(t)}):T.hardEscape(t)}),s.addMethod("show",function(t){t&&(this.offsets=t),this._element=o(this.templateId);var t;this.showBelow?(t=r(this.srcElement),t[1]+=this.srcElement.clientHeight+5):t=[d()+5,c()+5],this.offsets&&(t[0]+=this.offsets[0],t[1]+=this.offsets[1]),this._element.setStyle({position:"absolute",left:t[0]+"px",top:t[1]+"px",zIndex:this._calculateZIndex(this._element)});var e=this._element.select(this.LABEL_PATTERN),i=this._element.select(this.TEXT_PATTERN);if(this.label&&this._setValues(e,n(this.label)?this.label:[this.label]),this.text&&this._setValues(i,n(this.text)?this.text:[this.text]),this._element.removeClassName(m.HIDDEN_CLASS),t[0]+this._element.clientWidth>u(window).width()){var s=t[0]-this._element.clientWidth>0?t[0]-this._element.clientWidth:15;this._element.setStyle({left:s+"px"})}if(t[1]+this._element.clientHeight>u(window).height()){var l=t[1]-this._element.clientHeight-10;this._element.setStyle({top:l+"px"})}return this.loadTextCallback&&!this.loadTextExecuted&&(this.loadTextExecuted=!0,this.loadTextCallback(this)),this}),s.addMethod("updateText",function(t){if(this.text=this._escapeText(t),this._element){var e=this._element.select(this.TEXT_PATTERN);this._setValues(e,n(this.text)?this.text:[this.text])}}),s.addMethod("hide",function(){this._element&&this._element.addClassName(m.HIDDEN_CLASS)}),s.addMethod("disable",function(){p.hideJSTooltip(this.srcElement),this.disabled=!0}),s.addMethod("enable",function(){this.disabled=!1,p.showJSTooltip(this.srcElement,this.offsets)}),s.addMethod("remove",function(){var t=p.tooltips.indexOf(this.srcElement.jsTooltip);-1!==t&&(p.hideJSTooltip(this.srcElement),p.tooltips.splice(t,1)),this.removed=!0}),s.addMethod("isRemoved",function(){return this.removed});var p={TOOLTIP_PATTERN:"*[tooltiptext] > *",ELEMENT_WITH_TOOLTIP_PATTERN:"*[tooltiptext]",actualX:0,actualY:0,tooltips:[],showJSTooltip:function(t,e){if(t.jsTooltip){if(!t.jsTooltip.disabled&&e){this.actualX=e[0],this.actualY=e[1],this.cleanUp();var i=u(t).attr("tooltipappeardelay");i=i?parseInt(i):1e3,t.jsTooltip.timer&&clearTimeout(t.jsTooltip.timer),t.jsTooltip.timer=setTimeout(function(){t.jsTooltip.show([p.actualX,p.actualY])},i),u(t).on("mousemove",function(t){p.actualX=t.clientX,p.actualY=t.clientY})}}else t.jsTooltip=new s(t,{})},enableTooltips:function(){(this.tooltips||[]).forEach(function(t){t.enable()})},disableTooltips:function(){(this.tooltips||[]).forEach(function(t){t.disable()})},hideJSTooltip:function(t){t&&t.jsTooltip&&(t.jsTooltip.timer&&clearTimeout(t.jsTooltip.timer),t.jsTooltip.hide(),u(t).off("mousemove"))},cleanUp:function(){if(this.tooltips&&this.tooltips.length>0){var t=[],e="fuigasuifdughaiadbvguaidbapvuwbev";this.tooltips.each(function(i){i.srcElement.id&&document.getElementById(i.srcElement.id)||(i.srcElement.setAttribute("id",e),document.getElementById(e)||(i.hide(),t.push(i)),i.srcElement.setAttribute("id",null))}),t.length>0&&(this.tooltips=this.tooltips.reject(function(e){return t.include(e)}))}}};e.JSTooltip=s,e.tooltipModule=p});