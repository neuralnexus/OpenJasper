define(["require","exports","module","prototype","underscore","jquery","runtime_dependencies/js-sdk/src/common/stdnav/stdnav","text!runtime_dependencies/js-sdk/src/common/templates/dialogSystemConfirmTemplate.htm","../util/utils.animation","../util/utils.common","bundle!jasperserver_messages","bundle!jsexceptions_messages","../util/touch.controller","../core/core.layout","runtime_dependencies/js-sdk/src/common/util/xssUtil","scriptaculous/src/builder"],function(e,t,s){var o,n=e("prototype"),i=n.$,r=n.$$,a=e("underscore"),c=e("jquery"),d=e("runtime_dependencies/js-sdk/src/common/stdnav/stdnav"),l=e("text!runtime_dependencies/js-sdk/src/common/templates/dialogSystemConfirmTemplate.htm"),p=e("../util/utils.animation"),u=p.appear,h=e("../util/utils.common"),m=h.reParent,_=h.cascadeElement,f=h.centerElement,g=h.isIPad,I=h.matchMeOrUp,y=h.matchAny,x=h.pageDimmer,D=e("bundle!jasperserver_messages"),v=e("bundle!jsexceptions_messages"),T=e("../util/touch.controller"),A=e("../core/core.layout"),C=e("runtime_dependencies/js-sdk/src/common/util/xssUtil"),w=e("scriptaculous/src/builder"),E={};E.systemConfirm={container:null,message:null,show:function(e,t,s){if(window.isEmbeddedDesigner)c(document).trigger("adhocDesigner:notification",[e,t]);else{if(this.container=this.container||c("#systemMessageConsole").on("mouseup touchend",function(){E.systemConfirm.container.slideUp()}),this.message=this.message||document.getElementById("systemMessage"),!this.message)return void console.warn(e);this.closeText||(this.closeText=c(this.message).html().toLowerCase()),c(this.message).html(a.template(l,{messages:e,isWarning:s,closeText:this.closeText})),E.systemConfirm.container.slideDown(),setTimeout(function(){E.systemConfirm.hide()},t||2e3)}},showWarning:function(e,t){this.show(e,t,!0)},hide:function(){E.systemConfirm.container&&E.systemConfirm.container.slideUp()}},c(document).on("systemDialogWarn",function(e){var t=e.detail.message,s=e.detail.duration;E.systemConfirm.showWarning(t,s)}),E.errorPopup={_dom:null,_content:null,_DOM_ID:"standardAlert",_CONTENT_ID:"errorPopupContents",_PAGE_CONTENT_PATTERN:"#errorPageContent",_DIALOG_WIDTH:"546px",_DIALOG_HEIGHT:"350px",clickHandler:null,onClose:null,getZIndex:function(){var e=0;return this._dom&&(e=parseInt(this._dom.getStyle("zIndex"),10)),e},show:function(e,t,s){s||(s={});var o=w.node("DIV",{style:"display:none"});c(o).html(e),document.body.insertBefore(o,document.body.firstChild);var n=r(this._PAGE_CONTENT_PATTERN)[0],a=n?c(n).html():e,d=n&&c(n).html();if(o.remove(),a&&(this._dom||(this._dom=i(this._DOM_ID),this._content=i(this._CONTENT_ID),this.clickHandler=this._clickHandler.bindAsEventListener(this)),this._dom)){var l=a;d||(l=w.node("P",{class:"message"}),l.update(a)),this._content.update(l),this._dom.observe("click",this.clickHandler),this._dom.setStyle({height:s.height||this._DIALOG_HEIGHT,width:s.width||this._DIALOG_WIDTH}),t&&this._dom.addClassName(A.STACKTRACE_CLASS),E.popup.show(this._dom,t);var p=document.getElementById("completeStackTrace");p&&g()&&new T(p,p.parentNode,{noInit3d:!0})}},_hide:function(){this._dom&&(this._dom.stopObserving("click",this.clickHandler),this.onClose&&(this.onClose(),this.onClose=null),E.popup.hide(this._dom))},_clickHandler:function(e){var t=e.element();y(t,["button"],!0)&&this._hide()}},E.clusterErrorPopup=a.extend({},E.errorPopup,{show:function(e){var t=v["cluster.exception.session.attribute.missing.popup"];E.errorPopup.show.call(this,t);var s=D["button.home"];c("#"+this._DOM_ID).find("button span.wrap").html(s)},_hide:function(e){E.errorPopup._hide.apply(this,arguments),window.location="home.html"}}),E.popup={OWNER_ATTR:"data-owner",show:function(e,t,s){if(s=s||{},e=i(e)){"message"in s&&c(e).find(".body").text(C.unescape(s.message)),t&&(x.show(),e.match(A.DIALOG_LOADING_PATTERN)&&x.setZindex(e.getStyle("zIndex")-1)),m(e,document.body),e.setOpacity(0),e.removeClassName(A.HIDDEN_CLASS),A.createSizer.call(A,e),s.cascade?_(e,{position:s.position,number:s.number,horzOffset:40,vertOffset:40}):f(e,{horz:!0,vert:!0}),E.popup._setHigherZIndex(e),A.createMover.call(A,e,s),g()?e.setOpacity(1)&&e.show():u(e,.4),c(document.activeElement).addClass("preDialogFocus");var o=e;e&&c(".primary",e).length>0&&(o=c(".primary",e)[0]),s&&void 0!==s.focus&&!s.focus||(e.tabIndex=0,o.tabIndex=0,o.focus()),!t&&e.observe("click",E.popup.zIndexHandler),d.beginModalFocus(e)}},hide:function(e){d.endModalFocus(e);var t=c(".preDialogFocus");if(t.length&&c(e).is(":visible")&&(d.forceFocus(t.first()),t.removeClass("preDialogFocus")),e){var s=i(e);s.hasClassName(A.HIDDEN_CLASS)||(s.addClassName(A.HIDDEN_CLASS),x.hide(),s.match(A.DIALOG_LOADING_PATTERN)&&x.setZindex(A.DIMMER_Z_INDEX)),a.defer(function(){s.stopObserving("click",E.popup.zIndexHandler)})}},showShared:function(e,t,s){e&&(o=i(e),s=s||{},s.owner&&(o.writeAttribute(this.OWNER_ATTR,s.owner),o.hasClassName(A.HIDDEN_CLASS)&&this.show(o,t,s)))},hideShared:function(e,t){if(e){o=i(e);o.readAttribute(this.OWNER_ATTR)==t&&(o.writeAttribute(this.OWNER_ATTR,!1),this.hide(o))}},zIndexHandler:function(e){var t=Event.element(e),s=I(t,A.DIALOG_PATTERN);s&&E.popup._setHigherZIndex(s)},_setHigherZIndex:function(e,t){var s,o,n,i=0,r=0;e&&(n=e.getStyle("zIndex"),t&&(i=t.getStyle("zIndex")),s=document.body.select(A.DIALOG_PATTERN),s=s.filter(function(t){return!!t.visible()&&(!t.match(A.DIALOG_LOADING_PATTERN)&&t!==e)}),s.each(function(e){r=Math.max(r,e.getStyle("zIndex"))}),o=Math.max(i,n,r,A.DIMMER_Z_INDEX),e.setStyle({zIndex:o}),s.each(function(e){e.getStyle("zIndex")>=o&&e.setStyle({zIndex:o-1})}))}},E.popupConfirm=a.extend({},E.popup,{show:function(e,t,s){E.popup.show.apply(this,arguments),s=a.extend({okButtonSelector:"button.ok",cancelButtonSelector:"button.cancel"},s);var o=c(e),n=o.find(s.okButtonSelector),i=o.find(s.cancelButtonSelector),r=c.Deferred();return n.on("click",function(){s.validateFunc&&!1===s.validateFunc()||(n.off("click"),i.off("click"),E.popupConfirm.hide(e),r.resolve())}),i.on("click",function(){n.off("click"),i.off("click"),E.popupConfirm.hide(e),r.reject()}),r}}),E.childPopup=a.extend({},E.popup,{cascadePopups:{},show:function(e,t,s,o){s?(o=a.extend({parent:s},o),this.cascadePopups[s.id]||(this.cascadePopups[s.id]=[]),this.cascadePopups[s.id].push(e.id),i(e).setAttribute("data-parentDialog",s.id),E.popup.show.apply(this,[e,t,o]),E.popup._setHigherZIndex(e,s),t&&x.setZindex(e.getStyle("zIndex")-1),s.stopObserving("click",E.popup.zIndexHandler)):E.popup.show.apply(this,[e,t,o])},hide:function(e){var t=i(e).getAttribute("data-parentDialog");if(t){this.cascadePopups[t]&&(this.cascadePopups[t]=a.without(this.cascadePopups[t],e.id)),E.popup.hide.apply(this,[e]);var s=i(t);x.show(s),E.popup._setHigherZIndex(s)}else E.popup.hide.apply(this,[e])}}),window.dialogs=E,s.exports=E});