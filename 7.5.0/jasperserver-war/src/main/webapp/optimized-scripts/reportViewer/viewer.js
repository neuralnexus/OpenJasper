define(["require","exports","module","jasperreports-report","jquery","runtime_dependencies/js-sdk/src/common/util/browserDetection","./tmpl/jive.i18n.tmpl","../core/core.buttonManager","../components/components.dialogs","jquery","runtime_dependencies/js-sdk/src/common/stdnav/stdnav","bundle!all","jquery-ui/ui/widgets/draggable","csslink!jive.vm.css"],function(require,exports,module){var __disableStrictMode__="use strict",JReport=require("jasperreports-report"),$=require("jquery"),browserDetection=require("runtime_dependencies/js-sdk/src/common/util/browserDetection"),jivei18nText=require("./tmpl/jive.i18n.tmpl"),buttonManager=require("../core/core.buttonManager"),dialogs=require("../components/components.dialogs"),jQuery=require("jquery"),stdnav=require("runtime_dependencies/js-sdk/src/common/stdnav/stdnav"),i18n=require("bundle!all");require("jquery-ui/ui/widgets/draggable"),require("csslink!jive.vm.css");var jivei18n=JSON.parse(jivei18nText),Viewer=function(e){var t=this;if(t.reportInstance=null,t.jive=null,t.isUndoRedo=!1,t.config={at:null,reporturi:null,async:!0,page:0,toolbar:!0},t.dfds={"jive.inactive":null},t.loading=!1,t.loaded=!1,t.search={currentIndex:0,results:[]},t.tabs={maxCount:null,maxLabelLength:null},$.extend(t.config,e),t.container=t._getContainer(),t.hyperlinkHandlers={},t.stateStack.newState(),$("body").on({"jive.initialized":function(e,r){t.jive=r},"jive.inactive":function(){t.dfds["jive.inactive"]&&t.dfds["jive.inactive"].resolve()}}),t.features={zoom:{options:[],optionType:"toggle",selectedKeys:["1","fit_actual"],onClick:function(e){t.saveCurrentLevel(),t.processZoomOption(e),t.features.zoom.selectedKeys="fit_actual"===e||"1"===e?["1","fit_actual"]:[e],t.zoomChanged()},levels:{previous:{value:null,literal:null},current:{value:1,literal:null},dflt:null},containerWidth:$("div#reportContainer").width(),localZoomChange:!1},search:{options:[],optionType:"select",selectedKeys:[],config:{caseSensitive:!1,wholeWordsOnly:!1},onClick:function(e){var r,o=t.features.search.config;o[e]=!o[e],t.features.search.selectedKeys=[];for(r in o)o.hasOwnProperty(r)&&o[r]&&t.features.search.selectedKeys.push(r)}}},$("script#reportZoomText").length>0&&(t.features.zoom.options=JSON.parse($("script#reportZoomText").html()),$("button#zoom_in").on("click",function(e){t.saveCurrentLevel(),t.zoomIn(),t.zoomChanged()}),$("button#zoom_out").on("click",function(e){t.saveCurrentLevel(),t.zoomOut(),t.zoomChanged()}),$("input#zoom_value").on("keydown",function(e){13===e.which&&this.value.length&&(t.zoomTo(parseFloat(this.value)/100),t.getOptionsMenu("zoom").hide())}),$("button#zoom_value_button").on("click",function(e){var r=$(this),o=$("input#zoom_value"),a=o.offset(),n=t.getOptionsMenu("zoom"),s=n.data("openFor")||"";n.is(":visible")&&"zoom"===s?(n.hide(),n.data("openFor",null),o.focus()):(n.is(":visible")&&"zoom"!==s&&n.hide(),n.show().offset({left:a.left,top:a.top+r.height()}),n.data("openFor","zoom"),o.blur())}),$(window).on("resize",function(){var e=t.features.zoom,r=$.extend({},e.levels.current);t.processZoomOption(1),e.containerWidth=$("div#reportContainer").width(),t.processZoomOption(r.literal?r.literal:r.value)})),$("script#reportSearchText").length>0){t.features.search.options=JSON.parse($("script#reportSearchText").html()),$("input#search_report").on("keydown",function(e){13===e.which&&(this.value.length?t.reportInstance.search({searchString:this.value,caseSensitive:t.features.search.config.caseSensitive,wholeWordsOnly:t.features.search.config.wholeWordsOnly}):dialogs.errorPopup.show("Search string cannot be empty!"))}),$("button#search_report_button").on("click",function(e){$("input#search_report").trigger($.Event("keydown",{which:13}))}),$("button#search_options").on("click",function(e){var r=$(this),o=$("input#search_report").offset(),a=t.getOptionsMenu("search"),n=a.data("openFor")||"";a.is(":visible")&&"search"===n?(a.hide(),a.data("openFor",null)):(a.is(":visible")&&"search"!==n&&a.hide(),a.show().offset({left:o.left,top:o.top+r.height()}),a.data("openFor","search"))});var r=$("button#search_next"),o=$("button#search_previous");r.on("click",function(e){var r,o,a,n=$(".jr_search_result"),s=t.reportInstance.currentpage,i=null,l=0;for(r=0,o=t.search.results.length;r<o;r++)if(s===t.search.results[r].page-1&&(l=t.search.results[r].hitCount),s<t.search.results[r].page-1){i=t.search.results[r].page-1;break}null==i&&(i=t.search.results[0].page-1),t.search.currentIndex<l-1?(n.eq(t.search.currentIndex).removeClass("highlight"),a=n.eq(++t.search.currentIndex),a.addClass("highlight"),t.scrollElementIntoView(a[0]),t.search.currentPage=s):i===s?(n.eq(t.search.currentIndex).removeClass("highlight"),t.search.currentIndex=0,a=n.eq(t.search.currentIndex),a.addClass("highlight"),t.scrollElementIntoView(a[0]),t.search.currentPage=s):(t.disableSearchButtons(),t.reportInstance.gotoPage(i).then(function(e){t.enableSearchButtons();var r=$(".jr_search_result:first");r.addClass("highlight"),t.scrollElementIntoView(r[0]),t.search.currentIndex=0,t.search.currentPage=e.currentpage}))}),o.on("click",function(e){var r,o,a=$(".jr_search_result"),n=t.reportInstance.currentpage,s=null,i=0,l=0;for(r=t.search.results.length-1;r>=0;r--)if(n===t.search.results[r].page-1&&(l=t.search.results[r].hitCount),n>t.search.results[r].page-1){s=t.search.results[r].page-1,i=t.search.results[r].hitCount;break}null==s&&(s=t.search.results[t.search.results.length-1].page-1,i=t.search.results[t.search.results.length-1].hitCount),t.search.currentIndex>0?(a.eq(t.search.currentIndex).removeClass("highlight"),o=a.eq(--t.search.currentIndex),o.addClass("highlight"),t.scrollElementIntoView(o[0]),t.search.currentPage=n):s===n?(a.eq(t.search.currentIndex).removeClass("highlight"),t.search.currentIndex=l-1,o=a.eq(t.search.currentIndex),o.addClass("highlight"),t.scrollElementIntoView(o[0]),t.search.currentPage=n):(t.disableSearchButtons(),t.reportInstance.gotoPage(s).then(function(e){t.enableSearchButtons();var r=$(".jr_search_result:last");r.addClass("highlight"),t.scrollElementIntoView(r[0]),t.search.currentIndex=i-1,t.search.currentPage=e.currentpage}))})}t.bookmarksContainer=null,$("button#bookmarksDialog").on("click",function(){t.bookmarksContainer&&t.bookmarksContainer.toggle().offset({left:10,top:95})})};Viewer.privateMethods={prepareBookmarks:function(e){var t,r,o=this,a=$("div#jr_bookmarks");a.length&&a.find(".jrbookmark").length>0||(a.length||(a=$("<div id='jr_bookmarks' class='panel dialog overlay moveable sizeable' style='width: 250px; height: 600px; z-index: 2000; display: none'><div class='sizer diagonal ui-resizable-handle ui-resizable-se'></div><div class='content hasFooter'><div class='header mover'><div class='closeIcon'></div><div class='title'>"+i18n["net.sf.jasperreports.components.headertoolbar.bookmarks.dialog.title"]+"</div></div><div class='body' style='top: 29px; bottom: 24px; padding: 0'></div><div class='footer' style='height: 24px'></div></div></div>").appendTo("body"),a.on("click","a.jrbookmark",function(e){e.preventDefault();var t=$(this),r=t.data("pageindex"),a=t.text();o.reportInstance.currentpage===r?window.location.hash=a:o.reportInstance.gotoPage(r).then(function(){window.location.hash=a})}),a.on("click","div.closeIcon",function(){a.hide()}),a.on("click","b.icon",function(){var e,t=$(this);t.is(".noninteractive")||(e=t.closest("li.subtree"),e.is(".open")?e.removeClass("open").addClass("closed"):e.removeClass("closed").addClass("open"))}),a.draggable({handle:".mover"}),a.resizable({handles:{se:".sizer"}}),o.bookmarksContainer=a),t=a.find(".body"),t.empty(),r="<ul class='list collapsible type_basic'>",$.each(e,function(e,t){r+=o.exportBookmark(t)}),r+="</ul>",t.html(r))},exportBookmark:function(e){var t=this,r="",o="JR_BKMRK_0_"+e.pageIndex+"_"+e.elementAddress,a=e.label||o;return e.bookmarks&&e.bookmarks.length?(r+="<li class='node open subtree'><p class='wrap button'><b class='icon'></b><a href='"+o+"' data-pageindex='"+e.pageIndex+"' class='jrbookmark'>"+a+"</a></p>",r+="<ul class='list collapsible'>",$.each(e.bookmarks,function(e,o){r+=t.exportBookmark(o)}),r+="</ul>"):r+="<li class='leaf'><p class='wrap button'><b class='icon noninteractive'></b><a href='"+o+"' data-pageindex='"+e.pageIndex+"' class='jrbookmark'>"+a+"</a></p>",r+="</li>"},cleanupBookmarks:function(){this.bookmarksContainer&&this.bookmarksContainer.find(".body").empty()},prepareReportParts:function(e,t){var r=this,o=$("ul#reportPartsContainer"),a="";o.length&&o.find("div.reportPart").length>0&&!t||(r.initializedPartsContainer||(2===o.find("li.control.search").length&&(r.tabs.navButtons=o.html()),o.parent().removeClass("hidden"),o.on("click","div.reportPart",function(e){e.preventDefault();var t=$(this),a=t.data("pageindex");r.reportInstance.currentpage!==a&&(o.find("div.reportPart.active").removeClass("active"),t.addClass("active"),r.reportInstance.gotoPage(a))}),o.on("click","button#part_prev",function(e){var t=o.find("li div.reportPart.active").closest("li"),r=t.prev("li").not("li.control.search");$(this).prop("disabled",!0),r.find(".button").trigger("click")}),o.on("click","button#part_next",function(e){var t=o.find("li div.reportPart.active").closest("li"),r=t.next("li").not("li.control.search");$(this).prop("disabled",!0),r.find(".button").trigger("click")}),r.reportPartsContainer=o,r.initializedPartsContainer=!0),o.empty(),r.partsStartIndex=[],$.each(e,function(e,t){e<r.tabs.maxCount&&(a+=r.exportPart(t)),r.partsStartIndex.push(t.idx)}),a+=r.tabs.navButtons,o.html(a),r.markActiveReportPart())},exportPart:function(e){var t=this,r=e.name;return e.name.length>t.tabs.maxLabelLength&&(r=e.name.substring(0,t.tabs.maxLabelLength)+"..."),"<li class='leaf'><div class='button reportPart' role='button' js-navtype='button' data-pageindex='"+e.idx+"' data-title='true' aria-label='"+r+"' tabindex='-1'><span>"+r+"</span></div></li>"},getNextPart:function(e){var t=this;return t.getReportParts()[t.partsStartIndex.indexOf(e.data("pageindex"))+1]},getPreviousPart:function(e){var t=this;return t.getReportParts()[t.partsStartIndex.indexOf(e.data("pageindex"))-1]},getReportParts:function(){var e=this,t=e.reportInstance.components.reportparts[0].config.parts;return e.reportInstance.reportComponents&&e.reportInstance.reportComponents.reportparts&&e.reportInstance.reportComponents.reportparts[0].config.parts.length>t.length&&(t=e.reportInstance.reportComponents.reportparts[0].config.parts),t},markActiveReportPart:function(){var e,t,r,o,a,n=this,s=-1,i=-1,l=n.tabs.maxCount;if(n.reportPartsContainer&&($.each(n.partsStartIndex,function(e,t){n.reportInstance.currentpage>=t&&(s=e,i=t)}),-1!==s)){if(n.reportPartsContainer.find("div.reportPart.active").removeClass("active"),r=n.reportPartsContainer.find("div.reportPart[data-pageindex='"+i+"']"),!r.length){n.reportPartsContainer.empty(),o=n.getReportParts(),a="";var c,d,u,h=0;for(0!==s&&(h=parseInt(parseInt(s/l)*l),u=o.slice(h,h+l),u.length<l&&h-(l-u.length)>0&&(h-=l-u.length)),d=Math.min(o.length,h+l),c=h;c<d;c++)a+=n.exportPart(o[c]);a+=n.tabs.navButtons,n.reportPartsContainer.html(a),r=n.reportPartsContainer.find("div.reportPart[data-pageindex='"+i+"']")}r.addClass("active"),e=n.reportPartsContainer.find("#part_prev"),t=n.reportPartsContainer.find("#part_next"),0===s?(e.prop("disabled",!0),n.reportPartsContainer.find("li.search:first").is(".subfocus")&&stdnav.forceFocus("#reportPartsContainer li.search:last")):e.prop("disabled",!1),s<n.partsStartIndex.length-1?t.prop("disabled",!1):(t.prop("disabled",!0),n.reportPartsContainer.find("li.search:last").is(".subfocus")&&stdnav.forceFocus("#reportPartsContainer li.search:first"))}},cleanupParts:function(){this.reportPartsContainer&&this.reportPartsContainer.find(".body").empty(),this.partsStartIndex=[]},enableSearchButtons:function(){$("button#search_next").prop("disabled",!1),$("button#search_previous").prop("disabled",!1)},disableSearchButtons:function(){$("button#search_next").prop("disabled",!0),$("button#search_previous").prop("disabled",!0)},resetSearch:function(e){this.search={currentIndex:0,results:[]},!e&&$("input#search_report").val(""),$("button#search_next").prop("disabled",!0),$("button#search_previous").prop("disabled",!0)},restoreLastActiveSearchHighlight:function(){var e,t=this;t.search.results.length&&t.reportInstance.currentpage===t.search.currentPage&&(e=$(".jr_search_result"),e.eq(t.search.currentIndex).addClass("highlight"))},getOptionsMenu:function(e){var t,r,o,a,n=this,s=n.features[e],i=s.options,l=$("div#templateElements > div#reportViewerMenuHolder > div#vwroptions > div.menu"),c=!1;for(0===l.length&&(a="<div id ='reportViewerMenuHolder'><div id='vwroptions'><div class='menu vertical dropDown fitable' style='display: none; z-index: 99999'><div class='content'><ul js-navtype='toolbar'>",a+="</ul></div></div></div></div>",l=$("div#templateElements").append(a).find("div#vwroptions div.menu"),l.on("mouseleave",function(e){$(this).hide()})),t=l.find("ul"),t.empty(),l.off("click","p"),r=0;r<i.length;r++)o=i[r],o.key.startsWith("fit_")&&!c&&(c=!0,t.append("<li class='leaf separator'></li>")),s.selectedKeys.length&&-1!==$.inArray(o.key,s.selectedKeys)?t.append("<li class='leaf selected'><p class='wrap toggle button down' data-val='"+o.key+"'><span class='icon'></span>"+o.value+"</p></li>"):t.append("<li class='leaf'><p class='wrap toggle button' data-val='"+o.key+"'><span class='icon'></span>"+o.value+"</p></li>");return l.on("click","p",function(e){var t=$(this),r=t.attr("data-val");"select"===s.optionType?(t.closest("ul").find("p").removeClass("down"),t.closest("ul").find("li").removeClass("selected"),t.addClass("down"),t.closest("li").addClass("selected")):"toggle"===s.optionType&&(t.toggleClass("down"),t.closest("li").toggleClass("selected")),s.onClick.apply(null,[r]),l.hide()}),l},getZoomByValue:function(e){var t,r=this.features.zoom,o=$("div#reportViewFrame div.body:first"),a=$("table.jrPage");if(o.length||(o=$("#reportContainer")),"fit_width"===e)t=r.containerWidth/a.width();else if("fit_height"===e)t=o.height()/a.height();else if("fit_page"===e){var n=o.height(),s=r.containerWidth,i=a.height(),l=a.width();t=Math.min(s/l,n/i)}else t="fit_actual"===e?1:parseFloat(e);return t},processZoomOption:function(e){var t,r,o=this;o.features.zoom.levels;"string"==typeof e?(t=o.getZoomByValue(e),0===e.indexOf("fit_")&&(r=e)):t=e,t=parseFloat(t.toFixed(2)),$("#zoom_value").val((100*t).toFixed(0)+"%"),o.zoomTo(t,r)},propagateZoom:function(e){var t,r,o;this.reportInstance&&this.reportInstance.components&&(t=this.reportInstance.components,$.each(t,function(t,a){a.length>0&&(o=a[0].config.uimodule,require.defined(o)&&(r=require(o),r.zoom&&r.zoom(e)))}))},zoomIn:function(e,t){var r,o=this,a=o.features.zoom.levels.current.value,e=e||.1,n=$("table.jrPage"),s=n.width(),i=s*a,l=o.features.zoom.containerWidth,c={};r=parseFloat((a+e).toFixed(2)),o.features.zoom.selectedKeys=1===r?["1","fit_actual"]:t?[t]:[""+r],i<l&&s*r>l?(n.css("margin-left",0),o.applyScaleTransform(n,r,"0 0"),c.overflow=!0):i>=l?(o.applyScaleTransform(n,r,"0 0"),c.overflow=!0):(o.applyScaleTransform(n,r),c.overflow=!1),c.level=r,o.features.zoom.levels.current.literal=t||null,o.features.zoom.levels.current.value=r,o.reportInstance.zoom=c,$("#zoom_value").val((100*r).toFixed(0)+"%"),o.propagateZoom(c)},zoomOut:function(e,t){var r,o=this,a=o.features.zoom.levels.current.value,e=e||.1,n=$("table.jrPage"),s=n.width(),i=s*a,l=o.features.zoom.containerWidth,c={};r=parseFloat((a-e).toFixed(2)),r<=0&&(r=.1),o.features.zoom.selectedKeys=1===r?["1","fit_actual"]:t?[t]:[""+r],i>l&&s*r<l?(n.css("margin-left","auto"),o.applyScaleTransform(n,r),c.overflow=!1):i<=l?(o.applyScaleTransform(n,r),c.overflow=!1):(o.applyScaleTransform(n,r,"0 0"),c.overflow=!0),c.level=r,o.features.zoom.levels.current.literal=t||null,o.features.zoom.levels.current.value=r,o.reportInstance.zoom=c,$("#zoom_value").val((100*r).toFixed(0)+"%"),o.propagateZoom(c)},zoomTo:function(e,t){var r,o=this,a=o.features.zoom.levels.current.value;e>a?(r=parseFloat((e-a).toFixed(2)),o.zoomIn(r,t)):e<a?(r=parseFloat((a-e).toFixed(2)),o.zoomOut(r,t)):(o.features.zoom.levels.current.literal=t||null,o.reportInstance&&o.reportInstance.zoom&&(o.reportInstance.zoom.level=e),o.features.zoom.selectedKeys=1===e?["1","fit_actual"]:t?[t]:[""+e])},saveCurrentLevel:function(){this.features.zoom.levels.previous.value=this.features.zoom.levels.current.value,this.features.zoom.levels.previous.literal=this.features.zoom.levels.current.literal},zoomChanged:function(){var e=this.features.zoom.levels.current,t=this.features.zoom.levels.previous;e.value===t.value&&e.literal===t.literal||(this.features.zoom.localZoomChange=!0,this.reportInstance.saveZoom(e.literal||e.value))},applyScaleTransform:function(e,t,r){var o="scale("+t+")",r=r||"50% 0",a={"-webkit-transform":o,"-webkit-transform-origin":r,"-moz-transform":o,"-moz-transform-origin":r,"-ms-transform":o,"-ms-transform-origin":r,"-o-transform":o,"-o-transform-origin":r,transform:o,"transform-origin":r};e.css(a)},scrollElementIntoView:function(e){this.reportInstance.eventManager.triggerEvent("beforeSearchAdvance"),e.scrollIntoView(!1)},render:function render(htmlOutput){var it=this,topOfThePageControls=jQuery("#inputControlsForm.topOfPage");topOfThePageControls.length&&topOfThePageControls.detach(),it.container.html(htmlOutput),topOfThePageControls.length&&topOfThePageControls.insertBefore(jQuery("#reportContainer").children()[0]),$("table.jrPage").prop("tabindex","8"),$("table.jrPage").attr("role","grid"),$("table.jrPage tr").attr("role","row"),$("table.jrPage tbody tr").attr("role","row"),$("table.jrPage tr th").attr("role","columnheader"),$("table.jrPage tbody tr th").attr("role","columnheader"),$("table.jrPage tr td").attr("role","gridcell"),$("table.jrPage tbody tr td").attr("role","gridcell");try{var scripts=[];it.container.find("[name='_evalScript']").each(function(){var e=jQuery(this);scripts.push(e.html()),e.remove()}),$.each(scripts,function(i,v){var $=window.$;eval(v),it.reportInstance.loader.jasperPrintName!==window.Report.jasperPrintName&&(it.reportInstance.loader.jasperPrintName=window.Report.jasperPrintName)})}catch(e){alert(e)}},_getContainer:function(){var e=this.config.at,t=$(e);return t.length||(t=$("#"+e),t.length||(t=$("."+e))),!t.hasClass("_jr_report_container_")&&t.addClass("_jr_report_container_"),t},_zoom:function(e){this.processZoomOption(e.literal?e.literal:e.value)},setupEventsForReport:function(e){var t=this;e.on("reportHtmlReady",function(){var r=this.html;t.renderReportLater=!1;var o=r.match(/flowExecutionKeyOutput = ["|'](\w+)["|']/);if(o[1]&&(window.Report.flowExecutionKeyOutput=o[1]),t.dfds["jive.inactive"]=new $.Deferred,t.jive)if(!t.jive.active||t.isUndoRedo){t.isUndoRedo&&t.jive.hide();var a=$(r).filter(function(){return 1===this.nodeType});t.render(a.removeClass("hidden").html()),$("table.jrPage").css({"margin-left":"auto","margin-right":"auto"}),t.dfds["jive.inactive"].resolve(),$("table.jrPage").prop("tabindex","8"),$("table.jrPage").attr("role","grid"),$("table.jrPage tr").attr("role","row"),$("table.jrPage tbody tr").attr("role","row"),$("table.jrPage tr th").attr("role","columnheader"),$("table.jrPage tbody tr th").attr("role","columnheader"),$("table.jrPage tr td").attr("role","gridcell"),$("table.jrPage tbody tr td").attr("role","gridcell")}else t.renderReportLater=!0;else t.render($(r).removeClass("hidden").html()),$("table.jrPage").css({"margin-left":"auto","margin-right":"auto"}),$("table.jrPage").prop("tabindex","8"),$("table.jrPage").attr("role","grid"),$("table.jrPage tr").attr("role","row"),$("table.jrPage tbody tr").attr("role","row"),$("table.jrPage tr th").attr("role","columnheader"),$("table.jrPage tbody tr th").attr("role","columnheader"),$("table.jrPage tr td").attr("role","gridcell"),$("table.jrPage tbody tr td").attr("role","gridcell"),t.dfds["jive.inactive"].resolve();var n,s=t.features.zoom.levels,i=$.extend({},s.current);t.features.zoom.localZoomChange||null==e.status.defaultZoom||(s.dflt=n=e.status.defaultZoom,isNaN(n)?"string"==typeof n&&0===n.indexOf("fit_")&&(i.literal=n):(i.value=parseFloat(n).toFixed(2),i.literal=null)),s.current.value=1,t.currentZoom=i,$(r).find("div.highcharts_parent_container").length||t._zoom(i),t.restoreLastActiveSearchHighlight(),!t.tabs.maxCount&&e.status.tabs&&(t.tabs=e.status.tabs),t.markActiveReportPart()}),e.on("beforeAction",function(e){var r=$("div#reportViewFrame .body");r.scrollLeft(0),r.scrollTop(0),e.type&&"search"===e.type||t.resetSearch(),t.cleanupBookmarks(),t.cleanupParts(),this.cancelStatusUpdates(),t.features.zoom.localZoomChange=!1}),e.on("error",function(e){e.data&&e.data.error&&e.data.message&&(console&&"function"==typeof console.log&&console.log(e.data.error),dialogs.errorPopup.show(e.data.message)),e.type&&"highchartsInternalError"===e.type&&(buttonManager.disable($("#fileOptions")[0]),buttonManager.disable($("#export")[0]))}),e.on("undo",function(){t.isUndoRedo=!0,t.stateStack.prevState(),t.stateStack.hasNext()&&buttonManager.enable($("#redo")[0]),t.stateStack.hasPrevious()||(buttonManager.disable($("#undo")[0]),buttonManager.disable($("#undoAll")[0])),this.refreshPage(0).then(function(){if(!t.stateStack.hasPrevious()){var e=$("#viewerToolbar li.preDialogFocus"),r=$("#redo").closest("li");e.length?(e.removeClass("preDialogFocus"),r.addClass("preDialogFocus")):stdnav.forceFocus(r[0])}})}),e.on("redo",function(){t.isUndoRedo=!0,t.stateStack.nextState(),buttonManager.enable($("#undo")[0]),buttonManager.enable($("#undoAll")[0]),t.stateStack.hasNext()||buttonManager.disable($("#redo")[0]),this.refreshPage(0).then(function(){if(!t.stateStack.hasNext()){var e=$("#viewerToolbar li.preDialogFocus"),r=$("#undo").closest("li");e.length?(e.removeClass("preDialogFocus"),r.addClass("preDialogFocus")):stdnav.forceFocus(r[0])}})}),e.on("undoall",function(){t.isUndoRedo=!0,t.stateStack.firstState(),buttonManager.enable($("#redo")[0]),buttonManager.disable($("#undo")[0]),buttonManager.disable($("#undoAll")[0]),this.refreshPage(0).then(function(){var e=$("#viewerToolbar li.preDialogFocus"),t=$("#redo").closest("li");e.length?(e.removeClass("preDialogFocus"),t.addClass("preDialogFocus")):stdnav.forceFocus(t[0])})}),e.on("action",function(){t.isUndoRedo=!1,t.stateStack.newState(),buttonManager.enable($("#undo")[0]),buttonManager.enable($("#undoAll")[0]),buttonManager.disable($("#redo")[0]),this.refreshPage(0)}),e.on("search",function(e){var r=e.data;if(t.isUndoRedo=!1,r&&r.result.actionResult.searchResults&&r.result.actionResult.searchResults.length){var o,a,n=r.result.actionResult.searchResults,s=n[0].page-1,i=t.reportInstance.currentpage;for(n.sort(function(e,t){return e.page-t.page}),t.search.results=n,o=0,a=n.length;o<a;o++)if(i===n[o].page-1){s=i;break}this.gotoPage(s).then(function(){var e=$(".jr_search_result:first");e.addClass("highlight"),t.scrollElementIntoView(e[0]),t.search.currentPage=s,n.length>1||1===n.length&&n[0].hitCount>1?($("button#search_next").prop("disabled",!1),$("button#search_previous").prop("disabled",!1)):($("button#search_next").prop("disabled",!0),$("button#search_previous").prop("disabled",!0))})}else r&&r.result.actionResult.searchString&&(dialogs.errorPopup.show('Jaspersoft has finished searching the document. No matches were found for: "'+t.encodeString(r.result.actionResult.searchString)+'"!'),t.resetSearch(!0),this.gotoPage(0))}),e.on("saveZoom",function(){t.isUndoRedo=!1,t.stateStack.newState(),buttonManager.enable($("#undo")[0]),buttonManager.enable($("#undoAll")[0]),buttonManager.disable($("#redo")[0])}),e.on("pageModified",function(){this.gotoPage(this.currentpage)}),e.on("reportFinished",function(){this.status.pageFinal?(t.handleReportBookmarks(this.reportComponents),t.handleReportParts(this.reportComponents),window.Report.snapshotSaveStatus=this.status.originalStatus.snapshotSaveStatus,window.Report.lastPageIndex=this.status.originalStatus.lastPageIndex,window.Report.reportRefreshed()):this.gotoPage(this.currentpage)}),e.on("componentsLoaded",function(){function e(){if(window.location.href.indexOf("viewAsDashboardFrame=true")>-1)try{for(var e,r=parent.jQuery("iframe"),a=0;a<r.length;a++)if(r[a].contentWindow===window){e=r[a];break}if(e)return $(e).parent().height()-o.position().top}catch(e){return $(document).height()?$(document).height()-o.position().top:400}var n=o.offset().top-t.container.offset().top;return Math.max(400,t.container.height()-n)}var r=$("table.jrPage"),o=r.find("div.highcharts_parent_container");if(t.isAdhocView=!1,$.each(this.loadedComponents,function(e,r){"chart"===r.type&&r.hcinstancedata&&r.hcinstancedata.services&&r.hcinstancedata.services.length&&"adhocHighchartsSettingService"===r.hcinstancedata.services[0].service&&(t.isAdhocView=!0,t.recreateChartOptionsOnResize=r.hcinstancedata.services[0].data&&r.hcinstancedata.services[0].data.recreateOptionsOnResize)}),t.isAdhocView){t.container.css({position:"absolute",top:0,right:0,bottom:0,left:0});var a=r.width(),n=o.closest("tr"),s=r.find("tr"),i=s.index(n);if(o.css({"font-size":"11px"}),r.find("tr:first td").each(function(e,t){var r=$(t);r.css("width",r.width()/a*100+"%")}),n.css("height","100%"),s.each(function(e,t){e>i&&$(t).height(0)}),r.css({width:"100%",height:"100%"}),o.css("height",e()+"px"),!t.chartResizeListener){t.chartResizeListener=!0;var l=null;$(window).on("resize",function(){l&&clearTimeout(l),l=setTimeout(function(){$(window).trigger("customResizeEnd")},500)}),$(window).on("customResizeEnd",function(){o.css("height",e()+"px"),$.each(t.reportInstance.components.chart,function(){this.render({recreateConfig:t.recreateChartOptionsOnResize,ignoreSize:!0})})})}}}),e.on("componentsRegistered",function(){var e,r=t.reportInstance.components,o=[];t.loading=!1,t.loaded=!0,$.each(r,function(t,r){r.length>0&&(e=r[0].config.uimodule)&&o.push(e)}),t.dfds["jive.inactive"].then(function(){t.renderReportLater&&t.render($(t.reportInstance.html).removeClass("hidden").html()),o.length&&require(o,function(){$.each(arguments,function(e,r){r.init(t.reportInstance)})})}),t.isAdhocView&&(delete t.reportInstance.components.chart[0].hcConfig.chart.height,delete t.reportInstance.components.chart[0].hcConfig.chart.width);var a=$("table.jrPage"),n=a.find("div.highcharts_parent_container");if(t._zoom(t.currentZoom),r.chart&&(n.attr("js-stdnav","false"),$.each(r.chart,function(){var e=$("#"+this.config.hcinstancedata.renderto).length,r=this;t.isAdhocView?e&&t.container.height()&&setTimeout(function(){r.render()},1):e&&setTimeout(function(){r.render()},1)})),r.hyperlinks&&r.hyperlinks.length){var s=r.hyperlinks[0].config.hyperlinks,i={};$.each(s,function(e,t){i[t.type]||(i[t.type]=[]),i[t.type].push(t)}),$.each(i,function(e,r){require(["jr."+e],function(o){var a=new o(r);a.reportInstance=t.reportInstance,a.reportContainer=t.container,a.register(),t.hyperlinkHandlers[e]=a},function(t){var r=t.requireModules&&t.requireModules[0];r&&console&&"function"==typeof console.error&&console.error("Failed to load module: '"+r+"' for handling hyperlinks of type: '"+e+"'!")})})}if(t.handleReportParts(r),t.handleReportBookmarks(r),r.webfonts&&r.webfonts.length){var l,c=r.webfonts[0].config.webfonts,d=[],u={paths:{}};$.each(c,function(e,t){l="webfont_"+t.id,d.push("csslink!"+l),u.paths[l]=t.path}),requirejs.config(u),require(d,function(){if(/msie/i.test(navigator.userAgent)){var e=document.querySelectorAll("link.jrWebFont");setTimeout(function(){if(e)for(var t=0;t<e.length;t++)e.item(t).href=e.item(t).href},0)}})}r.googlemap&&r.googlemap.length&&$("table.jrPage").attr("js-stdnav","false"),window.Report.reportRefreshed();try{browserDetection.isIE9()&&window.location.href.indexOf("viewAsDashboardFrame=true")>-1&&r.chart&&setTimeout(function(){$(window).resize()},1)}catch(e){}}),e.on("hyperlinkInteraction",function(e){var r=e.data.hyperlink.type;r&&t.hyperlinkHandlers[r]&&t.hyperlinkHandlers[r].handleInteraction(e)})},handleReportBookmarks:function(e){var t=this,r=$("button#bookmarksDialog").closest("li");e.bookmarks&&e.bookmarks.length?(t.prepareBookmarks(e.bookmarks[0].config.bookmarks),r.removeClass("hidden").prev("li.divider").removeClass("hidden")):(r.addClass("hidden").prev("li.divider").addClass("hidden"),t.bookmarksContainer&&t.bookmarksContainer.hide())},handleReportParts:function(e){var t=this;if(e.reportparts&&e.reportparts.length){var r=e.reportparts[0].config.parts,o=!0;t.partsStartIndex&&t.partsStartIndex.length===r.length&&(o=!1),t.prepareReportParts(r,o),t.reportPartsContainer&&t.reportPartsContainer.removeClass("hidden")}},setLocation:function(e){document.location=e},encodeString:function(e){return $("<div/>").text(e).html()}},Viewer.publicMethods={loadReport:function(){var e=this;return e.loading=!0,e.reportInstance=new JReport({reporturi:e.config.reporturi,async:e.config.async,page:e.config.page,contextPath:e.config.contextPath,postProcess:function(){this.html.indexOf('id="emptyReportMessageHolder"')>0?this.status={isComponentMetadataEmbedded:!1,pageTimestamp:0,totalPages:-1}:(this.loader.jasperPrintName=this.status.jasperPrintName,this.loader.contextid=this.status.contextid)},container:e.container}),e.setupEventsForReport(e.reportInstance),e.reportInstance.init()},exit:function(){var e=new $.Deferred;return e.resolve(),this.reportInstance?this.reportInstance.loader.exit():e}},Viewer.actionStateCounter={stateStack:{counter:0,states:[],position:-1},currentState:function(){return this.stateStack.currentState()}},$.extend(Viewer.actionStateCounter.stateStack,{newState:function(){this.position+2<this.states.length&&this.states.splice(this.position+2,this.states.length-this.position-2),++this.position,++this.counter,this.states[this.position]=this.counter},prevState:function(){this.position>0&&--this.position},firstState:function(){this.position=0},nextState:function(){this.position+1<this.states.length&&++this.position},hasPrevious:function(){return this.position>0},hasNext:function(){return this.position+1<this.states.length},currentState:function(){return this.states[this.position]}}),$.extend(Viewer.prototype,Viewer.privateMethods),$.extend(Viewer.prototype,Viewer.publicMethods),$.extend(Viewer.prototype,Viewer.actionStateCounter),module.exports=Viewer});