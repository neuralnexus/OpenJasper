define(["require","exports","module","underscore","jquery","xregexp","./BaseDataSourceModel","./JdbcDriverModel","../collection/JdbcDriverCollection","settings!dataSourcePatterns","../enum/connectionTypes","bundle!jasperserver_messages","runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes","bundle!jasperserver_config"],function(e,t,r){var s=e("underscore"),i=e("jquery"),n=e("xregexp"),o=e("./BaseDataSourceModel"),a=e("./JdbcDriverModel"),l=e("../collection/JdbcDriverCollection"),u=e("settings!dataSourcePatterns"),c=e("../enum/connectionTypes"),d=e("bundle!jasperserver_messages"),v=e("runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes"),p=e("bundle!jasperserver_config"),h=n(u.forbidWhitespacesPattern),C=function(){var e={};return s.extend(e,o.prototype.validation,{connectionUrl:[{required:!0,msg:d["ReportDataSourceValidator.error.not.empty.reportDataSource.connectionUrl"]},{fn:function(e,t,r){if(!this.drivers.getDriverByClass(r.selectedDriverClass).get("allowSpacesInDbName")&&!h.test(e))return d["ReportDataSourceValidator.error.invalid.chars.reportDataSource.connectionUrl"]}}]}),e}();r.exports=o.extend({JDBC_BUNDLE_PREFIX:"resource.dataSource.jdbc.",otherDriverIsPresent:!0,type:v.JDBC_DATA_SOURCE,defaults:function(){var e={};return s.extend(e,o.prototype.defaults,{driverClass:"",selectedDriverClass:"",username:"",password:"",timezone:"",connectionUrl:"",isOtherDriver:!1,connectionType:c.JDBC}),e}(),validation:function(){return s.extend({},C)}(),initialize:function(e,t){o.prototype.initialize.apply(this,arguments),this.initialization=i.Deferred(),this.drivers=new l([],this.options);var r=this;this.fetchDrivers().then(function(){r.isNew()?r.setCustomAttributesDefaultValues(r.drivers.getDefaultDriver()):(r.set("selectedDriverClass",r.get("driverClass")),r.set(r.getCustomAttributeValuesFromConnectionUrl()),r.set("password",p["input.password.substitution"]),r.extendValidation());var e=s.map(r.drivers.getAllPossibleCustomAttributes(),function(e){return"change:"+e}).join(" ");r.on(e,r.setConnectionUrlFromCustomAttributes),r.on("change:connectionUrl",r.setCustomAttributesFromConnectionUrl),r.on("change:selectedDriverClass",r.changeSelectedDriver),r.initialization.resolve()})},fetchDrivers:function(){var e=this;return this.drivers.fetch({reset:!0}).done(function(){var t=s.groupBy(e.drivers.models,function(e){return e.attributes.available});s.each(t,function(e,r){t[r]=s.sortBy(e,function(e){return e.attributes.label})});var r=[];t.true&&(r=r.concat(t.true)),t.false&&(r=r.concat(t.false)),e.drivers.models=r,e.drivers.driverUploadEnabled&&e.otherDriverIsPresent&&e.drivers.add({defaultValues:{},jdbcDriverClass:a.OTHER_DRIVER,label:d["resource.dataSource.jdbc.otherDriver"],available:!1,default:!1,jdbcUrl:"",uploaded:!1})})},getCurrentDriver:function(){return this.drivers.getDriverByClass(this.get("selectedDriverClass"))},changeSelectedDriver:function(){var e=this.drivers.getDriverByClass(this.get("selectedDriverClass"));e&&(this.setCustomAttributesDefaultValues(e),this.setConnectionUrlFromCustomAttributes(),this.trigger("driverClassChange",this))},setCustomAttributesFromConnectionUrl:function(){var e=this.getCustomAttributeValuesFromConnectionUrl();this.set(e,{silent:!0}),this.trigger("customAttributesUpdate",this)},setConnectionUrlFromCustomAttributes:function(){var e=this.getCurrentDriver(),t=e.getCustomAttributes(),r=this.pick(t),s=this.replaceConnectionUrlTemplatePlaceholdersWithValues(e.get("jdbcUrl"),r);this.set("connectionUrl",s,{silent:!0}),this.trigger("connectionUrlUpdate",this)},getAttributeValueFromUrl:function(e,t){var r=t.exec(e);return[].slice.call(r||[],1)},getCustomAttributeValuesFromConnectionUrl:function(){var e,t=this.getCurrentDriver(),r=this.get("connectionUrl"),i=n(t.convertUrlTemplateToRegex()),o=t.getCustomAttributes(),a={};return e=this.getAttributeValueFromUrl(r,i),s.each(e,function(e,t){a[o[t]]=e}),a},setCustomAttributesDefaultValues:function(e){this.unsetCustomAttributes();var t={};e.isOtherDriver()?(t.selectedDriverClass=e.get("jdbcDriverClass"),t.driverClass="",t.isOtherDriver=!0):(s.extend(t,e.get("defaultValues")),t.selectedDriverClass=e.get("jdbcDriverClass"),t.driverClass=e.get("jdbcDriverClass"),t.isOtherDriver=!1,t.connectionUrl=this.replaceConnectionUrlTemplatePlaceholdersWithValues(e.get("jdbcUrl"),e.get("defaultValues"))),this.set(t,{silent:!0}),this.extendValidation()},unsetCustomAttributes:function(){var e=this;s.each(this.drivers.getAllPossibleCustomAttributes(),function(t){e.unset(t,{silent:!0})})},replaceConnectionUrlTemplatePlaceholdersWithValues:function(e,t){var r=this.getRegExpFieldGroupsFromConnectionUrlTemplate(e);return s.each(r,function(r){e=e.replace(r[0],s.isUndefined(t[r[1]])?"":t[r[1]])}),e},getRegExpFieldGroupsFromConnectionUrlTemplate:function(e){for(var t,r=[];!s.isNull(t=a.FIELD_TEMPLATE_REGEXP.exec(e));)s.isArray(t)&&2===t.length&&r.push(t);return r},extendValidation:function(){var e=this,t={},r=this.getCurrentDriver().getCustomAttributes();s.extend(t,C),s.each(r,function(r){t[r]=[{xRegExpPattern:a.VALIDATION_PATTERNS[r],msg:d[e.JDBC_BUNDLE_PREFIX+"invalidField"].replace("{0}",d[e.JDBC_BUNDLE_PREFIX+r])}]}),this.validation=t},toJSON:function(){var e=o.prototype.toJSON.apply(this,arguments);return this.options.isEditMode&&e.password===p["input.password.substitution"]&&(e.password=null),e}})});