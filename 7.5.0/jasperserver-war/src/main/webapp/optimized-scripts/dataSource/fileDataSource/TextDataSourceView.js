define(["require","exports","module","underscore","bundle!all","../../resource/resource.locate","../view/CustomDataSourceView","./TextDataSourceModel","./enum/delimitersTextDataSource","./enum/characterEncodings","./enum/fileSourceTypes","text!./template/backboneTemplate.htm","text!./template/fileLocationTemplate.htm","text!./template/filePropertiesTemplate.htm","text!runtime_dependencies/js-sdk/src/common/templates/components.pickers.htm"],function(e,t,i){var o=e("underscore"),r=e("bundle!all"),s=e("../../resource/resource.locate"),n=e("../view/CustomDataSourceView"),l=e("./TextDataSourceModel"),a=e("./enum/delimitersTextDataSource"),d=e("./enum/characterEncodings"),u=e("./enum/fileSourceTypes"),c=e("text!./template/backboneTemplate.htm"),m=e("text!./template/fileLocationTemplate.htm"),h=e("text!./template/filePropertiesTemplate.htm"),p=e("text!runtime_dependencies/js-sdk/src/common/templates/components.pickers.htm"),f=o.reduce(u,function(e,t){return"repository"===t.name&&e.push(t),e},[]);i.exports=n.extend({PAGE_TITLE_NEW_MESSAGE_CODE:"resource.datasource.text.page.title.new",PAGE_TITLE_EDIT_MESSAGE_CODE:"resource.datasource.text.page.title.edit",modelConstructor:l,browseButton:!1,events:function(){var e=o.extend({},n.prototype.events);return e["change [name=fileSourceType]"]="changeFileSourceType",e},initialize:function(e){n.prototype.initialize.apply(this,arguments),this.listenTo(this.model,"change:serverFileName",this.adjustFileSystemConnectButton),this.listenTo(this.model,"change:serverAddress",this.adjustFtpServerConnectButton),this.listenTo(this.model,"change:serverPath",this.adjustFtpServerConnectButton),this.listenTo(this.model,"change:ftpsPort",this.adjustFtpServerConnectButton),this.listenTo(this.model,"change:fieldDelimiter",this.adjustFieldDelimiterSection),this.listenTo(this.model,"change:rowDelimiter",this.adjustRowDelimiterSection),this.listenTo(this.model,"change",this.adjustPreviewButton),this.listenTo(this.model,"sourceFileIsOK",this.sourceFileIsOK),this.listenTo(this.model,"sourceFileCantBeParsed",this.sourceFileCantBeParsed)},changeFileSourceType:function(){o.defer(o.bind(function(){this.renderFileLocationSection()},this))},render:function(){return this.$el.empty(),this.renderTextDataSourceSection(),this},templateData:function(){return o.extend(n.prototype.templateData.apply(this,arguments),{fileSourceTypeOptions:f,fieldDelimiterOptions:a,rowDelimiterOptions:a,encodingOptions:d})},renderTextDataSourceSection:function(){this.$el.append(o.template(c,this.templateData())),this.renderFileLocationSection(),this.renderFilePropertiesSection()},renderFileLocationSection:function(){this.renderOrAddAnyBlock(this.$el.find("[name=textDataSourceFieldsContainer]"),o.template(m,this.templateData())),this.browseButton&&(this.browseButton.remove(),this.browseButton=!1),"repository"===this.model.get("fileSourceType")&&(this.browseButton=s.initialize({i18n:r,template:p,resourceInput:this.$el.find("[name=repositoryFileName]")[0],browseButton:this.$el.find("[name=repositoryBrowserButton]")[0],providerId:"contentResourceTreeDataProvider",dialogTitle:r["resource.Add.Files.Title"],selectLeavesOnly:!0,onChange:o.bind(function(e){this.model.set("repositoryFileName",e),this.model.validate({repositoryFileName:e})},this)})),this.adjustFileSystemConnectButton(),this.adjustFtpServerConnectButton()},adjustFileSystemConnectButton:function(){var e=this.model.isValid("serverFileName");this._adjustButton("serverFileSystemConnectToServer",e)},adjustFtpServerConnectButton:function(){var e=this.model.isValid(["serverAddress","serverPath","ftpsPort"]);this._adjustButton("ftpConnectToServer",e)},renderFilePropertiesSection:function(){this.renderOrAddAnyBlock(this.$el.find("[name=textDataSourceFieldsContainer]"),o.template(h,this.templateData())),this.adjustFieldDelimiterSection(),this.adjustRowDelimiterSection(),this.adjustPreviewButton()},adjustFieldDelimiterSection:function(){this._adjustSection("fieldDelimiter",{regex:"fieldDelimiterRegexInput",plugin:"fieldDelimiterPluginInput",other:"fieldDelimiterOtherInput"})},adjustRowDelimiterSection:function(){this._adjustSection("rowDelimiter",{regex:"rowDelimiterRegexInput",plugin:"rowDelimiterPluginInput",other:"rowDelimiterOtherInput"})},adjustPreviewButton:function(){var e="repository"===this.model.get("fileSourceType")&&this.model.isValid("repositoryFileName"),t="serverFileSystem"===this.model.get("fileSourceType")&&this.model.isValid("serverFileName"),i="ftpServer"===this.model.get("fileSourceType")&&this.model.isValid(["serverAddress","serverPath","ftpsPort"]),o=e||t||i;this._adjustButton("previewDataSource",o)},_adjustButton:function(e,t){var i=this.$el.find("[name="+e+"]");t?i.removeAttr("disabled"):i.attr("disabled","disabled")},_adjustSection:function(e,t){var i=this;o.each(t,function(t,o){i.$el.find("[name="+t+"]").toggleClass("hidden",i.model.get(e)!==o)})},sourceFileIsOK:function(){this.fieldIsValid(this,"repositoryFileName","name")},sourceFileCantBeParsed:function(){this.fieldIsInvalid(this,"repositoryFileName",r["resource.file.cantBeProcessed"],"name")}})});