define(["require","exports","module","backbone","underscore","jquery","bundle!all","./model/BaseDataSourceModel","../util/touch.controller","runtime_dependencies/js-sdk/src/common/util/featureDetection","../util/historyHelper","./factory/dataSourceViewFactory","./enum/dataSourceResourceTypes","./factory/saveDialogViewFactory","text!./template/dataSourceMainTemplate.htm","text!runtime_dependencies/js-sdk/src/common/templates/dialogErrorPopupTemplate.htm","runtime_dependencies/js-sdk/src/jrs.configs","./collection/CustomDataSourceCollection","settings!awsSettings","./util/settingsUtility","../util/redirectToUrlUtil","../components/components.dialogs"],function(e,t,a){var o=e("backbone"),r=e("underscore"),i=e("jquery"),s=e("bundle!all"),n=e("./model/BaseDataSourceModel"),c=e("../util/touch.controller"),d=e("runtime_dependencies/js-sdk/src/common/util/featureDetection"),l=e("../util/historyHelper"),u=e("./factory/dataSourceViewFactory"),h=e("./enum/dataSourceResourceTypes"),p=e("./factory/saveDialogViewFactory"),S=e("text!./template/dataSourceMainTemplate.htm"),m=e("text!runtime_dependencies/js-sdk/src/common/templates/dialogErrorPopupTemplate.htm"),v=e("runtime_dependencies/js-sdk/src/jrs.configs"),f=e("./collection/CustomDataSourceCollection"),g=e("settings!awsSettings"),y=e("./util/settingsUtility"),D=e("../util/redirectToUrlUtil"),T=e("../components/components.dialogs"),w=r.template(v.contextPath+"/domaindesigner.html?dataSource={{-resourceUri}}");a.exports=o.View.extend({dataSourceType:!1,dataSourceView:!1,saveDialog:!1,events:{"change select[name='dataSourceType']":"onDataSourceTypeChange","click #saveBtn, #createDomainBtn":"onSaveClick","click #cancelBtn":"onCancelClick"},historyBackToken:"DataSourceControllerHistory",constructor:function(e){var t=Array.prototype.slice.call(arguments,0);e=i.extend(!0,{},e),t[0]=e,this.isEditMode=e.isEditMode,o.View.apply(this,t)},initialize:function(e){this.options=e,this.dataSourceType=void 0,d.supportsTouch&&this.initSwipeScroll(),l.saveReferrer(this.historyBackToken),this.fetchingCustomDataSourcesDeferred=i.Deferred(),this.fetchingTheModelDeferred=i.Deferred(),this.customDataSourceCollection=new f,this.customDataSourceCollection.fetch().done(r.bind(function(){this.renderDataSourceContainer()},this));var t=y.deepDefaults(e,{awsSettings:g});if(this.options.resourceUri){var a=this,o=new n({uri:this.options.resourceUri});o.fetch().then(function(e,t,r){a.dataSource=o.attributes,a.dataSourceType=u.getViewType(r.getResponseHeader("Content-Type"),a.dataSource),a.fetchingTheModelDeferred.resolve()})}else this.options.dataSource&&this.options.dataSourceClientType?(this.dataSource=this.options.dataSource,this.dataSourceType=u.getViewType(this.options.dataSourceClientType,this.options.dataSource),this.fetchingTheModelDeferred.resolve()):(t.awsSettings.productTypeIsEc2&&(this.dataSourceType=u.getViewType(h.AWS,null)),this.fetchingTheModelDeferred.resolve())},renderDataSourceContainer:function(){var e={AZURE_SQL:"AzureSql",AWS:"Aws",BEAN:"Bean",JDBC:"JDBC",JNDI:"JNDI",VIRTUAL:"Virtual"},t=r.chain(e).map(function(e,t){return{value:h[t].toLowerCase(),label:s["resource.dataSource.dstype"+e]}}).value();this.customDataSourceCollection.forEach(function(e){var a=e.get("id");t.push({value:a,label:s[a+".name"]?s[a+".name"]:a})}),t=r.sortBy(t,function(e){return e.label.toLowerCase()}),this.$el.append(r.template(S,{dataSourceTypeOptions:t,i18n:s,supportsTouch:d.supportsTouch,isEditMode:this.isEditMode})),this.fetchingCustomDataSourcesDeferred.resolve()},initSwipeScroll:function(){var e=this.$("#stepDisplay");e.length&&new c(e.parent()[0],e.parent().parent()[0],{})},render:function(){i.when(this.fetchingCustomDataSourcesDeferred,this.fetchingTheModelDeferred).done(r.bind(function(){this._render()},this))},_render:function(){var e={};return this.dataSourceView&&(e={label:this.dataSourceView.model.get("label"),name:this.dataSourceView.model.get("name"),description:this.dataSourceView.model.get("description")}),this.dataSourceView&&this.dataSourceView.remove(),delete this.dataSourceView,0===this.$(".row.inputs .body:eq(0)").length&&this.$(".row.inputs > .column > .content").append("<div class='body dataSourceBody'></div>"),this.dataSourceType||(this.dataSourceType=h.JDBC.toLowerCase()),this.dataSourceView=u.getView(r.extend(this.options,{dataSourceType:this.dataSourceType,dataSource:r.extend({},this.dataSource,e),el:this.$(".row.inputs .body:eq(0)")})),this.$(".dataSourceBody").attr("dstype",this.dataSourceType.toLowerCase()),this.$("select[name='dataSourceType']").val(this.dataSourceType),this.dataSource&&this.dataSource.label&&this.$(".pageHeader .pageHeader-title-text").text(this.dataSource.label),this},onDataSourceTypeChange:function(e){var t=i(e.target).val();this.dataSourceType!=t&&(this.dataSourceType=t,this.render())},_prepareSaveDialog:function(e){this.saveDialog&&this.saveDialog.remove();var t=p.getView(this.dataSourceType);this.saveDialog=new t(r.extend({},this.options,{model:this.dataSourceView.model,saveFn:this.options.saveFn,success:r.bind(e?this._onSaveAndCreateDomainDone:this._onSaveDone,this),error:r.bind(this._onSaveFail,this)}))},onSaveClick:function(e){if(this.dataSourceView.model.isValid(!0)){var t=this,a=e&&"createDomainBtn"==e.currentTarget.id,o=function(){t._prepareSaveDialog(a),t.saveDialog.startSaveDialog()};return r.isUndefined(this.dataSourceView.model.validationMethodOnSaveClick)?r.isUndefined(this.dataSourceView.validationMethodOnSaveClick)?void o():void this.dataSourceView.validationMethodOnSaveClick(o):void this.dataSourceView.model.validationMethodOnSaveClick(o)}},_onSaveDone:function(){D.redirect(v.contextPath+"/flow.html?_flowId=repositoryConfirmFlow&resourceType=dataSource")},_onSaveAndCreateDomainDone:function(e){D.redirect(w({resourceUri:e.get("uri")}))},_onSaveFail:function(e,t){this.saveDialog&&(this.saveDialog.close(),this.saveDialog.remove());var a=this,o=!1,i=!1;try{o=JSON.parse(t.responseText)}catch(e){}if(r.isArray(o)||(o=[o]),r.each(o,function(e){var t=!1,o=!1;e&&("mandatory.parameter.error"===e.errorCode?e.parameters&&e.parameters[0]&&(o=s["resource.datasource.saveDialog.parameterIsMissing"],t=e.parameters[0].substr(e.parameters[0].indexOf(".")+1)):"illegal.parameter.value.error"===e.errorCode&&e.parameters&&e.parameters[0]&&(t=e.parameters[0].substr(e.parameters[0].indexOf(".")+1),o=s["resource.datasource.saveDialog.parameterIsWrong"]),"ConnectionUrl"===t&&(t="connectionUrl"),o&&t&&(a.dataSourceView.invalidField("[name="+t+"]",o),i=!0))}),!1===i){var n=r.template(m,{message:"Failed to save data source.",errorCode:o[0]?o[0].errorCode:null,errorMsg:o.message,respText:t.responseText});T.errorPopup.show(n)}},onCancelClick:function(){this.options.cancelFn?this.options.cancelFn():l.restore(this.historyBackToken)}})});