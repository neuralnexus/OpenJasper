define(["require","exports","module","underscore","runtime_dependencies/js-sdk/src/common/component/dialog/AlertDialog","../view/JdbcDataSourceView","../view/BaseDataSourceView","../model/AzureSqlDataSourceModel","../../dynamicTree/dynamicTree.utils","bundle!jasperserver_messages","bundle!jsexceptions_messages","text!../template/azureSqlSpecificTemplate.htm","text!runtime_dependencies/js-sdk/src/common/templates/components.pickers.htm","../../resource/resource.locate"],function(e,r,t){var o=e("underscore"),a=e("runtime_dependencies/js-sdk/src/common/component/dialog/AlertDialog"),i=e("../view/JdbcDataSourceView"),s=e("../view/BaseDataSourceView"),n=e("../model/AzureSqlDataSourceModel"),d=e("../../dynamicTree/dynamicTree.utils"),c=e("bundle!jasperserver_messages"),u=e("bundle!jsexceptions_messages"),l=e("text!../template/azureSqlSpecificTemplate.htm"),p=e("text!runtime_dependencies/js-sdk/src/common/templates/components.pickers.htm"),m=e("../../resource/resource.locate");t.exports=i.extend({PAGE_TITLE_NEW_MESSAGE_CODE:"resource.datasource.aws.page.title.new",PAGE_TITLE_EDIT_MESSAGE_CODE:"resource.datasource.aws.page.title.edit",modelConstructor:n,events:function(){var e={};return o.extend(e,i.prototype.events),e["click #updateDatabaseTree"]="updateDatabaseTree",e},initialize:function(e){s.prototype.initialize.apply(this,arguments),this.listenTo(this.model,"change",this.onModelChange)},onModelChange:function(){var e=o.keys(this.model.changedAttributes()),r=["serverName","dbName","connectionUrl"],t=this;o.each(o.intersection(e,r),function(e){t.$("[name='"+e+"']").val(t.model.get(e))})},updateDatabaseTree:function(e){e.preventDefault(),this.showAzureSqlDsTree("/")},render:function(){return this.$el.empty(),this.renderTimezoneSection(),this.renderAzureSqlSpecificSection(),this.renderTestConnectionSection(),this.initDataSourceTree(),this.options.isEditMode&&this.showAzureSqlDsTree(this.model.getFullDbTreePath()),this},showAzureSqlDsTree:function(e){this.model.validate({subscriptionId:this.model.get("subscriptionId"),keyStorePassword:this.model.get("keyStorePassword"),keyStoreUri:this.model.get("keyStoreUri")}),this.model.isValid("keyStorePassword")&&this.model.isValid("subscriptionId")&&this.azureSqlDataSourceTree.showTreePrefetchNodes(e||"/")},renderAzureSqlSpecificSection:function(){this.$el.append(o.template(l,this.templateData())),this.browseButton=m.initialize({i18n:c,template:p,resourceInput:this.$el.find("[name=keyStoreUri]")[0],browseButton:this.$el.find("[name=repositoryBrowserButton]")[0],providerId:"fileResourceBaseTreeDataProvider",dialogTitle:c["resource.Add.Files.Title"],selectLeavesOnly:!0,onChange:o.bind(function(e){this.model.set("keyStoreUri",e),this.model.validate({keyStoreUri:e})},this)})},initDataSourceTree:function(){var e=this.options.isEditMode,r=this,t={hideLoader:!0,bShowRoot:!1,treeId:"azureSqlDataSourceTree",providerId:"azureSqlDataSourceTreeDataProvider",selectLeavesOnly:!0,additionalParams:function(){return{subscriptionId:r.model.get("subscriptionId"),keyStorePassword:r.model.get("keyStorePassword"),keyStoreUri:r.model.get("keyStoreUri"),datasourceUri:r.model.get("uri")}}};this.azureSqlDataSourceTree=d.createRepositoryTree("azureSqlDataSourceTree",t),this.azureSqlDataSourceTree.httpErrorHandler=function(e){var r,t,o=!1,i=["azure.exception.datasource.recovery.public.ip.not.provided","azure.exception.datasource.recovery.firewall.rule.name.not.provided","azure.exception.datasource.recovery.server.name.not.provided","azure.exception.datasource.recovery.subscription.id.not.provided","azure.exception.datasource.recovery.key.store.file.not.provided","azure.exception.datasource.recovery.key.store.type.not.provided","azure.exception.datasource.key.error","azure.exception.datasource.auth.error","azure.exception.datasource.cannot.retrieve.database.list","azure.exception.datasource.cannot.ensure.firewall.rule","azure.exception.datasource.cannot.recover.datasource"];for(t=0;t<i.length;t++){var s=i[t];if(-1!==e.responseText.indexOf(s)){o=u[s];break}}return!!o&&(r=new a({modal:!0}),r.setMessage(o),r.open(),!0)},this.azureSqlDataSourceTree.observe("leaf:selected",function(t){var o=t.memo.node.param;if("leaf"===o.type&&!e){var a=o.extra;r.model.set({serverName:a.serverName,dbName:a.dBName,connectionUrlTemplate:a.jdbcTemplate,driverClass:a.jdbcDriver})}}),this.azureSqlDataSourceTree.observe("tree:loaded",function(){r.model.getFullDbTreePath()&&r.azureSqlDataSourceTree.openAndSelectNode(r.model.getFullDbTreePath(),function(){e=!1;var t=r.azureSqlDataSourceTree.getSelectedNode();t&&t.param&&t.param.extra&&r.model.set({connectionUrlTemplate:t.param.extra.jdbcTemplate,dbHost:t.param.extra.dnsAddress,dbPort:t.param.extra.dbPort})})})},remove:function(){this.azureSqlDataSourceTree&&this.azureSqlDataSourceTree.stopObserving(),i.prototype.remove.apply(this,arguments)}})});