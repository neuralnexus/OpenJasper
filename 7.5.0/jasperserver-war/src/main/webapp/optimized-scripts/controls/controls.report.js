define(["require","exports","module","prototype","../namespace/namespace","../core/core.layout","./controls.core","../util/utils.common","../components/components.dialogs","./controls.base","./controls.options","../namespace/namespace","../reportViewer/report.view.base","settings!inputControls","jquery","underscore","runtime_dependencies/js-sdk/src/common/component/dialog/ConfirmationDialog","runtime_dependencies/js-sdk/src/components/overlay/Overlay","../reportViewer/report.view.base","./controls.controller"],function(e,o,t){var n=e("prototype"),r=n.$,s=n.$$,i=e("../namespace/namespace"),l=i.JRS,a=e("../core/core.layout"),p=e("./controls.core"),c=e("../util/utils.common"),u=c.centerElement,O=c.matchAny,d=c.triggerNativeEvent,C=c.isIPad,g=c.selectAndFocusOn,h=e("../components/components.dialogs"),m=e("./controls.base"),_=m.ControlsBase,T=m.OptionsDialog,v=m.ControlDialog,R=e("./controls.options"),N=e("../namespace/namespace"),f=N.isProVersion,S=e("../reportViewer/report.view.base"),w=e("settings!inputControls"),A=e("jquery"),L=e("underscore"),P=e("runtime_dependencies/js-sdk/src/common/component/dialog/ConfirmationDialog"),U=e("runtime_dependencies/js-sdk/src/components/overlay/Overlay");e("../reportViewer/report.view.base"),e("./controls.controller");var y=function(e,o,t,n){return o.extend(t,{_messages:{},layouts:{LAYOUT_POPUP_SCREEN:1,LAYOUT_SEPARATE_PAGE:2,LAYOUT_TOP_OF_PAGE:3,LAYOUT_IN_PAGE:4},controlDialog:null,reportOptionsDialog:null,inputControlsLocation:null,toggleControlsOn:!1,controller:null,hideControls:null,selectionChanged:!0,initialize:function(){this.controller=new l.Controls.Controller({reportUri:n.reportUnitURI,reportOptionUri:n.reportOptionsURI});var s=o.extend(n.getAllRequestParameters(),n.reportParameterValues);this.controller.fetchControlsStructure(s).always(function(r){var s=t.controller.getViewModel(),i=s.areAllControlsValid(),p=!o.isUndefined(o.find(n.parametersWithoutDefaultValues,function(e){return!o.contains(o.keys(n.getAllRequestParameters()),e)}));n.hasInputControls&&((n.reportForceControls||p)&&o.isEmpty(n.reportParameterValues)||!i)?((!r||"number"!=typeof r.status||r.status<300)&&t.show(),n&&n.nothingToDisplay&&(n.nothingToDisplay.removeClassName(a.HIDDEN_CLASS),u(n.nothingToDisplay,{horz:!0,vert:!0}),e("#"+n.DATA_REFRESH_BUTTON).attr(a.DISABLED_ATTR_NAME,a.DISABLED_ATTR_NAME)),t.lastSelection=s.get("selection")):t.refreshReport(),l.Controls.listen({"viewmodel:selection:changed":function(){t.selectionChanged=!0},"reportoptions:selection:changed":function(e,o){t.selectionChanged=!0}})}),this.viewModel=t.controller.getViewModel(),this.initializeOptions(),this.buttonActions={"button#ok":o.bind(t.applyInputValues,t,!0),"button#apply":o.bind(t.applyInputValues,t),"button#cancel":o.bind(t.cancel,t),"button#reset":t.resetToInitial,"button#save":t.save,"button#remove":t.remove};var i={"button#ok":o.bind(t.applyInputValues,t,!0),"button#cancel":o.bind(t.cancel,t),"button#reset":t.resetToInitial,"button#apply":o.bind(t.applyInputValues,t),"button#save":t.save,"button#remove":t.remove};r(_.INPUT_CONTROLS_DIALOG)&&(this.controlDialog=new v(i)),r(_.INPUT_CONTROLS_FORM)&&r(_.INPUT_CONTROLS_FORM).observe("click",function(e){var o=e.element();for(var t in this.buttonActions)if(O(o,[t],!0))return this.buttonActions[t](),void e.stop()}.bindAsEventListener(this)),this.inputControlsLocation=r(r(_.INPUT_CONTROLS_CONTAINER)?_.INPUT_CONTROLS_CONTAINER:_.INPUT_CONTROLS_FORM),r(_.TOOLBAR_CONTROLS_BUTTON)&&(this.toggleControlsOn=r(_.TOOLBAR_CONTROLS_BUTTON).hasClassName("down"))},initializeOptions:function(){function s(){var o;(o=e(t.layouts.LAYOUT_POPUP_SCREEN==n.reportControlsLayout?"#"+_.INPUT_CONTROLS_DIALOG:"#"+_.INPUT_CONTROLS_FORM))&&o.length>0&&o.addClass("showingSubHeader")}function i(){var o;(o=e(t.layouts.LAYOUT_POPUP_SCREEN==n.reportControlsLayout?"#"+_.INPUT_CONTROLS_DIALOG:"#"+_.INPUT_CONTROLS_FORM))&&o.length>0&&o.removeClass("showingSubHeader")}if(f()){var a;a=this.layouts.LAYOUT_POPUP_SCREEN==n.reportControlsLayout?"#"+_.INPUT_CONTROLS_DIALOG+" .sub.header":(this.layouts.LAYOUT_TOP_OF_PAGE,n.reportControlsLayout,"#"+_.INPUT_CONTROLS_FORM+" .sub.header");var p=new R;p.fetch(n.reportUnitURI,n.reportOptionsURI).done(function(){e(a).append(p.getElem()),t.lastReportOptionsSelection=p.get("selection")}).fail(function(){e(a).addClass("hidden")}).always(function(){t.lastReportOptionsSelection||(t.lastReportOptionsSelection=p.get("defaultOption"))}),p.updateWarningMessage=function(){t.reportOptionsDialog.showWarning(this.error)},l.Controls.listen({"viewmodel:selection:changed":function(){var e=p.find({uri:n.reportUnitURI});p.set({selection:e},!0)},"viewmodel:order:changed":o.bind(function(e,t){n.newIcOrder=o.pluck(t,"id").join(";")},this)});var c={"button#saveAsBtnSave":function(){var o=t.reportOptionsDialog.input.getValue(),r=t.viewModel.get("selection"),i=o===t.reportOptionsDialog.optionNameToOverwrite;p.add(n.reportUnitURI,o,r,i).done(function(){t.reportOptionsDialog.hideWarning(),h.systemConfirm.show(_.getMessage("report.options.option.saved")),s();var o=p.getElem().parent();o.length>0?o.removeClass("hidden"):(e(a).removeClass("hidden"),e(a).append(p.getElem())),t.layouts.LAYOUT_TOP_OF_PAGE==n.reportControlsLayout&&e("#"+_.INPUT_CONTROLS_FORM+" .header").removeClass("hidden"),t.reportOptionsDialog.hide(),delete t.reportOptionsDialog.optionNameToOverwrite}).fail(function(e){if(e)try{"report.options.dialog.confirm.message"===JSON.parse(e.responseText).errorCode&&!i&&(t.reportOptionsDialog.optionNameToOverwrite=o)}catch(e){}})},"button#saveAsBtnCancel":function(){t.reportOptionsDialog.hide(),delete t.reportOptionsDialog.optionNameToOverwrite}};r(_.SAVE_REPORT_OPTIONS_DIALOG)&&(this.reportOptionsDialog=new T(c)),this.remove=function(){var o=p.get("selection").label,r=new P({text:_.getMessage("report.options.option.confirm.remove",{option:o})});r.on("button:yes",function(){p.removeOption(n.reportUnitURI,p.get("selection").id).done(function(){if(!p.get("values")){i();var o=p.getElem().parent();o.length>0?o.addClass("hidden"):(e(a).addClass("hidden"),e(a).html("")),t.layouts.LAYOUT_TOP_OF_PAGE==n.reportControlsLayout&&e("#"+_.INPUT_CONTROLS_FORM+" .header").addClass("hidden")}p.enableRemoveButton(!1),h.systemConfirm.show(_.getMessage("report.options.option.removed"))}),r.remove()}),r.on("button:no",function(){r.remove()}),r.open()},t.reportOptions=p}},cancel:function(){n.reportControlsLayout==t.layouts.LAYOUT_SEPARATE_PAGE&&t.separatePageICLayoutFirstShow?n.goBack():t.controller.update(t.lastSelection).always(function(){n.reportControlsLayout==t.layouts.LAYOUT_POPUP_SCREEN?t.controlDialog.hide():n.reportControlsLayout==t.layouts.LAYOUT_SEPARATE_PAGE&&t.showReport(),t.reportOptions&&t.lastReportOptionsSelection&&t.reportOptions.set({selection:t.lastReportOptionsSelection},!0)})},getLastSelection:function(){return this.lastSelection},save:function(){t.selectionChanged?t.controller.validate().then(t.showOptionDialog):t.showOptionDialog()},refreshReport:function(r){var s=new e.Deferred,i=s.promise(),a=t.viewModel.get("selection");if(r){if(!l.Controls.ViewModel.isSelectionChanged(t.lastSelection,a))return s.resolve(),i()}try{a&&!o.isEmpty(a)?(i=n.refreshReport(null,null,_.buildSelectedDataUri(a)),t.lastSelection=a):(i=n.refreshReport(),t.lastSelection={})}catch(e){alert(e),s.reject(e)}return i},applyInputValues:function(r){var s=t.viewModel;t.selectionChanged?t.controller.validate().then(function(s){if(s){var i,l=t.lastSelection;t.reportOptions&&(i=t.lastReportOptionsSelection),window.viewer&&window.viewer.jive&&window.viewer.jive.hide(),t.refreshReport().then(function(){t.selectionChanged=!1},function(){var s=new U({zIndex:h.errorPopup.getZIndex()-1});e("body").append(s.$el),s.show(),t.lastSelection=l,t.lastReportOptionsSelection=i,h.errorPopup.onClose=function(){t.lastSelection&&!o.isEmpty(t.lastSelection)?n.refreshReport(null,null,_.buildSelectedDataUri(t.lastSelection)):n.refreshReport(),s.remove()},r&&(t.cancel(),t.selectionChanged=!1)}),t.reportOptions&&(t.lastReportOptionsSelection=t.reportOptions.get("selection")),r&&t.hide()}}):s.areAllControlsValid()&&r&&t.hide()},resetToInitial:function(){t.selectionChanged=!0;var e=t.reportOptions;if(e){var r=e.find({uri:n.reportOptionsURI?n.reportOptionsURI:n.reportUnitURI});if(r)return void e.set({selection:r})}var s=null;"true"===w.useUrlParametersOnReset&&(s=o.extend(n.getAllRequestParameters(),n.reportParameterValues)),t.controller.reset(null,s)},show:function(){switch(n.reportControlsLayout){case 2:t.showControls();break;case 3:t.toggleControls();break;case 4:break;default:t.showDialog()}},hide:function(){switch(n.reportControlsLayout){case 2:t.showReport();break;case 3:case 4:break;default:t.controlDialog.hide()}},toggleControls:function(){t.toggleControlsOn?(r(_.TOOLBAR_CONTROLS_BUTTON).removeClassName("down").addClassName("up"),s(".panel.pane.inputControls")[0].addClassName(a.HIDDEN_CLASS),d("resize")):(r(_.TOOLBAR_CONTROLS_BUTTON).removeClassName("up").addClassName("down"),s(".panel.pane.inputControls")[0].removeClassName(a.HIDDEN_CLASS)),t.toggleControlsOn=!t.toggleControlsOn,C()&&n.touchController.reset(),e("#"+_.INPUT_CONTROLS_FORM).show().height()},showDialog:function(){t.controlDialog&&t.controlDialog.show()},showReport:function(){r(a.PAGE_BODY_ID).removeClassName(a.CONTROL_PAGE_CLASS).addClassName(a.ONE_COLUMN_CLASS)},showControls:function(){r(a.PAGE_BODY_ID).removeClassName(a.ONE_COLUMN_CLASS).addClassName(a.CONTROL_PAGE_CLASS),document.getElementById(_.INPUT_CONTROLS_FORM)&&e("#"+_.INPUT_CONTROLS_FORM).show()},showOptionDialog:function(){l.Controls.Utils.wait(200).then(function(){t.viewModel.areAllControlsValid()&&(t.reportOptionsDialog.show(),g(t.reportOptionsDialog.input))})}})}(A,L,p,S);t.exports=y});