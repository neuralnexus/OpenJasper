define(["require","exports","module","jquery","../namespace/namespace","underscore","./controls.core","./controls.datatransfer","./controls.viewmodel","./controls.components","jquery.urldecoder"],function(t,e,r){var n=t("jquery"),o=t("../namespace/namespace"),i=o.JRS,s=t("underscore");t("./controls.core"),t("./controls.datatransfer"),t("./controls.viewmodel"),t("./controls.components"),t("jquery.urldecoder"),function(t,e,r){function n(e){var r=t.url.parse(location.href).params;return r&&r[e]}e.extend(r,{Controller:r.Base.extend({constructor:function(n){e.bindAll(this,"fetchControlsStructure","detectReportUri","getReportUri","getDataTransfer","getViewModel","updateControlsValues","reset","update","validate"),this.viewModel=n&&n.viewModel?n.viewModel:new r.ViewModel,this.dataTransfer=n&&n.dataTransfer?n.dataTransfer:new r.DataTransfer({dataConverter:new r.DataConverter}),this.initialize(n),r.listen({"viewmodel:selection:changed":e.bind(function(t,e,r,n){e&&n&&this.updateControlsValues(e,r)},this),"reportoptions:selection:changed":e.bind(function(t,e){var r=e&&e.reportOption,n=e&&e.selectedData;this.reset(r&&r.uri,n)},this)}),r.getController=e.bind(function(){return this},this),t(document).trigger("controls:initialized",[this.getViewModel()])},initialize:function(t){this.dataTransfer.setReportUri(this.detectReportUri(t))},fetchControlsStructure:function(t,r){var n=this.dataTransfer,o=this.viewModel,i=r&&!e.isEmpty(t)?e.keys(t):[];return n.fetchControlsStructure(i,t).done(function(t){t&&o.set({structure:t.structure,state:t.state})})},detectReportUri:function(t){if(this.reportUri=t&&t.reportUri||n("reportUnitURI"),!this.reportUri)throw Error("Can't initialize without reportUri");return this.reportOptionUri=t&&t.reportOptionUri||n("reportOptionsURI"),this.getReportUri()},getReportUri:function(){return this.reportOptionUri||this.reportUri},getDataTransfer:function(){return this.dataTransfer},getViewModel:function(){return this.viewModel},updateControlsValues:function(t,r){var n=this.getDataTransfer(),o=this.getViewModel(),i=r||e.map(o.getControls(),function(t){return t.id});return n.fetchControlsUpdatedValues(i,t).done(function(t){o.set(t)})},reset:function(t,e){var r=this;return this.getDataTransfer().fetchInitialControlValues(t||this.getReportUri(),e).done(function(t){r.getViewModel().set(t)})},update:function(t){return t||(t=this.getViewModel().get("selection")),this.updateControlsValues(t)},validate:function(){var t=this.getDataTransfer(),r=this.getViewModel(),n=e.map(r.getControls(),function(t){return t.id}),o=r.get("selection");return t.fetchControlsUpdatedValues(n,o).then(function(t){var n=e(t.state).reduce(function(t,e,r){return t[r]={error:e.error},t},{});r.set({state:n})}).then(function(){return r.areAllControlsValid()})}})})}(n,s,i.Controls),r.exports=i.Controls});