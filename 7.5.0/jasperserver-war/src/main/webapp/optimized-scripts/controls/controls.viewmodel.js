define(["require","exports","module","../namespace/namespace","underscore","jquery","runtime_dependencies/js-sdk/src/common/util/browserDetection","./controls.core","./controls.basecontrol","jquery-ui/ui/widgets/sortable"],function(t,e,n){var o=t("../namespace/namespace"),i=o.JRS,r=t("underscore"),s=t("jquery"),a=t("runtime_dependencies/js-sdk/src/common/util/browserDetection");t("./controls.core"),t("./controls.basecontrol"),t("jquery-ui/ui/widgets/sortable"),i.Controls=function(t,e,n){var o=a.isIE(),i=function(){var e,n=(new Date).getTime();return function(){var o=(new Date).getTime(),i=this;o-n>400&&(n=o,t(this).trigger("scrollstart")),clearTimeout(e),e=setTimeout(function(){t(i).trigger("scrollstop")},300)}}(),r=n.Base.extend({constructor:function(t){this.containerSelector=t&&t.containerSelector||n.ViewModel.DEFAULT_CONTAINER,this.controls={},n.getViewModel=e.bind(function(){return this},this),e.bindAll(this,"registerEvents","onControlChange","_getAllSlaveControlIds","_getParentControlIds"),this.registerEvents()},registerEvents:function(){n.ignore("changed:control",this.onControlChange),n.listen({"changed:control":this.onControlChange})},onControlChange:function(o,i){var r,s,a=i.slaveDependencies&&i.slaveDependencies.length;if(a){s=this._getAllSlaveControlIds(i.id);var l=this._getParentControlIds(s),c=e.union(s,l);r=this.get("selection"),e.isEmpty(c)||e.each(r,function(t,n){-1===e.indexOf(c,n)&&delete r[n]})}else r=this.get("selection");t(document).trigger(n.ViewModel.CHANGE_SELECTION,[r,s,a]),a||t(document).trigger(n.ViewModel.CHANGE_VALUES,[this.state])},_getAllSlaveControlIds:function(t){var n=[],o=this.findControl({id:t});return o&&!e.isEmpty(o.slaveDependencies)&&e.each(o.slaveDependencies,function(t){n.push(t),n.push.apply(n,this._getAllSlaveControlIds(t))},this),e.uniq(n)},_getParentControlIds:function(t){var n=[];return e.each(t,function(t){var e=this.findControl({id:t});n.push.apply(n,e.masterDependencies)},this),e.uniq(n)}},{DEFAULT_CONTAINER:"#inputControlsContainer",CHANGE_VALUES:"viewmodel:values:changed",CHANGE_SELECTION:"viewmodel:selection:changed",CHANGE_ORDER:"viewmodel:order:changed",isSelectionChanged:function(t,n){var o=t?e(t).keys():[],i=n?e(n).keys():[];if(e.union(o,i).length===o.length){var r=t?e.flatten(e(t).values()):[],s=n?e.flatten(e(n).values()):[];return e.difference(r,s).length>0||e.difference(s,r).length>0}return!0}}),s={getControls:function(){return this.controls},instantiate:function(t){this.controls={},e.each(t,this.createControl,this)},createControl:function(t){var e=function(t){for(var e in n)if(t.toLowerCase()===e.toLowerCase())return n[e]}(t.type);if(!e)throw new Error("Can not find implementation of the control type: "+t.type);return this.controls[t.id]=new e(t),this.controls[t.id]},removeControl:function(t){delete this.controls[t]},reorderControl:function(e,o){if(1!=this.structure.length){for(var i,r=e<o?1:-1,s=e<o?Math.min(e,o):Math.max(e,o),a=e<o?Math.max(e,o):Math.min(e,o),l=s;l!=a;l+=r)i=this.structure[l],this.structure[l]=this.structure[l+r],this.structure[l+r]=i;t(document).trigger(n.ViewModel.CHANGE_ORDER,[this.structure])}},set:function(o,i){if(o){if(e.extend(this,o),void 0!==o.structure){var r=o.structure;this.instantiate(r),this.draw(r)}if(void 0!==o.state){var s=o.state;this.update(s),!i&&t(document).trigger(n.ViewModel.CHANGE_VALUES,[o.state])}}},get:function(t){if(t){if("selection"===t){var n={};return e.each(this.getControls(),function(t){var o=t.get("selection");o instanceof Array?n[t.id]=o:e.isUndefined(o)||(n[t.id]=[o])}),n}return this[t]}},findControl:function(t){var n=e.keys(t)[0],o=e.values(t)[0];return e.find(this.getControls(),function(t){return t[n]===o})},pluck:function(t){return e.pluck(this.getControls(),t)}},l={draw:function(t){var n=this.getContainer();if(n.empty(),o&&(n.attr("js-stdnav","false"),n.attr("js-navtype","none")),e.each(t,function(t){if(t.visible){var e=this.findControl({id:t.id});e.makeResizable&&e.makeResizable(),n.append(e.getElem())}},this),window.Report&&window.Report.icReorderEnabled){var i=window.Controls.layouts.LAYOUT_TOP_OF_PAGE==Report.reportControlsLayout;/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)||this._initSortable({container:n,horizontalLayout:i})}},update:function(t){e.each(t,function(t,e){this.findControl({id:e}).set({values:t.values,error:t.error})},this)},getContainer:function(){return this.container&&1==this.container.length?this.container:(this.container=t(this.containerSelector),this.container)},removeValidationMessages:function(){e.each(this.getControls(),function(t){t.set({error:null})})},areAllControlsValid:function(){return e.isEmpty(e.filter(this.getControls(),function(t){return!t.isValid()}))},setContainer:function(e){this.container=t(e)},reloadContainer:function(){return this.container=t(this.containerSelector),this.container},disable:function(){e.each(this.getControls(),function(t){t.set({disabled:!0})})},enable:function(){e.each(this.getControls(),function(t){t.set({disabled:!1})})},_initSortable:function(n){var r=n.container,s=n.horizontalLayout,a=!1,l=this,c=t(r).sortable({delay:200,placeholder:s?"verticalPlaceholder":"horizontalPlaceholder",axis:s?"x":"y",items:"> .leaf",cancel:"input,textarea,button,select,option,.list.inputSet,.jr-mSizer",start:function(t,e){e.item.data("oldIndex",e.item.index()),a=!0},stop:e.bind(function(t,e){var n=e.item.data("oldIndex"),o=e.item.index();n!=o&&this.reorderControl(n,o),a=!1},this)});if(o){var u=n.parent||c.parent();u.off("scroll",i),u.off("scrollstart"),u.off("scrollstop"),u.on("scroll",i),u.on("scrollstart",function(){if(!a)try{c.sortable("destroy")}catch(t){}}),u.on("scrollstop",function(){!a&&l._initSortable({parent:u,container:r,horizontalLayout:s})})}}};return e.extend(r.prototype,s,l),e.extend(n,{ViewModel:r})}(s,r,i.Controls),n.exports=i.Controls});