define(["require","exports","module","prototype","./resource.base","./resource.locate","../util/utils.common","../dataSource/DataSourceController","runtime_dependencies/js-sdk/src/jrs.configs","jquery","underscore"],function(e,t,i){var o=e("prototype"),a=o.$,s=e("./resource.base"),n=e("./resource.locate"),r=e("../util/utils.common"),d=r.ValidationModule,_=e("../dataSource/DataSourceController"),c=e("runtime_dependencies/js-sdk/src/jrs.configs"),u=e("jquery"),l=e("underscore"),h={STEP1_PAGE_ID:"addResource_query_step1",STEP2_PAGE_ID:"addResource_locateDataSource",STEP3_PAGE_ID:"addResource_query_step3",LABEL_ID:"query.label",RESOURCE_ID_ID:"query.name",DESCRIPTION_ID:"query.description",JUMP_TO_PAGE_ID:"jumpToPage",DONE_BUTTON_ID:"done",NEXT_BUTTON_ID:"next",JUMP_TO_BUTTON_ID:"jumpButton",NEW_DATA_SOURCE_LINK_ID:"newDataSourceLink",LOCAL_DATA_SOURCE_ID:"LOCAL",RESOURCE_URI_INPUT_ID:"resourceUri",QUERY_SQL:"query.sql",_canGenerateId:!0,initialize:function(e){this._step1Page=a(this.STEP1_PAGE_ID),this._step2Page=a(this.STEP2_PAGE_ID),this._step3Page=a(this.STEP3_PAGE_ID),this._step1Page&&(this._form=a(document.body).select("form")[0],this._label=a(this.LABEL_ID),this._resourceId=a(this.RESOURCE_ID_ID),this._description=a(this.DESCRIPTION_ID),this._label.validator=s.labelValidator.bind(this),this._resourceId.validator=s.resourceIdValidator.bind(this),this._description.validator=s.descriptionValidator.bind(this)),this._step2Page&&(this._form=a(document.body).select("form")[0],this._dataSourceUri=a(this.RESOURCE_URI_INPUT_ID),this._dataSourceUri.validator=s.dataSourceValidator.bind(this)),this._step3Page&&(this._form=a(document.body).select("form")[0],this._query=a(this.QUERY_SQL),this._query.validator=s.queryValidator.bind(this)),this._nextButton=a(this.NEXT_BUTTON_ID),this._doneButton=a(this.DONE_BUTTON_ID),this._jumpToPage=a(this.JUMP_TO_PAGE_ID),this._jumpButton=a(this.JUMP_TO_BUTTON_ID),this._newDataSourceLink=a(this.NEW_DATA_SOURCE_LINK_ID),this._localDataSource=a(this.LOCAL_DATA_SOURCE_ID),this._isEditMode=!!e&&e.isEditMode,n.initialize({resourceInput:"resourceUri",browseButton:"browser_button",newResourceLink:"newDataSourceLink",treeId:"queryTreeRepoLocation",providerId:"dsTreeDataProvider",dialogTitle:s.messages["resource.Query.Title"],selectLeavesOnly:!0}),this._initEvents()},_initEvents:function(){if(this._nextButton.observe("click",function(e){this._isDataValid()||e.stop(),this._localDataSource&&this._localDataSource.checked&&(e.stop(),this._newDataSourceLink.click())}.bindAsEventListener(this)),this._doneButton.observe("click",function(e){this._isDataValid()||e.stop()}.bindAsEventListener(this)),this._form.observe("keyup",function(e){var t=e.element();t==this._resourceId&&this._resourceId.getValue()!=s.generateResourceId(this._label.getValue())&&(this._canGenerateId=!1),t==this._label&&!this._isEditMode&&this._canGenerateId&&(this._resourceId.setValue(s.generateResourceId(this._label.getValue())),d.validate(s.getValidationEntries([this._resourceId])))}.bindAsEventListener(this)),this._newDataSourceLink){var e=this;this._newDataSourceLink.observe("click",function(t){if(e._localDataSource.checked){var i=c.addDataSource?l.clone(c.addDataSource.initOptions):{};i.saveFn=function(t,i){t.type=i.type;var o=document.createElement("input");o.type="hidden",o.name="dataSourceJson",o.value=JSON.stringify(l.extend(i.toJSON(),{name:t.name})),e._form.appendChild(o),o=document.createElement("input"),o.type="hidden",o.name="dataSourceType",o.value=i.type,e._form.appendChild(o),o=document.createElement("input"),o.type="hidden",o.name="_eventId_saveDatasource",e._form.appendChild(o),e._form.submit()},i.cancelFn=function(){e._form.submit()},i.skipLocation=!0,window.localContext&&window.localContext.initOptions&&window.localContext.initOptions&&(window.localContext.initOptions.dataSourceJson?(i.isEditMode=!0,i.dataSource=window.localContext.initOptions.dataSourceJson,i.dataSourceClientType=window.localContext.initOptions.dataSourceJson.type):window.localContext.initOptions.dataSourceUri&&(i.isEditMode=!0,i.resourceUri=window.localContext.initOptions.dataSourceUri));var o=new _(i);u("#display").append(o.$el),u("#selectFromRepository").remove(),o.render()}}.bindAsEventListener(this))}},_isDataValid:function(){var e=!0;return this._label&&(e=e&&d.validate(s.getValidationEntries([this._label]))),this._resourceId&&(this._resourceId.getValue()!=s.generateResourceId(this._label.getValue())&&(this._canGenerateId=!1),!this._isEditMode&&this._canGenerateId&&(this._resourceId.setValue(s.generateResourceId(this._label.getValue())),e=e&&d.validate(s.getValidationEntries([this._resourceId])))),this._description&&(e=e&&d.validate(s.getValidationEntries([this._description]))),this._dataSourceUri&&!this._dataSourceUri.disabled&&(e=e&&d.validate(s.getValidationEntries([this._dataSourceUri]))),this._query&&(e=e&&d.validate(s.getValidationEntries([this._query]))),e},jumpTo:function(e){return this._jumpToPage.setValue(e),this._jumpButton.click(),!1}};void 0===e&&document.observe("dom:loaded",function(){h.initialize(window.localContext.initOptions)}),i.exports=h});