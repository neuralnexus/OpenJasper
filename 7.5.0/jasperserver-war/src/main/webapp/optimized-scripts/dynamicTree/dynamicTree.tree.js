define(["require","exports","module","prototype","../core/core.layout","../util/utils.common"],function(e,t,s){var d=e("prototype"),r=d.$,i=e("../core/core.layout"),o=e("../util/utils.common"),l=o.isNotNullORUndefined,n=o.cloneCustomAttributes,a={trees:{},nodes:{},treeNodeEdited:null,editaborted:!1,activeTreeId:null,Tree:function(e,t){this.id=e,t?(this.setRootNode(t.root),this.bShowRoot=!!t.bShowRoot,this.handleNodeOnDblclick=void 0===t.handleNodeOnDblclick||t.handleNodeOnDblclick,this.multiSelectEnabled=!!t.multiSelectEnabled,this.showAllNodesOnStartup=!!t.showAllNodesOnStartup,this.treeClassName=t.treeClassName?t.treeClassName:"",this.dragPattern=t.dragPattern,this.dragClasses=t.dragClasses,this.dropClasses=t.dropClasses,this.selectOnMousedown=t.selectOnMousedown,this.regionID=t.regionID,this.scroll=t.scroll,this.templateDomId=t.templateDomId?t.templateDomId:this.DEFAULT_TREE_TEMPLATE_ID):(this.templateDomId=this.DEFAULT_TREE_TEMPLATE_ID,this.handleNodeOnDblclick=!0),this.stateObject={},this.sortNodes=!0,this.sorters=[this.sortByOrder,this.sortByName],this.selectedNodes=[],this.TREE_NN_ITEMS_SELECTED="#{count} items selected",a.trees[this.id]=this,this._createFromTemplate(),this.refreshStyle(),this._registerEvents(),this._registerCustomScroll()},getNextId:function(){var e=1;return function(){return e++}}(),getActiveTree:function(){return a.trees[a.activeTreeId]},getTreeNode:function(e){return a.nodes[e]},getStorageVal:function(e){return(JSON.parse(window.localStorage.getItem("dynamicTree"))||{})[e]||null},setStorageVal:function(e,t){var s=window.localStorage,d=JSON.parse(s.getItem("dynamicTree"))||{};d[e]=t;try{s.setItem("dynamicTree",JSON.stringify(d))}catch(e){window.console&&console.log(e)}},_templateHash:{}};a.Tree.addVar("DEFAULT_TREE_TEMPLATE_ID","list_responsive_collapsible"),a.Tree.addVar("HIDE_ROOT_CLASS_NAME","hideRoot"),a.Tree.addMethod("getId",function(){return this.id}),a.Tree.addMethod("_getElement",function(){return this._element||(this._element=r(this.id)),this._element}),a.Tree.addMethod("_createFromTemplate",function(){this._getElement()&&(this._getElement().insert({after:this._getTemplateElement(this._getElement())}),this._getElement().remove(),this._element=null,this._getElement().update())}),a.Tree.addMethod("_registerCustomScroll",function(){if(!this.scroll&&this._getElement()){var e=this._getElement().up(i.SWIPE_SCROLL_PATTERN);if(e){var t=i.scrolls.get(e.identify());t&&(this.scroll=t)}}}),a.Tree.addMethod("setRootNode",function(e){this.rootNode=e,this.rootNode&&(this.rootNode.treeId=this.id)}),a.Tree.addMethod("getRootNode",function(){return this.rootNode}),a.Tree.addMethod("refreshStyle",function(){var e=this._getElement();e.templateClassName&&(e.className=e.templateClassName),this.treeClassName&&e.addClassName(this.treeClassName),this.bShowRoot?e.removeClassName(this.HIDE_ROOT_CLASS_NAME):e.addClassName(this.HIDE_ROOT_CLASS_NAME)}),a.Tree.addMethod("resetSelected",function(){this._prevSelectedNodes=this.selectedNodes.clone(),this.selectedNodes=[]}),a.Tree.addMethod("revertSelection",function(e){var t=this._prevSelectedNodes.clone();t=t.concat(this.selectedNodes),this.selectedNodes=this._prevSelectedNodes.clone();for(var s=0;s<t.length;s++)t[s].refreshStyle()}),a.Tree.addMethod("getSelectedNode",function(){return 0===this.selectedNodes.length?null:this.selectedNodes[0]}),a.Tree.addMethod("addNodeToSelected",function(e){this.selectedNodes.push(e),this._prevSelectedNodes=this.selectedNodes.clone()}),a.Tree.addMethod("removeNodeFromSelected",function(e){for(var t=0;t<this.selectedNodes.length;t++)if(this.selectedNodes[t]==e)return this._prevSelectedNodes=this.selectedNodes.clone(),void this.selectedNodes.splice(t,1)}),a.Tree.addMethod("isNodeSelected",function(e){var t=this.selectedNodes&&this.selectedNodes.length;if(t)for(var s=0;s<t;s++)if(this.selectedNodes[s]==e)return!0;return!1}),a.Tree.addMethod("resortSubtree",function(e){if(e){e.resortChilds();for(var t=0;t<e.childs.length;t++)this.resortSubtree(e.childs[t])}}),a.Tree.addMethod("resortTree",function(){this.sortNodes&&this.resortSubtree(this.rootNode)}),a.Tree.addMethod("readStates",function(){var e=a.getStorageVal("tree"+this.id);if(e)for(var t in e)this.stateObject[t]=e[t]}),a.Tree.addMethod("getState",function(e){var t,s=this.stateObject;return s[e]?(t=s[e],null!==t&&""!==t||(t=a.TreeNode.State.CLOSED),t):a.TreeNode.State.CLOSED}),a.Tree.addMethod("writeStates",function(e,t){var s={},d=this.stateObject;for(var r in d)s[r]=d[r];d[e]=t,null!=t&&(s[e]=t),a.setStorageVal("tree"+this.id,s)}),a.Tree.addMethod("resetStates",function(){this.stateObject={},a.setStorageVal("tree"+this.id,"")}),a.Tree.addMethod("comparer",function(e,t){var s,d;if(this.sorters&&this.sorters.length)for(s=0;s<this.sorters.length;s++)if(0!==(d=this.sorters[s](e,t)))return d;return 0}),a.Tree.addMethod("renderTree",function(){this.readStates(),this.stopWaiting(),this.refreshStyle();var e=this._getElement();this.rootNode&&(this.writeStates(this.rootNode.id,a.TreeNode.State.OPEN),this.rootNode.showNode(),this.rootNode.render(e),this.refreshScroll())}),a.Tree.addMethod("refreshScroll",function(e){e?setTimeout(function(){this.scroll&&this.scroll.refresh()}.bind(this),e):this.scroll&&this.scroll.refresh()}),a.Tree.addMethod("binarySearchOfNode",function(e,t){for(var s=0,d=e.length-1;s<=d;){var r=Math.round((s+d)/2),i=e[r];if(this.comparer(i,t)<0)s=r+1;else{if(!(this.comparer(i,t)>0))return r;d=r-1}}return-(s+1)}),a.Tree.addMethod("_deselectAllNodes",function(e){if(this.selectedNodes.length>0){var t=this.selectedNodes.clone();this.resetSelected();for(var s=0;s<t.length;s++)t[s].refreshStyle();if(e){a.trees[this.id].fireUnSelectAllEvent(e)}}}),a.Tree.addMethod("_selectOrEditNode",function(e,t,s,d,r,i){var o,n,h,c=t.isSelected()&&r,u=this.multiSelectEnabled&&t.isSelected()&&s&&!c,N=t.isSelected()&&a.treeNodeEdited!==t&&!this.multiSelectEnabled&&!s&&!c,f=null!=a.treeNodeEdited&&(T||u),S=this.multiSelectEnabled&&!t.isSelected()&&d&&l(this._lastSelectedNode)&&this._lastSelectedNode.parent===t.parent,m=this.multiSelectEnabled&&t.isSelected()&&d&&l(this._lastSelectedNode)&&this._lastSelectedNode.parent===t.parent,T=!this.multiSelectEnabled&&!t.isSelected()||this.multiSelectEnabled&&!s&&!t.isSelected(),_=!t.isSelected()||T&&this.selectedNodes.length>1;if(d&&this._lastSelectedNode||(this._lastSelectedNode=t),u&&t.deselect(e),T&&this._deselectAllNodes(e),N)return void t.edit(e);if(f&&a.treeNodeEdited.doEndEdit(e),S||m){h=t.parent;var E=h.childs.indexOf(this._lastSelectedNode),g=h.childs.indexOf(t);o=Math.min(E,g),n=Math.max(E,g)}if(S)if(o>-1)for(var p=o;p<=n;p++)h.childs[p].select(e);else h.childs[n].select(e);else if(m){for(var p=0;p<o;p++)h.childs[p].deselect(e);for(var p=n+1;p<h.childs.length;p++)h.childs[p].deselect(e)}else _&&t.select(e,t.nofocus,i)}),a.Tree.addMethod("_deselectOthers",function(e,t,s,d,r){this.multiSelectEnabled&&this.selectedNodes.length>1&&t.isSelected()&&!(s||d||r)&&this.selectedNodes.findAll(function(e){return e!=t}.bind(this)).invoke("deselect",e)}),a.Tree.addMethod("_selectNextNode",function(e,t){function s(e){return e=e.parent,e?e.nextSibling?e.nextSibling:s(e):null}var d=e.isOpen()&&e.getFirstChild()||e.nextSibling||s(e);d&&e.deselect()&&d.select(t)}),a.Tree.addMethod("_selectPreviousNode",function(e,t){function s(e){return!(e.isOpen()&&e.hasChilds())&&e||s(e.getLastChild())}var d=e.prevSibling&&s(e.prevSibling)||e.parent;d&&e.deselect()&&d.select(t)}),a.Tree.addMethod("_selectInwards",function(e,t){var s=e.isOpen()&&e.getFirstChild();s?e.deselect()&&s.select(t):e.handleNode(t)}),a.Tree.addMethod("_selectOutwards",function(e,t){if(!e.isHiddenRootNode()){var s=e.isOpen()?null:e.parent;s?e.deselect()&&s.select(t):e.handleNode(t)}}),a.Tree.addMethod("sortByOrder",function(e,t){var s=e.orderNumber,d=t.orderNumber;return null==s&&null==d?0:null==s?1:null==d?-1:s-d}),a.Tree.addMethod("sortByName",function(e,t){var s=e.name.toLowerCase(),d=t.name.toLowerCase();return s>d?1:s<d?-1:0}),a.Tree.addVar("TREE_WAIT_TEMPLATE_DOM_ID","list_responsive_collapsible:loading"),a.Tree.addMethod("wait",function(){r(this.id).update(r(this.TREE_WAIT_TEMPLATE_DOM_ID).cloneNode(!0))}),a.Tree.addMethod("stopWaiting",function(){r(this.id).update("")}),a.Tree.addMethod("_getTemplateElement",function(e){var t=this.templateDomId,s=r(t).cloneNode(!0);return s.writeAttribute("id",this.getId()),s.templateId=t,s.templateClassName=s.className,n(e,s),s}),s.exports=a});