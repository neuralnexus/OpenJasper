define(["require","exports","module","jquery","underscore","backbone","bundle!ImportExportBundle","../export/view/ExportDialogView","../import/view/ImportDialogView","./tenantTree","runtime_dependencies/js-sdk/src/common/component/menu/ContextMenu","text!../templates/tooltipTemplate.htm"],function(e,t,n){var i=e("jquery"),o=e("underscore"),r=e("backbone"),s=e("bundle!ImportExportBundle"),a=e("../export/view/ExportDialogView"),l=e("../import/view/ImportDialogView"),p=e("./tenantTree"),c=e("runtime_dependencies/js-sdk/src/common/component/menu/ContextMenu"),h=e("text!../templates/tooltipTemplate.htm"),d=r.View.extend({initialize:function(e){this.$container=i(e.container);var t=window.localStorage?JSON.parse(localStorage.getItem("selectedTenant")):null,n=e.selectedTenant||t,r=e.currentUser?e.currentUser.split("|")[1]||"organizations":"/"===n.tenantUri?n.tenantId||"organizations":"organizations";this.splittedUri=o.compact(n.tenantUri.split("/")),this.splittedUri.splice(this.splittedUri.length-1,1),this.splittedUri.unshift(r);var d={tooltipContentTemplate:h,tenantId:n.id||r,comparator:e.comparator};e.removeContextMenuTreePlugin||(this.contextMenu=new c([{label:s["context.menu.option.export"],action:"export"},{label:s["context.menu.option.import"],action:"import"}],{hideOnMouseLeave:!0}),o.extend(d,{contextMenu:this.contextMenu}),this.listenTo(this.contextMenu,"option:export",this._onExport),this.listenTo(this.contextMenu,"option:import",this._onImport)),this.exportDialog=new a,this.importDialog=new l,this.tree=new p(d),this._initEvents()},render:function(){this.$container.append(this.tree.render().$el)},refreshTenant:function(e){var t=this.tree.getLevel(e);this.tree.getDataLayer(t).predefinedData=[],e?t.refresh():this.tree.refresh()},getTenant:function(){return this.selectedTenant},setTenant:function(e,t,n){t?this.selectedTenant[t]=n:this.selectedTenant=e},selectTenant:function(e){this.tree.select(e)},addTenant:function(e,t){var n=this.tree.getLevel(e);this.listenToOnce(n,"ready",function(){this.tree.addItem(e,this._processItem(t,!0))}),n.open()},updateTenant:function(e,t,n){this.tree.updateItem(this._processItem(t,!1,n),e)},removeTenant:function(e,t){var n,i=this.tree.getLevel(t);e=o.isArray(e)?e:[e],o.each(e,function(e){(n=this.tree.getLevel(e))&&n.remove()},this),i.refresh(),i.open()},remove:function(){this.tree.remove(),this.contextMenu&&this.contextMenu.remove()},_processItem:function(e,t,n){var i=e.tenantId||e.id,o=e.tenantFolderUri||e.tenantUri,r=e.tenantName,s={id:i,label:r,uri:o,tenantUri:o,parentId:e.parentId};return t?{_node:!0,id:i,label:r,value:s}:{id:e.tenantId,addToSelection:n,label:r,value:s}},_initEvents:function(){this.expandedLevels=[],this.listenTo(this.tree,"selection:change",function(e){this.trigger("selection:change",o.compact(e)[0])}),this.listenTo(this.importDialog,"import:finished",function(e){this.refreshTenant(e),this.trigger("import:finished",e)}),this._recursivelyOpenLevels(this.tree.rootLevel)},_recursivelyOpenLevels:function(e){this.listenTo(e,"ready",function(){var e=this.tree.getLevel(this.splittedUri[0]);this.splittedUri.splice(0,1),e?(this.expandedLevels.push(e),this.tree.expand(e.id),this._recursivelyOpenLevels(e)):o.each(this.expandedLevels,function(e){this.stopListening(e,"ready")},this)})},_onExport:function(){this.exportDialog.openTenantDialog(this.selectedTenant)},_onImport:function(){this.importDialog.openDialog(this.selectedTenant)}});n.exports=d});