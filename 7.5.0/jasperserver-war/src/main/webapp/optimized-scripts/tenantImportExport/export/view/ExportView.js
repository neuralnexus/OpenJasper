define(["require","exports","module","jquery","underscore","backbone","../model/ExportModel","../model/ExportStateModel","../model/AuthorityPickerModel","./AuthorityPickerView","./LoadingDialog","./ExportDependentResourcesDialogView","runtime_dependencies/js-sdk/src/common/component/notification/Notification","runtime_dependencies/js-sdk/src/common/view/mixin/epoxyViewMixin","../factory/exportTemplateFactory","../enum/exportTypesEnum","bundle!ImportExportBundle","bundle!CommonBundle","settings!awsSettings"],function(e,s,t){function i(e){this.rolesList=new u({model:c.instance("rest_v2/{{if (tenantId) { }}organizations/{{-tenantId}}/{{ } }}roles?q={{-searchString}}{{ if (excludeSubOrgs) { }}&includeSubOrgs=false{{ } }}",{tenantId:e.tenantId}),customClass:"selectedRoles",title:y["export.dialog.roles.users.roles.label"],selectLabel:y["export.dialog.roles.users.select.all.roles.label"]}),this.rolesList.on("change:selection",this.bindWithRoles),this.rolesList.render(),this.usersList=new u({model:c.instance("rest_v2/{{if (tenantId) { }}organizations/{{-tenantId}}/{{ } }}users?q={{-searchString}}{{ if (excludeSubOrgs) { }}&includeSubOrgs=false{{ } }}",{tenantId:e.tenantId}),customClass:"select selectedUsers",title:y["export.dialog.roles.users.users.label"],selectLabel:y["export.dialog.roles.users.select.all.users.label"]}),this.usersList.on("change:selection",this.bindWithUsers),this.usersList.render(),this.rolesToUsers=c.instance("rest_v2/users?hasAllRequiredRoles=false{{ if (roles) for (var i = 0; i < roles.length; i++) { }}&requiredRole={{-roles[i]}}{{ } }}"),this.rolesToUsers.on("change",this.onRolesToUsersChange),this.usersToRoles=c.instance("rest_v2/roles?hasAllUsers=false{{ if (users) for (var i = 0; i < users.length; i++) { }}&user={{-users[i]}}{{ } }}"),this.usersToRoles.on("change",this.onUsersToRolesChange),this.changeEnabledState(),this.listenTo(this.model,"change:everything",this.changeEnabledState),this.$el.find(".selectRolesUsers").append(this.rolesList.el).append(this.usersList.el),this.listenTo(this.model,"change:includeSubOrganizations",this.filterAuthoritiesBySubOrgs)}function o(){var e=document.createElement("iframe");e.src=this.model.url()+"/"+this.stateModel.id+"/"+this.model.get("fileName"),e.style.display="none",r("body").append(e)}function n(e){this.model.cancel(),this.stateModel.set("phase",e)}var r=e("jquery"),l=e("underscore"),h=e("backbone"),a=e("../model/ExportModel"),d=e("../model/ExportStateModel"),c=e("../model/AuthorityPickerModel"),u=e("./AuthorityPickerView"),g=e("./LoadingDialog"),p=e("./ExportDependentResourcesDialogView"),m=e("runtime_dependencies/js-sdk/src/common/component/notification/Notification"),f=e("runtime_dependencies/js-sdk/src/common/view/mixin/epoxyViewMixin"),R=e("../factory/exportTemplateFactory"),b=e("../enum/exportTypesEnum"),y=e("bundle!ImportExportBundle"),T=e("bundle!CommonBundle"),x=e("settings!awsSettings"),v=h.View.extend({className:"export-view",events:{"change .usersWithSelectedRoles":"includeRolesByUsers","change .rolesWithSelectedUsers":"includeUsersWithRoles","change .selectedUsersRoles":"includeSelectedRolesUsersOnly","click .section .checkBox label":"_clickOnCheckbox"},computeds:{includeAccessEventsChecked:function(){return!!this.model.get("everything")&&this.model.get("includeAccessEvents")},enableAttributesValues:{deps:["everything","includeAttributes"],get:function(e,s){return!e&&s}},enableReportJobs:{deps:["everything","includeReports"],get:function(e,s){return!e&&s}},someResourceIsChecked:{deps:["everything","includeReports","includeAdHocViews","includeDashboards","includeDomains","includeDataSources","includeOtherResourceFiles"],get:function(e,s,t,i,o,n,r){return!e&&(s||t||i||o||n||r)}}},initialize:function(){l.bindAll(this,"render","doExport","handleExportPhase","filterAuthoritiesBySubOrgs","bindWithRoles","bindWithUsers","changeEnabledState","includeRolesByUsers","includeUsersWithRoles","includeSelectedRolesUsersOnly","sendParameters","onRolesToUsersChange","onUsersToRolesChange","_isServerLevel","_includeUsersOrRoles","_showNotification","_getBrokenDependencies","_clickOnCheckbox","_onModelChange","_resetModel"),this.model||(this.model=new a),this.stateModel=new d,this.epoxifyView(),this.loadingDialog=new g({content:T["dialog.overlay.loading"]}),this.notification=new m,this.dependentResourcesDialogView=new p,this.listenTo(this.model,"change",this._onModelChange),this.listenTo(this.stateModel,"change:phase",this.handleExportPhase,this),this.listenTo(this.model,"error:unauthorized",window.location.reload),this.listenTo(this.stateModel,"error:unauthorized",window.location.reload);var e={delay:!1,message:y["export.error.cancelled"]},s={delay:!1,message:y["export.error.unexpected"]};this.listenTo(this.model,"error:notFound",l.bind(this.notification.show,this.notification,e)),this.listenTo(this.stateModel,"error:notFound",l.bind(this.notification.show,this.notification,e)),this.listenTo(this.model,"error:internalServerError",l.bind(this.notification.show,this.notification,s)),this.listenTo(this.stateModel,"error:internalServerError",l.bind(this.notification.show,this.notification,s)),this.listenTo(this.model,"error",l.bind(this.loadingDialog.close,this.loadingDialog)),this.listenTo(this.stateModel,"error",l.bind(this.loadingDialog.close,this.loadingDialog)),this.listenTo(this.dependentResourcesDialogView,"button:export",l.compose(l.bind(this.dependentResourcesDialogView.close,this.dependentResourcesDialogView),l.bind(function(){o.call(this),this._showNotification({message:y["export.finished"],type:"success"})},this))),this.listenTo(this.dependentResourcesDialogView,"button:cancel",l.bind(n,this,d.STATE.CANCELLED))},render:function(e){e=e||{},this.type=e.type;var s=this._isServerLevel(this.type),t=s||this.type===b.ROOT_TENANT;t?this.$el.addClass("with-events"):this.$el.removeClass("with-events"),this.stopListening(this.model,"change:includeSubOrganizations",this.filterAuthoritiesBySubOrgs),this._resetModel(e);var o=y["export.dialog.file.properties.encryption.hint"];return(x.productTypeIsJrsAmi||x.productTypeIsMpAmi)&&(o=y["export.dialog.file.properties.encryption.hint.aws"]),this.template=l.template(R(e))({everything:!1,i18n:y,encryptionHint:o,isServerOrRootType:t,isServerLevel:s,isServerCe:this.type===b.SERVER_CE,isRepository:this.type===b.REPOSITORY,isSubOrgLevel:e.isSubOrgLevel}),this.$el.html(this.template),this.$(".selectRolesUsers").length&&i.call(this,e),this.applyEpoxyBindings(),this},doExport:function(){var e=this;this.model.isValid(!0)&&(this.loadingDialog.open(),this.model.save().done(function(s){e.stateModel.unset("warnings",{silent:!0}),e.stateModel.set(s),e.model.set("id",s.id)}))},handleExportPhase:function(){var e,s=this.stateModel.get("phase"),t=this._getBrokenDependencies();s==d.STATE.READY&&(this.loadingDialog.close(),l.isEmpty(t)?(o.call(this),e={message:y["export.finished"],type:"success"}):this.dependentResourcesDialogView.open({items:t})),s==d.STATE.FAILED&&(e={message:y["export.error.unexpected"]}),s==d.STATE.CANCELLED&&(e={message:y["export.error.cancelled"]}),e&&this._showNotification(e)},filterAuthoritiesBySubOrgs:function(){var e={excludeSubOrgs:!this.model.get("includeSubOrganizations")};this.rolesList.model.setContext(e),this.usersList.model.setContext(e)},bindWithRoles:function(e){this.model.set({roles:e}),this.onUsersToRolesChange(),e.length?this.rolesToUsers.setContext({roles:e}):this.rolesToUsers.set({items:[]})},bindWithUsers:function(e){this.model.set({users:e}),this.onRolesToUsersChange(),e.length?this.usersToRoles.setContext({users:e}):this.usersToRoles.set({items:[]})},changeEnabledState:function(){var e=this.model.get("everything");this.rolesList.setDisabled(e||this.model.get("rolesForUser")),this.usersList.setDisabled(e||this.model.get("userForRoles")),e&&(this.rolesList.selectNone(),this.usersList.selectNone())},includeRolesByUsers:function(e){var s=r(e.target).is(":checked");this.model.set({rolesForUser:!s,userForRoles:s}),this.onRolesToUsersChange(),this._includeUsersOrRoles(!s,s)},includeUsersWithRoles:function(e){var s=r(e.target).is(":checked");this.model.set({rolesForUser:s,userForRoles:!s}),this.onUsersToRolesChange(),this._includeUsersOrRoles(s,!s)},includeSelectedRolesUsersOnly:function(e){r(e.target).is(":checked")&&(this.model.set({userForRoles:!1,rolesForUser:!1}),this.onRolesToUsersChange(),this.onUsersToRolesChange(),this._includeUsersOrRoles(!1,!1))},sendParameters:function(e){this.model.isValid(!0)&&this.model.save()},onRolesToUsersChange:function(){this.model.get("userForRoles")?(this.usersList.highlightSet(l.map(this.rolesToUsers.get("items"),function(e){return e.username+(e.tenantId?"|"+e.tenantId:"")})),this.rolesList.highlightSet([])):this.usersList.highlightSet([])},onUsersToRolesChange:function(){this.model.get("rolesForUser")?(this.rolesList.highlightSet(l.map(this.usersToRoles.get("items"),function(e){return e.name+(e.tenantId?"|"+e.tenantId:"")})),this.usersList.highlightSet([])):this.rolesList.highlightSet([])},_isServerLevel:function(e){return e===b.SERVER_CE||e===b.SERVER_PRO},_includeUsersOrRoles:function(e,s){this.rolesList.setDisabled(e),this.usersList.setDisabled(s),this.rolesList.selectNone(),this.usersList.selectNone()},_showNotification:function(e){e=l.defaults(e,{type:"warning"}),this.loadingDialog.isVisible()&&this.loadingDialog.close(),this.notification.show({delay:!1,message:e.message,type:e.type})},_getBrokenDependencies:function(){var e=this.stateModel.get("warnings"),s=[];return l.each(e,function(e){"export.broken.dependency"===e.code&&s.push(e.parameters)}),l.flatten(l.sortBy(s,function(e){return e}))},_clickOnCheckbox:function(e){var s=r(e.target).next();s[0].disabled||this.model.set(s[0].name,!s[0].checked)},_onModelChange:function(){this.model.isValid(!0)},_resetModel:function(e){var s={organization:this.type==b.REPOSITORY?null:e.tenantId};if(this.type===b.ROOT_TENANT||this.type===b.TENANT){var t=this.type===b.ROOT_TENANT?"root_export.zip":e.tenantId+"_export.zip";l.extend(s,{fileName:t})}this.model.reset(s,this.type)}});l.extend(v.prototype,f),t.exports=v});