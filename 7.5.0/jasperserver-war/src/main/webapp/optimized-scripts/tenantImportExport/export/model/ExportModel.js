define(["require","exports","module","jquery","underscore","backbone","runtime_dependencies/js-sdk/src/common/extension/backboneValidationExtension","runtime_dependencies/js-sdk/src/jrs.configs","bundle!ImportExportValidationBundle","runtime_dependencies/js-sdk/src/common/model/BaseModel","../model/ResourcesModel","../factory/exportModelAttributesFactory","../enum/exportTypesEnum","runtime_dependencies/js-sdk/src/common/util/i18nMessage"],function(e,t,s){function n(e){var t,s,n=[];return e.get("everything")?(n.push("everything"),e.get("includeAccessEvents")&&n.push("include-access-events")):(t=i(e)&&e.get("includeRepositoryPermissions")&&!l.isEmpty(e.get("uris")),s=!e.get("includeAttributeValues")||!e.get("includeAttributes"),e.get("userForRoles")&&n.push("role-users"),e.get("rolesForUser")&&n.push("users-roles"),t&&n.push("repository-permissions"),!e.get("includeSubOrganizations")&&n.push("skip-suborganizations"),e.get("includeAttributes")&&n.push("include-attributes"),s&&n.push("skip-attribute-values"),e.get("includeServerSettings")&&n.push("include-server-settings"),(!i(e)||!e.get("includeDependentObjects"))&&n.push("skip-dependent-resources")),e.get("includeAuditEvents")&&n.push("include-audit-events"),e.get("includeMonitoringEvents")&&n.push("include-monitoring-events"),e.get("encryptFile")&&n.push("encrypted"),n}function r(e){var t=[],s=new u.Deferred;return!e.get("everything")&&i(e)?e.resources.fetch().done(function(n){for(var r in x)e.get(r)&&t.push(n[x[r]]);s.resolve(l.flatten(t))}):s.resolve(null),s}function i(e){var t=l.keys(x);return l.filter(t,function(t){return e.get(t)}).length}function o(e){var t=a.organizationsFolderUri||"/organizations",s=a.orgTemplateFolderUri||"/org_template";return new RegExp("^("+t+"(?!"+s+")/([^/]+))+").exec(e)}var u=e("jquery"),l=e("underscore"),d=e("backbone"),c=e("runtime_dependencies/js-sdk/src/common/extension/backboneValidationExtension"),a=e("runtime_dependencies/js-sdk/src/jrs.configs"),p=e("bundle!ImportExportValidationBundle"),h=e("runtime_dependencies/js-sdk/src/common/model/BaseModel"),g=e("../model/ResourcesModel"),m=e("../factory/exportModelAttributesFactory"),f=e("../enum/exportTypesEnum"),v=e("runtime_dependencies/js-sdk/src/common/util/i18nMessage"),b=v.extend({bundle:p}),x={includeReports:"report",includeDomains:"domain",includeAdHocViews:"adhocDataView",includeDataSources:"dataSource",includeDashboards:"dashboard",includeOtherResourceFiles:"others"},y=h.extend({defaults:{uris:["/"],fileName:"export.zip",encryptFile:!1,includeRepositoryPermissions:!0,includeScheduledReportJobs:!0,includeDependencies:!0,includeFullResourcePath:!0},validation:{fileName:[{required:!0,msg:new b("export.file.name.empty")},{maxLength:256,msg:new b("export.file.name.too.long",256)},{fn:function(e){return/[\\\/?*%:|"<>]/g.test(e)?new b("export.file.name.contains.not.supported.characters"):/^[\.]{1,2}$/g.test(e)?new b("export.file.name.not.valid"):void 0}}],uris:[{fn:function(){var e=this.toExportTask();return!(e.uris||e.roles||e.users||l.filter(e.parameters,function(e){return"role-users"!==e&&"users-roles"!==e}).length)}}]},initialize:function(){h.prototype.initialize.call(this),l.bindAll(this,"url","save","cancel","toExportTask","reset"),this.resources=new g},url:function(){return"rest_v2/export"},save:function(){var e=new u.Deferred,t=new d.Model,s=this;t.url=this.url;var n={};return r(this).done(function(r){r&&(n.resourceTypes=r),t.save(l.extend(s.toExportTask(),n)).done(function(t){e.resolve(t)}).fail(function(t){e.reject(t),s.trigger("error",s,t)})}),e},cancel:function(){var e=this.url()+"/"+this.id;this.destroy({url:e})},toExportTask:function(){var e=this.get("everything"),t=this.get("roles"),s=this.get("users"),r=l.clone(this.get("uris")),u=e||this.get("includeReports")&&this.get("includeScheduledReportJobs"),d={uris:r,scheduledJobs:this.get("includeScheduledReportJobs")?r:null,parameters:[]};this.get("includeRepositoryPermissions")&&d.parameters.push("repository-permissions"),!this.get("includeDependencies")&&d.parameters.push("skip-dependent-resources");var c=o(r&&r[0]);c&&!this.get("includeFullResourcePath")&&(d.organization=c.last(),d.parameters.push("skip-suborganizations","skip-attribute-values"),d.uris=l.map(r,function(e){return e.replace(c.first(),"")}),d.scheduledJobs=this.get("includeScheduledReportJobs")?d.uris:null);var a={uris:i(this)?r:null,roles:l.isEmpty(t)?null:t,users:l.isEmpty(s)?null:s,scheduledJobs:u?r:null,organization:this.get("organization"),parameters:n(this)};return this.type!==f.REPOSITORY?a:d},reset:function(e,t){this.type=t;var s=l.extend({},this.defaults,m(t));this.clear().set(l.extend({},s,e))}});l.extend(y.prototype,c.mixin),s.exports=y});