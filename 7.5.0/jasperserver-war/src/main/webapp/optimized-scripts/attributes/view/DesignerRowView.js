define(["require","exports","module","underscore","jquery","../../attributes/view/RowView","../../serverSettingsCommon/behaviors/DeleteConfirmBehavior","../../serverSettingsCommon/enum/confirmDialogTypesEnum","../../attributes/enum/permissionMasksEnum","../../attributes/factory/rowTemplatesFactory"],function(e,t,i){var n=e("underscore"),o=e("jquery"),s=e("../../attributes/view/RowView"),r=e("../../serverSettingsCommon/behaviors/DeleteConfirmBehavior"),d=e("../../serverSettingsCommon/enum/confirmDialogTypesEnum"),a=e("../../attributes/enum/permissionMasksEnum"),l=e("../../attributes/factory/rowTemplatesFactory"),h=s.extend({tagName:"div",className:"table-row",ui:{passwordInput:"input[type='password']"},events:n.extend({},s.prototype.events,{"click .edit":"toggleActive","click .cancel":"cancel","click .ok":"runValidation","click @ui.passwordInput":"toggleValue","blur @ui.passwordInput":"toggleValue"}),modelEvents:{change:"_onModelChange"},behaviors:n.extend(s.prototype.behaviors,{DeleteConfirm:{behaviorClass:r}}),computeds:n.extend(s.prototype.computeds,{readOnly:{deps:["inherited","permissionMask"],get:function(e,t){var i=t===a.READ_ONLY;return i||e&&i}},disableRemove:{deps:["inherited","permissionMask"],get:function(e,t){return e||t===a.READ_ONLY}}}),initialize:function(e){this.editMode=!1,this._onViewInitialize&&this._onViewInitialize(),s.prototype.initialize.apply(this,arguments)},render:function(){return s.prototype.render.apply(this,arguments),this._onViewRender&&this._onViewRender(),this},getTemplate:function(){var e=!this.editMode&&this.model.get("name");return n.template(l({editMode:!e}))},toggleActive:function(){var e=new o.Deferred,t=this;return this.toggleMode().done(function(){t.trigger("active",t.editMode,e)}),e},toggleMode:function(){var e=new o.Deferred;return this.editMode=!this.editMode,this.editMode?this.slideDown(e):this.slideUp(e),e},toggleIfModelIsValid:function(){return this.validateModel()?(this.model.setState("confirmedState"),this.model.isNew()&&this.confirmState(),this.modelChanged=null,this.toggleActive()):new o.Deferred},slideDown:function(e){return this.render().hide().slideDown({done:function(){e.resolve()}}),this},slideUp:function(e,t){t=t||"28px";var i=this;return this.$el.animate({height:t},{done:function(){i.render().$el.css({height:"100%"}).show(),e.resolve()}}),this},hide:function(){return this.$el.hide()},show:function(){return this.$el.show()},cancel:function(){this.model.set(this.model.getState("confirmedState")),this.toggleActive()},runValidation:function(e,t){this.validateModel(t)&&this.triggerConfirmOpening(t)},triggerConfirmOpening:function(e){e=e||{};var t=new o.Deferred,i=this,s=function(){i.permissionConfirmShouldBeShown?i._openPermissionConfirm&&n.bind(i._openPermissionConfirm,i,e)():i.triggerModelValidation(e)};this.model.isNew()?s():this.modelChanged?(this.modelChanged.name?this.trigger("open:confirm",d.NAME_CONFIRM,{dfd:t}):t.resolve(),t.done(function(){i.modelChanged._embedded?s():i.triggerModelValidation(e)})):this.toggleActive()},triggerModelValidation:function(e){this.model.trimAttrs(["name","value","description"]),this.trigger("validate",e)},validateModel:function(e){e=e||{};var t=this.model.isValid(!0);return!t&&e.dfd&&e.dfd.reject(),t},confirmState:function(e){this.model.confirmState(e)},isStateConfirmed:function(){return this.model.isStateConfirmed()},isInherited:function(){return this.model.getState("originalState").inherited},getChangedProperties:function(e){if(this.modelChanged)return e?this.modelChanged[e]:this.modelChanged},toggleValue:function(e){if(this.editMode){var t=o(e.target),i=t.val(),n="~secure~"===i,s=o(e.relatedTarget).hasClass("ok"),r="click"===e.type;i&&(r&&n&&(t.val(""),this.model.resetField("value")),r||s||t.val("~secure~"))}},invokeFiltration:function(){var e=this.model;if(e.hasChanged("secure")||e.hasChanged("_embedded")&&!this._isPermissionLimited())return!this.editMode&&e.hasChanged("inherited")},validateIfSecure:function(){var e=this.getChangedProperties("name");this.model.validateIfSecure=this.model.validateSecureValue()&&e||!1},_onSaveSuccess:function(){this.modelChanged=null,this.model.setId(),this.model.get("secure")&&this.model.resetField("value"),this.model.setState(),this.model.setState("confirmedState")},_onModelChange:function(e){this.modelChanged=this.modelChanged||{};var t,i=e.changedAttributes(),o=this.model.getState(),s=this.isInherited(),r=e.isNew();n.each(i,function(e,t){if("inherited"!==t){var i=o[t];(n.isObject(e)?n.isEqual(i,e):i===e)?delete this.modelChanged[t]:this.modelChanged[t]=e}},this),t=!n.isEmpty(this.modelChanged),s&&e.set("inherited",!t),!this.editMode&&i.secure&&e.setState("confirmedState"),this.trigger("changed",t||r),this.model.validate(this.modelChanged)}});i.exports=h});