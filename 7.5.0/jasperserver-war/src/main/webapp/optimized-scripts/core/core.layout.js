define(["require","exports","module","dragdropextra","prototype","../util/utils.common","../util/tools.truncator","iscroll","scriptaculous/src/effects","jquery","jquery-ui/ui/widgets/draggable"],function(e,i,t){var n=e("dragdropextra"),a=n.Draggable,r=e("prototype"),l=r.$H,o=r.$$,s=r.$,d=e("../util/utils.common"),m=d.isIE7,E=d.parseFunc,c=d.centerElement,S=d.matchMeOrUp,_=d.isIPad,A=d.doNothing,I=d.getDimensionInPx,g=d.getActualDimension,N=d.isIE8,u=d.isIE9,T=e("../util/tools.truncator"),h=e("iscroll"),f=h.iScroll,p=e("scriptaculous/src/effects"),P=e("jquery");e("jquery-ui/ui/widgets/draggable");var L={ELEMENT_CONTEXTMENU:"element:contextmenu",SIZEABLE_PATTERN:".sizeable",SIZER_PATTERN:".sizer",RESIZE_OVERLAY_PATTERN:".resizeOverlay",MOVEABLE_PATTERN:".moveable",MOVER_PATTERN:".mover",MINIMIZER_PATTERN:".maximized .minimize",MINIMIZED_PATTERN:".minimized .minimize",TRUNCATE_PATTERN:".trunc",TREE_LEAF_PATTERN:"a.>node",TREE_CONTAINER_PATTERN:".collapsible",TOOLBAR_CAPSULE_PATTERN:"#toolbar .capsule",NAVIGATION_MUTTON_PATTERN:"li.mutton",NAVIGATION_PATTERN:"#navigationOptions li",NAVIGATION_HOVER_PATTERN:"#navigationOptions li.over",META_LINKS_PATTERN:"#metaLinks #main_logOut_link",BUTTON_SET_BUTTON:".buttonSet > *",TABSET_TAB_PATTERN:".tab",BUTTON_PATTERN:".button",PRESSED_PATTERN:".pressed",SELECTED_PATTERN:".selected",LIST_ITEM_PATTERN:".list.responsive > li",LIST_ITEM_WRAP_PATTERN:".wrap",DISCLOSURE_BUTTON_PATTERN:".disclosure",MENU_LIST_PATTERN:"#menu li",SEPARATOR_PATTERN:".separator",MESSAGE_PATTERN:".message",MESSAGE_WARNING_PATTERN:".message.warning",MESSAGE_WARNING_DETAILS_PATTERN:".details",MESSAGE_SUCCESS_PATTERN:".message.success",DETAILS_PATTERN:".details",COLUMN_NODE_WRAPPER_PATTERN:".node > .wrap > .column",PAGE_HEADER_TITLE_PATTERN:".pageHeader > .pageHeader-title > .pageHeader-title-text",COLUMN_LEAF_WRAPPER_PATTERN:".leaf > .wrap > .column",SEARCH_LOCKUP_PATTERN:".searchLockup",DIALOG_PATTERN:".dialog",DIALOG_LOADING_PATTERN:".dialog.loading",SWIPE_SCROLL_PATTERN:".swipeScroll",SCROLL_WRAPPER_PATTERN:".scrollWrapper",ADHOC_MODE_OPTION_CLASS:"tab mode horizontal",DRAGGING_CLASS:"dragging",COPY_CLASS:"copy",PRESSED_CLASS:"pressed",SELECTED_CLASS:"selected",DISABLED_CLASS:"disabled",HOVERED_CLASS:"over",ERROR_CLASS:"error",SUCCESS_CLASS:"error",MESSAGE_CLASS:"error",UP_CLASS:"up",LAST_CLASS:"last",FIRST_CLASS:"first",SCHEDULED_CLASS:"scheduled",MENU_ROOT_CLASS:"menuRoot",NODE_CLASS:"node",LEAF_CLASS:"leaf",ICON_CLASS:"icon",OPEN_CLASS:"open",CLOSED_CLASS:"closed",LOADING_CLASS:"loading",NOTHING_TO_DISPLAY_CLASS:"nothingToDisplay",COLLAPSIBLE_CLASS:"collapsible",RESPONSIVE_CLASS:"responsive",HIDDEN_CLASS:"hidden",NO_GENERATORS_CLASS:"noGenerators",STACKTRACE_CLASS:"stacktrace",EMPHASIS_CLASS:"emphasis",ASCENDING_CLASS:"ascending",DESCENDING_CLASS:"descending",CANCELLABLE_CLASS:"cancellable",DROP_TARGET_CLASS:"dropTarget",BUTTON_CLASS:"button",ONE_COLUMN_CLASS:"oneColumn",CONTROL_PAGE_CLASS:"controlPage",DISABLED_ATTR_NAME:"disabled",SELECTED_ATTR_NAME:"selected",OPEN_ATTR_NAME:"open",CLOSED_ATTR_NAME:"closed",READONLY_ATTR_NAME:"readonly",HORIZONTAL_CENTERING_CLASS:"centered_horz",VERTICAL_CENTERING_CLASS:"centered_vert",DIMMER_ID:"pageDimmer",PAGE_BODY_ID:"display",MENU_ID:"menu",MAIN_NAVIGATION_ID:"mainNavigation",MAIN_NAVIGATION_HOME_ITEM_ID:"main_home",MAIN_NAVIGATION_LIBRARY_ITEM_ID:"main_library",META_LINK_LOGOUT_ID:"main_logOut_link",MAIN_SEARCH_INPUT_ID:"searchInput",SCROLL_SENSITIVITY:50,DND_MOVABLE_ZINDEX:2e3,DIMMER_Z_INDEX:4e3,FOLDERS_RESIZABLE_PANEL_ID:"folders",FILTERS_RESIZABLE_PANEL_ID:"filters",PROPERTIES_RESIZABLE_PANEL_ID:"properties",FIELDS_RESIZABLE_PANEL_ID:"fields",FOLDERS_RESIZABLE_PANEL_COOKIE_NAME:"foldersPanelWidth",FOLDERS_MINIMIZED_PANEL_COOKIE_NAME:"foldersMinimized",FILTERS_RESIZABLE_PANEL_COOKIE_NAME:"filtersPanelWidth",FILTERS_MINIMIZED_PANEL_COOKIE_NAME:"filtersMinimized",PROPERTIES_RESIZABLE_PANEL_COOKIE_NAME:"propertiesPanelWidth",PROPERTIES_MINIMIZED_PANEL_COOKIE_NAME:"propertiesMinimized",FIELDS_RESIZABLE_PANEL_COOKIE_NAME:"fieldsPanelWidth",FIELDS_MINIMIZED_PANEL_COOKIE_NAME:"fieldsMinimized",PANEL_WIDTH:"PanelWidth",MINIMIZED:"Minimized",PANEL_STATE_CHANGED_MANUALLY:"PSCM",scrolls:l(),initialize:function(e){e=s(e)||s(document.body),new T(e.select(L.TRUNCATE_PATTERN)),m()&&this.fixIE7Sizes(),e.select(this.SIZEABLE_PATTERN).each(this.createSizer.bind(this)),e.select(this.MOVEABLE_PATTERN).each(this.createMover.bind(this)),e.select(".centered_horz,.centered_vert").each(function(e){var i=E(e,"centered_fn_");i||(i=c),i(e,{horz:e.match(".centered_horz"),vert:e.match(".centered_vert")})}),null!=s(L.DIMMER_ID)&&(s(L.DIMMER_ID).style.zIndex=L.DIMMER_Z_INDEX),P.datepicker&&P.datepicker.initialized&&(P.datepicker.initialized=!1),P(function(){0===P("#ajaxbuffer").length&&P("body").append(P('<div id="ajaxbuffer" style="display:none"></div>'))}),P(window).resize(function(){this.resizeTo&&clearTimeout(this.resizeTo),this.resizeTo=setTimeout(function(){P(this).trigger("resizeEnd")},500)})},updateOnOrientation:function(){},isVisible:function(e){return e&&!s(e).hasClassName(L.HIDDEN_CLASS)},createScroller:function(e,i){if(e){e=e.identify?e:s(e);var t=L.scrolls.get(e.identify());t&&t.destroy();var n=["mainTableContainer","resultsContainer","filtersPanel","foldersPodContent"];e.identify().startsWith("iframeScroll_")&&n.push(e.identify()),i=Object.extend({hideScrollbar:!1,useTransform:!n.include(e.identify()),bounce:["resultsContainer"].include(e.identify())},i||{});var a=new f(e,i);return L.scrolls.set(e.identify(),a),a}return null},createSizer:function(e,i){e=s(e);var t=i&&i.sizer?s(i.sizer):e.down(this.SIZER_PATTERN);if(t&&!S(e,"."+L.HIDDEN_CLASS)){var n=this.getSizerType(t),r=this.alignmentModule.getSizerAlignment(t,n),l=new a(t);l.resizeablePanel=e,l.primaryPanel=s(e).siblings().find(function(e){return e.match&&e.match(".primary")}),i&&i.fillerPattern&&(l.filler=s(P(e).find(i.fillerPattern)[0]));var o=function(){return function(e){l.pointerX=e.pointerX(),l.pointerY=e.pointerY()}}();t.observe("mousedown",o),P(t).bind({touchstart:function(e){o(e.originalEvent),this.style.background="#666",this.style.zIndex=9},touchend:function(){this.style.background="transparent"}}),l.sizerType=n,l.alignment=r,l.options={constraint:"diagonal"===n?"":n,onStart:L.beginSizerDragging.bind(L),onDrag:_()?A:L.respondToDrag.bind(L),onEnd:L.endSizerDragging.bind(L)}}},getSizerType:function(e){return e.match(".horizontal")&&"horizontal"||e.match(".vertical")&&"vertical"||e.match(".diagonal")&&"diagonal"},alignmentModule:{alignments:[["left","right"],["top","bottom"]],alignmentIndexes:{horizontal:0,vertical:1},dimensions:["width","height"],getSizerAlignment:function(e,i){var t=["",""];if("diagonal"===i)return["right","bottom"];var n=this.alignmentIndexes[i],a=this.alignments[n],r=[0,1].map(function(i){return parseInt(e.getStyle(a[i]))}),l=isNaN(r[0])||r[0]>r[1]?a[1]:a[0];return t[n]=l,t}},beginSizerDragging:function(e,i){var t=e.element;e.parentOffset=[t.getStyle(e.alignment[0]),t.getStyle(e.alignment[1])],e.offsetUnit="px",e.pointerX=e.pointerX||i.pointerX(),e.pointerY=e.pointerY||i.pointerY(),e.element.addClassName(L.DRAGGING_CLASS),o(L.RESIZE_OVERLAY_PATTERN).each(function(e){e.removeClassName(L.HIDDEN_CLASS)})},endSizerDragging:function(e,i){L.respondToDrag(e,i),e.element.removeClassName(L.DRAGGING_CLASS),o(L.RESIZE_OVERLAY_PATTERN).each(function(e){e.addClassName(L.HIDDEN_CLASS)}),document.fire("dragger:sizer",{targetEvent:i,element:e.element}),P(window).trigger("resize",{targetEvent:i,element:e.element})},respondToDrag:function(e,i){"vertical"!==e.sizerType&&this.resizeOnDrag(e,i,"horizontal"),"horizontal"!==e.sizerType&&this.resizeOnDrag(e,i,"vertical")},resizeOnDrag:function(e,i,t){var n={};n.axis="horizontal"==t?0:1,n.myAlignments=this.alignmentModule.alignments[n.axis],n.dimension=this.alignmentModule.dimensions[n.axis],n.sizeProperty=n.axis?"offsetHeight":"offsetWidth";var a=n.axis?"pointerY":"pointerX",r={pointerY:"clientY",pointerX:"clientX"};e.element;n.sizeableAnchorage=e.alignment[n.axis]===n.myAlignments[0]?n.myAlignments[1]:n.myAlignments[0];var l=i.changedTouches?i.changedTouches[0][r[a]]:i[a](),o=e[a]?l-e[a]:0;o=e.alignment[n.axis]===n.myAlignments[1]?o:0-o,n.dragDelta=o,e[a]=i[a](),this.resizePanelsOnDrag(e,n)},resizePanelsOnDrag:function(e,i){var t=this.getSizeTracker();t.checkpoint(e.resizeablePanel[i.sizeProperty]),e.filler&&!e["fillerDelta"+i.dimension]&&(e["fillerDelta"+i.dimension]=e.resizeablePanel[i.sizeProperty]-e.filler[i.sizeProperty]);var n=I(e.resizeablePanel,i.dimension);if((this.isInBounds(e,i)||!this.isInBounds(e,i)&&i.dragDelta<0)&&(e.resizeablePanel.setStyle(i.dimension+":"+(n+i.dragDelta)+"px"),e.filler&&e.filler.setStyle(i.dimension+":"+(n+i.dragDelta-e["fillerDelta"+i.dimension])+"px")),window.localStorage&&localStorage.setItem(e.resizeablePanel.identify()+L.PANEL_WIDTH,e.resizeablePanel.getWidth()),!t.changed(e.resizeablePanel[i.sizeProperty])){var a=g(e.resizeablePanel,i.dimension);return e.alignment[i.axis]!=i.myAlignments[0]&&(e.element.style[i.myAlignments[0]]=""),e.element.setStyle(e.alignment[i.axis]+":"+e.parentOffset[i.axis]),e.resizeablePanel.setStyle(i.dimension+":"+a+"px"),e.primaryPanel&&e.primaryPanel.style.zIndex==e.resizeablePanel.style.zIndex&&e.primaryPanel.setStyle(i.sizeableAnchorage+":"+a+"px"),void(e.filler&&e.filler.setStyle(i.dimension+":"+(a-e["fillerDelta"+i.dimension])+"px"))}var r;if(e.resizeablePanel.currentStyle?r=e.resizeablePanel.currentStyle.minWidth:(r=document.defaultView.getComputedStyle(e.resizeablePanel,null),r=r["min-width"]?r["min-width"]:r.minWidth),r=r.substring(0,r.indexOf("px")),e.primaryPanel&&e.primaryPanel.style.zIndex==e.resizeablePanel.style.zIndex){var l=I(e.primaryPanel,i.sizeableAnchorage)+i.dragDelta,o=l<r?r:l;e.primaryPanel.setStyle(i.sizeableAnchorage+":"+o+"px")}e.alignment[i.axis]!=i.myAlignments[0]&&(e.element.style[i.myAlignments[0]]=""),e.element.setStyle(e.alignment[i.axis]+":"+e.parentOffset[i.axis]),P("body").trigger("layout_update")},isInBounds:function(e,i){var t,n,a,r,l,o=P(e.primaryPanel),s=o.parent(),d=i.dimension;if(e.primaryPanel){d=d.replace(d.charAt(0),d.charAt(0).toUpperCase()),l=P.fn["outer"+d],r=l.call(o,!0)-l.call(o),t=parseInt(o.css("min-"+i.dimension)),isNaN(t)&&(t=0),n=parseInt(o.css(i.sizeableAnchorage)),a=parseInt(s.css(i.dimension));var m=s.children("div:visible:not(.minimized)").not("div.pageHeader").not("div.header");return P.each(m,function(){var i=P(this),t=0===i.width()||0===i.height();e.resizeablePanel==this||e.primaryPanel==this||t||(a-=l.call(i,!0))}),a-n-i.dragDelta>t+r}return!0},getSizeTracker:function(){var e=-1;return{checkpoint:function(i){e=i},changed:function(i){return i!=e}}},createMover:function(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=e.down(this.MOVER_PATTERN);if(t&&!S(e,"."+L.HIDDEN_CLASS)){var n=Math.max(this.DND_MOVABLE_ZINDEX,e.getStyle("zIndex"));i.useJQueryForDraggable?P(e).draggable({zIndex:n,handle:t,containment:"document"}):new a(e,{handle:t,zindex:n})}},maximize:function(e,i){function t(){a.removeClassName("minimized_if_vertical_orientation"),a.removeClassName("minimized"),a.addClassName("maximized"),window.localStorage&&localStorage.setItem(a.identify()+L.MINIMIZED,!1),P("div.content",a).show()}i=!0;var n=e.hasClassName?e:s(e),a=n.hasClassName("column")?n:n.up(".column");0===window.orientation&&("filters"==a.id&&L.minimize(document.getElementById("fields")),"fields"==a.id&&L.minimize(document.getElementById("filters")));var r,l=L.alignmentModule.alignments[0],o=l.map(function(e){return parseInt(a.getStyle(e))}),d=l[0===o[0]?0:1],m=a.siblings().find(function(e){return e.match&&e.match(".primary")});m&&window.localStorage&&(r=localStorage.getItem(a.identify()+L.PANEL_WIDTH)),r&&!isNaN(r)&&(r+="px",a.setStyle({width:r}),i?(m.style[d]=r,a.removeClassName("minimized_if_vertical_orientation"),a.removeClassName("minimized"),a.addClassName("maximized"),window.localStorage&&localStorage.setItem(a.identify()+L.MINIMIZED,!1),P("div.content",a).show(),P("div.vtitle",a).hide()):(new p.Morph(m,{style:d+":"+r,duration:.6,afterFinish:function(){P("body").trigger("layout_update")}}),new p.Opacity(a,{to:0,from:1,duration:.3,queue:{position:"front",scope:"sidePanel"},afterFinish:t}),new p.Opacity(a,{to:1,from:0,duration:.3,queue:{position:"end",scope:"sidePanel"}}))),P(a).find(".sizer").show(),P("body").trigger("layout_update",{elem:e.parentNode,type:"panel-maximize"}),P(".column.secondary > div.content > .body").show().height()},minimize:function(e,i){function t(){r.addClassName("minimized"),r.removeClassName("maximized"),r.removeClassName("minimized_if_vertical_orientation"),window.localStorage&&localStorage.setItem(r.identify()+L.MINIMIZED,!0),P("div.content",r).hide()}var n;i=!0;var a=e.hasClassName?e:s(e),r=a.hasClassName("column")?a:a.up(".column");!(window.localStorage&&"true"==localStorage.getItem(r.identify()+L.MINIMIZED))&&window.localStorage&&localStorage.setItem(r.identify()+L.PANEL_WIDTH,r.getWidth());var l=L.alignmentModule.alignments[0],o=l.map(function(e){return parseInt(r.getStyle(e))}),d=l[0===o[0]?0:1];if(n=r.siblings().find(function(e){return e.match&&e.match(".primary")}))if(n.getStyle(d),i){var E=P("div.title",r).eq(0),c=P("div.vtitle",r),S=E.html(),_=E.width();_=7*P.trim(E.text()).length,n.style[d]="24px",r.addClassName("minimized"),r.removeClassName("maximized"),r.removeClassName("minimized_if_vertical_orientation"),window.localStorage&&localStorage.setItem(r.identify()+L.MINIMIZED,!0),c.length||(c=P('<div class="vtitle"></div>').appendTo(r),c.on("mouseup touchend",function(e){L.maximize(c[0]),e.preventDefault()}),c.html(P.trim(S)).width(_+24)),m()||N()||u()?c.css({top:0,left:0}):c.css("top",_+24+"px"),c.show(),P("div.content",r).hide()}else new p.Morph(n,{style:d+":0px",duration:.6,afterFinish:function(){P("body").trigger("layout_update")}}),new p.Opacity(r,{to:0,from:1,duration:.3,queue:{position:"front",scope:"sidePanel"},afterFinish:t}),new p.Opacity(r,{to:1,from:0,duration:.3,queue:{position:"end",scope:"sidePanel"}});P(r).find(".sizer").hide(),P("body").trigger("layout_update",{elem:e.parentNode,type:"panel-minimize"})},resizeOnClient:function(e,i,t){var n,a=[],r=P("#"+i),l=P("#display").width()-20-parseInt(r.width());P.each([e,t],function(e,i){i&&(a.push({id:i,isLeft:0===e,jo:P("#"+i),width:window.localStorage?parseInt(localStorage.getItem(i+L.PANEL_WIDTH)):250}),a[e].minimized=!!window.localStorage&&localStorage.getItem(i+L.MINIMIZED),a[e].minimized=Object.isUndefined(a[e].minimized)?a[e].jo.hasClass("minimized"):"true"==a[e].minimized,n=a[e].jo[0].currentStyle?a[e].jo[0].currentStyle.minWidth:document.defaultView.getComputedStyle(a[e].jo[0],null).minWidth,a[e].minWidth=(n&&n.indexOf("px"))>0?n.substring(0,n.indexOf("px")):200,a[e].width=a[e].width?a[e].width:a[e].jo.width(),l-=a[e].width)});var o=l<0?Math.abs(l):0;l=0,P.each(a,function(e,i){i.jo.length&&i.jo.is(":visible")&&(i.minimized?(i.jo.removeClass("maximized").addClass("minimized"),L.minimize(i.jo[0],!0)):(1==e&&!a[0].minimized&&a[0].jo.is(":visible")&&(i.width-=o,i.width<i.minWidth&&(l=i.width-i.minWidth,i.width=i.minWidth)),i.jo.removeClass("minimized").addClass("maximized"),r.css(i.isLeft?"left":"right",i.width+"px"),i.jo.css("width",i.width+"px")))}),0!==l&&(a[0].width+=l,a[0].width=a[0].width<a[0].minWidth?a[0].minWidth:a[0].width,r.css("left",a[0].width+"px"),a[0].jo.css("width",a[0].width+"px"))},autoMaximize:function(e){"true"==(window.localStorage?localStorage.getItem(e.identify()+L.MINIMIZED):"false")?e.hasClassName("minimized")&&L.maximize(e,!0):!e.hasClassName("minimized")&&L.minimize(e,!0)},autoMinimize:function(e){"false"==(window.localStorage?localStorage.getItem(e.identify()+L.MINIMIZED):"false")?L.minimize(e,!0):e.removeClassName("minimized")},fixIE7Sizes:function(){o(".control.tabSet.buttons.vertical").each(function(e){e.immediateDescendants().each(function(i){i.style.width=e.clientWidth||e.offsetWidth})})},storePanelWidth:function(e,i){window.localStorage&&localStorage.setItem(e+L.PANEL_WIDTH,i)},getPanelWidth:function(e){return window.localStorage?localStorage.getItem(e+L.PANEL_WIDTH):void 0},getPanelMinimizedState:function(e){return window.localStorage?localStorage.getItem(e+L.MINIMIZED):void 0},storePanelMinimizedState:function(e,i){window.localStorage&&localStorage.setItem(e+L.MINIMIZED,i.toString())},manuallyChangePanelState:function(e,i,t){window.localStorage&&localStorage.setItem(e+L.PANEL_STATE_CHANGED_MANUALLY+i,t)},panelStateWasManuallyChanged:function(e,i){return!!window.localStorage&&"true"===localStorage.getItem(e+L.PANEL_STATE_CHANGED_MANUALLY+i)}};t.exports=L});