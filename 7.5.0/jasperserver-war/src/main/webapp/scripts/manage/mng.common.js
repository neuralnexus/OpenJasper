define(function(require, exports, module) {
var __disableStrictMode__ = "use strict";

var _dragdropextra = require('dragdropextra');

var Droppables = _dragdropextra.Droppables;

var _prototype = require('prototype');

var $ = _prototype.$;
var $$ = _prototype.$$;
var $A = _prototype.$A;
var Template = _prototype.Template;

var SearchBox = require('../components/components.searchBox');

var toolbarButtonModule = require('../components/components.toolbarButtons.events');

var _utilUtilsCommon = require('../util/utils.common');

var toFunction = _utilUtilsCommon.toFunction;
var getAsFunction = _utilUtilsCommon.getAsFunction;
var isArray = _utilUtilsCommon.isArray;
var matchAny = _utilUtilsCommon.matchAny;
var centerElement = _utilUtilsCommon.centerElement;
var ValidationModule = _utilUtilsCommon.ValidationModule;
var deepClone = _utilUtilsCommon.deepClone;
var doNothing = _utilUtilsCommon.doNothing;

var layoutModule = require('../core/core.layout');

var _componentsListBase = require('../components/list.base');

var dynamicList = _componentsListBase.dynamicList;

var InfiniteScroll = require('../util/tools.infiniteScroll');

var _componentsComponentsTooltip = require('../components/components.tooltip');

var JSTooltip = _componentsComponentsTooltip.JSTooltip;

var buttonManager = require('../core/core.events.bis');

var primaryNavModule = require('../actionModel/actionModel.primaryNavigation');

var _coreCoreAjax = require("../core/core.ajax");

var ajaxTargettedUpdate = _coreCoreAjax.ajaxTargettedUpdate;
var AjaxRequester = _coreCoreAjax.AjaxRequester;

var _coreCoreAjaxUtils = require("../core/core.ajax.utils");

var baseErrorHandler = _coreCoreAjaxUtils.baseErrorHandler;

var XRegExp = require('xregexp');

var orgModule = require('./mng.org.module');

var xssUtil = require("runtime_dependencies/js-sdk/src/common/util/xssUtil");

var jQuery = require('jquery');

function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }

_extends(orgModule, {
  TREE_ID: 'orgTree',
  COOKIE_NAME: 'selectedTenant',
  messages: [],
  ActionMap: {
    SEARCH: 'search',
    BROWSE: 'browse',
    NEXT: 'next',
    SELECT_AND_GET_DETAILS: 'selectAndGetDetails',
    SEARCH_AVAILABLE: 'searchAvailable',
    SEARCH_ASSIGNED: 'searchAssigned',
    NEXT_AVAILABLE: 'nextAvailable',
    NEXT_ASSIGNED: 'nextAssigned',
    CREATE: 'create',
    UPDATE: 'update',
    DELETE: 'delete',
    DELETE_ALL: 'deleteAll',
    EXIST: 'exist'
  },
  Event: {
    /** Request events. */
    ORG_BROWSE: 'org:browse',
    ENTITY_SEARCH: 'entity:search',
    ENTITY_NEXT: 'entity:next',
    ENTITY_SELECT_AND_GET_DETAILS: 'entity:selectAndGetDetails',

    /** Response events. */
    RESULT_CHANGED: 'result:changed',
    RESULT_NEXT: 'result:next',
    ENTITY_DETAILS_LOADED: 'entity:detailsLoaded',
    SEARCH_AVAILABLE_LOADED: 'searchAvailable:loaded',
    SEARCH_ASSIGNED_LOADED: 'searchAssigned:loaded',
    NEXT_AVAILABLE_LOADED: 'nextAvailable:loaded',
    NEXT_ASSIGNED_LOADED: 'nextAssigned:loaded',
    SERVER_ERROR: 'server:error',
    SERVER_UNAVAILABLE: 'server:unavailable',
    ENTITY_CREATED: 'entity:created',
    ENTITY_UPDATED: 'entity:updated',
    ENTITY_DELETED: 'entity:deleted',
    ENTITIES_DELETED: 'entities:deleted'
  },
  observe: function observe(eventName, handler) {
    this._getContainer().observe(eventName, handler);
  },
  stopObserving: function stopObserving(eventName, handler) {
    this._getContainer().stopObserving(eventName, handler);
  },
  fire: function fire(eventName, memo) {
    this._getContainer().fire(eventName, memo);
  },
  getMessage: function getMessage(messageId, options) {
    var message = orgModule.messages[messageId];
    return message ? new Template(message).evaluate(options ? options : {}) : '';
  },
  _comparator: function _comparator(l1, l2) {
    return l1 > l2 ? 1 : l1 < l2 ? -1 : 0;
  },
  _getContainer: function _getContainer() {
    if (!this._container) {
      this._container = document.body;
    }

    return this._container;
  },
  Configuration: {
    nameSeparator: '|',
    userDefaultRole: 'ROLE_USER',
    userNameNotSupportedSymbols: '[|]',
    roleNameNotSupportedSymbols: '[|]',
    emailRegExpPattern: '^[\\p{L}\\p{M}\\p{N}._%\'-\\@\\,\\;\\s]+$',
    superuserRole: 'ROLE_SUPERUSER',
    adminRole: 'ROLE_ADMINISTRATOR',
    anonymousRole: 'ROLE_ANONYMOUS'
  }
});

orgModule.systemRoles = [orgModule.Configuration.userDefaultRole, orgModule.Configuration.superuserRole, orgModule.Configuration.adminRole, orgModule.Configuration.anonymousRole];
/**
* This Class represents tenant in JS
*
* @param node {@link dynamicTree.TreeNode}
*/

/**
 * This Class represents tenant in JS
 *
 * @param node {@link dynamicTree.TreeNode}
 */

orgModule.Organization = function (jsonOrNode) {
  if (!jsonOrNode) {
    throw new Error('Can\'t create Organization from undefined json or node');
  }

  if (jsonOrNode.param) {
    this.id = jsonOrNode.param.id;
    this.name = jsonOrNode.name;
    this.uri = jsonOrNode.param.uri;
    this.treeNode = jsonOrNode;
  } else {
    this.id = jsonOrNode.tenantId || jsonOrNode.id;
    this.name = jsonOrNode.tenantName;
    this.alias = jsonOrNode.tenantAlias || jsonOrNode.alias || '';
    this.desc = jsonOrNode.tenantDesc;
    this.uri = jsonOrNode.tenantUri;
    this.parentId = jsonOrNode.parentId;
    this.subTenantCount = jsonOrNode.subTenantCount;
  }
};

orgModule.Organization.addMethod('isRoot', function (level) {
  // TODO: load name of root organization from configuration.
  return this.id == 'organizations';
});
orgModule.Organization.addMethod('getNameWithTenant', function () {
  return this.id;
});
orgModule.Organization.addMethod('getDisplayName', function () {
  return this.name;
});
orgModule.Organization.addMethod('equals', function (org) {
  return org && this.id == org.id;
});
orgModule.Organization.addMethod('toJSON', function (org) {
  return {
    tenantId: this.id,
    tenantName: this.name,
    tenantAlias: this.alias,
    tenantDesc: this.desc,
    parentId: this.parentId,
    tenantUri: this.uri
  };
});
orgModule.Organization.addMethod('navigateToManager', function () {
  primaryNavModule.navigationPaths.tempNavigateToManager = deepClone(primaryNavModule.navigationPaths.organization);
  primaryNavModule.navigationPaths.tempNavigateToManager.params += '&' + Object.toQueryString({
    tenantId: this.id
  });
  primaryNavModule.navigationOption('tempNavigateToManager');
});

orgModule.Permission = function (options) {
  this.isInherited = !!options.isInherited;

  if (options.permission) {
    this.permission = options.permission;
  }

  if (options.inheritedPermission) {
    this.inheritedPermission = options.inheritedPermission;
  }

  this.isDisabled = !!options.isDisabled;
};

orgModule.Permission.addMethod('getResolvedPermission', function () {
  return this.isInherited ? this.inheritedPermission : this.permission;
});
orgModule.Permission.addMethod('toJSON', function () {
  return {
    permission: this.permission,
    isInherited: this.isInherited,
    inheritedPermission: this.inheritedPermission,
    newPermission: this.newPermission
  };
});
orgModule.Permission.addMethod('toData', function () {
  return {
    permission: this.permission,
    isInherited: this.isInherited,
    inheritedPermission: this.inheritedPermission,
    newPermission: this.newPermission
  };
});

orgModule.User = function (options) {
  if (options) {
    this.userName = options.userName;
    this.fullName = options.fullName;
    this.password = options.password || '';
    this.confirmPassword = options.confirmPassword || '';
    this.tenantId = options.tenantId;
    this.email = options.email;
    this.enabled = options.enabled;
    this.external = options.external;
    this.roles = [];

    if (options.roles) {
      options.roles.each(function (role) {
        this.roles.push(new orgModule.Role(role));
      }.bind(this));
    }

    if (options.permissionToDisplay) {
      this.permission = new orgModule.Permission(options.permissionToDisplay);
    }
  }
};

orgModule.User.addVar('FLOW_ID', 'userListFlow');
orgModule.User.addMethod('getDisplayName', function () {
  return this.userName;
});
orgModule.User.addMethod('getNameWithTenant', function () {
  if (this.tenantId && !this.tenantId.blank()) {
    return this.userName + orgModule.Configuration.userNameSeparator + this.tenantId;
  } else {
    return this.userName;
  }
});
orgModule.User.addMethod('getManagerURL', function () {
  return 'flow.html?' + Object.toQueryString({
    _flowId: this.FLOW_ID,
    text: typeof this.userName !== 'undefined' ? encodeURIComponent(this.userName) : this.userName,
    tenantId: typeof this.tenantId !== 'undefined' ? encodeURIComponent(this.tenantId) : this.tenantId
  });
});
orgModule.User.addMethod('navigateToManager', function () {
  primaryNavModule.navigationPaths.tempNavigateToManager = deepClone(primaryNavModule.navigationPaths.user);
  primaryNavModule.navigationPaths.tempNavigateToManager.params += '&' + Object.toQueryString({
    text: this.userName,
    tenantId: this.tenantId
  });
  primaryNavModule.navigationOption('tempNavigateToManager');
});
orgModule.User.addMethod('equals', function (user) {
  return user && this.userName == user.userName && this.tenantId == user.tenantId;
});
orgModule.User.addMethod('toPermissionData', function (user) {
  return {
    userName: this.userName,
    tenantId: this.tenantId,
    permissionToDisplay: this.permission.toData()
  };
});

orgModule.Role = function (options) {
  if (options) {
    this.roleName = options.roleName;
    this.external = options.external;
    this.tenantId = options.tenantId;
  }

  if (options.permissionToDisplay) {
    this.permission = new orgModule.Permission(options.permissionToDisplay);
  }
};

orgModule.Role.addVar('FLOW_ID', 'roleListFlow');
orgModule.Role.addMethod('getDisplayName', function () {
  return this.roleName;
});
orgModule.Role.addMethod('getNameWithTenant', function () {
  if (this.tenantId && !this.tenantId.blank()) {
    return this.roleName + orgModule.Configuration.userNameSeparator + this.tenantId;
  } else {
    return this.roleName;
  }
});
orgModule.Role.addMethod('getManagerURL', function () {
  return 'flow.html?' + Object.toQueryString({
    _flowId: this.FLOW_ID,
    // Object.toQueryString already does encodeURIComponent() once, so we have double encoding here
    text: typeof this.roleName !== 'undefined' ? encodeURIComponent(this.roleName) : this.roleName,
    tenantId: typeof this.tenantId !== 'undefined' ? encodeURIComponent(this.tenantId) : this.tenantId
  });
});
orgModule.Role.addMethod('navigateToManager', function () {
  primaryNavModule.navigationPaths.tempNavigateToManager = deepClone(primaryNavModule.navigationPaths.role);
  primaryNavModule.navigationPaths.tempNavigateToManager.params += '&' + Object.toQueryString({
    text: this.roleName,
    tenantId: this.tenantId
  });
  primaryNavModule.navigationOption('tempNavigateToManager');
});
orgModule.Role.addMethod('equals', function (role) {
  return role && this.roleName == role.roleName && this.tenantId == role.tenantId;
});
orgModule.Role.addMethod('toPermissionData', function (user) {
  return {
    roleName: this.roleName,
    tenantId: this.tenantId,
    permissionToDisplay: this.permission.toData()
  };
});

orgModule.initTenantsTreeEvents = function () {
  orgModule.manager.tenantsTree.on('selection:change', function (selectedItem) {
    if (!orgModule.manager.lastSelectedOrg || orgModule.manager.lastSelectedOrg.id !== selectedItem.id) {
      var selectedTenant = new orgModule.Organization(selectedItem),
          properties = orgModule.properties;
      orgModule.manager.tenantsTree.setTenant(selectedTenant);
      window.localStorage && localStorage.setItem(orgModule.COOKIE_NAME, JSON.stringify(selectedItem));
      orgModule.fire(orgModule.Event.ORG_BROWSE, {
        organization: selectedTenant,
        entityEvent: false
      });

      if (orgModule.orgManager) {
        properties.changeDisable(false, ['#' + properties._EDIT_BUTTON_ID]);
        orgModule.fire(orgModule.Event.ENTITY_SELECT_AND_GET_DETAILS, {
          entityId: selectedTenant.id,
          entityEvent: false
        });
      }

      if (orgModule.userManager || orgModule.roleManager) {
        properties.hide();
        properties.unlock();
      }
    }
  });
  orgModule.manager.tenantsTree.on('import:finished', function (tenantId) {
    var properties = orgModule.properties;
    orgModule.fire(orgModule.Event.ORG_BROWSE, {
      force: true,
      entityEvent: false
    });

    if (orgModule.orgManager) {
      properties.changeDisable(false, ['#' + properties._EDIT_BUTTON_ID]);
      orgModule.fire(orgModule.Event.ENTITY_SELECT_AND_GET_DETAILS, {
        refreshAttributes: true,
        entityId: tenantId,
        entityEvent: false
      });
    }
  });
};

orgModule.entityList = {
  ID_PATTERN: '.ID > a',
  _listId: 'entitiesList',
  _containerId: 'listContainer',
  _searchBoxId: 'secondarySearchBox',
  initialize: function initialize(options) {
    this.list = new dynamicList.List(this._listId, {
      listTemplateDomId: options.listTemplateId,
      itemTemplateDomId: options.itemTemplateId,
      multiSelect: true,
      selectionDefaultsToCursor: true,
      comparator: function comparator(item1, item2) {
        return orgModule._comparator(item1.getLabel(), item2.getLabel());
      }
    });

    this._initEvents(); // Infinite scroll setup.
    // Infinite scroll setup.


    this._infiniteScroll = new InfiniteScroll({
      id: this._containerId,
      contentId: this._listId
    });
    this._searchBox = new SearchBox({
      id: this._searchBoxId
    });

    if (options.text) {
      this._searchBox.setText(options.text);
    }

    this._infiniteScroll.onLoad = function () {
      orgModule.fire(orgModule.Event.ENTITY_NEXT, {});
    };

    this._searchBox.onSearch = function (text) {
      orgModule.fire(orgModule.Event.ENTITY_SEARCH, {
        text: text
      });
    };

    orgModule.toolbar.initialize(options.toolbarModel);
    this.toolbar = orgModule.toolbar;
    this.list.show();
  },
  _initEvents: function _initEvents() {
    this.list.observe('item:selected', function (event) {
      var item = event.memo.item,
          properties = orgModule.properties;
      this.lastSelectedName = item.getValue().getNameWithTenant();
      orgModule.fire(orgModule.Event.ENTITY_SELECT_AND_GET_DETAILS, {
        entityId: item.getValue().id,
        entityEvent: true
      });
      properties.changeDisable(false, ['#' + properties._EDIT_BUTTON_ID]);
    }.bindAsEventListener(this));
    this.list.observe('item:unselected', function (event) {
      var tenantsTree = orgModule.manager.tenantsTree,
          properties = orgModule.properties;
      properties.changeDisable(false, ['#' + properties._EDIT_BUTTON_ID]); // Due to complexity of code in mng.common (event flow) there is need to handle some cases in such inappropriate manner
      // This need to by refactored once mng.common will be refactored in new AMD way + new tree.
      // Due to complexity of code in mng.common (event flow) there is need to handle some cases in such inappropriate manner
      // This need to by refactored once mng.common will be refactored in new AMD way + new tree.

      if (!properties.locked && tenantsTree) {
        orgModule.fire(orgModule.Event.ENTITY_SELECT_AND_GET_DETAILS, {
          entityId: tenantsTree.getTenant().id,
          entityEvent: true,
          isCtrlHeld: event.memo.isCtrlHeld
        });
      } else {
        properties.hide();
        this.toolbar.refresh();
      }
    }.bindAsEventListener(this));
    this.list.observe('item:beforeSelectOrUnselect', function (event) {
      var item = event.memo.item;
      event.stopSelectOrUnselect = !orgModule.invokeClientAction('cancelIfEdit', {
        entity: item.getValue(),
        showConfirm: event.memo.showConfirm
      });
    }.bindAsEventListener(this));
  },
  //    _refreshProperties: function() {
  //        if (this.list.getSelectedItems().length == 1) {
  //            orgModule.properties.show(this.list.getSelectedItems()[0].getValue());
  //        } else {
  //            orgModule.properties.hide();
  //        }
  //    },
  _createEntityItem: function _createEntityItem(value) {
    var item = new dynamicList.ListItem({
      label: value.getDisplayName(),
      value: value
    });
    var entityList = this;

    item.processTemplate = function (element) {
      var id = element.select(entityList.ID_PATTERN)[0];
      id.update(xssUtil.hardEscape(this.getValue().getDisplayName()));
      return element;
    };

    return item;
  },
  getSearchText: function getSearchText() {
    return this._searchBox.getText();
  },
  setSearchText: function setSearchText(text) {
    return this._searchBox.setText(text);
  },
  getSelectedEntities: function getSelectedEntities() {
    if (this.list) {
      return this.list.getSelectedItems().collect(function (item) {
        return item.getValue();
      });
    } else {
      return [];
    }
  },
  setEntities: function setEntities(entities) {
    var items = entities.collect(this._createEntityItem.bind(this));

    this._infiniteScroll.reset();

    this.list.setItems(items);
    this.list.show();
    this.toolbar.refresh();
  },
  findEntity: function findEntity(name) {
    var items = this.list.getItems(),
        options = orgModule.properties.options || orgModule.userManager.options;
    return options._.find(items, function (item) {
      return item.getValue().fullName === name;
    });
  },
  addEntities: function addEntities(entities) {
    var items = entities.collect(this._createEntityItem.bind(this));
    this.list.addItems(items);
    this.list.refresh();
    this.toolbar.refresh();
  },
  selectEntity: function selectEntity(entityName) {
    var all = this.list.getItems();
    var matched = all.detect(function (item) {
      return item.getValue().getNameWithTenant() == entityName;
    });

    if (matched) {
      matched.isSelected() && matched.deselect();
      matched.select();
      this.lastSelectedName = matched.getValue().getNameWithTenant();
    }
  },
  restoreSelectedEntity: function restoreSelectedEntity(entityName) {
    this.selectEntity(this.lastSelectedName ? this.lastSelectedName : entityName);
  },
  deselectAll: function deselectAll() {
    this.list.resetSelected();
  },
  update: function update(entityName, newEntity) {
    var all = this.list.getItems();
    var matched = all.findAll(function (item) {
      return item.getValue().getNameWithTenant() == entityName;
    });
    matched.each(function (item) {
      item.setValue(newEntity);
      item.refresh();
    });
  },
  remove: function remove(entityNameOrNameSet) {
    var all = this.list.getItems();
    var matched;

    if (isArray(entityNameOrNameSet)) {
      matched = all.findAll(function (item) {
        return entityNameOrNameSet.include(item.getValue().getNameWithTenant());
      });
    } else {
      matched = all.findAll(function (item) {
        return item.getValue().getNameWithTenant() == entityNameOrNameSet;
      });
    }

    this.list.resetSelected();
    this.list.removeItems(matched);
  }
};
orgModule.properties = {
  _EDIT_MODE_CLASS: 'editMode',
  _moveButtonsId: 'moveButtons',
  _id: 'properties',
  _value: null,
  isEditMode: false,
  _NOTHING_TO_DISPLAY_ID: 'nothingToDisplay',
  _ASSIGNED_VIEW_ID: 'assignedView',
  _ASSIGNED_VIEW_LIST_ID: 'assignedViewList',
  _ASSIGNED_ID: 'assigned',
  _AVAILABLE_ID: 'available',
  _ASSIGNED_LIST_ID: 'assignedList',
  _AVAILABLE_LIST_ID: 'availableList',
  _ATTRIBUTES_LIST_ID: 'attributesTab',
  _EDIT_BUTTON_ID: 'edit',
  _SAVE_BUTTON_ID: 'save',
  _CANCEL_BUTTON_ID: 'cancel',
  _DELETE_BUTTON_ID: 'delete',
  _REMOVE_FROM_ASSIGNED_BUTTON_ID: 'removeFromAssigned',
  _ADD_TO_ASSIGNED_BUTTON_ID: 'addToAssigned',
  _BUTTONS_CONTAINER_ID: 'propertiesButtons',
  _MOVE_BUTTONS_CONTAINER_ID: 'moveButtons',
  _DND_CLASS: '.draggable',
  _DROP_CLASS: 'wrap',
  buttonsFunctions: {},
  initialize: function initialize(options) {
    var attributesTypesEnum = options.attributesTypesEnum;
    this.options = options;
    this.locked = false;
    this.hide();
    this.processTemplate(options);

    this._toggleButton();

    if (options.attributes) {
      var attributesType = !orgModule.userManager && orgModule.orgManager ? attributesTypesEnum.TENANT : attributesTypesEnum.USER,
          optionsFactory = options.attributesViewOptionsFactory,
          scrollEventTrait = options.scrollEventTrait,
          AttributesViewFacade = options.AttributesViewFacade;

      this.options._.extend(this, scrollEventTrait);

      this.attributesFacade = new AttributesViewFacade(optionsFactory({
        context: options.attributes.context,
        container: jQuery('#attributesTab'),
        type: attributesType
      }));
    }

    if (this.options.showAssigned) {
      this.initDnD();
    }

    this.initEvents();
    this.initButtonsFunctions();
    this.options.ConfirmationDialog && this._initConfirmationDialog();
  },
  _initConfirmationDialog: function _initConfirmationDialog() {
    var self = this,
        i18n = this.options.i18n;
    this.confirmationDialog = new this.options.ConfirmationDialog({
      title: i18n['attributes.confirm.dialog.title'],
      text: i18n['attributes.confirm.cancel.dialog.text']
    });
    this.confirmationDialog.on('button:yes', function () {
      self.cancelOnEdit();
    });
  },
  _toggleButton: function _toggleButton() {
    var propertiesIsChanged = this.isChanged(),
        attributesAndPropertiesChanged = this.attributesFacade && this.attributesFacade.containsUnsavedItems() || propertiesIsChanged;
    attributesAndPropertiesChanged ? this.saveButton.removeAttribute('disabled') : this.saveButton.removeClassName('over').setAttribute('disabled', 'disabled');
  },
  show: function show(value, refreshAttributes) {
    if (!this.locked) {
      if (this.attributesFacade) {
        var self = this,
            isRoot = value && value.isRoot && value.isRoot(),
            context = !isRoot ? value : this.options._.extend({}, value, {
          id: null
        });
        this.attributesFacade.getCurrentView().setContext(context, refreshAttributes).done(function () {
          self.attributesFacade.render(isRoot);
        });
      }

      var nothingToDisplay = $(this._NOTHING_TO_DISPLAY_ID);
      nothingToDisplay.addClassName(layoutModule.HIDDEN_CLASS);
      document.body.removeClassName(layoutModule.NOTHING_TO_DISPLAY_CLASS);
      this._value = value;
      this.changeMode(false);
    }
  },
  hide: function hide() {
    if (!this.locked) {
      var nothingToDisplay = $(this._NOTHING_TO_DISPLAY_ID);
      nothingToDisplay.removeClassName(layoutModule.HIDDEN_CLASS);
      centerElement(nothingToDisplay, {
        horz: true,
        vert: true
      });
      document.body.addClassName(layoutModule.NOTHING_TO_DISPLAY_CLASS);
      this._value = null;
      this.changeMode(false);
    }
  },
  lock: function lock() {
    this.locked = true;
  },
  unlock: function unlock() {
    this.locked = false;
  },
  setDetailsLoadedEntity: function setDetailsLoadedEntity(entity) {
    this.detailsLoadedEntity = entity;
  },
  getDetailsLoadedEntity: function getDetailsLoadedEntity() {
    return this.detailsLoadedEntity;
  },
  processTemplate: function processTemplate(options) {
    this.editButton = $(this._EDIT_BUTTON_ID);
    this.saveButton = $(this._SAVE_BUTTON_ID);
    this.cancelButton = $(this._CANCEL_BUTTON_ID);
    this.deleteButton = $(this._DELETE_BUTTON_ID);

    if (this.options.showAssigned) {
      this.removeFromAssigned = $(this._REMOVE_FROM_ASSIGNED_BUTTON_ID);
      this.addToAssigned = $(this._ADD_TO_ASSIGNED_BUTTON_ID);
      this.assignedViewList = new dynamicList.List(this._ASSIGNED_VIEW_LIST_ID, {
        listTemplateDomId: options.viewAssignedListTemplateDomId,
        itemTemplateDomId: options.viewAssignedItemTemplateDomId,
        comparator: this.assignedComparator,
        allowSelections: false,
        selectionDefaultsToCursor: false
      });
      var commonOptions = {
        listTemplateDomId: 'list_responsive_collapsible_fields',
        itemTemplateDomId: 'list_responsive_collapsible_fields:fields',
        comparator: this.assignedComparator,
        dragPattern: this._DND_CLASS,
        allowSelections: true,
        selectionDefaultsToCursor: true,
        multiSelect: true,
        selectOnMousedown: true,
        setCursorOnMouseDown: true
      };
      this.assignedList = new dynamicList.List(this._ASSIGNED_LIST_ID, Object.extend({}, commonOptions, {
        allowSelections: false,
        selectionDefaultsToCursor: false //selectOnMouseDown: false,
        //setCursorOnMouseDown: false

      }));
      this.availableList = new dynamicList.List(this._AVAILABLE_LIST_ID, commonOptions); //            this.assignedList.DND_WRAPPER_TEMPLATE = "column_two";
      //            this.assignedList.DND_ITEM_TEMPLATE = "column_two:resourceName";
      //            this.availableList.DND_WRAPPER_TEMPLATE = "column_two";
      //            this.availableList.DND_ITEM_TEMPLATE = "column_two:resourceName";
      //            this.assignedList.DND_WRAPPER_TEMPLATE = "column_two";
      //            this.assignedList.DND_ITEM_TEMPLATE = "column_two:resourceName";
      //            this.availableList.DND_WRAPPER_TEMPLATE = "column_two";
      //            this.availableList.DND_ITEM_TEMPLATE = "column_two:resourceName";

      if (options.searchAssigned) {
        this.assignedViewSearchBox = new SearchBox({
          id: $(this._ASSIGNED_VIEW_ID).select(layoutModule.SEARCH_LOCKUP_PATTERN)[0].identify()
        });

        this.assignedViewSearchBox.onSearch = function (text) {
          orgModule.invokeServerAction(orgModule.ActionMap.SEARCH_ASSIGNED, {
            text: text
          });
        };
      }

      this.availableSearchBox = new SearchBox({
        id: $(this._AVAILABLE_ID).select(layoutModule.SEARCH_LOCKUP_PATTERN)[0].identify()
      });

      this.availableSearchBox.onSearch = function (text) {
        orgModule.invokeServerAction(orgModule.ActionMap.SEARCH_AVAILABLE, {
          text: text
        });
      };

      this.assignedSearchBox = new SearchBox({
        id: $(this._ASSIGNED_ID).select(layoutModule.SEARCH_LOCKUP_PATTERN)[0].identify()
      });

      this.assignedSearchBox.onSearch = function (text) {
        orgModule.invokeServerAction(orgModule.ActionMap.SEARCH_ASSIGNED, {
          text: text
        });
      };

      if (options.searchAssigned) {
        this.assignedViewInfiniteScroll = new InfiniteScroll({
          id: $($(this._ASSIGNED_VIEW_LIST_ID).parentNode).identify(),
          contentId: this._ASSIGNED_VIEW_LIST_ID
        });

        this.assignedViewInfiniteScroll.onLoad = function () {
          orgModule.invokeServerAction(orgModule.ActionMap.NEXT_ASSIGNED, {});
        };
      }

      this.availableInfiniteScroll = new InfiniteScroll({
        id: $($(this._AVAILABLE_LIST_ID).parentNode).identify(),
        contentId: this._AVAILABLE_LIST_ID
      });

      this.availableInfiniteScroll.onLoad = function () {
        orgModule.invokeServerAction(orgModule.ActionMap.NEXT_AVAILABLE, {});
      };

      this.assignedInfiniteScroll = new InfiniteScroll({
        id: $($(this._ASSIGNED_LIST_ID).parentNode).identify(),
        contentId: this._ASSIGNED_LIST_ID
      });

      this.assignedInfiniteScroll.onLoad = function () {
        orgModule.invokeServerAction(orgModule.ActionMap.NEXT_ASSIGNED, {});
      };
    }
  },
  initDnD: function initDnD() {
    Droppables.add($(this._ASSIGNED_LIST_ID).up(), {
      accept: [this._DROP_CLASS],
      hoverclass: layoutModule.DROP_TARGET_CLASS,
      onDrop: function (dragged, dropped, event) {
        if (dragged.items) {
          this._addToAssigned();
        }
      }.bind(this)
    });
    Droppables.add($(this._AVAILABLE_LIST_ID).up(), {
      accept: [this._DROP_CLASS],
      hoverclass: layoutModule.DROP_TARGET_CLASS,
      onDrop: function (dragged, dropped, event) {
        if (dragged.items) {
          this._removeFromAssigned();
        }
      }.bind(this)
    });
  },
  initEvents: function initEvents() {
    function assignedSelectionHandler() {
      (this.assignedList.getSelectedItems().length > 0 ? buttonManager.enable : buttonManager.disable)(this.removeFromAssigned);
    }

    function availableSelectionHandler() {
      (this.availableList.getSelectedItems().length > 0 ? buttonManager.enable : buttonManager.disable)(this.addToAssigned);
    }

    $(this._BUTTONS_CONTAINER_ID).observe('click', function (event) {
      var element = event.element();
      var button = matchAny(element, [layoutModule.BUTTON_PATTERN], true);

      if (button) {
        if (this.buttonsFunctions[button.identify()]) {
          this.buttonsFunctions[button.identify()].call(this);
        }
      }

      event.stop();
    }.bindAsEventListener(this));

    if (this.options.showAssigned) {
      $(this._MOVE_BUTTONS_CONTAINER_ID).observe('click', function (event) {
        var element = event.element();
        var button = matchAny(element, [layoutModule.BUTTON_PATTERN], true);

        if (button) {
          if (button == this.removeFromAssigned) {
            this._removeFromAssigned();
          } else if (button == this.addToAssigned) {
            this._addToAssigned();
          }
        }

        event.stop();
      }.bindAsEventListener(this));
      this.assignedList.observe('item:selected', assignedSelectionHandler.bindAsEventListener(this));
      this.assignedList.observe('item:unselected', assignedSelectionHandler.bindAsEventListener(this));
      this.assignedList.observe('item:dblclick', function (event) {
        this._removeFromAssigned();
      }.bindAsEventListener(this));
      this.availableList.observe('item:selected', availableSelectionHandler.bindAsEventListener(this));
      this.availableList.observe('item:unselected', availableSelectionHandler.bindAsEventListener(this));
      this.availableList.observe('item:dblclick', function (event) {
        this._addToAssigned();
      }.bindAsEventListener(this));
    }

    this.attributesFacade && this.attributesFacade.on('change', this.options._.bind(this._toggleButton, this));
  },
  initButtonsFunctions: function initButtonsFunctions() {
    this.buttonsFunctions[this._EDIT_BUTTON_ID] = function () {
      this.changeMode(true);
    };

    this.buttonsFunctions[this._SAVE_BUTTON_ID] = function () {
      var extObj = this;
      var dfd = new jQuery.Deferred();

      if (this.validate()) {
        this.attributesFacade ? this.attributesFacade.getCurrentView().saveChildren().done(function () {
          dfd.resolve();
        }).fail(function () {
          dfd.reject();
          jQuery('.tab[tabid=\'#attributesTab\']').trigger('mouseup');
        }) : dfd.resolve();
        dfd.done(function () {
          extObj.save(extObj._value);
        });
      }
    };

    this.buttonsFunctions[this._CANCEL_BUTTON_ID] = function () {
      if (this.attributesFacade) {
        this.isChanged() ? this.confirmationDialog.open() : this.cancelOnEdit();
      } else {
        orgModule.invokeClientAction('cancelIfEdit', {
          entity: this.getValue()
        });
      }
    };

    this.buttonsFunctions[this._DELETE_BUTTON_ID] = function () {
      this._deleteEntity();
    };

    this.buttonsFunctions[this._REMOVE_FROM_ASSIGNED_BUTTON_ID] = function () {
      this._removeFromAssigned();
    };

    this.buttonsFunctions[this._ADD_TO_ASSIGNED_BUTTON_ID] = function () {
      this._addFromAssigned();
    };
  },
  cancelOnEdit: function cancelOnEdit() {
    var self = this;

    if (this.isEditMode) {
      this.cancel().done(function () {
        self.unlock();
        self.changeMode(false);

        self._toggleButton();
      });
    }
  },
  changeMode: function changeMode(edit) {
    this.isEditMode = edit;
    var tabs, attributeTab, propertiesTab, $anchor;

    if (this.attributesFacade) {
      attributeTab = $('attributesTab');
      var hideFilters = !!this._value && this._value.id === 'organizations';
      this.detachScrollEvent(this.attributesFacade.getCurrentView().$container.parent());
      this.attributesFacade.toggleMode(edit, hideFilters);
      edit && this.initScrollEvent(this.attributesFacade.getCurrentView());
      tabs = $$('.tertiary')[0];
      propertiesTab = $('propertiesTab');
      $anchor = jQuery('.control.tabSet.anchor');
    }

    if (edit) {
      $(this._id).addClassName(this._EDIT_MODE_CLASS);

      if (tabs) {
        tabs.down('.selected').removeClassName('selected');
        tabs.down('li', 0).addClassName('selected');
        tabs.addClassName('tabbed');
        attributeTab.addClassName('hidden');
        propertiesTab.removeClassName('hidden');
        $anchor.removeClass('attributesAnchor');
      }

      this._assigned = [];
      this._unassigned = [];

      if (this.options.showAssigned) {
        centerElement($(this._moveButtonsId), {
          horz: true
        });
        $(this._moveButtonsId).style.zIndex = 1000; //fix for bug 26831
        //fix for bug 26831

        this.assignedList.setItems([]);
        this.assignedList.show();
        this.availableList.setItems([]);
        this.availableList.show();
        buttonManager.disable(this.removeFromAssigned);
        buttonManager.disable(this.addToAssigned);
        this.assignedSearchBox.setText('');
        this.availableSearchBox.setText('');
        orgModule.invokeServerAction(orgModule.ActionMap.SEARCH_ASSIGNED, {
          text: this.assignedSearchBox.getText()
        });
        orgModule.invokeServerAction(orgModule.ActionMap.SEARCH_AVAILABLE, {
          text: this.availableSearchBox.getText()
        });
      }

      this._editEntity();

      this._toggleButton();
    } else {
      $(this._id).removeClassName(this._EDIT_MODE_CLASS);

      if (tabs) {
        attributeTab.removeClassName('hidden');
        propertiesTab.removeClassName('hidden');
        tabs.removeClassName('tabbed');
      }

      if (this.options.searchAssigned && this.assignedViewSearchBox) {
        this.assignedViewSearchBox.setText('');
      }

      this.changeDisable(this.canEdit(), ['#' + this._EDIT_BUTTON_ID]);
      this.changeDisable(this.canDelete(), ['#' + this._DELETE_BUTTON_ID]);

      this._showEntity();

      this._assigned = [];
      this._unassigned = [];
    }
  },
  canEdit: function canEdit() {
    return true;
  },
  canDelete: function canDelete() {
    var org = orgModule.manager.tree && orgModule.manager.tree.getOrganization();

    if (org && org.uri === '/' && !orgModule.entityList.getSelectedEntities().length) {
      return false;
    }

    return true;
  },
  setValuesProperty: function setValuesProperty(name, value) {
    this._value[name] = value;
  },
  getValue: function getValue() {
    return this._value;
  },
  setProperties: function setProperties(properties) {},
  // Template method.
  isChanged: function isChanged(properties) {},
  // Template method.
  save: function save(properties) {},
  // Template method.
  validate: function validate() {
    // Template method.
    return true;
  },
  assignedComparator: function assignedComparator(item1, item2) {
    var l1 = item1.getLabel();
    var l2 = item2.getLabel();
    return l1 > l2 ? 1 : l1 < l2 ? -1 : 0;
  },
  _moveEntities: function _moveEntities(bToAssigned) {
    var from, to, fromList, toList;

    if (bToAssigned) {
      from = this._unassigned;
      fromList = this.availableList;
      to = this._assigned;
      toList = this.assignedList;
    } else {
      from = this._assigned;
      fromList = this.assignedList;
      to = this._unassigned;
      toList = this.availableList;
    }

    var items = fromList.getSelectedItems();
    var entities = items.collect(function (item) {
      return item.getValue();
    });
    to = to.concat(entities.collect(function (entity) {
      return entity.available == bToAssigned ? entity : null;
    })).compact();
    from = from.reject(function (fromItem) {
      return entities.detect(function (entity) {
        return fromItem.equals(entity);
      });
    });
    fromList.removeItems(items);
    toList.addItems(items, true);
    toList.refresh();

    if (bToAssigned) {
      this._unassigned = from;
      this._assigned = to;
    } else {
      this._assigned = from;
      this._unassigned = to;
    }
  },
  _addToAssigned: function _addToAssigned() {
    this._moveEntities(true);
  },
  _removeFromAssigned: function _removeFromAssigned() {
    this._moveEntities(false);
  },
  _entitiesToItems: function _entitiesToItems(entities, isAvailable) {
    entities = entities ? entities : [];
    return entities.collect(function (entity) {
      var label = '';
      var tooltipText = [],
          template = 'orgTooltip';

      if (entity instanceof orgModule.User) {
        label = entity.userName;

        if (entity.fullName && entity.fullName.length > 0) {
          tooltipText = [entity.fullName];
        }

        template = entity.tenantId ? 'fullNameAndOrgTooltip' : 'fullNameTooltip';
      } else if (entity instanceof orgModule.Role) {
        label = entity.roleName;
        template = entity.tenantId ? 'orgTooltip' : undefined;
      }

      if (entity.tenantId && entity.tenantId.length > 0) {
        tooltipText.push(entity.tenantId);
      }

      entity.available = !!isAvailable;
      var item = new dynamicList.ListItem({
        label: label,
        value: entity
      });

      if (this.isEditMode) {
        item.processTemplate = function (element) {
          if (tooltipText.length > 0) {
            new JSTooltip(element, {
              text: xssUtil.hardEscape(tooltipText),
              templateId: template
            });
          }

          return dynamicList.ListItem.prototype.processTemplate.call(this, element);
        };
      } else {
        item.processTemplate = function (element) {
          var nameAnchor = element.select('a')[0];
          nameAnchor.insert(xssUtil.hardEscape(this.getLabel()));
          nameAnchor.writeAttribute('href', this.getValue().getManagerURL());

          if (tooltipText.length > 0) {
            new JSTooltip(element, {
              text: xssUtil.hardEscape(tooltipText),
              templateId: template
            });
          }

          return element;
        };
      }

      return item;
    }.bind(this));
  },
  getAssignedEntities: function getAssignedEntities() {
    return this._assigned;
  },
  getUnassignedEntities: function getUnassignedEntities() {
    return this._unassigned;
  },
  setAssignedEntities: function setAssignedEntities(entities) {
    this.assignedViewInfiniteScroll && this.assignedViewInfiniteScroll.reset();
    this.assignedInfiniteScroll && this.assignedInfiniteScroll.reset();
    var list = this.isEditMode ? this.assignedList : this.assignedViewList;

    var filteredEntities = this._filterEntities(entities, this._unassigned, this._assigned, this.assignedSearchBox.getText());

    list.setItems(this._entitiesToItems(filteredEntities));
    list.refresh();
  },
  addAssignedEntities: function addAssignedEntities(entities) {
    var list = this.isEditMode ? this.assignedList : this.assignedViewList;

    var filteredEntities = this._filterEntities(entities, this._unassigned, this._assigned, this.assignedSearchBox.getText());

    list.addItems(this._entitiesToItems(filteredEntities));
    list.refresh();
  },
  setAvailableEntities: function setAvailableEntities(entities) {
    this.availableInfiniteScroll.reset();

    var filteredEntities = this._filterEntities(entities, this._assigned, this._unassigned, this.availableSearchBox.getText());

    this.availableList.setItems(this._entitiesToItems(filteredEntities, true));
    this.availableList.refresh();
  },
  addAvailableEntities: function addAvailableEntities(entities) {
    var filteredEntities = this._filterEntities(entities, this._assigned, this._unassigned, this.availableSearchBox.getText());

    this.availableList.addItems(this._entitiesToItems(filteredEntities, true));
    this.availableList.refresh();
  },
  _filterEntities: function _filterEntities(entities, removeSet, addSet, text) {
    var allEntities = entities.reject(function (entity) {
      return removeSet.detect(function (removeEntity) {
        return removeEntity.equals(entity);
      });
    });
    text = text.toLowerCase();
    allEntities = allEntities.concat(addSet.findAll(function (entity) {
      return entity.getDisplayName().toLowerCase().include(text);
    }));
    return allEntities;
  },
  changeReadonly: function changeReadonly(edit, elementsPatterns) {
    elementsPatterns.each(function (elementPattern) {
      $(this._id).select(elementPattern)[0].writeAttribute(layoutModule.READONLY_ATTR_NAME, edit ? null : layoutModule.READONLY_ATTR_NAME);
    }.bind(this));
  },
  resetValidation: function resetValidation(elementsPatterns) {
    var panel = $(this._id);
    elementsPatterns.each(function (elementPattern) {
      ValidationModule.hideError(panel.select(elementPattern)[0]);
    }.bind(this));
  },
  changeDisable: function changeDisable(edit, elementsPatterns) {
    elementsPatterns.each(function (elementPattern) {
      if (edit) {
        buttonManager.enable($(this._id).select(elementPattern)[0]);
      } else {
        buttonManager.disable($(this._id).select(elementPattern)[0]);
      }
    }.bind(this));
  },
  _deleteEntity: function _deleteEntity() {},
  // Template method.
  _editEntity: function _editEntity() {},
  // Template method.
  _showEntity: function _showEntity() {} // Template method.

};
orgModule.addDialog = {
  show: function show(organization) {},
  // Template method.
  hide: function hide(organization) {} // Template method.

};

orgModule.Action = function (invokeFn, beforeInvoke) {
  if (Object.isFunction(invokeFn)) {
    beforeInvoke = beforeInvoke && Object.isFunction(beforeInvoke) ? beforeInvoke : this.beforeInvoke;

    this.invokeAction = function () {
      if (beforeInvoke()) {
        return invokeFn.apply(this, arguments);
      }
    };
  }
};
/**
* Invokes action.
*/

/**
 * Invokes action.
 */


orgModule.Action.addMethod('invokeAction', doNothing);
/**
* Invokes function before action is invoked..
*
* @return {Boolean} if false if true the action will not occur
*/

/**
 * Invokes function before action is invoked..
 *
 * @return {Boolean} if false if true the action will not occur
 */

orgModule.Action.addMethod('beforeInvoke', function () {
  return true;
});

orgModule.ServerAction = function (eventId, options) {
  this.actionURL = 'flow.html?_flowExecutionKey=' + window.localContext.flowExecutionKey + '&_eventId=' + eventId;
  this.data = Object.toQueryString(options);
  this.onSuccess = doNothing();
  this.onError = doNothing();
};
/**
* Invokes server action.
*/

/**
 * Invokes server action.
 */


orgModule.ServerAction.addMethod('invokeAction', function () {
  if (this.beforeInvoke()) {
    ajaxTargettedUpdate(this.actionURL, {
      postData: this.data,
      callback: function (response) {
        if (response.error) {
          this.onError(response.error);
        } else {
          this.onSuccess(response.data);
        }
      }.bind(this),
      errorHandler: function errorHandler(ajaxAgent) {
        if (ajaxAgent.getResponseHeader('LoginRequested')) {
          orgModule.fire(orgModule.Event.SERVER_UNAVAILABLE, {});
          return true;
        }

        return baseErrorHandler(ajaxAgent);
      },
      mode: AjaxRequester.prototype.EVAL_JSON
    });
  }
});
/**
* Invokes function before server action is invoked..
*
* @return {Boolean} if false if true the action will not occur
*/

/**
 * Invokes function before server action is invoked..
 *
 * @return {Boolean} if false if true the action will not occur
 */

orgModule.ServerAction.addMethod('beforeInvoke', function () {
  return true;
});
orgModule.toolbar = {
  _actionModel: {},
  initialize: function initialize(actionModel) {
    this._actionModel = actionModel;
    toolbarButtonModule.initialize(this._toActionMap(this._actionModel));
    this.refresh();
  },
  refresh: function refresh() {
    for (var name in this._actionModel) {
      var id = this._actionModel[name].buttonId;
      var testFn = toFunction(this._actionModel[name].test);
      toolbarButtonModule.setButtonState($(id), testFn());
    }
  },
  _toActionMap: function _toActionMap(bulkActionModel) {
    var actionMap = {};

    for (var name in bulkActionModel) {
      var bulkAction = bulkActionModel[name];
      var id = bulkAction.buttonId;

      actionMap[id] = function (action, actionArgs) {
        return function () {
          var myAction = getAsFunction(action);
          var args = actionArgs;
          var belongsToLocalContext = window.localContext && window.localContext[action];

          if (args && isArray(args)) {
            myAction.apply(belongsToLocalContext ? window.localContext : null, args);
          } else {
            myAction.call(belongsToLocalContext ? window.localContext : null, args);
          }
        };
      }(bulkAction.action, bulkAction.actionArgs);
    }

    return actionMap;
  }
}; ////////////////////////////////////////////////////////////////////////////////////////
// Input validator
////////////////////////////////////////////////////////////////////////////////////////

/**
 * Parameter should have two properties:
 * <ul>
 * <li>regExp {RegExp} - expression must contains list of unsupported symbols</li>
 * <li>unsupportedSymbols {String} -  list of unsupported symbols which will be displayed in error message</li>
 * </ul>
 * @param input {DOMElement}
 */
////////////////////////////////////////////////////////////////////////////////////////
// Input validator
////////////////////////////////////////////////////////////////////////////////////////

/**
 * Parameter should have two properties:
 * <ul>
 * <li>regExp {RegExp} - expression must contains list of unsupported symbols</li>
 * <li>unsupportedSymbols {String} -  list of unsupported symbols which will be displayed in error message</li>
 * </ul>
 * @param input {DOMElement}
 */

orgModule.createInputRegExValidator = function (input) {
  return {
    validator: function validator(value) {
      var matches = input.regExp.test(value);
      var isValid = !matches;
      var errorMessage = isValid ? '' : orgModule.getMessage('unsupportedSymbols', {
        symbols: input.unsupportedSymbols
      });
      input.isValid = isValid;
      return {
        isValid: isValid,
        errorMessage: errorMessage
      };
    },
    element: input
  };
};
/**
*  Check element value isn't blank
*
* @param element {DOMElement}
* @param messageKey {String}
*/

/**
 *  Check element value isn't blank
 *
 * @param element {DOMElement}
 * @param messageKey {String}
 */


orgModule.createBlankValidator = function (element, messageKey, onValid, onInvalid) {
  return {
    validator: function validator(value) {
      var isValid = !value.blank();
      var errorMessage = isValid ? '' : orgModule.getMessage(messageKey);
      return {
        isValid: isValid,
        errorMessage: errorMessage
      };
    },
    element: element,
    onValid: onValid,
    onInvalid: onInvalid
  };
};
/**
*  Check max length of value
*
* @param element {DOMElement}
* @param messageKey {String}
*/

/**
 *  Check max length of value
 *
 * @param element {DOMElement}
 * @param messageKey {String}
 */


orgModule.createMaxLengthValidator = function (element, messageKey, replaceKey) {
  return {
    validator: function validator(value) {
      var max = element.hasAttribute('maxlength') ? element.readAttribute('maxlength') : element.maxlength;
      var isValid = value.length < parseInt(max);
      var errorMessage = isValid ? '' : orgModule.getMessage(messageKey);
      replaceKey && (errorMessage = errorMessage.replace(replaceKey, max));
      return {
        isValid: isValid,
        errorMessage: errorMessage
      };
    },
    element: element
  };
};
/**
*
*
* @param element {DOMElement} Validated element
* @param asElement {DOMElement} Element to compare with
* @param messageKey {String}
*/

/**
 *
 *
 * @param element {DOMElement} Validated element
 * @param asElement {DOMElement} Element to compare with
 * @param messageKey {String}
 */


orgModule.createSameValidator = function (element, asElement, messageKey) {
  return {
    validator: function validator(value) {
      var isValid = value === asElement.getValue();
      var errorMessage = isValid ? '' : orgModule.getMessage(messageKey);
      return {
        isValid: isValid,
        errorMessage: errorMessage
      };
    },
    element: element
  };
};
/**
*
*
* @param element {DOMElement} Validated element
* @param messageKey {String}
*/

/**
 *
 *
 * @param element {DOMElement} Validated element
 * @param messageKey {String}
 */


orgModule.createRegExpValidator = function (element, messageKey, regExp) {
  return {
    validator: function validator(value) {
      var matches = regExp.exec(value);
      var isValid = !matches && value.length === 0 || matches && value == matches[0];
      var errorMessage = isValid ? '' : orgModule.getMessage(messageKey);
      return {
        isValid: isValid,
        errorMessage: errorMessage
      };
    },
    element: element
  };
};

orgModule.truncateOrgName = function (name) {
  return name && name.length > 0 ? name.truncate(15) : '';
}; ////////////////////////////////////////////////////////////////////////////////////////
// Used to convert regular expression with unsupported symbols into string separated by comas.
////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////
// Used to convert regular expression with unsupported symbols into string separated by comas.
////////////////////////////////////////////////////////////////////////////////////////


function RegExpRepresenter(expression) {
  this.charMap = {
    '\\s': ' '
  };
  this.expressionTokens = this.__parse(expression);
}

RegExpRepresenter.addMethod('__parse', function (expression) {
  var result = $A();

  for (var i = 1; i < expression.length - 1; i++) {
    var ch = expression.charAt(i);

    if (ch == '\\') {
      ch += expression.charAt(++i);
    }

    if (ch == "\\u") {
      ch += expression.substring(++i, i + 4);
      i += 3;
    }

    result.push(ch);
  }

  return result;
});
RegExpRepresenter.addMethod('getCharacters', function () {
  var result = $A();
  this.expressionTokens.each(function (token) {
    if (token.startsWith("\\u")) {
      /*eslint-disable-next-line no-eval*/
      result.push(eval('"' + token + '"'));
    } else if (token.startsWith('\\')) {
      var ch = this.charMap[token];
      result.push(ch ? ch : token.substring(1, token.length));
    } else {
      result.push(token);
    }
  }.bind(this));
  return result;
});
RegExpRepresenter.addMethod('getRepresentedString', function () {
  var result = '';
  var chars = this.getCharacters();
  var len = chars.length;

  for (var i = 0; i < len; i++) {
    var ch = chars[i];

    if (ch == ' ' || ch == '.' || ch == ',') {
      result += '[' + ch + ']';
    } else {
      result += ch;
    }

    if (i < len - 1) {
      result += ', ';
    }
  }

  return result;
});
module.exports = orgModule;

});