define(["require","exports","module","../namespace/namespace","underscore","./mng.org.module"],function(e,t,n){function i(e,t){var n=c.serverActionFactory[e];if(!n)throw new Error("No server action found for action name '"+e+"'");n.call(c.serverActionFactory,t).invokeAction()}function s(e,t){var n=c.clientActionFactory[e];if(n){return n.call(c.clientActionFactory,t).invokeAction()}throw new Error("No client action found for action name '"+e+"'")}var r=e("../namespace/namespace"),o=r.isProVersion,a=e("underscore"),c=e("./mng.org.module");c.confirmAndLeave=function(){var e=c.entityList.getSelectedEntities();return!!c.properties.attributesFacade||c.invokeClientAction("cancelIfEdit",{entity:e[0],entityEvent:!1})},c.manager={initialize:function(e){this.options=e,this.state=e.state,a.extend(this.state,{id:this.state.tenantId}),o()&&(this.tenantsTree=new e.TenantsTreeView({container:"#folders .body",currentUser:e.currentUser,removeContextMenuTreePlugin:e.removeContextMenuTreePlugin,selectedTenant:this.state,comparator:function(e,t){return c._comparator(e.tenantName,t.tenantName)}}),c.initTenantsTreeEvents(),this.tenantsTree.render()),c.observe("org:browse",function(e){var t;this.tenantsTree&&(t=this.tenantsTree.getTenant());var n=e.memo.entityEvent;if(e.memo.force||!this.lastSelectedOrg||this.lastSelectedOrg.id!=t.id){var i=c.entityList.getSelectedEntities();c.invokeClientAction("cancelIfEdit",{entity:i[0]||t,entityEvent:n})?(c.invokeServerAction(c.ActionMap.BROWSE,{tenantId:t?t.id:null}),this.lastSelectedOrg=t):this.lastSelectedOrg&&this.tenantsTree.selectTenant(this.lastSelectedOrg.id)}}.bindAsEventListener(this)),c.observe("entity:search",function(e){var t,n=c.entityList.getSelectedEntities(),i=e.memo.text;this.tenantsTree&&(t=this.tenantsTree.getTenant()),c.invokeClientAction("cancelIfEdit",{entity:n[0]||t})?(c.invokeServerAction(c.ActionMap.SEARCH,{text:i}),this.lastSearchText=i):0===i.length&&this.lastSearchText&&0!==this.lastSearchText.length&&c.entityList.setSearchText(this.lastSearchText)}.bindAsEventListener(this)),c.observe("entity:next",function(e){c.invokeServerAction(c.ActionMap.NEXT,{})}.bindAsEventListener(this)),c.observe("entity:selectAndGetDetails",function(e){var t=e.memo.entityEvent,n=e.memo.isCtrlHeld,i=e.memo.cancelIfEdit,s=c.entityList.getSelectedEntities(),r=Boolean(e.memo.refreshAttributes);if(s.length>1)c.properties.hide(),c.entityList.toolbar.refresh();else{var o,a=s[0];if(o=a&&t?a.getNameWithTenant():(!t||n||i)&&e.memo.entityId,!a&&(c.userManager||!c.userManager&&c.roleManager)&&n)return void c.properties.hide();o&&c.invokeServerAction(c.ActionMap.SELECT_AND_GET_DETAILS,{refreshAttributes:r,entity:o})}}.bindAsEventListener(this)),c.observe("result:changed",function(t){var n=t.memo.responseData;c.entityList.setEntities(n.entities.collect(this.entityJsonToObject)),e.defaultEntity&&c.entityList.restoreSelectedEntity(e.defaultEntity)}.bindAsEventListener(this)),c.observe("result:next",function(e){var t=e.memo.responseData;t.entities.length>0&&c.entityList.addEntities(t.entities.collect(this.entityJsonToObject))}.bindAsEventListener(this)),c.observe("entity:detailsLoaded",function(e){var t=this.entityJsonToObject(e.memo.responseData),n=c.properties,i=e.memo.inputData.refreshAttributes;c.entityList.update(t.getNameWithTenant(),t),n.setDetailsLoadedEntity(t),n.show(t,i),!n.locked&&n.setProperties(t),c.entityList.toolbar.refresh(),n.unlock()}.bindAsEventListener(this)),c.observe("searchAvailable:loaded",function(e){var t=e.memo.responseData;t&&t.entities&&c.properties.setAvailableEntities(t.entities.collect(this.relatedEntityJsonToObject))}.bindAsEventListener(this)),c.observe("searchAssigned:loaded",function(e){var t=e.memo.responseData;t&&t.entities&&c.properties.setAssignedEntities(t.entities.collect(this.relatedEntityJsonToObject))}.bindAsEventListener(this)),c.observe("nextAvailable:loaded",function(e){var t=e.memo.responseData;t&&t.entities&&t.entities.length>0&&c.properties.addAvailableEntities(t.entities.collect(this.relatedEntityJsonToObject))}.bindAsEventListener(this)),c.observe("nextAssigned:loaded",function(e){var t=e.memo.responseData;t&&t.entities&&t.entities.length>0&&c.properties.addAssignedEntities(t.entities.collect(this.relatedEntityJsonToObject))}.bindAsEventListener(this)),c.observe("server:error",function(e){var t=e.memo.responseData;t&&alert(t.message+"\n\n"+t.description?t.description:"")}),c.observe("entity:created",function(e){c.addDialog.hide();var t=e.memo.inputData.entity;if(t){var n=this.entityJsonToObject(t.evalJSON());c.entityList.addEntities([n]),c.entityList.deselectAll(),c.entityList.selectEntity(n.getNameWithTenant())}}.bindAsEventListener(this)),c.observe("entity:updated",function(e){var t=this,n=e.memo.inputData.entityName,i=e.memo.responseData;i.roles||(i=e.memo.unencryptedEntity),i||(i=e.memo.inputData.entity);var s=c.properties.attributesFacade||{},r=s.designer&&s.designer.saveDfD;c.properties.isEditMode&&(r?r.done(function(){c.properties.changeMode(!1)}):c.properties.changeMode(!1)),i&&(r?r.done(function(){t.updateEntityList(i,n)}):this.updateEntityList(i,n))}.bindAsEventListener(this)),c.observe("entity:deleted",function(e){var t=e.memo.inputData.entity;c.entityList.remove(t)}.bindAsEventListener(this)),c.observe("entities:deleted",function(e){var t=e.memo.inputData.entities;t&&c.entityList.remove(t.evalJSON())}.bindAsEventListener(this))},updateEntityList:function(e,t){var n=this.entityJsonToObject(e.evalJSON?e.evalJSON():e);c.entityList.update(t,n),c.entityList.selectEntity(n.getNameWithTenant?n.getNameWithTenant():t)},entityJsonToObject:function(e){},relatedEntityJsonToObject:function(e){},reloadEntities:function(){c.fire(c.Event.ORG_BROWSE,{})},isUserSuperuser:function(){var e=o()?c.Configuration.superuserRole:c.Configuration.adminRole;return null!=this.options.currentUserRoles.detect(function(t){return t.roleName==e&&!t.tenantId})}},c.invokeServerAction=i,c.invokeClientAction=s,n.exports=c});