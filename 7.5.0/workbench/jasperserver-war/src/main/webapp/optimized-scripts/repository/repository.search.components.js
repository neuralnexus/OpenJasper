define(["require","exports","module","dragdropextra","prototype","../core/core.accessibility","../core/core.events.bis","../manage/mng.common","../components/list.base","./repository.search.main","../components/components.searchBox","../components/components.dialogs","../components/components.toolbarButtons.events","../util/utils.common","../dynamicTree/dynamicTree.utils","../actionModel/actionModel.modelGenerator","../core/core.layout","../util/touch.controller","../util/tools.infiniteScroll","runtime_dependencies/js-sdk/src/common/component/dialog/ConfirmationDialog","../components/components.tooltip","../tenantImportExport/export/view/ExportDialogView","../tenantImportExport/export/enum/exportTypesEnum","runtime_dependencies/js-sdk/src/common/util/xssUtil","underscore","jquery","runtime_dependencies/js-sdk/src/jrs.configs","runtime_dependencies/js-sdk/src/common/extension/customEventExtension"],function(e,t,i){var s=e("dragdropextra"),o=s.Droppables,n=s.Draggables,r=e("prototype"),a=r.$,l=r.$break,d=e("../core/core.accessibility"),c=e("../core/core.events.bis"),h=e("../manage/mng.common"),u=e("../components/list.base"),_=u.dynamicList,m=u.baseList,p=e("./repository.search.main"),f=p.repositorySearch,g=p.Folder,E=p.canFolderBeCopied,v=p.invokeFolderAction,T=p.canFolderBeMoved,I=p.canFolderBeCopiedOrMovedToFolder,b=p.canAllBeCopiedOrMovedToFolder,A=p.invokeBulkAction,L=p.invokeRedirectAction,S=p.ResourcesUtils,C=e("../components/components.searchBox"),w=e("../components/components.dialogs"),D=e("../components/components.toolbarButtons.events"),N=e("../util/utils.common"),P=N.isMetaHeld,R=N.getBoxOffsets,O=N.toFunction,y=N.getAsFunction,M=N.isArray,B=N.disableSelectionWithoutCursorStyle,V=N.isIPad,x=N.isSupportsTouch,U=N.matchAny,F=N.centerElement,H=N.ValidationModule,k=N.fileSender,G=e("../dynamicTree/dynamicTree.utils"),W=e("../actionModel/actionModel.modelGenerator"),j=e("../core/core.layout"),Y=e("../util/touch.controller"),z=e("../util/tools.infiniteScroll"),X=e("runtime_dependencies/js-sdk/src/common/component/dialog/ConfirmationDialog"),K=e("../components/components.tooltip"),q=K.JSTooltip,J=K.tooltipModule,Z=e("../tenantImportExport/export/view/ExportDialogView"),$=e("../tenantImportExport/export/enum/exportTypesEnum"),Q=e("runtime_dependencies/js-sdk/src/common/util/xssUtil"),ee=e("underscore"),te=e("jquery"),ie=e("runtime_dependencies/js-sdk/src/jrs.configs");e("runtime_dependencies/js-sdk/src/common/extension/customEventExtension");var se=window.canBeRun,oe=window.canBeOpened,ne=window.canBeScheduled;f.exportDialog=new Z,f.exportDialog.render({type:$.REPOSITORY}),f.secondarySearchBox={_searchBox:null,initialize:function(e){this._searchBox=new C({id:"secondarySearchBox"}),this._searchBox.onSearch=function(e){f.fire(f.Event.SEARCH_SEARCH,{text:e})},this.setText(e)},setText:function(e){this._searchBox.setText(e)}},f.toolbar={_bulkActions:{},initialize:function(e){this._bulkActions=e,D.initialize(this._toActionMap(this._bulkActions)),this.refresh()},refresh:function(){for(var e in this._bulkActions){var t=this._bulkActions[e].buttonId,i=O(this._bulkActions[e].test);D.setButtonState(a(t),i())}},_toActionMap:function(e){var t={};for(var i in e){var s=e[i];t[s.buttonId]=function(e,t){return function(){var i=y(e),s=t,o=window.localContext&&window.localContext[e];s&&M(s)?i.apply(o?window.localContext:null,s):i.call(o?window.localContext:null,s)}}(s.action,s.actionArgs)}return t}},f.foldersPanel={_treeId:"foldersTree",_uri:"/",_cookieName:"lastFolderUri",_canDoBrowse:!0,_touchController:null,initialize:function(e){if(e.isFolderSet)this._uri=e.state.folderUri;else{var t=window.localStorage?localStorage.getItem(this._cookieName):void 0;this._uri=t&&t.length>0?t:"/"}return this._container=a(this.getTreeId()).up(1),this.tree=new G.createRepositoryTree(this.getTreeId(),{providerId:"repositoryExplorerTreeFoldersProvider",rootUri:f.model.getRootFolderUri(),organizationId:e.organizationId,publicFolderUri:e.publicFolderUri,urlGetNode:"flow.html?_flowId=searchFlow&method=getNode",urlGetChildren:"flow.html?_flowId=searchFlow&method=getChildren",dragPattern:".draggable",selectOnMousedown:!1}),B(a(this.getTreeId()).up(1)),this.tree.observe("key:contextMenu",function(e){var t=e.memo.node,i=R(t,!0);f.actionModel.showFolderMenu(e,{menuLeft:i[0]+100,menuTop:i[1]+20}),Event.stop(e)}),this.tree.observe("key:escape",function(e){W.hideMenu(),Event.stop(e)}),this.tree.observe("tree:mouseover",function(e){this.tree._overNode=e.memo.node}.bindAsEventListener(this)),this.tree.observe("tree:mouseout",function(e){this.tree.refreshDropTarget(!1),this.tree._overNode==e.memo.node&&(this.tree._overNode=null)}.bindAsEventListener(this)),this.tree.setDragStartState=function(e,t,i){G.Tree.prototype.setDragStartState.call(this,e,t,i);var s=new g(e);P(i,!0)?(E(s)&&v("CopyFolder",s),a(document.body).addClassName(j.COPY_CLASS)):T(s)&&v("MoveFolder",s)},this.tree.setDragEndState=function(e,t,i){f.CopyMoveController.cancel(),this.refreshDropTarget(!1),a(document.body).removeClassName(j.COPY_CLASS),G.Tree.prototype.setDragEndState.call(this,e,t,i)},this.tree.refreshDropTarget=function(e){this._overNode&&(this._overNode.isDropTarget=e,this._overNode.refreshStyle())},o.remove(this.getTreeId()),o.add(this.getTreeId(),{accept:["dragging","wrap"],onHover:function(e,t,i){if(this.tree._overNode){var s=new g(this.tree._overNode),o=e.node&&I(s)||e.items&&b(s);this.tree.refreshDropTarget(o)}}.bind(this),onDrop:function(e,t,i){var s;if(n.supportsTouch){var o=i.changedTouches[0];s=this.tree.getTreeNodeByElement(a(document.elementFromPoint(o.pageX,o.pageY)))}else s=this.tree.getTreeNodeByEvent(i);if(s&&(this.tree._overNode=s),this.tree._overNode){var r=new g(this.tree._overNode);e.node&&I(r)&&v("PasteFolder",r),e.items&&b(r)&&v("PasteResources",r)}}.bind(this)}),this.tree.observe("server:error",function(){window.console&&alert("Tree load error.")}),this.tree.observe("childredPrefetched:loaded",function(e){this.tree.openAndSelectNode(this._uri)}.bindAsEventListener(this)),this.tree.observe("tree:loaded",function(e){this._canDoBrowse=!1,"/"==this._uri?this.tree.rootNode.select():this.tree.openAndSelectNode(this._uri),this._canDoBrowse=!0;var t=this.tree.getSelectedNode();t&&t.scroll(a(this._treeId).parentNode),this.doBrowse()}.bindAsEventListener(this)),this.tree.observe("node:selected",function(e){this._uri=e.memo.node.param.uri,window.localStorage&&localStorage.setItem(this._cookieName,this._uri),f.model.setSelectedFolder(new g(e.memo.node)),this.doBrowse()}.bindAsEventListener(this)),this.tree.observe("node:mouseup",function(e){f.model.setContextFolder(new g(e.memo.node))}),this.tree.showTreePrefetchNodes(this._uri),this},doBrowse:function(){this._canDoBrowse&&f.fire(f.Event.SEARCH_BROWSE,{uri:this._uri})},getSelectedUri:function(){return this._uri},getTreeId:function(){return this._treeId},selectFolder:function(e){this.tree.openAndSelectNode(e.URI)},reselectFolder:function(e){e.node.isSelected()&&(e.node.deselect(),e.node.select())},refreshFolder:function(e){this.selectFolder(e),this.updateSubFolders(e)},updateFolder:function(e,t,i){e.label=t,e.description=i,e.node.changeName(e.label),e.node.param.extra.desc=e.description,this.tree.resortSubtree(e.node.parent),e.node.parent.refreshNode()},updateSubFolders:function(e){e.node.hasChilds()||e.node.setHasChilds(!0),e.node.isOpen()&&e.node.handleNode(),e.node.isloaded=!1,e.node.handleNode()},isFolderContextMenu:function(e){return this.tree.getTreeNodeByEvent(e)&&!this.tree.isIconEvent(e)},moveOrCopyFolder:function(e,t,i){var s=e.getParentFolder().node;return i||s.removeChild(e.node),this.tree.getTreeNodeChildren(t.node,function(t){if(t){var i=t.detect(function(t){return t.param.id==e.name});i&&this.tree.openAndSelectNode(i.param.uri)}}.bind(this))}},f.resultsPanel={_list:null,_infiniteScroll:null,_resultListHeaderId:"resultsListHeader",_resultListId:"resultsList",_resultsContainerId:"resultsContainer",_touchScroller:null,_folderDisplayPathCache:{},NOTHING_TO_DISPLAY_ID:"nothingToDisplay",RESOURCE_NAME_TOOLTIP_ID:"resourceNameTooltip",NAME_PATTERN:".resourceName",LINK_NAME_PATTERN:".resourceName > a",DISCLOSURE_PATTERN:".disclosure",SCHEDULED_PATTERN:".scheduled",LOADING_CLASS_NAME:"loading",initialize:function(e){var t=this;return this._container=a(this._resultListId).up(),this._header=a(this._resultListHeaderId),this._list=new _.List(this._resultListId,{listTemplateDomId:"tabular_fourColumn_resources",itemTemplateDomId:"tabular_fourColumn_resources:leaf",dragPattern:e.enableDnD?".draggable":"",multiSelect:!0,selectOnMousedown:!V()}),this._intiListEvents(),this._initDnD(),this.getList().show(),x()&&(this._touchController=new Y(document.getElementById(this._resultListId),document.getElementById(this._resultsContainerId),{scrollbars:!0}),te("#"+this._resultListId).on("layout_update orientationchange",function(){te("#"+t._resultListId).css("min-width",te("#"+t._resultsContainerId).width()+"px"),te("#"+t._resultListId).width(te("#"+t._resultsContainerId).width())})),V()?this._infiniteScroll=new z({id:this._container.identify(),contentId:this._resultListId,scroll:this._touchController}):this._infiniteScroll=new z({id:this._container.identify(),contentId:this._resultListId}),this._infiniteScroll.onLoad=function(){f.fire(f.Event.SEARCH_NEXT)},B(this._container),Event.observe(a(window),"resize",function(){this._toggleInfiniteScrollBasedOnViewportHeight()}.bind(this)),this._fixHeaderWidth(),this},_fixHeaderWidth:function(){V()||this._header.setStyle({marginRight:this._container.getWidth()-a(this._resultListId).getWidth()+"px"})},_createResourceItem:function(e){var t;e.hasChildren?(t=new _.CompositeItem({cssClassName:j.NODE_CLASS,label:e.label,value:e,openHandlerPattern:".disclosure.icon",closeHandlerPattern:".disclosure.icon",excludeFromSelectionTriggers:[".disclosure.icon"],listOptions:{listTemplateDomId:"tabular_fourColumn_resources_sublist",itemTemplateDomId:"tabular_fourColumn_resources_sublist:leaf",multiSelect:!0}}),t.setLoading=function(e){this.isLoading=e,this.refreshStyle(),f.resultsPanel.refresh()}):t=new _.ListItem({cssClassName:j.LEAF_CLASS,label:e.label,value:e}),t.processTemplate=function(e){var t=se(this.getValue())||oe(this.getValue()),i=t?f.resultsPanel.LINK_NAME_PATTERN:f.resultsPanel.NAME_PATTERN,s=e.select(i)[0],o=e.select(f.resultsPanel.NAME_PATTERN)[0],n=e.select(".resourceDescription")[0];s.update(Q.hardEscape(this.getValue().label));var r=this;new q(o,{text:[Q.hardEscape(this.getValue().label),Q.hardEscape(f.messages.loading)],templateId:f.resultsPanel.RESOURCE_NAME_TOOLTIP_ID,loadTextCallback:function(e){function t(e,t){var i=f.model.getFolderSeparator();return e===i?e+t:e+i+t}function i(i,o,n){o=Q.hardEscape(o),s=Q.hardEscape(t(i,n)),e.updateText([o,s])}var s,o=r.getValue().parentFolder,n=f.resultsPanel._folderDisplayPathCache[o];if(n)i(n,r.getValue().label,r.getValue().name);else{var a=new f.ServerAction(f.InfoAction.GET_DISPLAY_PATH,{data:{resourceUri:o,isFolder:!0}});a.onSuccess=function(e){f.resultsPanel._folderDisplayPathCache[o]=e,i(e,r.getValue().label,r.getValue().name)},a.onError=f.defaultErrorHandler,a.invokeAction()}}});var a=this.getValue().description;n.update(Q.hardEscape(a)),a?new q(n,{text:a}):n.jsTooltip&&n.jsTooltip.disable();var l=e.select(".resourceType")[0],d=e.select(".modifiedDate")[0],c=e.select(".createdDate")[0];return l.update(this.getValue().type),d.update(this.getValue().updateDate),new q(d,{text:this.getValue().updateDateTime}),c.update(this.getValue().date),new q(c,{text:this.getValue().dateTime}),e};var i=t.refreshStyle;return t.refreshStyle=function(){i.call(this);var e=this._getElement();this.getValue().isScheduled&&e.addClassName(j.SCHEDULED_CLASS),this.isLoading&&e.addClassName(j.LOADING_CLASS)},t},_initDnD:function(){var e=this.getList();e.setDragStartState=function(e,t,i){_.List.prototype.setDragStartState.call(this,e,t,i),P(i,!0)&&a(document.body).addClassName(j.COPY_CLASS).setStyle({cursor:null}),A(P(i,!0)?"Copy":"Move")},e.setDragEndState=function(e,t,i){f.CopyMoveController.cancel(),f.foldersPanel.tree.refreshDropTarget(!1),a(document.body).removeClassName(j.COPY_CLASS),_.List.prototype.setDragEndState.call(this,e,t,i)}},_intiListEvents:function(){this.getList().observe("item:click",function(e){var t=e.memo.item,i=e.memo.targetEvent,s=t.getValue();this._isLinkEvent(i)&&(se(s)?L("RunResourceAction"):ie.isProVersion?oe(s)&&L("OpenResourceAction",{isContentResource:window.isContentResource(s)}):oe(s)&&L("OpenResourceAction")),this._isScheduleIconEvent(i)&&ne(s)&&L("ScheduleAction")}.bindAsEventListener(this)),this.getList().observe("item:selected",function(e){var t=(e.memo.item,this.getList().getSelectedItems().collect(function(e){return e.getValue()}));f.model.setSelectedResources(t),f.actionModel.refreshToolbar()}.bindAsEventListener(this)),this.getList().observe("item:unselected",function(e){var t=(e.memo.item,this.getList().getSelectedItems().collect(function(e){return e.getValue()}));f.model.setSelectedResources(t),f.actionModel.refreshToolbar()}.bindAsEventListener(this)),this.getList().observe("item:mouseup",function(e){}),this.getList().observe("item:open",function(e){var t=e.memo.item,i=t.getValue();i.isLoaded()||(t.setLoading(!0),f.fire(f.Event.SEARCH_CHILDREN,{resource:i,item:t})),this.refresh()}.bindAsEventListener(this)),this.getList().observe("item:closed",function(e){this.refresh()}.bindAsEventListener(this)),this.getList().observe("key:contextMenu",function(e){var t=e.memo.node,i=R(t,!0),s={menuLeft:i[0]+100,menuTop:i[1]+20};this.getList().getSelectedItems().length>1?f.actionModel.showResourceBulkMenu(e,s):f.actionModel.showResourceMenu(e,s),Event.stop(e)}.bindAsEventListener(this)),this.getList().observe("key:escape",function(e){W.hideMenu(),Event.stop(e)})},_isLinkEvent:function(e){var t=Event.element(e);return null!=U(t,[this.LINK_NAME_PATTERN])},_isScheduleIconEvent:function(e){return Event.element(e).match(this.SCHEDULED_PATTERN)},_isDisclosureEvent:function(e){var t=Event.element(e);return null!=U(t,[this.DISCLOSURE_PATTERN])},_refreshEmptyListMessage:function(){var e=a(this.NOTHING_TO_DISPLAY_ID);0===this._list.getItems().length?(e.removeClassName(j.HIDDEN_CLASS),F(e,{horz:!0,vert:!0})):e.addClassName(j.HIDDEN_CLASS)},_toggleInfiniteScrollBasedOnViewportHeight:function(){this._isListHeightLessThanViewport()?this._infiniteScroll.onLoad():(this.refresh(),this._infiniteScroll.stopWaiting())},_isListHeightLessThanViewport:function(){return this.getList()._element.clientHeight<document.body.clientHeight},getList:function(){return this._list},removeResources:function(e){var t=e.findAll(function(e){return e.isChild}),i=e.findAll(function(e){return!e.isChild}),s=this.getList().getItems(),o=[],n=[];s.each(function(e){e.isComposite&&n.push(e),i.include(e.getValue())&&o.push(e)}),n.each(function(e){e.getItems()&&e.removeItems(e.getItems().findAll(function(e){return t.include(e.getValue())}))}),this.getList().removeItems(o),this._refreshEmptyListMessage(),this.refresh()},setResources:function(e,t){var i=e.collect(this._createResourceItem),s=this.getList();t?(t.setItems(i),t.refresh()):(this._infiniteScroll&&this._infiniteScroll.reset(),s.setItems(i),s.show(),this._refreshEmptyListMessage()),this._isListHeightLessThanViewport()&&J.disableTooltips(),i.length>0&&this._toggleInfiniteScrollBasedOnViewportHeight();var o=new CustomEvent("".concat(s._id,":loaded"));s._element.dispatchEvent(o)},addResources:function(e){var t=e.collect(this._createResourceItem);J.disableTooltips(),this.getList().addItems(t),this.getList().refresh(),t.length>0&&(this._toggleInfiniteScrollBasedOnViewportHeight(),J.enableTooltips())},isResourceContextMenu:function(e){return this.getList().getItemByEvent(e)},updateResource:function(e){this.getList().getItems().each(function(t){t.getValue().URIString==e.URIString&&(t.setValue(e),t.refresh(),this.getList().isItemSelected(t)&&this.getList().selectItem(t))}.bind(this))},findResource:function(e){var t=this.getList().getItems(),i=t.detect(function(t){return t.getValue().URIString===e});return i?i.getValue():null},refresh:function(){this._fixHeaderWidth(),J.cleanUp()}},f.filtersPanel={_id:"filtersPanel",_container:void 0,_filtersLists:{},_cookieName:"filtersPopularity",_ignoreFilterEvent:!1,initialize:function(e,t){this._getContainer().update(),e.each(function(e,t){this._getContainer().insert(new Element("ul",{id:e.id,"data-tab-index":5+t,"data-component-type":"list"}));var i=this._createFiltersList(e.id,e);i.show(),this._filtersLists[e.id]=i}.bind(this));for(var i in t)this.select(i,t[i]);return x()&&(this._touchController=new Y(document.getElementById(this._id),a(this._id).up())),this},_refreshScroll:function(){var e=j.scrolls.get(this._id);e&&e.refresh()},_createItemsList:function(e){var t=e.options,i=0,s=t.collect(function(e){return new _.ListItem({value:e,cssClassName:j.LEAF_CLASS,label:f.getMessage(e.labelId)})}).partition(function(){return i++,-1===e.showCount||e.showCount>i});return s[1].length>0&&s[0].push(new _.CompositeItem({value:{isMore:!0},templateDomId:"list_responsive_filters:node",openUp:!0,openHandlerPattern:".more.launcher",closeHandlerPattern:".fewer.launcher",respondOnItemEvents:!1,items:s[1]})),s[0]},_createFiltersList:function(e,t){var i=new _.List(e,{listTemplateDomId:"list_responsive_filters",itemTemplateDomId:"list_responsive_filters:leaf",items:this._createItemsList(t)});return i.addItems([new _.CompositeItem({templateDomId:"list_responsive_filters:separator",respondOnItemEvents:!1,value:{isSeparator:!0}})].compact()),i.observe("item:selected",function(e){var t=e.memo.item;t.getValue().isSeparator||t.getValue().isMore||this._ignoreFilterEvent||f.fire(f.Event.SEARCH_FILTER,{filterId:i.getId(),optionId:t.getValue().id})}.bindAsEventListener(this)),i},select:function(e,t,i){var s=this._filtersLists[e],o=function(e){if(e.getValue().id==t)throw e.isSelected()||(this._ignoreFilterEvent=i,e.select(),this._ignoreFilterEvent=!1),l;if(e.isComposite){var s=e._getElement();m.isItemOpen(s)||m.openItem(s),e.getItems()&&e.getItems().each(o)}}.bind(this);s.getItems().each(o)},_getContainer:function(){return this._container||(this._container=a(this._id),this._container.hasClassName(j.SWIPE_SCROLL_PATTERN)&&(this._container=this._container.down())),this._container}},f.filterPath={_containerId:"filterPath",_contentBodySelector:".primary.column>.content>.body",initialize:function(){return this._filterPathList=new _.List(this._containerId,{listTemplateDomId:"list_control_path",itemTemplateDomId:"list_control_path:step"}),this._filterPathList.observe("item:selected",function(e){var t=e.memo.item;t.getValue().isLast||f.fire(f.Event.SEARCH_ROLLBACK,{position:t.getValue().position})}),this},setPathItems:function(e){if(e.length>1){var t=e.length-1,i=e.collect(function(e,i){return e.isLast=i==t,new _.ListItem({label:e.label,value:e})});this._filterPathList.setItems(i),this._filterPathList.show(),a(this._containerId).up().removeClassName("hidden"),a(document.body).select(this._contentBodySelector)[0].addClassName("showingSubHeader")}else this._filterPathList.setItems([]),this._filterPathList.show(),a(this._containerId).up().addClassName("hidden"),a(document.body).select(this._contentBodySelector)[0].removeClassName("showingSubHeader")}},f.sortersPanel={_LABEL_TEMPLATE_DOM_ID:"sortPanelLabelTemplate",_containerId:"sortMode",_ignoreSortEvent:!1,sortersList:null,initialize:function(e,t){this.labelItem=new _.ListItem({label:f.getMessage("SEARCH_SORT_BY")+":",value:{isLabel:!0},templateDomId:"tabSet_control_horizontal_responsive:label",respondOnItemEvents:!1});var i=e.collect(function(e,t){return new _.ListItem({label:f.getMessage(e.labelId),value:e})});this.sortersList=new _.List(this._containerId,{listTemplateDomId:"tabSet_control_horizontal_responsive",itemTemplateDomId:"tabSet_control_horizontal_responsive:tab",items:[this.labelItem].concat(i)});var s=this;return this.sortersList.observe(this.sortersList.Event.ITEM_SELECTED,function(e){var t=e.memo.item;t.getValue().isLabel||s._ignoreSortEvent||(f.sortersPanel.disableItems(),f.fire(f.Event.SEARCH_SORT,{sorterId:t.getValue().id}))}),this.sortersList.show(),this.labelItem.disable(),this.select(t),this},select:function(e,t){this.sortersList.getItems().each(function(i){if(i.getValue().id===e&&!i.isSelected())return this._ignoreSortEvent=t,this.sortersList.selectItem(i),void(this._ignoreSortEvent=!1)}.bind(this))},disableItems:function(){var e=this;this.sortersList.getItems().each(function(t){t===e.labelItem||t.isSelected()||(t.disable(),t.refresh())})},enableItems:function(){var e=this;this.sortersList.getItems().each(function(t){t===e.labelItem||t.isSelected()||(t.enable(),t.refresh())})},_getContainer:function(){return this._container||(this._container=a(this._containerId)),this._container},_getLabelTemplate:function(){var e=a(this._LABEL_TEMPLATE_DOM_ID).cloneNode(!0);return e.removeAttribute("id"),e}};var re=function(e){this._resource=e,this._isVisible=!1,this._listId=this.ENTITY_LIST_ID,this._listContainerId=this.LIST_CONTAINER_ID,this._searchBoxId=this.SEARCH_BOX_ID,this.viewBy="USER",this._processTemplate()};re.addVar("TEMPLATE_DOM_ID","permissions"),re.addVar("TOOLTIP_TEMPLATE_DOM_ID","orgTooltip"),re.addVar("LIST_TEMPLATE_ID","tabular_twoColumn_setLeft"),re.addVar("ITEM_TEMPLATE_ID","tabular_twoColumn_setLeft:leaf"),re.addVar("WAIT_ITEM_TEMPLATE_ID","tabular_twoColumn_setLeft:loading"),re.addVar("ENTITY_LIST_ID","permissionsList"),re.addVar("LIST_CONTAINER_ID","permissionsListContainer"),re.addVar("SEARCH_BOX_ID","searchPermissionsBox"),re.addVar("NAME_TOOLTIP_PATTERN",".one"),re.addVar("NAME_PATTERN",".one>a.launcher"),re.addVar("PERMISSIONS_PATTERN",".two>select"),re.addVar("VIEW_BY_TAB_SET_PATTERN","#permissionsViewBy"),re.addVar("TAB_PATTERN",".tab>p"),re.addVar("PATH_PATTERN",".path"),re.addVar("SUBMIT_BUTTON","#permissionsOk"),re.addVar("APPLAY_BUTTON","#permissionsApply"),re.addVar("CANCEL_BUTTON","#permissionsCancel"),re.addVar("BODY_PATTERN","div.body"),re.addMethod("_processTemplate",function(){this._dom=a(this.TEMPLATE_DOM_ID).cloneNode(!0),this._dom.writeAttribute("id",null),this._dom.down(".body").writeAttribute("id","");var e=this._dom.select(this.PATH_PATTERN)[0];e.update(Q.hardEscape(this._resource.URIString.truncate(50))),e.writeAttribute("title",this._resource.URIString),this._viewByTabSet=this._dom.select(this.VIEW_BY_TAB_SET_PATTERN)[0],this._byUsersButton=this._dom.select(this.TAB_PATTERN)[0],this._byRolesButton=this._dom.select(this.TAB_PATTERN)[1],this._submitButton=this._dom.select(this.SUBMIT_BUTTON)[0],this._applyButton=this._dom.select(this.APPLAY_BUTTON)[0],this._cancelButton=this._dom.select(this.CANCEL_BUTTON)[0],this._byUsersButton.viewType="USER",this._byRolesButton.viewType="ROLE",this._submitButton.writeAttribute("id",null),this._applyButton.writeAttribute("id",null),this._cancelButton.writeAttribute("id",null);var t=this._dom.select("#"+this.ENTITY_LIST_ID)[0],i=this._dom.select("#"+this.LIST_CONTAINER_ID)[0],s=this._dom.select("#"+this.SEARCH_BOX_ID)[0];this._listId=t.writeAttribute("id",null).identify(),this._listContainerId=i.writeAttribute("id",null).identify(),this._searchBoxId=s.writeAttribute("id",null).identify()}),re.addMethod("_updateValueAndLabel",function(e,t,i,s){var o=e.select(t)[0];return o.writeAttribute("id",null),o.setValue(i),e.select(s)[0].writeAttribute("for",o.identify()),o}),re.addMethod("_updateContentAndLabel",function(e,t,i,s){var o=e.select(t)[0];return o.writeAttribute("id",null),o.update(i),e.select(s)[0].writeAttribute("for",o.identify()),o}),re.addMethod("_buttonClickHandler",function(e){var t=e.element();if(!this._waiting){var i=U(t,[j.BUTTON_PATTERN],!0),s=this._resource.URIString;[this._submitButton,this._applyButton].include(i)&&(this._byUsersButton.addClassName(j.BUTTON_CLASS),this._byRolesButton.addClassName(j.BUTTON_CLASS),f.fire(f.PermissionEvent.UPDATE,{uri:s,entities:this.getChangedEntities(),finishEdit:i==this._submitButton})),[this._byUsersButton,this._byRolesButton].include(i)&&(this.isChanged()?(this._showWarning(),e.stop()):(this._hideWarning(),this.viewBy=i.viewType,f.fire(f.PermissionEvent.BROWSE,{uri:s,type:this.viewBy}))),[this._cancelButton].include(i)&&this.hide()}}),re.addMethod("_showWarning",function(){this._dom.select(this.BODY_PATTERN)[0].addClassName(j.ERROR_CLASS)}),re.addMethod("_hideWarning",function(){this._dom.select(this.BODY_PATTERN)[0].removeClassName(j.ERROR_CLASS)}),re.addMethod("_launcherClickHandler",function(e){var t=e.element();if(!this._waiting){if(U(t,[this.NAME_PATTERN],!0)){var i=t.up("li");if(i&&i.listItem){i.listItem.getValue().navigateToManager()}}}e.stop()}),re.addMethod("_selectChangeHandler",function(e){var t=e.element();if(e.stop(),!this._waiting){if("select"==t.tagName.toLowerCase()){var i=t.options[t.selectedIndex].value,s=t.up("li");if(s&&s.listItem){var o=s.listItem.getValue();s.listItem.getValue().permission.newPermission=i!=o.permission.getResolvedPermission()?i:void 0,s.listItem.refresh()}}this.isChanged()?(this._byUsersButton.removeClassName(j.BUTTON_CLASS),this._byRolesButton.removeClassName(j.BUTTON_CLASS)):(this._byUsersButton.addClassName(j.BUTTON_CLASS),this._byRolesButton.addClassName(j.BUTTON_CLASS))}}),re.addMethod("_selectMouseOverHandler",function(e){U(e.element(),[this.PERMISSIONS_PATTERN],!0)&&e.stop()}),re.addMethod("_initControls",function(){this.list=new _.List(this._listId,{listTemplateDomId:this.LIST_TEMPLATE_ID,itemTemplateDomId:this.ITEM_TEMPLATE_ID});var e=a(this._listId).up();x()&&(this._touchController||(this._touchController=new Y(a(this._listId),a(this._listId).up(),{forceLayout:!0}))),this._infiniteScroll=new z({id:e.identify(),contentId:this._listId,scroll:this._touchController||void 0}),this._searchBox=new C({id:this._searchBoxId});var t=this._resource.URIString;this._infiniteScroll.onLoad=function(){this._waiting||f.fire(f.PermissionEvent.NEXT,{text:this._searchBox.getText(),uri:t,type:this.viewBy})}.bind(this),this._searchBox.onSearch=function(e){this._waiting||(this.isChanged()?this._showWarning():(this._hideWarning(),f.fire(f.PermissionEvent.SEARCH,{text:e,uri:t,type:this.viewBy})))}.bind(this)}),re.addMethod("show",function(){this._isVisible||(document.body.insert(this._dom),this._initControls(),this.list.setItems([]),this.list.show(),h.entityList._createEntityItem=this._createEntityItem,this.viewBy="ROLE",f.fire(f.PermissionEvent.BROWSE,{initialize:!0,uri:this._resource.URIString,type:this.viewBy,isFolder:this._resource.isFolder()}),this._isVisible=!0,document.getElementById(this._listId).parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.style.height="360px",w.popup.show(this._dom),this._dom.observe("click",this._buttonClickHandler.bindAsEventListener(this)),x()&&this._viewByTabSet.observe("touchstart",this._buttonClickHandler.bindAsEventListener(this)),this._dom.observe("click",this._launcherClickHandler.bindAsEventListener(this)),this._dom.observe("mouseover",this._selectMouseOverHandler.bindAsEventListener(this)))}),re.addMethod("showAndWait",function(){this._isVisible||(this._waiting=!0,this.show(),this._waitingItem=new _.ListItem({templateDomId:this.WAIT_ITEM_TEMPLATE_ID}),this.list.addItems([this._waitingItem]),this.list.refresh(),this.disable())}),re.addMethod("stopWaiting",function(){this._waiting&&(this._waiting=!1,this.list.removeItems([this._waitingItem]),this.enable())}),re.addMethod("hide",function(){w.popup.hide(this._dom),this._dom.remove(),this._dom.stopObserving("click"),this._dom.stopObserving("change"),this._dom.stopObserving("mouseover"),x()&&this._viewByTabSet.stopObserving("touchstart"),f.dialogsPool.removePermissionsDialog(this._resource)}),re.addMethod("enable",function(){this._searchBox.enable(),c.enable(this._byUsersButton),c.enable(this._byRolesButton)}),re.addMethod("disable",function(){this._searchBox.disable(),c.disable(this._byUsersButton),c.disable(this._byRolesButton)}),re.addMethod("_createItem",function(e){var t=new _.ListItem({label:e.getDisplayName(),value:e}),i=this.NAME_TOOLTIP_PATTERN,s=this.NAME_PATTERN,o=this.PERMISSIONS_PATTERN,n=this.TOOLTIP_TEMPLATE_DOM_ID,r=this;return t.processTemplate=function(e){var t=e.select(i)[0],a=e.select(s)[0],l=e.select(o)[0],d=this.getValue().permission,c=this.getValue().tenantId;if(d.newPermission?a.addClassName(j.EMPHASIS_CLASS):a.removeClassName(j.EMPHASIS_CLASS),a.update(Q.hardEscape(this.getValue().getDisplayName())),c&&c.length>0){new q(t,{text:Q.hardEscape(c),templateId:n});var h=e.remove;e.remove=function(){J.hideJSTooltip(t),J.cleanUp(),h.apply(this)}}l.update("");for(var u=0,_=f.model.getConfiguration().permissions,m=0;m<_.length;m++){var p=f.getMessage(_[m].labelId),g=new Element("option",{value:_[m].name});l.insert(g.update(d.inheritedPermission==_[m].name?Q.hardEscape(p+" *"):Q.hardEscape(p))),d.newPermission?d.newPermission==_[m].name&&(u=m):d.getResolvedPermission()==_[m].name&&(u=m)}return l.observe("change",r._selectChangeHandler.bindAsEventListener(r)),l.selectedIndex=u,this.getValue().permission.isDisabled&&l.writeAttribute("disabled","disabled"),e},t}),re.addMethod("addEntities",function(e){var t=e.collect(this._createItem.bind(this));this.list.addItems(t),this.list.refresh(),this._infiniteScroll.stopWaiting()}),re.addMethod("resetList",function(e){var t=te("#"+e);t.find("[js-nonmodal-tabindex]").removeAttr("js-nonmodal-tabindex"),t.find("[js-navtype]").attr("js-navtype",!1),t.find("[tabindex]").removeAttr("tabindex")}),re.addMethod("scrollReset",function(){var e=this._listId,t=this.resetList;te("#"+this._listContainerId).find(".content").find(".body").on("scroll",ee.debounce(function(){t(e)},100))}),re.addMethod("setEntities",function(e){this.list.setItems([]),this._touchController&&this._touchController.reset(),this.addEntities(e),this.resetList(this._listId),this.scrollReset()}),re.addMethod("getChangedEntities",function(){var e=this.list.getItems(),t=[];return e.each(function(e){var i=e.getValue();i.permission&&i.permission.newPermission&&t.push(i)}),t}),re.addMethod("updateEntities",function(e){this.list.getItems().each(function(t){var i=t.getValue(),s=e.detect(function(e){return e.equals(i)});s&&(t.setValue(s),t.refresh())})}),re.addMethod("isChanged",function(){return this.getChangedEntities().length>0}),f.dialogsPool={POOL_NOT_FOUND_EXCEPTION:"PoolNotFoundException",DIALOD_EXIST_EXCEPTION:"DialodExistException",NULL_RESOURCE_EXCEPTION:"NullResourceException",_permissionsDialogPool:{},_propertiesDialogPool:{},_getPool:function(e){var t;if(e==re&&(t=this._permissionsDialogPool),e==ae&&(t=this._propertiesDialogPool),t)return t;throw{name:this.POOL_NOT_FOUND_EXCEPTION,message:"Can't find pool for "+e.toString()}},_createDialog:function(e,t,i){var s=t.URIString,o=this._getPool(e);if(null==t)throw{name:this.NULL_RESOURCE_EXCEPTION,message:"Resource is null."};if(o[s])throw{name:this.DIALOD_EXIST_EXCEPTION,message:e.toString()+" dilaog for resource '"+s+"' arleady exist."};return o[s]=new e(t,i),o[s]},_createOrGetDialog:function(e,t,i){try{return this._createDialog(e,t,i)}catch(i){if(i.name==this.DIALOD_EXIST_EXCEPTION)return this._getDialog(e,t);throw i}},_getDialog:function(e,t){var i=Object.isString(t)?t:t.URIString;return this._getPool(e)[i]},_getAllDialogs:function(e){var t=this._getPool(e),i=[];for(var s in t)t[s]&&i.push(t[s]);return i},_removeDialog:function(e,t){var i=Object.isString(t)?t:t.URIString;this._getPool(e)[i]=void 0},createPermissionsDialog:function(e){return this._createDialog(re,e)},createPropertiesDialog:function(e){return this._createDialog(ae,e)},createOrGetPermissionsDialog:function(e){return this._createOrGetDialog(re,e)},createOrGetPropertiesDialog:function(e,t){return this._createOrGetDialog(ae,e,t)},getAllPermissionsDialogs:function(){return this._getAllDialogs(re)},getAllPropertiesDialogs:function(){return this._getAllDialogs(ae)},getPermissionsDialog:function(e){return this._getDialog(re,e)},getPropertiesDialog:function(e){return this._getDialog(ae,e)},
removePermissionsDialog:function(e){return this._removeDialog(re,e)},removePropertiesDialog:function(e){return this._removeDialog(ae,e)}};var ae=function(e,t){this._resource=e,this._changedCallback=t.changedCallback,this._showMode=t.showMode,this._processTemplate()};ae.addVar("TEMPLATE_DOM_ID","propertiesResource"),ae.addMethod("_processTemplate",function(){this._dom=a(this.TEMPLATE_DOM_ID).cloneNode(!0),this._dom.writeAttribute("id",null),this._dom.addClassName("_activeResourcePropertiesDialog");var e=this._dom.select(".title")[0];e.update(te(e).html().strip()+": "+Q.hardEscape(this._resource.label).truncate(50)),this._label=this._updateValueAndLabel(this._dom,"input#displayName",this._resource.label,'label[for="displayName"]'),this._description=this._updateContentAndLabel(this._dom,"textarea#description",Q.hardEscape(this._resource.description),'label[for="description"]'),this._path=this._updateValueAndLabel(this._dom,"input#path",Q.hardEscape(this._resource.URIString),'label[for="path"]'),this._showMode&&(this._dom.addClassName("showMode"),this._label.writeAttribute("readonly","readonly"),this._description.writeAttribute("readonly","readonly")),this._updateValueAndLabel(this._dom,"div#resourceID",Q.hardEscape(this._resource.name),'label[for="resourceID"]'),this._updateValueAndLabel(this._dom,"input#type",Q.hardEscape(this._resource.type),'label[for="type"]'),this._updateValueAndLabel(this._dom,"input#createdDate",Q.hardEscape(this._resource.date),'label[for="createdDate"]'),this._updateValueAndLabel(this._dom,"input#userAccess",Q.hardEscape(this._resource.permissionsToString()),'label[for="userAccess"]'),this._submitButton=this._dom.select("button.submit")[0],this._cancelButton=this._dom.select("button.cancel")[0],this._okButton=this._dom.select("button.ok")[0]}),ae.addMethod("_updateValueAndLabel",function(e,t,i,s){var o=e.select(t)[0];return o.writeAttribute("id",null),o.writeAttribute("value",i),o.setValue?o.setValue(i):o.update(i),e.select(s)[0].writeAttribute("for",o.identify()),o}),ae.addMethod("_updateContentAndLabel",function(e,t,i,s){var o=e.select(t)[0];return o.writeAttribute("id",null),o.update(i),e.select(s)[0].writeAttribute("for",o.identify()),o}),ae.addMethod("_buttonClickHandler",function(e){var t=U(e.element(),[j.BUTTON_PATTERN],!0);if(t==this._submitButton){if(this._showMode)this._hide();else if(this._isDataValid()){if(this._changedCallback){var i=this._resource.clone();i.label=this._label.getValue(),i.description=this._description.getValue(),this._changedCallback(i)}this._hide()}}else t!=this._cancelButton&&t!=this._okButton||this._hide()}),ae.addMethod("_isDataValid",function(e){return H.validate([{validator:S.labelValidator,element:this._label},{validator:S.descriptionValidator,element:this._description}])}),ae.addMethod("show",function(e){document.body.insert(this._dom),e&&e.cascade?w.popup.show(this._dom,!1,e):w.popup.show(this._dom),this._dom.observe("click",this._buttonClickHandler.bindAsEventListener(this))}),ae.addMethod("_hide",function(){w.popup.hide(this._dom),this._dom.remove(),this._dom.stopObserving("click"),f.dialogsPool.removePropertiesDialog(this._resource)}),ae.addMethod("isChanged",function(){return this._resource.label!=this._label.getValue()||this._resource.description!=this._description.getValue()}),f.showCreateFolderConfirm=function(e){var t,i=a("addFolder"),s=a("addFolderInputName"),o=a("addFolderInputDescription"),n=a("addFolderBtnAdd"),r=a("addFolderBtnCancel"),l=function(e){t=e,w.popup.show(i),s.setValue(f.messages["action.create.folder.name"]),d.disable(),setTimeout(function(){s.focus(),s.select()},500)},c=function(e){s.clear(),o.clear(),H.hideError(s),H.hideError(o),w.popup.hide(i),d.enable(),e.stop()},h=function(){return H.validate([{validator:S.labelValidator,element:s},{validator:S.descriptionValidator,element:o}])},u=function(e){"disabled"!==n.readAttribute("disabled")&&(new f.ServerAction.createFolderAction(f.FolderAction.CREATE,{toFolder:t,label:s.getValue(),desc:o.getValue()}).invokeAction(),c(e))};n.observe("click",function(e){h()&&u(e),e.stop()}),r.observe("click",c),f.showCreateFolderConfirm=l,l(e)},f.DeleteConfirmation={ID_DELETE_DIALOG_CONTAINER:"standardConfirm",ID_DELETE_DIALOG_OK_BUTTON:"deleteResourceOK",ID_DELETE_DIALOG_CANCEL_BUTTON:"deleteResourceCancel"},f.showDeleteFolderConfirm=function(e){var t=f.getMessage("SEARCH_DELETE_FOLDER_CONFIRM_MSG",{folderUri:e.URI}),i=new f.ServerAction.createFolderAction(f.FolderAction.DELETE,{folder:e});f._showDeleteDialog(t,i)},f.showDeleteResourceConfirm=function(e){var t=f.getMessage("SEARCH_DELETE_CONFIRM_MSG",{resourceUri:e.URIString}),i=new f.ServerAction.createResourceAction(f.ResourceAction.DELETE,{resources:[e]});f._showDeleteDialog(t,i)},f.showBulkDeleteResourcesConfirm=function(e){var t=f.getMessage("SEARCH_BULK_DELETE_CONFIRM_MSG",{count:e.length}),i=new f.ServerAction.createResourceAction(f.ResourceAction.DELETE,{resources:e});f._showDeleteDialog(t,i)},f._showDeleteDialog=function(e,t){var i=a(f.DeleteConfirmation.ID_DELETE_DIALOG_CONTAINER);i.down(".body").update(Q.hardEscape(e)),w.popupConfirm.show(i,!0,{okButtonSelector:"#"+f.DeleteConfirmation.ID_DELETE_DIALOG_OK_BUTTON,cancelButtonSelector:"#"+f.DeleteConfirmation.ID_DELETE_DIALOG_CANCEL_BUTTON}),te("#"+f.DeleteConfirmation.ID_DELETE_DIALOG_OK_BUTTON).on("click",function(){t.invokeAction()})},f.showResourceProperties=function(e,t){f.dialogsPool.createOrGetPropertiesDialog(e,{showMode:!0}).show(t)},f.editResourceProperties=function(e,t){f.dialogsPool.createOrGetPropertiesDialog(e,{changedCallback:function(e){new f.ServerAction.createResourceAction(f.ResourceAction.UPDATE,{resource:e}).invokeAction()}}).show(t)},f.showFolderProperties=function(e){f.dialogsPool.createOrGetPropertiesDialog(e,{showMode:!0}).show()},f.editFolderProperties=function(e){f.dialogsPool.createOrGetPropertiesDialog(e,{changedCallback:function(e){new f.ServerAction.createFolderAction(f.FolderAction.UPDATE,{folder:e}).invokeAction()}}).show()},f.editResourcePermissions=function(e){f.dialogsPool.createOrGetPermissionsDialog(e).showAndWait()},f.editFolderPermissions=function(e){f.dialogsPool.createOrGetPermissionsDialog(e).showAndWait()},f.showUploadThemeConfirm=function(e,t){var i,s,o=a("uploadTheme"),n=a("themeName"),r=a("themeZip"),l=a("uploadThemeBtnUpload"),d=a("uploadThemeBtnCancel"),c=function(e,t){i=e,s=t,w.popup.show(o),n.removeAttribute("disabled"),n.setValue(f.messages.RM_NEW_THEME_NAME),s&&(n.writeAttribute("disabled"),n.setValue(i.name)),n.select(),n.focus()},h=function(e){n.clear(),r.clear(),w.popup.hide(o),e.stop()},u=function(){return H.validate([{validator:S.labelValidator,element:n},{validator:S.zipFileTypeValidator,element:r}])},_=function(e){var t={};if(t.themeName=n.getValue(),t._eventId="uploadTheme",t._flowExecutionKey=f.flowExecutionKey,t.folderUri=i.URI,t.folderUri=i.URI,s){var o=i.URI;t.folderUri=o.slice(0,o.lastIndexOf("/")),t.reuploadAction=s,t._eventId="reuploadTheme"}var l=function(e){var o;if(r=a("themeZip"),e)try{if((o=e.evalJSON())&&"OK"==o.status){if(o.data.themeExist){var n=f.messages.SEARCH_OVERWRITE_THEME_CONFIRM_MSG,l=new X({text:n});l.on("button:yes",function(){new f.ServerAction.createFolderAction(f.ThemeAction.REUPLOAD,t).invokeAction(),l.remove()}),l.on("button:no",function(){l.remove()}),l.open()}else if(o.data.isActiveTheme){var d=o.data.themeUri,c=new f.ServerAction.createFolderAction(f.ThemeAction.SETTHEME,{folderUri:d});c.invokeAction()}}else o&&"ERROR"==o.status?alert(o.data):alert(f.messages.RM_UPLOAD_THEME_ERROR)}catch(e){alert(e)}s&&o.data.isActiveTheme||f.foldersPanel.refreshFolder(i)};k.upload(r,"searchFlow",t,l),h(e)};l.observe("click",function(e){u()&&_(e),e.stop()}),d.observe("click",h),f.showUploadThemeConfirm=c,c(e,t)},i.exports=f});