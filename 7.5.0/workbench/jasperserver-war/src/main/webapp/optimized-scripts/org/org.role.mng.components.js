define(["require","exports","module","prototype","../core/core.layout","../namespace/namespace","../components/list.base","../tenantImportExport/utils/RegExpRepresenter","../components/components.dialogs","../util/utils.common","./org.role.mng.main","jquery"],function(e,t,i){var o=e("prototype"),a=o.$,n=e("../core/core.layout"),r=e("../namespace/namespace"),s=r.isProVersion,l=e("../components/list.base"),d=l.dynamicList,p=e("../tenantImportExport/utils/RegExpRepresenter"),E=e("../components/components.dialogs"),_=e("../util/utils.common"),u=_.ValidationModule,h=_.matchAny,m=e("./org.role.mng.main"),c=e("jquery");m.roleManager.roleList={CE_LIST_TEMPLATE_ID:"tabular_oneColumn:roles",CE_ITEM_TEMPLATE_ID:"tabular_oneColumn:roles:leaf",PRO_LIST_TEMPLATE_ID:"tabular_twoColumn:roles",PRO_ITEM_TEMPLATE_ID:"tabular_twoColumn:roles:leaf",ROLE_ID_PATTERN:".ID",ROLE_ORGANIZATION_PATTERN:".organization",initialize:function(e){m.entityList.initialize({listTemplateId:s()?this.PRO_LIST_TEMPLATE_ID:this.CE_LIST_TEMPLATE_ID,itemTemplateId:s()?this.PRO_ITEM_TEMPLATE_ID:this.CE_ITEM_TEMPLATE_ID,toolbarModel:e.toolbarModel,text:e.text}),m.entityList._createEntityItem=function(e){var t=new d.ListItem({label:e.roleName,value:e});return t.processTemplate=function(e){e.select(m.roleManager.roleList.ROLE_ID_PATTERN)[0].update(this.getValue().roleName);var t=this.getValue().tenantId;if(s()&&t){e.select(m.roleManager.roleList.ROLE_ORGANIZATION_PATTERN)[0].update(t)}return e},t}}},m.roleManager.properties={ROLE_NAME_PATTERN:"#roleName",EXTERNAL_ROLE_PATTERN:"#externalRole",role:null,initialize:function(){m.properties.initialize({viewAssignedListTemplateDomId:"list_responsive_fields",viewAssignedItemTemplateDomId:"list_responsive_fields:leaf",searchAssigned:!0,showAssigned:!0});var e=a(m.properties._id);this.roleName=e.select(this.ROLE_NAME_PATTERN)[0],this.external=e.select(this.EXTERNAL_ROLE_PATTERN)[0],this.roleName.regExp=new RegExp(m.Configuration.roleNameNotSupportedSymbols),this.roleName.unsupportedSymbols=new p(m.Configuration.roleNameNotSupportedSymbols).getRepresentedString(),this.roleName.inputValidator=m.createInputRegExValidator(this.roleName),this._validators=[m.createBlankValidator(this.roleName,"roleNameIsEmpty"),this.roleName.inputValidator],this._initCustomEvents(),m.properties.setProperties=function(e){var t=m.roleManager.properties;t.roleName.setValue(e.roleName),t.external.checked=e.external,e.external?t.external.up("fieldset").removeClassName(n.HIDDEN_CLASS):t.external.up("fieldset").addClassName(n.HIDDEN_CLASS),m.invokeServerAction(m.ActionMap.SEARCH_ASSIGNED,{text:""})},m.properties._deleteEntity=function(){m.invokeClientAction(m.ActionMap.DELETE,{entity:this._value})},m.properties._editEntity=function(){var e=m.roleManager.properties;this.resetValidation([e.ROLE_NAME_PATTERN]),this.changeReadonly(!0,[e.ROLE_NAME_PATTERN])},m.properties._showEntity=function(){var e=m.roleManager.properties;this.resetValidation([e.ROLE_NAME_PATTERN]),this.changeReadonly(!1,[e.ROLE_NAME_PATTERN])},m.properties.validate=function(){var e=m.roleManager.properties,t=e._toRole(this._value.tenantId);if(t.roleName!=this._value.roleName)return u.validateLegacy(e._validators)&&m.invokeServerAction(m.ActionMap.EXIST,{entity:t,onExist:function(){u.showError(e.roleName,m.messages.roleNameIsAlreadyInUse)}.bind(this),onNotExist:function(){u.hideError(e.roleName),this.save(t)}.bind(this)});this.save(t)},m.properties.isChanged=function(){var e=m.roleManager.properties,t=this._value,i=e._toRole();return this.isEditMode&&(t.roleName!=i.roleName||this.getAssignedEntities().length>0||this.getUnassignedEntities().length>0)},m.properties.save=function(e){m.invokeServerAction("update",{entityName:this._value.getNameWithTenant(),entity:e,assigned:this.getAssignedEntities(),unassigned:this.getUnassignedEntities()})},m.properties.cancel=function(){var e=new c.Deferred;return this.setProperties(this._value),e.resolve()},m.properties.canEdit=function(){return null==this._value||m.canEditRole(this._value)},m.properties.canDelete=function(){return null==this._value||m.canDeleteRole(this._value)}},_initCustomEvents:function(e){var t=a(m.properties._id),i=c("#moveButtons, #userEnable"),o=c("#editUsers").find("#assigned, #available");t.observe("keyup",function(e){var t=e.element();t==this.roleName&&(u.validateLegacy([t.inputValidator]),e.stop()),m.properties._toggleButton()}.bindAsEventListener(this)),i.on("click",function(e){m.properties._toggleButton()}),o.on("dblclick",function(){m.properties._toggleButton()})},_toRole:function(e){var t=a(m.properties._id),i=new m.Role({roleName:t.select(this.ROLE_NAME_PATTERN)[0].getValue()});return e&&(i.tenantId=e),i.users=m.properties.getAssignedEntities(),i}},m.roleManager.addDialog={ADD_ROLE_ID:"addRole",ADD_ROLE_BUTTON_ID:"addRoleBtn",CANCEL_ROLE_BUTTON_ID:"cancelAddRoleBtn",ADD_ROLE_NAME_ID:"addRoleName",ADD_ROLE_BUTTON_TITLE_PATTERN:".wrap",initialize:function(){this.addRole=a(this.ADD_ROLE_ID),this.addBtn=a(this.ADD_ROLE_BUTTON_ID),this.cancelBtn=a(this.CANCEL_ROLE_BUTTON_ID),this.roleName=a(this.ADD_ROLE_NAME_ID),this.roleName.regExp=new RegExp(m.Configuration.roleNameNotSupportedSymbols),this.roleName.unsupportedSymbols=new p(m.Configuration.roleNameNotSupportedSymbols).getRepresentedString(),this.roleName.inputValidator=m.createInputRegExValidator(this.roleName),this._validators=[m.createBlankValidator(this.roleName,"roleNameIsEmpty"),this.roleName.inputValidator],this.addRole.observe("keyup",function(e){var t=e.element();t==this.roleName&&(u.validateLegacy([t.inputValidator]),e.stop())}.bindAsEventListener(this)),this.addRole.observe("click",function(e){var t=h(e.element(),[n.BUTTON_PATTERN],!0);t==this.addBtn?this._doAdd():t==this.cancelBtn&&this.hide()}.bindAsEventListener(this))},show:function(e){this.organization=e,u.hideError(this.roleName);var t=this.addBtn.select(this.ADD_ROLE_BUTTON_TITLE_PATTERN)[0];if(t){var i=this.organization&&!this.organization.isRoot()?m.getMessage("addRoleTo",{organizationName:m.truncateOrgName(this.organization.id)}):m.getMessage("addRole");t.update(i)}this.addBtn.title=this.organization&&!this.organization.isRoot()?m.getMessage("addRoleTo",{organizationName:this.organization.id}):m.getMessage("addRole"),E.popup.show(this.addRole,!0);try{this.roleName.focus()}catch(e){}},hide:function(){E.popup.hide(this.addRole),this.roleName.setValue("")},_validate:function(){return u.validateLegacy(this._validators)},_doAdd:function(){if(this._validate()){var e=new m.Role({roleName:this.roleName.getValue()});this.organization&&!this.organization.isRoot()&&(e.tenantId=this.organization.id),m.invokeServerAction(m.ActionMap.EXIST,{entity:e,onExist:function(){u.showError(this.roleName,m.messages.roleNameIsAlreadyInUse)}.bind(this),onNotExist:function(){u.hideError(this.roleName),m.invokeServerAction(m.ActionMap.CREATE,{entity:e})}.bind(this)})}}},i.exports=m});