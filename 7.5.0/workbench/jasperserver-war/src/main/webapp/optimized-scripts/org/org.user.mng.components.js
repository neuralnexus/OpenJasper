define(["require","exports","module","prototype","jquery","runtime_dependencies/js-sdk/src/common/util/encrypter","xregexp","./org.user.mng.main","../util/utils.common","../tenantImportExport/utils/RegExpRepresenter","../namespace/namespace","runtime_dependencies/js-sdk/src/common/util/xssUtil","../core/core.layout","../core/core.events.bis","../components/components.dialogs","../components/list.base"],function(e,t,s){var a=e("prototype"),i=a.$,r=e("jquery"),n=e("runtime_dependencies/js-sdk/src/common/util/encrypter"),o=e("xregexp"),l=e("./org.user.mng.main"),d=e("../util/utils.common"),u=d.ValidationModule,_=d.matchAny,p=e("../tenantImportExport/utils/RegExpRepresenter"),E=e("../namespace/namespace"),h=E.isProVersion,m=e("runtime_dependencies/js-sdk/src/common/util/xssUtil"),c=e("../core/core.layout"),N=e("../core/core.events.bis"),T=e("../components/components.dialogs"),g=e("../components/list.base"),A=g.dynamicList;l.userManager.userList={CE_LIST_TEMPLATE_ID:"tabular_twoColumn",CE_ITEM_TEMPLATE_ID:"tabular_twoColumn:leaf",PRO_LIST_TEMPLATE_ID:"tabular_threeColumn",PRO_ITEM_TEMPLATE_ID:"tabular_threeColumn:leaf",USER_ID_PATTERN:".ID > a",USER_NAME_PATTERN:".name",USER_ORGANIZATION_PATTERN:".organization",initialize:function(e){l.entityList.initialize({listTemplateId:h()?this.PRO_LIST_TEMPLATE_ID:this.CE_LIST_TEMPLATE_ID,itemTemplateId:h()?this.PRO_ITEM_TEMPLATE_ID:this.CE_ITEM_TEMPLATE_ID,onLoad:function(){l.fire(l.userManager.Event.SEARCH_NEXT,{})},onSearch:function(e){l.fire(l.userManager.Event.SEARCH,{text:e})},toolbarModel:e.toolbarModel,text:e.text}),l.entityList._createEntityItem=function(e){var t=new A.ListItem({label:e.userName,value:e});return t.processTemplate=function(e){var t=e.select(l.userManager.userList.USER_ID_PATTERN)[0],s=e.select(l.userManager.userList.USER_NAME_PATTERN)[0];t.update(m.hardEscape(this.getValue().userName)),s.update(m.hardEscape(this.getValue().fullName));var a=this.getValue().tenantId;if(h()&&a){e.select(l.userManager.userList.USER_ORGANIZATION_PATTERN)[0].update(m.hardEscape(a))}return e},t}}},l.userManager.properties={USER_NAME_PATTERN:"#userName",USER_ID_PATTERN:"#propUserID",EMAIL_PATTERN:"#email",ENABLE_USER_PATTERN:"#enableUser",EXTERNAL_USER_PATTERN:"#externalUser",PASSWORD_PATTERN:"#password",PASSWORD_CONFIRM_PATTERN:"#confirmPassword",_LOGIN_AS_USER_BUTTON:"loginAsUser",user:null,initialize:function(e){l.properties.initialize(e._.extend({},e,{viewAssignedListTemplateDomId:"list_type_attributes",viewAssignedItemTemplateDomId:"list_type_attributes:role",searchAssigned:!1,showAssigned:!0,attributes:{context:{urlGETTemplate:"rest_v2/attributes?includeInherited=true&holder=user:{{if (tenantId) { }}/{{-tenantId}}{{ } }}/{{-userName}}&group=custom&excludeGroup=serverSettings",urlPUTTemplate:"rest_v2{{ if (tenantId) { }}/organizations/{{-tenantId}}{{ } }}/users/{{-userName}}/attributes?_embedded=permission"}}}));var t=i(l.properties._id);this.name=t.select(this.USER_NAME_PATTERN)[0],this.id=t.select(this.USER_ID_PATTERN)[0],this.email=t.select(this.EMAIL_PATTERN)[0],this.enabled=t.select(this.ENABLE_USER_PATTERN)[0],this.external=t.select(this.EXTERNAL_USER_PATTERN)[0],this.pass=t.select(this.PASSWORD_PATTERN)[0],this.confirmPass=t.select(this.PASSWORD_CONFIRM_PATTERN)[0],this.email.blurValidator=l.createRegExpValidator(this.email,"invalidEmail",o(l.Configuration.emailRegExpPattern)),this.pass.inputValidator=l.createRegExpValidator(this.pass,"passwordIsWeak",o(l.Configuration.passwordPattern)),this._validators=[this.email.blurValidator,this.pass.inputValidator,l.createSameValidator(this.confirmPass,this.pass,"invalidConfirmPassword")],this._initCustomEvents();var s=e.currentUser;l.properties.setProperties=function(e){var t=l.userManager.properties;t.name.setValue(e.fullName),t.id.setValue(e.userName),t.email.setValue(e.email),t.enabled.checked=e.enabled,t.external.checked=e.external,t.pass.setValue(""),t.confirmPass.setValue(""),e.external?t.external.up("fieldset").removeClassName(c.HIDDEN_CLASS):t.external.up("fieldset").addClassName(c.HIDDEN_CLASS),this.setAssignedEntities(e.roles),e.enabled&&e.getNameWithTenant()!=s?N.enable(t._LOGIN_AS_USER_BUTTON):N.disable(t._LOGIN_AS_USER_BUTTON),e.getNameWithTenant()!==s?N.enable(this._DELETE_BUTTON_ID):N.disable(this._DELETE_BUTTON_ID)},l.properties._deleteEntity=function(){l.invokeClientAction("delete",{entity:this._value})},l.properties._loginAsUser=function(){l.invokeUserManagerAction("login",{user:this._value})},l.properties._editEntity=function(){var e=l.userManager.properties;this._value.external?(r(e.PASSWORD_PATTERN).parent().addClass(c.HIDDEN_CLASS),r(e.PASSWORD_CONFIRM_PATTERN).parent().addClass(c.HIDDEN_CLASS)):(r(e.PASSWORD_PATTERN).parent().removeClass(c.HIDDEN_CLASS),r(e.PASSWORD_CONFIRM_PATTERN).parent().removeClass(c.HIDDEN_CLASS)),r(e.PASSWORD_PATTERN).val(""),r(e.PASSWORD_CONFIRM_PATTERN).val(""),this.resetValidation([e.USER_NAME_PATTERN,e.EMAIL_PATTERN,e.PASSWORD_CONFIRM_PATTERN]),this.changeReadonly(!0,[e.USER_NAME_PATTERN,e.EMAIL_PATTERN]);var t=this._value.getNameWithTenant()!==s;this.changeDisable(t,[e.ENABLE_USER_PATTERN])},l.properties._showEntity=function(){var e=l.userManager.properties;this.resetValidation([e.USER_NAME_PATTERN,e.EMAIL_PATTERN,e.PASSWORD_CONFIRM_PATTERN]),this.changeReadonly(!1,[e.USER_NAME_PATTERN,e.EMAIL_PATTERN]),this.changeDisable(!1,[e.ENABLE_USER_PATTERN])},l.properties.validate=function(){var e=l.userManager.properties;return!!u.validateLegacy(e._validators)||(T.systemConfirm.show(l.messages.validationErrors,2e3),!1)},l.properties.isChanged=function(){var e=l.userManager.properties,t=this._value,s=e._toUser(),a=l.properties.attributesFacade,i=a&&a.containsUnsavedItems();return this.isEditMode&&(i||t.fullName!=s.fullName||t.email!=s.email||t.enabled!=s.enabled||t.password!=s.password||t.confirmPassword!=s.confirmPassword||this.getAssignedEntities().length>0||this.getUnassignedEntities().length>0)},l.properties.save=function(){var e=l.userManager.properties,t=this;e._toUser(function(e,s){t._value.tenantId&&(e.tenantId=t._value.tenantId,s.tenantId=t._value.tenantId),e.roles=t.getAssignedEntities(),s.roles=t.getAssignedEntities(),l.invokeServerAction("update",{entityName:t._value.getNameWithTenant(),entity:e,unencryptedEntity:s,assigned:t.getAssignedEntities(),unassigned:t.getUnassignedEntities()}),l.properties.changeMode(!1)})},l.properties.cancel=function(){var e=new r.Deferred;return this.setProperties(this._value),this.attributesFacade?this.attributesFacade.cancel():e.resolve()}},_initCustomEvents:function(e){var t=i(l.properties._id),s=r("#moveButtons, #userEnable"),a=r("#editRoles").find("#assigned, #available");this.id.regExp=new RegExp(l.Configuration.userNameNotSupportedSymbols),this.id.unsupportedSymbols=new p(l.Configuration.userNameNotSupportedSymbols).getRepresentedString(),t.observe("keyup",function(e){var t=e.element();t.inputValidator&&u.validateLegacy(t.inputValidator),t==this.id&&(u.validateLegacy([l.createInputRegExValidator(t)]),e.stop()),l.properties._toggleButton()}.bindAsEventListener(this)),s.on("click",function(e){l.properties._toggleButton()}),a.on("dblclick",function(){l.properties._toggleButton()}),this.email.observe("blur",function(e){var t=e.element();if(t.blurValidator){if(!u.validateLegacy(t.blurValidator))return t.inputValidator=t.blurValidator,t.focus(),!1;t.inputValidator&&(t.inputValidator=null)}}),i(l.properties._BUTTONS_CONTAINER_ID).observe("click",function(e){var t=_(e.element(),[c.BUTTON_PATTERN],!0),s=i(this._LOGIN_AS_USER_BUTTON);t!=s||N.isDisabled(s)||l.properties._loginAsUser()}.bindAsEventListener(this))},_toUser:function(e){if(!e)return new l.User({fullName:this.name.getValue(),userName:this.id.getValue(),email:this.email.getValue(),enabled:this.enabled.checked,external:this.external.checked,password:this.pass.getValue(),confirmPassword:this.confirmPass.getValue()});var t=new l.User({fullName:this.name.getValue(),userName:this.id.getValue(),email:this.email.getValue(),enabled:this.enabled.checked,external:this.external.checked,password:"",confirmPassword:""});if(window.isEncryptionOn){var s=this,a={};a[this.pass.id]=this.pass.getValue(),a[this.confirmPass.id]=this.confirmPass.getValue(),n.encryptData(a,function(a){if(!a)throw new Error("No encrypted data found.");r("#"+s.pass.id).val(a[s.pass.id]),r("#"+s.confirmPass.id).val(a[s.confirmPass.id]);var i=new l.User({fullName:s.name.getValue(),userName:s.id.getValue(),email:s.email.getValue(),enabled:s.enabled.checked,external:s.external.checked,password:a[s.pass.id]});e(i,t)})}else t.password=this.pass.getValue(),e(t,t)}},l.userManager.addDialog={_ADD_USER_ID:"addUser",_ADD_BUTTON_ID:"addUserBtn",_CANCEL_BUTTON_ID:"cancelUserBtn",_FULL_NAME_ID:"addUserFullName",_USER_NAME_ID:"addUserID",_USER_EMAIL_ID:"addUserEmail",_ENABLE_USER_ID:"addUserEnableUser",_PASSWORD_ID:"addUserPassword",_CONFIRM_PASSWORD_ID:"addUserConfirmPassword",_ADD_BUTTON_TITLE_PATTERN:".wrap",initialize:function(){this.addUser=i(this._ADD_USER_ID),this.addBtn=i(this._ADD_BUTTON_ID),this.cancelBtn=i(this._CANCEL_BUTTON_ID),this.fullName=i(this._FULL_NAME_ID),this.userName=i(this._USER_NAME_ID),this.userEmail=i(this._USER_EMAIL_ID),this.enableUser=i(this._ENABLE_USER_ID),this.password=i(this._PASSWORD_ID),this.confirmPassword=i(this._CONFIRM_PASSWORD_ID),this.userName.regExp=new RegExp(l.Configuration.userNameNotSupportedSymbols),this.userName.regExpForReplacement=new RegExp(l.Configuration.userNameNotSupportedSymbols,"g"),this.userName.unsupportedSymbols=new p(l.Configuration.userNameNotSupportedSymbols).getRepresentedString(),this.userName.inputValidator=l.createInputRegExValidator(this.userName),this.userEmail.blurValidator=l.createRegExpValidator(this.userEmail,"invalidEmail",o(l.Configuration.emailRegExpPattern)),this.password.inputValidator=l.createRegExpValidator(this.password,"passwordIsWeak",o(l.Configuration.passwordPattern)),this.confirmPassword.blurValidator=l.createSameValidator(this.confirmPassword,this.password,"invalidConfirmPassword"),this._validators=[l.createBlankValidator(this.userName,"userNameIsEmpty"),l.createBlankValidator(this.password,"passwordIsEmpty",function(e){e.element.inputValidator=null},function(e){e.element.inputValidator=e}),this.confirmPassword.blurValidator,this.userEmail.blurValidator,this.password.inputValidator,this.userName.inputValidator],this.addUser.observe("keyup",function(e){var t=e.element();t.inputValidator&&u.validateLegacy(t.inputValidator),t==this.userName?t.changedByUser||(t.changedByUser=t.getValue()!=t.prevValue):t==this.fullName&&(this.userName.changedByUser||(this.userName.regExp.test(this.fullName.getValue())?this.userName.setValue(t.getValue().replace(this.userName.regExpForReplacement,"_")):this.userName.setValue(t.getValue())),e.stop())}.bindAsEventListener(this)),[this.userEmail,this.confirmPassword].invoke("observe","blur",function(e){var t=e.element();if(t.blurValidator){if(!u.validateLegacy(t.blurValidator))return t.inputValidator=t.blurValidator,!1;t.inputValidator&&(t.inputValidator=null)}}),this.addUser.observe("keydown",function(e){var t=e.element();this.userName==t&&(this.userName.prevValue=this.userName.getValue())}.bindAsEventListener(this)),this.addUser.observe("click",function(e){var t=_(e.element(),[c.BUTTON_PATTERN],!0);t==this.addBtn?this._doAdd():t==this.cancelBtn&&this.hide()}.bindAsEventListener(this))},_hideValidationErrors:function(){[this.fullName,this.userName,this.password,this.confirmPassword,this.userEmail].each(function(e){u.hideError(e,!0),e.changedByUser=!1})},show:function(e){this.organization=e,this._hideValidationErrors();var t=this.addBtn.select(this._ADD_BUTTON_TITLE_PATTERN)[0];if(t){var s=this.organization&&!this.organization.isRoot()?l.getMessage("addUserTo",{organizationName:l.truncateOrgName(this.organization.id)}):l.getMessage("addUser");t.update(s)}this.addBtn.title=this.organization&&!this.organization.isRoot()?l.getMessage("addUserTo",{organizationName:this.organization.id}):l.getMessage("addUser"),T.popup.show(this.addUser,!0);try{this.fullName.focus()}catch(e){}},hide:function(){T.popup.hide(this.addUser),this.userName.setValue(""),this.fullName.setValue(""),this.userEmail.setValue(""),this.enableUser.checked=!0,this.password.setValue(""),this.confirmPassword.setValue("")},_validate:function(){return u.validateLegacy(this._validators)},_autoFill:function(){},_doAdd:function(){if(this._validate()){var e,t=this;window.isEncryptionOn&&(e={pswd:this.password.getValue()}),n.encryptData(e,function(e){var s=t.password.getValue();e&&e.pswd&&(s=e.pswd);var a=l.Configuration.userDefaultRole,i=new l.User({userName:t.userName.getValue(),fullName:t.fullName.getValue(),email:t.userEmail.getValue(),enabled:t.enableUser.checked,password:s,roles:a?[{roleName:a}]:[]});t.organization&&!t.organization.isRoot()&&(i.tenantId=t.organization.id),l.invokeServerAction(l.ActionMap.EXIST,{entity:i,onExist:function(){u.showError(this.userName,l.messages.userNameIsAlreadyInUse)}.bind(t),onNotExist:function(){u.hideError(t.userName),l.invokeServerAction(l.ActionMap.CREATE,{entity:i})}.bind(t)})})}}},s.exports=l});