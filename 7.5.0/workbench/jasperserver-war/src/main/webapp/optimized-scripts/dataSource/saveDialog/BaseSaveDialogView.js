define(["require","exports","module","underscore","bundle!all","runtime_dependencies/bi-repository/src/bi/repository/model/RepositoryResourceModel","runtime_dependencies/js-sdk/src/common/component/dialog/DialogWithModelInputValidation","text!./template/baseSaveDialogTemplate.htm","settings!treeComponent","runtime_dependencies/bi-repository/src/bi/repository/factory/repositoryTreeFactory","runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes"],function(e,o,t){var i=e("underscore"),r=e("bundle!all"),s=e("runtime_dependencies/bi-repository/src/bi/repository/model/RepositoryResourceModel"),a=e("runtime_dependencies/js-sdk/src/common/component/dialog/DialogWithModelInputValidation"),n=e("text!./template/baseSaveDialogTemplate.htm"),l=e("settings!treeComponent"),d=e("runtime_dependencies/bi-repository/src/bi/repository/factory/repositoryTreeFactory"),c=e("runtime_dependencies/bi-repository/src/bi/repository/enum/repositoryResourceTypes");t.exports=a.extend({theDialogIsOpen:!1,autoUpdateResourceID:!0,saveDialogTemplate:n,constructor:function(e){e||(e={}),this.options=e;var o=this.extendModel(this.options.model),t=this._getLabelForSaveButton(o);this.autoUpdateResourceID=!this.options.isEditMode,this.preSelectedFolder=e.parentFolderUri,a.prototype.constructor.call(this,{skipLocation:!!e.skipLocation,modal:!0,model:o,minHeight:500,minWidth:440,setMinSizeAsSize:!0,resizable:!e.skipLocation,additionalCssClasses:"dataSourceSaveDialog"+(e.skipLocation?" no-minheight":""),title:r["resource.datasource.saveDialog.save"],content:i.template(this.saveDialogTemplate,{i18n:r,model:i.extend({},o.attributes),skipLocation:!!this.options.skipLocation,isEmbedded:this.options.isEmbedded,isEditMode:this.options.isEditMode}),buttons:[{label:r[t],action:"save",primary:!0},{label:r["resource.datasource.saveDialog.cancel"],action:"cancel",primary:!1}]}),this.on("button:save",i.bind(this._onSaveDialogSaveButtonClick,this)),this.on("button:cancel",i.bind(this._onSaveDialogCancelButtonClick,this))},initialize:function(e){a.prototype.initialize.apply(this,arguments),!i.isUndefined(this.preSelectedFolder)&&this.preSelectedFolder||(this.preSelectedFolder="/"),e.skipLocation||this.initializeTree(),this.listenTo(this.model,"change:label",this._onDataSourceNameChange),this.$contentContainer.find("[name=name]").change(i.bind(this._onResourceIDInputChange,this))},restoreModel:function(){this.originalModelValidation&&(this.model.validation=this.originalModelValidation)},extendModel:function(e){return this.originalModelValidation=e.validation,e.validation=i.extend({},s.prototype.validation,{label:[{required:!0,msg:r["resource.datasource.saveDialog.validation.not.empty.label"]},{maxLength:s.settings.LABEL_MAX_LENGTH,msg:r["resource.datasource.saveDialog.validation.too.long.label"]}],name:[{required:!0,msg:r["resource.datasource.saveDialog.validation.not.empty.name"]},{maxLength:s.settings.NAME_MAX_LENGTH,msg:r["resource.datasource.saveDialog.validation.too.long.name"]},{doesNotContainSymbols:s.settings.NAME_NOT_SUPPORTED_SYMBOLS,msg:r["resource.datasource.saveDialog.validation.invalid.chars.name"]}],description:[{required:!1},{maxLength:s.settings.DESCRIPTION_MAX_LENGTH,msg:r["resource.datasource.saveDialog.validation.too.long.description"]}],parentFolderUri:[{fn:function(e){if(!this.options.skipLocation){if(i.isNull(e)||i.isUndefined(e)||i.isString(e)&&""===e)return r["resource.datasource.saveDialog.validation.not.empty.parentFolderIsEmpty"];if("/"!==e.slice(0,1))return r["resource.datasource.saveDialog.validation.folder.not.found"].replace("{0}",e)}}}]}),e},initializeTree:function(){this.foldersTree=d({processors:["folderTreeProcessor","treeNodeProcessor","i18nItemProcessor","filterPublicFolderProcessor","cssClassItemProcessor","fakeUriProcessor"],treeBufferSize:l.treeLevelLimit,types:[c.FOLDER],tooltipOptions:{}}),this.listenTo(this.foldersTree,"selection:change",function(e){var o;e&&i.isArray(e)&&e[0]&&e[0].uri&&(o=e[0].uri),o&&this.model.set("parentFolderUri",o)}),this.$el.find(".treeBox .folders").append(this.foldersTree.render().el);var e=this.foldersTree.$el.parent().parent().parent();this.foldersTree._selectTreeNode(this.preSelectedFolder,e)},startSaveDialog:function(){this._openDialog()},_openDialog:function(){this.theDialogIsOpen||(this.bindValidation(),a.prototype.open.apply(this,arguments),this.$contentContainer.find("[name=label]").focus(),this.theDialogIsOpen=!0)},_closeDialog:function(){this.theDialogIsOpen&&(this.unbindValidation(),this.clearValidationErrors(),a.prototype.close.apply(this,arguments),this.theDialogIsOpen=!1)},_getLabelForSaveButton:function(){return"resource.datasource.saveDialog.save"},_onDialogResize:function(){var e=this,o=0,t=this.$contentContainer.find(".control.groupBox.treeBox"),i=this.$contentContainer.closest(".jr-mDialog > .jr-mDialog-body");this.$contentContainer.children().not(t).each(function(){o+=e.$(this).outerHeight(!0)}),t.height(i.outerHeight(!0)-o-40)},_onDataSourceNameChange:function(){if(this.autoUpdateResourceID){var e=s.generateResourceName(this.model.get("label"));this.model.set("name",e),this.$("input[name='name']").val(e)}},_onResourceIDInputChange:function(){this.autoUpdateResourceID=!1},_onSaveDialogCancelButtonClick:function(){this.restoreModel(),this._closeDialog()},_onSaveDialogSaveButtonClick:function(){this.model.isValid(!0)&&this.performSave()},performSave:function(){if(this.options.saveFn)return void this.options.saveFn(this.model.attributes,this.model);this.model.save({},{success:i.bind(this._saveSuccessCallback,this),error:i.bind(this._saveErrorCallback,this)})},_saveSuccessCallback:function(e){this._closeDialog(),i.isFunction(this.options.success)&&this.options.success(e)},_saveErrorCallback:function(e,o,t){var s=this,a=!1,n=!1;try{a=JSON.parse(o.responseText)}catch(e){}i.isArray(a)||(a=[a]),i.each(a,function(e){var o=!1,t=!1;e&&(s.theDialogIsOpen&&("version.not.match"===e.errorCode?(o="name",t=r["resource.dataSource.resource.alreadyInUse"]):"mandatory.parameter.error"===e.errorCode?e.parameters&&e.parameters[0]&&(t=r["resource.datasource.saveDialog.parameterIsMissing"],o=e.parameters[0].substr(e.parameters[0].indexOf(".")+1)):"illegal.parameter.value.error"===e.errorCode?e.parameters&&e.parameters[0]&&(o=e.parameters[0].substr(e.parameters[0].indexOf(".")+1),t=r["resource.datasource.saveDialog.parameterIsWrong"]):"folder.not.found"===e.errorCode?(o="parentFolderUri",t=r["ReportDataSourceValidator.error.folder.not.found"].replace("{0}",e.parameters[0])):"access.denied"===e.errorCode&&(o="parentFolderUri",t=r["jsp.accessDenied.errorMsg"])),t&&o&&-1!==["label","name","description","parentFolderUri"].indexOf(o)&&(s.invalidField("[name="+o+"]",t),n=!0))}),!1===n&&i.isFunction(this.options.error)&&this.options.error(e,o,t)}})});