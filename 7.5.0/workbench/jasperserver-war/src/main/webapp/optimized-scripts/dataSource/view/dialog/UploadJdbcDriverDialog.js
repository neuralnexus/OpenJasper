define(["require","exports","module","../../view/dialog/BaseDialog","underscore","jquery","runtime_dependencies/js-sdk/src/common/transport/AjaxFormSubmitter","runtime_dependencies/js-sdk/src/components/loadingOverlay/LoadingOverlay","../../../components/components.dialogs","bundle!jasperserver_messages","text!../../template/dialog/uploadJdbcDriverDialogTemplate.htm","text!../../template/dialog/fileUploadTemplate.htm","../../../util/utils.common"],function(e,r,a){var t=e("../../view/dialog/BaseDialog"),s=e("underscore"),i=e("jquery"),n=e("runtime_dependencies/js-sdk/src/common/transport/AjaxFormSubmitter"),o=e("runtime_dependencies/js-sdk/src/components/loadingOverlay/LoadingOverlay"),l=e("../../../components/components.dialogs"),d=e("bundle!jasperserver_messages"),c=e("text!../../template/dialog/uploadJdbcDriverDialogTemplate.htm"),u=e("text!../../template/dialog/fileUploadTemplate.htm");e("../../../util/utils.common"),a.exports=t.extend({TITLE:d["resource.dataSource.jdbc.selectDriverTitle"],PRIMARY_BUTTON_LABEL:d["button.upload"],SECONDARY_BUTTON_LABEL:d["button.cancel"],events:function(){return s.extend({},t.prototype.events,{"change input[type='file']":"onFileChange"})},initialize:function(e){this.driverClass=e.driverClass,this.driverAvailable=e.driverAvailable,this.fileIndex=0,this._overlay=new o({delay:1e3}),t.prototype.initialize.apply(this,arguments),i(this.el).addClass("jr jr-uploadJdbcDriverDialog")},onFileChange:function(e){var r=i(e.target),a=r.next(".message.warning");if(a.parent().removeClass("error"),r.val().match(/.jar$/)){if(r.is(this.$("input[type='file']:last-of-type"))){var t=0,n=this.$("input[type='file']");s.each(n,function(e,r){t+=r+1}),t>=n.length&&this.addFileInput(),this.$("button.primary").removeClass("disabled").attr("disabled",null)}}else a.text(d["resource.dataSource.jdbc.upload.wrongExtension"]).parent().addClass("error")},render:function(){var e=this;return this.$(".body").html(s.template(c,{className:this.driverClass,i18n:d})),s.defer(function(){e.addFileInput(),e.driverAvailable?e.$(".warningMessageContainer").removeClass("hidden").find(".message").text(d["resource.dataSource.jdbc.upload.overwriteWarning"]):e.$(".warningMessageContainer").addClass("hidden").find(".message").text("")}),this.$("button.primary").addClass("disabled").attr("disabled","disabled"),this},onSuccessCallback:function(e){this.trigger("driverUpload",e),this.hide(),l.systemConfirm.show(d["resource.dataSource.jdbc.upload.driverUploadSuccess"]),s.defer(s.bind(this.remove,this))},onErrorCallback:function(e){var r;e=e.responseJSON?e.responseJSON:e,"illegal.parameter.value.error"===e.errorCode&&e.parameters&&e.parameters.length&&"className"===e.parameters[0]?r=d["resource.dataSource.jdbc.classNotFound"].replace("{0}",this.driverClass):e.message?r=e.message:"error.invalid.response"===(r=e.errorCode)&&(r="The required driver class ("+this.driverClass+") is not found in uploaded files"),this.$(".errorMessageContainer").addClass("error").find(".message").text(r)},addFileInput:function(){this.$("ul").append(s.template(u,{fileIndex:this.fileIndex})),this.fileIndex++},primaryButtonOnClick:function(){var e=this;this.$(".errorMessageContainer").removeClass("error").find(".message").text(""),this.$("button.primary").addClass("disabled").attr("disabled","disabled"),i("body").append(this._overlay.$el),this._overlay.show();var r=this.$("form");new n(r[0]).submit().done(function(r){r.errorCode?e.onErrorCallback(r):e.onSuccessCallback(r)}).fail(function(r){e.onErrorCallback(r)}).always(function(){e._overlay.hide(),i("body").detach(e._overlay.$el),e.$("button.primary").removeClass("disabled").attr("disabled",null)})},secondaryButtonOnClick:function(){this._overlay.hide(),i("body").detach(this._overlay.$el),this.hide(),s.defer(s.bind(this.remove,this))}})});