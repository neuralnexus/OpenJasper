define(["require","exports","module","jquery","underscore","runtime_dependencies/bi-repository/src/bi/repository/model/RepositoryResourceModel","../model/BaseDataSourceModel","bundle!jasperserver_messages","settings!userTimeZones","backbone","text!../template/timezoneTemplate.htm","../../components/components.dialogs","text!../template/testConnectionTemplate.htm","runtime_dependencies/js-sdk/src/common/extension/backboneValidationExtension"],function(e,t,n){var i,s,a=e("jquery"),o=e("underscore"),r=e("runtime_dependencies/bi-repository/src/bi/repository/model/RepositoryResourceModel"),d=e("../model/BaseDataSourceModel"),l=e("bundle!jasperserver_messages"),c=e("settings!userTimeZones"),m=e("backbone"),p=e("text!../template/timezoneTemplate.htm"),u=e("../../components/components.dialogs"),h=e("text!../template/testConnectionTemplate.htm"),f=e("runtime_dependencies/js-sdk/src/common/extension/backboneValidationExtension");n.exports=m.View.extend({PAGE_TITLE_NEW_MESSAGE_CODE:void 0,PAGE_TITLE_EDIT_MESSAGE_CODE:void 0,modelConstructor:d,events:{"keyup input[type='text'], input[type='password'], textarea, select":"updateModelProperty","change input[type='text'], input[type='password'], input[type='radio'], input[type='checkbox'], textarea, select":"updateModelProperty","click #testDataSource":"testConnection","click [name=testConnectionMessageDetails]":"showTestConnectionMessageDetails"},initialize:function(e){this.options=e,this.isEditMode=e.isEditMode,this.timezones=e.timezones?e.timezones:c;var t={};if(e.dataSource&&(t=o.extend(t,e.dataSource)),this.model=new this.modelConstructor(t,e),f.bind(this,{valid:this.fieldIsValid,invalid:this.fieldIsInvalid,forceUpdate:!0,selector:"name"}),this.model.initialization){var n=this;this.model.initialization.done(function(){n.render.apply(n)})}else this.render();this.setPageTitle()},testConnection:function(){if(!0!==i){var e,t,n=this.model.testConnection(),a=this;n&&(i=!0,t=a.$el.find("#testDataSource"),t.addClass("disabled"),e=this.$el.find("[name=testConnectionMessage]"),e.removeClass("warning success").addClass("hidden"),e.parent().addClass("error"),e.find("a").addClass("hidden"),n.done(function(){e.addClass("success").find("span").text(l["resource.dataSource.connectionState.passed"])}).fail(function(t){var n=a.getTestConnectionErrorMessage(t);e.addClass("warning").find("span").text(n.text),n.details&&(e.find("a").removeClass("hidden"),s=n.details)}).always(function(){i=!1,e.removeClass("hidden"),t.removeClass("disabled")}))}},showTestConnectionMessageDetails:function(){u.errorPopup.show(s)},getTestConnectionErrorMessage:function(e){var t=!1,n=l["resource.dataSource.connectionState.failed"],i=!1;try{t=JSON.parse(e.responseText)}catch(t){i=e.responseText}return t&&(t.parameters&&t.parameters[2]&&(n=t.parameters[2]),t.parameters&&t.parameters[3]&&(i=t.parameters[3])),{text:n,details:i}},updateModelProperty:function(e){var t=a(e.target),n={},i=t.attr("name"),s="checkbox"===t.attr("type")?t.is(":checked"):a.trim(t.val());if(n[i]=s,this.model.set(n),!this.isEditMode)if("name"===i){var o=r.generateResourceName(this.model.get("label"));s!==o&&(this._idUpdatedManually=!0)}else if("label"===i&&!this._idUpdatedManually){var d=r.generateResourceName(s);this.model.set("name",d),this.$("input[name='name']").val(d)}this.model.validate(n)},render:function(){return this.$el.empty(),this},renderTimezoneSection:function(){this.$el.append(o.template(p,this.templateData()))},renderTestConnectionSection:function(){this.$el.append(o.template(h,this.templateData()))},renderOrAddAnyBlock:function(e,t){if(o.isString(t)){try{t=a(t)}catch(e){t=!1}if(!t)return!1}var n=t.first().attr("name");return!!n&&(e.find("[name="+n+"]").length>0?e.find("[name="+n+"]").empty().append(t.children()):e.append(t),!0)},templateData:function(){return{_:o,i18n:l,modelAttributes:o.clone(this.model.attributes),timezones:this.timezones,isEditMode:this.isEditMode}},setPageTitle:function(){var e,t=a("#display .showingToolBar > .content > .header > .title");e=this.isEditMode?l[this.PAGE_TITLE_EDIT_MESSAGE_CODE]+": "+this.model.get("label"):l[this.PAGE_TITLE_NEW_MESSAGE_CODE],t.text(e)},fieldIsValid:function(e,t,n){var i=e.$("["+n+'="'+t+'"]').parent();i.removeClass("error"),i.find(".message.warning").text("")},fieldIsInvalid:function(e,t,n,i){if(!0!==n){var s=e.$("["+i+'="'+t+'"]').parent();s.addClass("error"),s.find(".message.warning").text(n)}},validField:function(e){var t=this.$(e).parent();t.removeClass("error"),t.find(".message.warning").text("")},invalidField:function(e,t){var n=this.$(e).parent();n.addClass("error"),n.find(".message.warning").text(t.toString())},remove:function(){return a("div[id^='selectFromRepository1'], div[id^='selectFromRepository2']").remove(),f.unbind(this),m.View.prototype.remove.call(this),this}})});