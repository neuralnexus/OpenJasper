define(["require","exports","module","jquery","runtime_dependencies/js-sdk/src/jrs.configs","./report.view.runtime","../core/core.ajax.utils","../namespace/namespace","../util/utils.common","../core/core.buttonManager"],function(e,r,t){function o(e,r,t){var o=new i.Deferred;return i.ajax(e.url+(e.urlParams?"?"+e.urlParams:""),{type:"POST",dataType:r,data:e.params,beforeSend:function(e){"undefined"!=typeof ajax&&ajax.csrfRequestHeaders&&ajax.csrfRequestHeaders.each(function(r){e.setRequestHeader(r.key,r.value)})},success:function(e,r,a){n(a,t)?(c&&c.hideAjaxDialog&&c.hideAjaxDialog(),o.reject(a,r)):o.resolve(e,r,a)},error:function(e,r,a){if(!n(e,t)&&e.status>=400){var s="<p>HTML response error code: "+e.status+", "+r+"</p>";if(e.responseText.indexOf('id="errorPageContent"')>=0)s+=i(e.responseText).find("#errorPageContent .body").html();else if(e.responseText.indexOf('{"result":{"msg":"')>=0){var p=JSON.parse(e.responseText);p.result.devmsg.indexOf("<#_#>")?(s="",i.each(p.result.devmsg.split("<#_#>"),function(){s+="<p>"+this+"</p>"})):s="<p>"+p.result.devmsg+"</p>"}else s+="<p>HTML response was: "+e.responseText+"</p>";var u=i("body"),l=u.hasClass("dashboardViewFrame"),m={reportUri:t,type:"responseError"};l&&window.reportFrameWidth&&window.reportFrameHeight&&(m.width=window.reportFrameWidth<parseInt(x,10)?window.reportFrameWidth-20+"px":x,m.height=window.reportFrameHeight<parseInt(v,10)?window.reportFrameHeight-20+"px":v,u.css({width:window.reportFrameWidth+"px",height:window.reportFrameHeight+"px"})),d(s,m),l&&!g()&&u.css({width:"auto",height:"auto"})}c&&c.hideAjaxDialog&&c.hideAjaxDialog(),o.reject(e,r)}}),o.promise()}function n(e,r){return e.getResponseHeader("LoginRequested")?(d("Login requested.",{reportUri:r,type:"sessionError"}),window.viewer&&window.viewer.setLocation&&window.viewer.setLocation("."),!0):e.getResponseHeader("reportError")?(d(e.responseText,{reportUri:r,type:"reportError"}),!0):!!e.getResponseHeader("JasperServerError")&&(e.getResponseHeader("reportPageNonExisting")&&d("Page does not exist",{reportUri:r,type:"reportPageNonExistingError"}),e.getResponseHeader("SuppressError")||(1==i(".dashboardViewFrame").length?(i(document.body).html(e.responseText),i("#"+m.fid,window.parent.document).removeClass("hidden").show()):(d(e.responseText,{reportUri:r,type:"JasperserverError"}),a(e.responseText)&&setTimeout(function(){var e=i("#standardAlert"),r=i(".dimmer"),t=e.find("button");r.removeClass("hidden").css("z-index",parseInt(e.css("z-index"),10)-1),t.on("click",function(){w.disable(i("#redo")[0]),window.viewer.stateStack.states.pop(),s=!0,window.viewer.reportInstance.undo(),window.viewer.reportInstance.components&&window.viewer.reportInstance.components.chart&&window.viewer.reportInstance.components.chart[0]&&(i("[data-hcname]").removeClass("selected"),i("[data-hcname='"+window.viewer.reportInstance.components.chart[0].config.charttype+"']").addClass("selected")),r.addClass("hidden"),t.off("click")})},0))),!0)}function a(e){for(var r=!1,t=0;t<c.chartTypeChangeErrorMessages.length;t++)if(e.indexOf(c.chartTypeChangeErrorMessages[t])>-1){r=!0;break}return r}var s,i=e("jquery"),p=e("runtime_dependencies/js-sdk/src/jrs.configs"),c=e("./report.view.runtime"),u=e("../core/core.ajax.utils"),d=u.showErrorPopup,l=e("../namespace/namespace"),m=l.JRS,h=e("../util/utils.common"),g=h.isIPad,w=e("../core/core.buttonManager"),f=p.contextPath,x="546px",v="350px",j={reportcontexturl:null,reportoutputurl:f+"/flow.html",reportactionurl:f+"/runReportAction.html",reportcomponentsurl:f+"/getReportComponents.html",reportpagestatusurl:f+"/viewReportPageUpdateCheck.html",cancelExecutionUrl:f+"/viewReportCancel.html",cancelAsyncExecutionUrl:f+"/viewReportAsyncCancel.html"},y=function(e){this.config={reporturi:null,async:!0},i.extend(this.config,e),this.jasperPrintName=null,this.contextid=null};y.prototype={getHtmlForPage:function(e,r,t){if(s){s=!1,c&&c.hideAjaxDialog&&c.hideAjaxDialog();var n=new i.Deferred;return n.reject(),n}var a={_flowExecutionKey:c.reportExecutionKey(this.config.reporturi),_flowId:"viewReportFlow",_eventId:r?"navigate":"refreshReport",pageIndex:e,decorate:"no",confirm:"true",decorator:"empty",ajax:"true"};return c&&c.requestedInputParameters&&(t=c.requestedInputParameters),o({url:j.reportoutputurl,urlParams:i.param(a),params:t},"html",this.config.reporturi)},cancelExecution:function(e){return o({url:e?j.cancelAsyncExecutionUrl+"?jasperPrintName="+this.jasperPrintName:j.cancelExecutionUrl+"?_flowExecutionKey="+c.reportExecutionKey(this.config.reporturi)},"json")},getStatusForPage:function(e,r){return o({url:j.reportpagestatusurl,params:{jasperPrintName:this.jasperPrintName,pageIndex:e,pageTimestamp:r}},"json")},getComponentsForPage:function(e){return o({url:j.reportcomponentsurl,params:{jasperPrintName:this.jasperPrintName||c.jasperPrintName,pageIndex:e}},"json")},runAction:function(e){var r=this;(null==e.showAjaxDialog||e.showAjaxDialog)&&c&&c.showAjaxDialog&&c.showAjaxDialog();try{return o({url:j.reportactionurl,params:{jr_ctxid:r.contextid,jr_action:JSON.stringify(e.action)}},"json",r.config.reporturi)}catch(e){alert(e)}},save:function(e){var r=e.folder&&e.name?"saveReportAs":"saveReport",t={_flowExecutionKey:c.reportExecutionKey(this.config.reporturi),_eventId:r};"saveReportAs"==r&&(t.folder=e.folder,t.name=e.name,t.description=e.description||"",t.overwrite=!!e.overwrite);try{return o({url:j.reportoutputurl,params:t},"json",this.config.reporturi)}catch(e){alert(e)}},exit:function(){var e={_flowExecutionKey:c.reportExecutionKey(),_eventId:"end"};return o({url:j.reportoutputurl,urlParams:i.param(e)},"html")},setPageUpdateStatus:function(e){this.lastPageUpdateStatus=e.result,this.config.eventManager.triggerEvent("pageUpdateAvailable")}},y.UrlManager=j,t.exports=y});