define(["require","exports","module","prototype","./report.view.base","../controls/controls.report","../controls/controls.base","../components/components.toolbarButtons.events","../util/utils.common","../namespace/namespace","../util/touch.controller","../core/core.layout","../components/components.dialogs","../core/core.ajax","../core/core.events.bis","underscore","jquery","runtime_dependencies/js-sdk/src/common/stdnav/stdnav"],function(e,t,o){var n=e("prototype"),r=n.$,a=e("./report.view.base"),s=e("../controls/controls.report"),i=e("../controls/controls.base"),l=i.ControlsBase,d=e("../components/components.toolbarButtons.events"),A=e("../util/utils.common"),c=A.matchAny,p=A.isIPad,u=A.isSupportsTouch,N=A.centerElement,_=A.addDataToForm,I=e("../namespace/namespace"),T=I.JRS,E=e("../util/touch.controller"),P=e("../core/core.layout"),h=e("../components/components.dialogs"),g=e("../core/core.ajax"),v=g.ajax,m=e("../core/core.events.bis"),C=e("underscore"),R=e("jquery"),S=e("runtime_dependencies/js-sdk/src/common/stdnav/stdnav");a.toolbarActionMap={back:"Report.goBack",ICDialog:"Controls.show",export:"doNothing",undo:"Report.undo",redo:"Report.redo",undoAll:"Report.undoAll"},R.extend(a,{initialize:function(){this.commonInit(),a.exportForm=r(a.EXPORT_ACTION_FORM),this.nothingToDisplay=r("nothingToDisplay"),r(a.DATA_REFRESH_BUTTON)&&r(a.DATA_REFRESH_BUTTON).observe("mouseup",function(){if(window.viewer.jive&&window.viewer.jive.hide(),void 0!==s){var e=s.viewModel.get("selection"),t=l.buildSelectedDataUri(e);this.refreshReport({freshData:!0},null,t?"&"+t:"")}else this.refreshReport({freshData:!0},null,"")}.bindAsEventListener(this)),r(a.ASYNC_CANCEL_BUTTON)&&r(a.ASYNC_CANCEL_BUTTON).observe("mouseup",function(){this.cancelReportAsyncExecution(!0)}.bindAsEventListener(this)),d.ACTION_MODEL_TAG=a.TOOLBAR_SUBMENU,d.initialize(a.toolbarActionMap),r(a.PAGINATION_PAGE_CURRENT)&&(r(a.PAGINATION_PAGE_CURRENT).observe("change",function(e){this.goToPage(r(a.PAGINATION_PAGE_CURRENT).getValue()),e.stop()}.bindAsEventListener(this)),R(".toolsRight")[0].observe("click",function(e){var t=e.element();e.stop();for(var o in this.pageActions)if(c(t,[o],!0))return void this.navigateToReportPage(this.pageActions[o])}.bindAsEventListener(this))),document.location.href.indexOf("noReturn=true")>0&&m.disable(r("back")),void 0!==s?s.initialize.bind(s)(a.refreshReport):a.refreshReport()},reportRefreshed:function(e){var t,o;if(void 0!==T&&T.fid){t=R("#"+T.fid,window.parent.document),o=t.contents().find("#reportContainer"),t.removeClass(P.HIDDEN_CLASS).show(),p()||t.parent().parent().css("background-image","none");o.height(),o.width();u()&&(new E(o.get(0),t.get(0).parentNode.parentNode,{use2Fingers:!0,showBorders:!0,noInit3d:!0}),o.children("div").bind({touchstart:function(){t.parent().parent().siblings().removeClass(P.HOVERED_CLASS),t.parent().parent().addClass(P.HOVERED_CLASS)}})),o.show(),window.reportFrameHeight=window.reportFrameHeight||t.parent().height(),window.reportFrameWidth=window.reportFrameWidth||t.parent().width()}else{var n=r(l.INPUT_CONTROLS_FORM);if(u()){if(this.touchController)this.touchController.reset();else{var s=R("#reportContainer").parent().parent(),i=R("#reportContainer > div").width();s.width()<i&&s.css("width",i+"px"),this.touchController=new E(s[0],s.parent()[0],{noInit3d:!0,scrollbars:!0})}var d=R("#"+l.INPUT_CONTROLS_FORM+" > button.minimize");if(n&&d&&d.is(":visible")){var A=n.hasClassName("minimized");P.maximize(n),A&&P.minimize(n)}}R("#reportContainer").show().height()}R("#reportContainer").parents(".body").slice(0,1).scrollTop(0),a.nothingToDisplay&&(a.nothingToDisplay.addClassName(P.HIDDEN_CLASS),R("#"+a.DATA_REFRESH_BUTTON).removeAttr(P.DISABLED_ATTR_NAME));var c=R("#paginationIndexHolder"),_=R("#emptyReportMessageHolder");if(c.length>0){var I=c.attr("data-lastPageIndex");R("#emptyReportID").addClass(P.HIDDEN_CLASS),"0"===I?R(".control.paging").addClass(P.HIDDEN_CLASS).prev(".divider").addClass(P.HIDDEN_CLASS):R(".control.paging").removeClass(P.HIDDEN_CLASS).prev(".divider").removeClass(P.HIDDEN_CLASS)}if(_&&_.length>0){var g=_.html();R(".control.paging").addClass(P.HIDDEN_CLASS).prev(".divider").addClass(P.HIDDEN_CLASS),R(R("#emptyReportID p.message")[1]).html(g),R("#emptyReportID").removeClass(P.HIDDEN_CLASS),N(R("#emptyReportID"),{horz:!0,vert:!0})}a.refreshPagination(e),a.refreshExporters(),a.refreshSave(),a.refreshAsyncCancel(),this.dataTimestampMessage&&r(a.DATA_TIMESTAMP_SPAN)&&r(a.DATA_TIMESTAMP_SPAN).update(this.dataTimestampMessage),a.allRequestParameters.viewAsDashboardFrame?R("#innerPagination").css("margin","none"):R("#innerPagination").css("margin",0),h.popup.hideShared(r(v.LOADING_ID),a.REPORT_COMPONENT_ID)}}),R.extend(a,{refreshExporters:function(){m[null!=this.lastPageIndex?"enable":"disable"](r("export"))},refreshSave:function(){},refreshPagination:function(e){var t=window.viewer.reportInstance.currentpage,o=window.viewer.reportInstance.status.totalPages;if(this.emptyReport||null!=o&&o<=0)return m.disable(r(a.PAGINATION_PAGE_FIRST)),m.disable(r(a.PAGINATION_PAGE_PREV)),m.disable(r(a.PAGINATION_PAGE_CURRENT)),m.disable(r(a.PAGINATION_PAGE_NEXT)),m.disable(r(a.PAGINATION_PAGE_LAST)),void(r(a.PAGINATION_PAGE_CURRENT)&&(r(a.PAGINATION_PAGE_CURRENT).setValue(""),r(a.PAGINATION_PAGE_TOTAL).update("")));t>0?(m.enable(r(a.PAGINATION_PAGE_FIRST)),m.enable(r(a.PAGINATION_PAGE_PREV))):(m.disable(r(a.PAGINATION_PAGE_FIRST)),m.disable(r(a.PAGINATION_PAGE_PREV))),null==o?(null==this.lastPartialPageIndex||t<this.lastPartialPageIndex?m.enable(r(a.PAGINATION_PAGE_NEXT)):m.disable(r(a.PAGINATION_PAGE_NEXT)),m.disable(r(a.PAGINATION_PAGE_LAST))):t+1<o?(m.enable(r(a.PAGINATION_PAGE_NEXT)),m.enable(r(a.PAGINATION_PAGE_LAST))):(m.disable(r(a.PAGINATION_PAGE_NEXT)),m.disable(r(a.PAGINATION_PAGE_LAST))),m.enable(r(a.PAGINATION_PAGE_CURRENT)),r(a.PAGINATION_PAGE_CURRENT)&&(e||r(a.PAGINATION_PAGE_CURRENT).setValue(t+1),null==o?r(a.PAGINATION_PAGE_TOTAL).update(""):r(a.PAGINATION_PAGE_TOTAL).update(this.getMessage("jasper.report.view.page.of")+o)),this.pageActions={"button#page_first":0,"button#page_prev":t-1,"button#page_next":t+1},null!=window.viewer.reportInstance.status.totalPages&&(this.pageActions["button#page_last"]=o-1);var n=R(".toolsRight .paging.subfocus").find("button");n.length&&n.is(":disabled")?n.is("#"+a.PAGINATION_PAGE_LAST)?S.forceFocus(".toolsRight li.page_first"):n.is("#"+a.PAGINATION_PAGE_FIRST)?S.forceFocus(".toolsRight li.page_last"):n.is("#"+a.PAGINATION_PAGE_NEXT)?S.forceFocus(".toolsRight li.page_prev"):n.is("#"+a.PAGINATION_PAGE_PREV)?S.forceFocus(".toolsRight li.page_next"):n.closest("ul").focus():n.addClass(P.HOVERED_CLASS)},refreshAsyncCancel:function(e){var t=window.viewer.reportInstance.status;r(a.ASYNC_CANCEL_BUTTON)&&(e?(r("asyncIndicator").addClassName(P.HIDDEN_CLASS),m.disable(a.ASYNC_CANCEL_BUTTON),r(a.DATA_REFRESH_BUTTON).removeClassName(P.HIDDEN_CLASS)):t.jasperPrintName&&"running"==t.reportStatus&&null==t.totalPages?(m.enable(a.ASYNC_CANCEL_BUTTON),r("asyncIndicator").removeClassName(P.HIDDEN_CLASS),r(a.DATA_REFRESH_BUTTON).addClassName(P.HIDDEN_CLASS)):(r("asyncIndicator").addClassName(P.HIDDEN_CLASS),m.disable(a.ASYNC_CANCEL_BUTTON),r(a.DATA_REFRESH_BUTTON).removeClassName(P.HIDDEN_CLASS)))}}),R.extend(a,{exportReport:function(e,t){var o,n,r,i,l=a.exportForm;R(l).empty(),l.method="post",l.target="_blank",o=l.action,i=function(){l.target="_self",l.action=o},n={_eventId:"export",_flowExecutionKey:a.reportExecutionKey(),output:""+e};var d=s.getLastSelection();r=C.extend(n,d),_(l,r),t&&(l.action=t),l.submit(),setTimeout(i,500)},goBack:function(){if(a.confirmExit()){var e=a.getAllRequestParameters();m.disable(r("back")),e._ddHyperlink?window.history.back():(a.exportForm._eventId.value="close",a.exportForm._flowExecutionKey.value=a.reportExecutionKey(),a.exportForm.submit())}},open:function(){alert("Not implemented yet: open report")},save:function(){alert("Report saving is not available in community edition")},saveAs:function(){alert("Report saving is not available in community edition")},undo:function(){window.viewer.reportInstance.undo()},redo:function(){window.viewer.reportInstance.redo()},undoAll:function(){window.viewer.reportInstance.undoAll()},cancelReportAsyncExecution:function(e){window.viewer.reportInstance.status.jasperPrintName&&(m.disable(r(a.ASYNC_CANCEL_BUTTON)),window.viewer.reportInstance.cancelExecution(e).then(function(e,t,o){var n=e.result.status;if("finished"!=window.viewer.reportInstance.status.reportStatus&&null==window.viewer.reportInstance.status.totalPages)return e.result.lastPartialPageIndex&&(a.lastPartialPageIndex=e.result.lastPartialPageIndex),"error"==n?void alert("Report execution error: "+e.result.errorMessage):"canceled"==n?(a.refreshAsyncCancel(!0),void h.systemConfirm.show(a.getMessage("jasper.report.view.report.canceled"),5e3)):(e.result.lastPageIndex&&(a.lastPageIndex=e.result.lastPageIndex,window.viewer.reportInstance.status.totalPages=a.lastPageIndex+1),e.result.snapshotSaveStatus&&(a.snapshotSaveStatus=e.result.snapshotSaveStatus),window.viewer.reportInstance.status.reportStatus=n,a.refreshPagination(!0),a.refreshExporters(),a.refreshSave(),a.refreshAsyncCancel(),void 0)},function(e){e.getResponseHeader("lastPartialPageIndex")&&(a.lastPartialPageIndex=e.getResponseHeader("lastPartialPageIndex")),a.refreshPagination(!0)}))}}),o.exports=a});