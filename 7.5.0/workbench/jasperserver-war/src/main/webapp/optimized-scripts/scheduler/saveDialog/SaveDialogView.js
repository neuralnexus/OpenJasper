define(["require","exports","module","underscore","bundle!all","runtime_dependencies/bi-repository/src/bi/repository/model/RepositoryResourceModel","runtime_dependencies/js-sdk/src/common/component/dialog/DialogWithModelInputValidation","text!./template/saveDialogTemplate.htm"],function(e,i,o){var t=e("underscore"),n=e("bundle!all"),a=e("runtime_dependencies/bi-repository/src/bi/repository/model/RepositoryResourceModel"),l=e("runtime_dependencies/js-sdk/src/common/component/dialog/DialogWithModelInputValidation"),s=e("text!./template/saveDialogTemplate.htm"),r={};o.exports=l.extend({theDialogIsOpen:!1,saveDialogTemplate:s,constructor:function(e){e||(e={}),r=t.extend({},e);var i=this.extendModel(e.model),o=this._getLabelForSaveButton(i);l.prototype.constructor.call(this,{skipLocation:!!r.skipLocation,modal:!0,model:i,resizable:!0,additionalCssClasses:"schedulerSaveDialog jr-uWidth-425px jr-uHeight-275px",title:n["report.scheduling.saveDialog.save"],content:t.template(this.saveDialogTemplate,{i18n:n,model:t.extend({},i.attributes),skipLocation:!!r.skipLocation,isEmbedded:r.isEmbedded,isEditMode:r.isEditMode}),buttons:[{label:n[o],action:"save",primary:!0},{label:n["report.scheduling.saveDialog.cancel"],action:"cancel",primary:!1}]}),this.on("button:save",t.bind(this._onSaveDialogSaveButtonClick,this)),this.on("button:cancel",t.bind(this._onSaveDialogCancelButtonClick,this))},initialize:function(){l.prototype.initialize.apply(this,arguments)},restoreModel:function(){this.originalModelValidation&&(this.model.validation=this.originalModelValidation)},extendModel:function(e){return this.originalModelValidation=e.validation,e.validation=t.extend({},a.prototype.validation,{name:null,parentFolderUri:null,label:[{required:!0,msg:n["report.scheduling.saveDialog.validation.not.empty.label"]},{maxLength:a.LABEL_MAX_LENGTH,msg:n["report.scheduling.saveDialog.validation.too.long.label"]}],description:[{required:!1},{maxLength:a.DESCRIPTION_MAX_LENGTH,msg:n["report.scheduling.saveDialog.validation.too.long.description"]}]}),e},startSaveDialog:function(){this._openDialog()},closeDialog:function(){this.restoreModel(),this._closeDialog()},_openDialog:function(){this.theDialogIsOpen||(this.bindValidation(),l.prototype.open.apply(this,arguments),this.$contentContainer.find("[name=label]").focus(),this.theDialogIsOpen=!0)},_closeDialog:function(){this.theDialogIsOpen&&(this.unbindValidation(),this.clearValidationErrors(),l.prototype.close.apply(this,arguments),this.theDialogIsOpen=!1)},_getLabelForSaveButton:function(){return"report.scheduling.saveDialog.save"},_onDialogResize:function(){var e=this,i=0,o=this.$contentContainer.find("textarea"),t=this.$contentContainer.closest(".jr-mDialog > .jr-mDialog-body");this.$contentContainer.children().not(o).each(function(){i+=e.$(this).outerHeight(!0)}),o.height(t.outerHeight(!0)-i-60)},_onSaveDialogCancelButtonClick:function(){this.restoreModel(),this._closeDialog()},_onSaveDialogSaveButtonClick:function(){this.model.isValid(!0)&&this.performSave()},performSave:function(){var e=this;this.model.checkSaveValidation({editMode:r.isEditMode}).done(function(){e.model.save({},{success:t.bind(e._saveSuccessCallback,e),error:t.bind(e._saveErrorCallback,e)})}).fail(function(){e.trigger("saveValidationFailed")})},_saveSuccessCallback:function(e,i){this._closeDialog(),t.isFunction(r.onSaveDone)&&r.onSaveDone()},_saveErrorCallback:function(e,i,o){var a=this,l=!1,s=!1;try{l=JSON.parse(i.responseText)}catch(e){}l.error&&(l=l.error),t.isArray(l)||(l=[l]),t.each(l,function(e){if("label"===e.field){var i="";"error.not.empty"===e.errorCode&&(i=n["error.not.empty.label"]),"version.not.match"===e.errorCode&&(i=n["report.scheduling.resource.exists"]),"mandatory.parameter.error"===e.errorCode&&(i=n["report.scheduling.saveDialog.parameterIsMissing"]),""!==i&&(a.invalidField("[name=label]",i),s=!0)}}),!1===s&&t.isFunction(r.onSaveFail)&&r.onSaveFail(e,i,o)}})});