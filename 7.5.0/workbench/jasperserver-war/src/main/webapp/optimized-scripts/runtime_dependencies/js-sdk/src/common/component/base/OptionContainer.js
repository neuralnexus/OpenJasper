define(["require","exports","module","backbone","underscore","./OptionView"],function(t,e,o){function i(t){if(!t||s.isEmpty(t))throw new Error("Init options must be specified");if(!t.options||!t.options.length)throw new Error("Option views descriptors must be specified");if(!t.mainTemplate&&!t.el)throw new Error("Option container must have a template");if(!t.optionTemplate)throw new Error("Option container must have an option template")}var n=t("backbone"),s=t("underscore"),c=t("./OptionView");o.exports=n.View.extend({events:{mouseout:"_mouseout",mouseover:"_mouseover"},el:function(){return s.template(this.template)()},constructor:function(t){i(t),this.contextName=t.contextName||"option",this.contentContainer=t.contentContainer?t.contentContainer:t.el||".content > ul",this.toggle=!!t.toggle,this.toggleClass=t.toggleClass||"active",this.options=[],this.collection=t.collection||new n.Collection,delete t.collection,t.options&&this.collection.reset(t.options),this.hasGroups=!(!this.collection.models[0]||!this.collection.models[0].get("groupId")),this.defalutOptionView=this.hasGroups?this.collection.where({default:!0}):[this.collection.findWhere({default:!0})],this.listenTo(this.collection,"select",this._selectOption),this.listenTo(this.collection,"update reset",this.render),this.template=t.mainTemplate,this.optionTemplate=t.optionTemplate,n.View.apply(this,arguments)},_mouseout:function(){this.trigger("container:mouseout")},_mouseover:function(){this.trigger("container:mouseover")},setElement:function(t){var e=n.View.prototype.setElement.apply(this,arguments);return this.$contentContainer=this.contentContainer?this.$(this.contentContainer).addBack().filter(this.contentContainer):this.$el,e},initialize:function(){this.render(),this.toggle&&this.defalutOptionView&&s.each(this.defalutOptionView,function(t){t&&this.getOptionView(t.get("action")).addSelection()},this)},render:function(){var t=this;s.each(this.options,function(e){t.stopListening(e,"mouseover"),t.stopListening(e,"mouseout"),e.remove()}),this.options=[],this.collection.forEach(function(e){var o=new c({template:t.optionTemplate,model:e,toggleClass:t.toggleClass});t.listenTo(o,"mouseover",function(e,o){t.trigger("mouseover",e,t,o)}),t.listenTo(o,"mouseout",function(e,o){t.trigger("mouseout",e,t,o)}),t.options.push(o),t.$contentContainer.append(o.$el)})},_onKeyDown:function(t){var e=this.getOptionView(t.keyCode,"triggerOnKeyCode");e&&!e.isDisabled()&&e.select()},_selectOption:function(t,e){if(this.toggle){var o=e.get("groupId"),i=this.hasGroups?s.reduce(this.options,function(t,e){return e.model.get("groupId")===o&&t.push(e),t},[]):this.options;s.each(i,function(t){t.removeSelection()},this),t.addSelection()}this.trigger("selection",t,e),this.trigger(this.contextName+":"+e.get("action"),t,e)},getOptionView:function(t,e){return s.find(this.options,function(o){return o.model.get(e||"action")===t})},resetSelection:function(t,e){t=t||[],this.toggle&&(this.hasGroups?(t.length<this.defalutOptionView.length&&s.each(this.defalutOptionView,function(e){var o={groupId:e.get("groupId")};!s.findWhere(t,o)&&e&&t.push(s.extend(o,{action:e.get("action")}))}),t=s.pluck(t,"action")):!t.length&&this.defalutOptionView[0]&&t.push(this.defalutOptionView[0].get("action")),s.each(this.options,function(o){t.length&&s.contains(t,o.model.get("action"))?e?this._selectOption(o,o.model):o.addSelection():o.removeSelection()},this))},select:function(){var t=Array.prototype.slice.call(arguments,0);this.toggle&&s.each(this.options,function(e){!t.length||s.contains(t,e.model.get("action"))?e.addSelection():e.removeSelection()},this)},deselect:function(){var t=Array.prototype.slice.call(arguments,0);this.toggle&&s.each(this.options,function(e){(!t.length||s.contains(t,e.model.get("action")))&&e.removeSelection()},this)},getSelection:function(){return s.chain(this.options).filter(function(t){return t.model.get("selected")}).map(function(t){return t.model.get("action")}).value()},show:function(){return s.each(this.options,function(t){var e=t.model.get("test");e&&!e()?t.hide():t[t.model.get("hidden")?"hide":"show"]()}),this.$el.show(),this.trigger("show",this),this},hide:function(){return this.$el.hide(),this.trigger("hide",this),this},enable:function(t){var e=Array.prototype.slice.call(arguments);s.each(this.options,function(t){(!e.length||s.contains(e,t.model.get("action")))&&t.enable()})},disable:function(t){var e=Array.prototype.slice.call(arguments);s.each(this.options,function(t){(!e.length||s.contains(e,t.model.get("action")))&&t.disable()})},addOptions:function(t,e){this.collection.add(t,s.extend(e||{},{silent:!0})),this.collection.reset(this.collection.toJSON())},removeOptions:function(t){var e=this.collection.filter(function(e){return!s.contains(t,e.get("action"))});e.length<this.collection.length&&this.collection.reset(e)},remove:function(){s.invoke(this.options,"remove"),n.View.prototype.remove.apply(this,arguments)}})});