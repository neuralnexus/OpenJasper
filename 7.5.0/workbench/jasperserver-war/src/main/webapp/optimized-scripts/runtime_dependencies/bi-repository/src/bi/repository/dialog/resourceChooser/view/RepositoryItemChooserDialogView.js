define(["require","exports","module","underscore","jquery","bundle!all","runtime_dependencies/js-sdk/src/jrs.configs","runtime_dependencies/js-sdk/src/common/component/dialog/Dialog","runtime_dependencies/js-sdk/src/common/component/dialog/AlertDialog","runtime_dependencies/js-sdk/src/common/component/tree/Tree","runtime_dependencies/js-sdk/src/common/component/tree/TreeDataLayer","runtime_dependencies/js-sdk/src/common/component/panel/trait/tabbedPanelTrait","runtime_dependencies/js-sdk/src/common/component/tree/plugin/SearchPlugin","runtime_dependencies/js-sdk/src/common/component/tree/plugin/TooltipPlugin","runtime_dependencies/js-sdk/src/common/component/tree/plugin/InfiniteScrollPlugin","runtime_dependencies/js-sdk/src/common/component/tree/plugin/NoSearchResultsMessagePlugin","../../../enum/repositoryResourceTypes","../../../util/resourcesTreeGetDataUriFnUtil","../../../util/extractRootLevelDataFromHtmlResponse","runtime_dependencies/js-sdk/src/common/util/browserDetection","text!../template/itemDialog/resourceDialogTemplate.htm","text!../template/itemDialog/sidebarTreeLeafTemplate.htm","text!../template/itemDialog/tabPanelButtonTemplate.htm","text!../template/itemDialog/treeTooltipTemplate.htm"],function(e,t,s){function i(e){switch(e.value.resourceType){case _.REPORT_UNIT:e.cssClass="report";break;case _.DOMAIN_TOPIC:e.cssClass="domain topic";break;case _.SEMANTIC_LAYER_DATA_SOURCE:e.cssClass="domain";break;case _.ADHOC_DATA_VIEW:e.cssClass="adhocDataView";break;case _.OLAP_CUBE:e.cssClass="olap";break;default:e.cssClass="adhocDataView"}return e}var o=e("underscore"),r=e("jquery"),n=e("bundle!all"),l=e("runtime_dependencies/js-sdk/src/jrs.configs"),c=e("runtime_dependencies/js-sdk/src/common/component/dialog/Dialog"),a=e("runtime_dependencies/js-sdk/src/common/component/dialog/AlertDialog"),u=e("runtime_dependencies/js-sdk/src/common/component/tree/Tree"),h=e("runtime_dependencies/js-sdk/src/common/component/tree/TreeDataLayer"),d=e("runtime_dependencies/js-sdk/src/common/component/panel/trait/tabbedPanelTrait"),p=e("runtime_dependencies/js-sdk/src/common/component/tree/plugin/SearchPlugin"),m=e("runtime_dependencies/js-sdk/src/common/component/tree/plugin/TooltipPlugin"),T=e("runtime_dependencies/js-sdk/src/common/component/tree/plugin/InfiniteScrollPlugin"),g=e("runtime_dependencies/js-sdk/src/common/component/tree/plugin/NoSearchResultsMessagePlugin"),_=e("../../../enum/repositoryResourceTypes"),f=e("../../../util/resourcesTreeGetDataUriFnUtil"),b=e("../../../util/extractRootLevelDataFromHtmlResponse"),D=e("runtime_dependencies/js-sdk/src/common/util/browserDetection"),y=e("text!../template/itemDialog/resourceDialogTemplate.htm"),C=e("text!../template/itemDialog/sidebarTreeLeafTemplate.htm"),R=e("text!../template/itemDialog/tabPanelButtonTemplate.htm"),v=e("text!../template/itemDialog/treeTooltipTemplate.htm"),S=l.contextPath,w=!1,L=S+"/flow.html?_flowId=searchFlow&method=getNode&provider=repositoryExplorerTreeFoldersProvider&uri=/&depth=1";s.exports=c.extend({constructor:function(e){e||(e={}),this.options=e,!0===this.options.disableListTab&&(w=!0),this.options.resourcesTypeToSelect&&this.options.resourcesTypeToSelect.length||(this.options.resourcesTypeToSelect=[_.REPORT_UNIT]),this.options.resourcesTypeToSelectTree&&this.options.resourcesTypeToSelectTree.length||(this.options.resourcesTypeToSelectTree=this.options.resourcesTypeToSelect),this._dfdRenderSerachFormTo=r.Deferred();var t={treeNodeProcessor:{processItem:function(e){return e._node=o.contains([_.FOLDER],e.value.resourceType),e}},filterPublicFolderProcessor:{processItem:function(e){if("/public"!==e.value.uri)return e}},filterTempFolderProcessor:{processItem:function(e){if(-1===e.value.uri.indexOf("/temp"))return e}},filterEmptyFoldersProcessor:{processItem:function(e){if("folder"!==e.value.resourceType||""!==e.value._links.content)return e}},cssClassItemProcessor:{processItem:e.cssClassItemProcessor||i}};this.resourcesTreeView=u.use(T).use(m,{i18n:n,attachTo:this.$el,contentTemplate:v}).create().instance({type:"tree",itemsTemplate:C,listItemHeight:22,selection:{allowed:!0,multiple:!1},rootless:!0,collapsed:!0,lazyLoad:!0,bufferSize:e.treeBufferSize||5e3,additionalCssClasses:"folders",getDataUri:f({getFolderUri:function(e){return"/root"===e?"":e},contextPath:S,recursive:!1,type:this.options.resourcesTypeToSelectTree,containerType:_.FOLDER,forceTotalCount:!0,forceFullPage:!0}),levelDataId:"uri",customDataLayers:{"/":o.extend(new h({dataUriTemplate:L,processors:o.chain(t).omit("filterPublicFolderProcessor").values().value(),getDataArray:function(e){e=b(e);var t=[{id:"/root",label:e.label,uri:"/",resourceType:"folder",_links:{content:"@fakeContentLink"}}];if(l.isProVersion){var s=o.find(e.children,function(e){return"/public"===e.uri});s&&t.push({id:"/public",label:s.label,uri:"/public",resourceType:"folder",_links:{content:"@fakeContentLink"}})}return t}}),{accept:"text/html",dataType:"text"})},processors:o.values(t),getDataArray:function(e,t,s){return e&&e[_.RESOURCE_LOOKUP]?e[_.RESOURCE_LOOKUP]:[]},getDataSize:function(e,t,s){return+s.getResponseHeader("Total-Count")}}),this.resourcesListView=u.use(g).use(m,{i18n:n,attachTo:this.$el,contentTemplate:v}).use(p,{dfdRenderTo:this._dfdRenderSerachFormTo}).create().instance({type:"list",rootLevelHeight:o.bind(this._getContentHeight,this),itemsTemplate:C,listItemHeight:22,selection:{allowed:!0,multiple:!1},rootless:!0,collapsed:!0,lazyLoad:!0,getDataUri:f({getFolderUri:function(e){return"/root"===e?"":e},contextPath:S,recursive:!0,type:this.options.resourcesTypeToSelect,forceTotalCount:!0,forceFullPage:!0}),levelDataId:"uri",cache:{searchKey:"searchString",pageSize:100},processors:[t.cssClassItemProcessor,t.filterTempFolderProcessor],getDataArray:function(e,t,s){return e&&e[_.RESOURCE_LOOKUP]?e[_.RESOURCE_LOOKUP]:[]},getDataSize:function(e,t,s){return+s.getResponseHeader("Total-Count")}}),c.prototype.constructor.call(this,{template:y,modal:!0,resizable:!0,minWidth:400,minHeight:400,additionalCssClasses:"sourceDialogNew"+(w?" listDisabled":""),title:e.title||n["Repository.ItemSelectDialog.dialogTitle"],traits:[d],tabHeaderContainerSelector:".tabHeaderContainer",tabContainerClass:"tabContainer control groupBox treeBox",optionTemplate:R,toggleClass:"down",tabs:[{label:n["Repository.ItemSelectDialog.foldersTab"],action:"tree",content:this.resourcesTreeView,exposeAction:!0,additionalCssClasses:"action square small",i18n:n},{label:n["Repository.ItemSelectDialog.listTab"],action:"list",content:this.resourcesListView,exposeAction:!0,additionalCssClasses:"action square small",i18n:n}],buttons:[{label:n["Repository.ItemSelectDialog.okButton"],action:"apply",primary:!0},{label:n["Repository.ItemSelectDialog.cancelButton"],action:"cancel",primary:!1}]})},initialize:function(e){this.listenTo(this.resourcesTreeView,"selection:change",this._selectionListener),this.listenTo(this.resourcesTreeView,"levelRenderError",this._onLevelRenderError),this.listenTo(this.resourcesTreeView,"item:dblclick",this._onOkButtonClick),this.listenTo(this.resourcesListView,"selection:change",this._selectionListener),this.listenTo(this.resourcesListView,"levelRenderError",this._onLevelRenderError),this.listenTo(this.resourcesListView,"item:dblclick",this._onOkButtonClick),this.listenTo(this.resourcesListView.searchForm,"search",this._onSearch),this.listenTo(this.resourcesListView.searchForm,"clear",this._resetTreeAndList),this.listenTo(this,"button:apply",o.bind(this._onOkButtonClick,this)),this.listenTo(this,"button:cancel",o.bind(this._onCancelButtonClick,this)),this.listenTo(this,"tab:tree tab:list",this._tabChangedEvent),c.prototype.initialize.apply(this,arguments),this._haveBeenOpened=!1,this._isOpened=!1,this.selectedResource=null,this._lastSelectedResource=null},events:{resize:"_onResize"},render:function(){return c.prototype.render.apply(this,arguments),this._dfdRenderSerachFormTo.resolve(this.$tabHeaderContainer),this},open:function(){this._openDialog()},close:function(){this._closeDialog()},remove:function(){this._closeDialog(),this.resourcesTreeView.remove(),this.resourcesListView.remove(),c.prototype.remove.apply(this,arguments)},setDefaultSelectedItem:function(e){this._defaultSelectedItem=e},_onOkButtonClick:function(){this.selectedResource&&(this._closeDialog(),this.trigger("item:select",this.selectedResource),this._lastSelectedResource=this.selectedResource)},_onCancelButtonClick:function(){this.selectedResource=null,this._lastSelectedResource&&(this.selectedResource=this._lastSelectedResource),this._closeDialog()},_openDialog:function(){if(!this._isOpened){var e=this;this._resizableContainerShiftHeight=6-(w?40:0),!1===this._haveBeenOpened?(this._initialDialogWidth=this.$el.css("width"),this._initialDialogHeight=this.$el.css("height"),this._haveBeenOpened=!0):this.$el.css({width:this._initialDialogWidth,height:this._initialDialogHeight}),c.prototype.open.apply(this,arguments);var t=o.bind(function(){this.$contentContainer.find(".tabContainer").css({height:"inherit","overflow-y":"auto"})},this);D.isIE8()||D.isIE9()?setTimeout(t,1):t(),this.$el.children().not(".subcontainer").not(".ui-resizable-e").not(".ui-resizable-se").each(function(){e._resizableContainerShiftHeight+=e.$(this).outerHeight(!0)}),this.$contentContainer.height(this.$el.height()-this._resizableContainerShiftHeight),this.resourcesListView.searchForm.clearSilently(),this._resetTreeAndList(),this.disableButton("apply"),this.resourcesTreeView._onceVisible=new r.Deferred,this.resourcesListView._onceVisible=new r.Deferred,this._preselectItem(),this._openTab(w?"tree":"list"),this._isOpened=!0}},_closeDialog:function(){this._isOpened&&(this.resourcesTreeView._onceVisible.reject(),this.resourcesListView._onceVisible.reject(),c.prototype.close.apply(this,arguments),this._isOpened=!1)},_selectionListener:function(e){var t=Object.keys(e),s=e&&(o.isArray(e)||o.isObject(e))&&e[t[0]],i=s?s.uri:void 0,r=s?s.resourceType:void 0;return s||i||r?(r===_.FOLDER?this.$(".itemDescription").empty():this.$(".itemDescription").text(s.description||""),o.contains(o.union([_.FOLDER]),r)?(this.selectedResource=null,void this.disableButton("apply")):(this.selectedResource={resourceUri:i,event:this._getAdHocFlowEvent(r)},void this.enableButton("apply"))):(this.disableButton("apply"),void this.$(".itemDescription").empty())},_resetTreeAndList:function(){this.resourcesTreeView.collapse("/root",{silent:!0}),this.resourcesTreeView.collapse("/public",{silent:!0}),this.resourcesTreeView.resetSelection(),this.resourcesListView.resetSelection(),this.$(".itemDescription").empty()},_preselectItem:function(){var e=!1;if(this._lastSelectedResource?e=this._lastSelectedResource.resourceUri:this._defaultSelectedItem&&(e=this._defaultSelectedItem),e){var t=this.resourcesTreeView.$el.parent();this.resourcesTreeView._onceVisible.done(o.bind(function(){this.resourcesTreeView._selectTreeNode(e,t)},this));r(this.resourcesListView.$el.find("div.subcontainer")[0]);this.resourcesListView._onceVisible.done(o.bind(function(){},this))}},_onResize:function(){this.$contentContainer.height(this.$el.height()-this._resizableContainerShiftHeight),this.resourcesListView.rootLevel.list.$el.height(this.$el.height()-this._resizableContainerShiftHeight-6),this.resourcesTreeView.rootLevel.list.$el.css("height","100%")},_getContentHeight:function(){return this.$el.height()-this._resizableContainerShiftHeight-6},_onSearch:function(){this._openTab("list"),this.disableButton("apply")},_tabChangedEvent:function(){"tree"===this.selectedTab?this.resourcesTreeView._onceVisible.resolve():"list"===this.selectedTab&&this.resourcesListView._onceVisible.resolve()},_openTab:function(e){this.openTab.apply(this,arguments)},_getAdHocFlowEvent:function(e){var t="";return e==_.REPORT_UNIT||e==_.DOMAIN_TOPIC?t="startAdHocWithTopic":e==_.SEMANTIC_LAYER_DATA_SOURCE&&(t="startQueryBuilder"),t},_getErrorDialog:function(){return this.errorDialog?this.errorDialog:this.errorDialog=new a},_onLevelRenderError:function(e,t,s){t=JSON.parse(t);var i=this._getErrorDialog();i.setMessage(t.parameters[0].substring(t.parameters[0].indexOf(": ")+2,t.parameters[0].indexOf("\n"))),i.open(),s.$el.removeClass(s.loadingClass).addClass(s.openClass)}})});