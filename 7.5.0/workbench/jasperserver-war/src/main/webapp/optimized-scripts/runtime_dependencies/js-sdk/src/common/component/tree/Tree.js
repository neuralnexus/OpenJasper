define(["require","exports","module","jquery","underscore","backbone","./TreeLevel","./TreeDataLayer","text!./template/treeLevelListTemplate.htm","text!./template/treeLevelTemplate.htm"],function(e,t,i){function s(e){var t=e.list.model.get("items"),i=this;t=o.where(t,{_node:!0}),e.$(".node").each(function(n,r){var a=t[n].id;e.items[a]?e.items[a].setElement(r):(e.items[a]=new l(o.extend({},i._options,{el:r,item:t[n],parent:e})),i.listenTo(e.items[a],"listRenderError",o.bind(function(e,t,i){this.trigger("levelRenderError",e,t,i)},i)),e.listenTo(e.items[a],"ready",o.bind(s,i)),e.listenTo(e.items[a],"selection:change",function(t,i,s){i&&s.push(i),e.list.model.clearSelection(),e.trigger("selection:change",t,e,s)}),e.listenTo(e.items[a],"item:dblclick",function(t){e.list.model.clearSelection(),e.trigger("item:dblclick",t)}),e.items[a].render())}).length&&e.$(".j-view-port-chunk").css({height:"auto"})}var n=e("jquery"),o=e("underscore"),r=e("backbone"),l=e("./TreeLevel"),a=e("./TreeDataLayer"),h=e("text!./template/treeLevelListTemplate.htm"),d=e("text!./template/treeLevelTemplate.htm"),c={ADD:"add",UPDATE:"update"},u=r.View.extend({template:o.template(d),_plugins:[],el:function(){return this.template()},constructor:function(e){e||(e={}),this.defaultDataLayer=new a(e),this.customDataLayers=e.customDataLayers,e.type?(this._type=e.type,e.type=void 0):this._type="tree",e.collapserSelector||(e.collapserSelector="b.icon:eq(0)"),e.predefinedData?(this.defaultDataLayer.predefinedData=e.predefinedData,e.predefinedData=void 0):this.defaultDataLayer.predefinedData={},e.rootless&&(this.rootless=e.rootless,e.rootless=void 0),e.additionalCssClasses&&(this.additionalCssClasses=e.additionalCssClasses,e.additionalCssClasses=void 0),e.getDataLayer&&(this.getDataLayer=e.getDataLayer,e.getDataLayer=void 0),this._options=o.extend({itemsTemplate:h,plugins:this._plugins,owner:this},e),this.context=e.context||{};for(var t=0,i=this._plugins.length;t<i;t++)this._plugins[t].processors&&(this.processors=this.processors.concat(this._plugins[t].processors));r.View.apply(this,arguments)},initialize:function(e){this.rootLevel=new l(o.extend({},this._options,{levelHeight:e.rootLevelHeight},{el:this.$("li")[0]},{item:{id:"/",value:{id:"/",resourceType:"folder"}}})),this.rootless&&this.$el.find("ul:first").addClass("hideRoot"),this.additionalCssClasses&&this.$el.find("ul:first").addClass(this.additionalCssClasses),this.listenTo(this.rootLevel,"ready",o.bind(s,this)),this.listenTo(this.rootLevel,"selection:change",o.bind(function(e,t,i){t&&i&&o.isArray(i)&&(this.rootLevel.selection.multiple||this.rootLevel.resetSelection({silent:!0,exclude:[i[0]]})),this.trigger("selection:change",e)},this)),this.listenTo(this.rootLevel,"item:dblclick",o.bind(function(e){this.trigger("item:dblclick",e)},this));for(var t=0,i=this._plugins.length;t<i;t++)this._plugins[t].constr.treeInitialized.call(this,this._plugins[t].options);this.rootLevel.render(),e.collapsed&&e.lazyLoad&&this.rootless&&this.expand("/")},remove:function(){for(var e=0,t=this._plugins.length;e<t;e++)this._plugins[e].constr.treeRemoved.call(this);this.rootLevel.remove(),r.View.prototype.remove.apply(this,arguments)},expand:function(e,t){var i=this.getLevel(e);return i&&i.open(t),this},collapse:function(e,t){var i=this.getLevel(e);return i&&i.close(t),this},_getNodeByLevelId:function(e){var t,i,s=this.getLevel(e);if(s)return s.parent?(t=s.parent.list,{node:s.item,nodeElement:s.$el,itsList:t}):null;var n=!1;if("list"===this._type)n=this.rootLevel;else if("tree"===this._type){var r=e.split("/");if(r=r.slice(0,r.length-1).join("/"),""===r&&(r="/"),!(n=this.getLevel(r)))return null}return n?(t=n.list,i=o.find(t.model.get("items"),function(t){return t.id===e}),i?{node:i,nodeElement:t.$el.find("li.leaf.selected"),itsList:t}:null):null},select:function(e){var t=this._getNodeByLevelId(e);t&&(t.itsList.model.clearSelection().addValueToSelection(t.node.value,t.node.index),this.trigger("selection:change",t.itsList.getValue()))},deselect:function(e){},addItem:function(e,t){var i=this.getLevel(e),s=c.ADD;return i&&this._getNodeItems(e,i,t,s),this},updateItem:function(e,t){var i=t?this.getLevel(t):this.rootLevel;return i&&this._getNodeItems(i.id,i,e),this},resetSelection:function(e){return this.rootLevel.list.clearSelection(),this.rootLevel.list.model.selection=[],this.rootLevel.resetSelection(e),this},refresh:function(e){e&&(this.context=e),this.rootLevel.refresh()},recalcConstraints:function(){this.rootLevel.recalcConstraints()},fetchVisibleData:function(){this.rootLevel.fetchVisibleData()},clearCache:function(){this.rootLevel.clearCache()},getLevel:function(e){return this.rootLevel.id===e?this.rootLevel:this.rootLevel.getLevel(e)},getDataLayer:function(e){return this.customDataLayers&&this.customDataLayers[e.id]?this.customDataLayers[e.id]:this.defaultDataLayer},_addItem:function(e,t,i){return!o.findWhere(e,{id:i.id})&&e.push(i),e},_updateItem:function(e,t){return o.each(e,function(e){e.id===t.id&&o.extend(e,t)},this),e},_getNodeItems:function(e,t,i,s){var n,r=this.getDataLayer(t),l=t.list.model.get("items")?t.list.model.get("items"):[];r.predefinedData=r.predefinedData||{},n=s===c.ADD?this._addItem(l,e,i):this._updateItem(l,i),r.predefinedData[e]=o.sortBy(n,"label"),t.fetch({force:!0,keepPosition:!0})},_selectTreeNode:function(e,t){if(o.isString(e)&&""!==e){var i=o.bind(function(){var s=o.bind(function(){var s=e,n=this.getLevelId(s);if(this.expand(n),this.select(n),"list"===this._type)this.rootLevel.on("ready",i);else if("tree"===this._type&&t&&t.length){var o=this.$el,r=this._getNodeByLevelId(n);if(!r)return;var l=r.nodeElement;if(!l)return;var a=l.offset().top-o.offset().top-t.height()/2+l.height()/2;t.scrollTop(a)}},this);if("/"===e||"/public"===e||"list"===this._type)s();else{var r=e.replace(/\/$/,""),l=r.substr(0,r.lastIndexOf("/"));l=l||"/";var a=new n.Deferred;this._openPath(l,a,0),a.done(s)}},this);this.rootLevel.isReady()?i():this.rootLevel.on("ready",i)}},_openPath:function(e,t,i){if(!e)return t.resolve();var s,n,r,l,a=this;if("/"===e?n=["/"]:(n=e.split("/"),n[0]="/"),"/"===n[0]&&"public"===n[1]&&(n=o.union(["/public"],o.rest(n,2))),(i=i||0)===n.length)return t.resolve();s=o.first(n,i+1).join("/"),s=s.replace(/\/\//g,"/"),l=this.getLevelId(s),(r=this.getLevel(l))&&(r.collapsed?(r.once("ready",function(){a._openPath(e,t,i+1)}),r.open()):this._openPath(e,t,i+1))},getLevelId:function(e){var t="",i=["/public"];if("/"===e||"/root"===e)t="/root";else{for(var s=!1,n=0;n<i.length;n++)if(0===e.indexOf(i[n])){s=!0;break}t=s?e:"/root/"+e.substr(1)}return t}},{instance:function(e){return new this(e)}});i.exports={use:function(e,t){return function(e){return{use:function(t,i){return e.prototype._plugins.push({constr:t,options:i}),this},create:function(){return e}}}(u.extend({_plugins:[{constr:e,options:t}]}))},create:function(){return u}}});