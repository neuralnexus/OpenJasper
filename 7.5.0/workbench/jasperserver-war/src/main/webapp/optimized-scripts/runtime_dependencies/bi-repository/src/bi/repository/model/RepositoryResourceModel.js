define(["require","exports","module","jquery","underscore","runtime_dependencies/js-sdk/src/common/model/BaseModel","runtime_dependencies/js-sdk/src/common/extension/backboneValidationExtension","request","bundle!RepositoryResourceBundle","runtime_dependencies/js-sdk/src/common/util/i18nMessage"],function(e,t,r){function n(e,t,r,n,i){return c({type:t,dataType:"json",url:e.contextPath+"/rest_v2/resources"+r+"?overwrite="+n+"&createFolders="+i,headers:{Accept:"application/json","Content-Location":e.get("uri")}}).done(function(t){e.set("uri",t.uri)})}var i=e("jquery"),o=e("underscore"),s=e("runtime_dependencies/js-sdk/src/common/model/BaseModel"),a=e("runtime_dependencies/js-sdk/src/common/extension/backboneValidationExtension"),c=e("request"),d=e("bundle!RepositoryResourceBundle"),u=e("runtime_dependencies/js-sdk/src/common/util/i18nMessage"),l=u.extend({bundle:d}),p={LABEL_MAX_LENGTH:100,NAME_MAX_LENGTH:100,DESCRIPTION_MAX_LENGTH:250,NAME_NOT_SUPPORTED_SYMBOLS:"~!#\\$%^|\\s`@&*()\\-+={}\\[\\]:;\"'\\<\\>,?/\\|\\\\"},h=/application\/repository\.([^\+]+)\+json/,f=s.extend({idAttribute:"uri",type:void 0,urlRoot:function(){return(this.contextPath||"")+"/rest_v2/resources"},defaults:{name:void 0,parentFolderUri:void 0,uri:void 0,label:void 0,description:void 0,permissionMask:void 0,creationDate:void 0,updateDate:void 0,version:void 0},validation:{name:function(e,t,r){return e&&e.length>p.NAME_MAX_LENGTH?new l("error.field.max.length","name",p.NAME_MAX_LENGTH):e&&new RegExp("["+p.NAME_NOT_SUPPORTED_SYMBOLS+"]","g").test(e)?new l("error.field.bad.symbols","name",p.NAME_NOT_SUPPORTED_SYMBOLS):void 0},label:function(e,t,r){return o.isEmpty(e)?new l("error.field.required","label"):e.length>p.LABEL_MAX_LENGTH?new l("error.field.max.length","label",p.LABEL_MAX_LENGTH):void 0},description:function(e,t,r){if(e&&e.length>p.DESCRIPTION_MAX_LENGTH)return new l("error.field.max.length","description",p.DESCRIPTION_MAX_LENGTH)},parentFolderUri:[{required:!0,msg:new l("error.field.required","parentFolderUri")}]},url:function(){return this.isNew()?this.urlRoot()+encodeURI(this.get("parentFolderUri")):this.urlRoot()+encodeURI(this.id)},constructor:function(e,t){t||(t={}),o.defaults(t,{parse:!0}),s.call(this,e,t)},initialize:function(e,t){this.contextPath=t.contextPath,t.type&&(this.type=t.type),this.on("change:parentFolderUri change:name",this._updateUri),this.on("change:uri",this._updateNameAndParentFolderUri),s.prototype.initialize.apply(this,arguments)},clone:function(){return new this.constructor(this.attributes,{contextPath:this.contextPath})},parse:function(e){return void 0!==e.uri?(e.name=f.getNameFromUri(e.uri),e.parentFolderUri=f.getParentFolderFromUri(e.uri)):e.parentFolderUri&&e.name&&(e.uri=f.constructUri(e.parentFolderUri,e.name)),e},toJSON:function(){var e=this.serialize();return delete e.name,delete e.parentFolderUri,e},_updateUri:function(){var e=this.get("name"),t=this.get("parentFolderUri"),r=f.constructUri(t,e);r&&this.set("uri",r)},_updateNameAndParentFolderUri:function(){var e=this.get("uri"),t=f.getNameFromUri(e),r=f.getParentFolderFromUri(e);this.set({name:t,parentFolderUri:r})},fetch:function(e){return o.defaults(e||(e={}),{headers:{Accept:"application/json"}}),e.url=this.url()+"?expanded="+(!0===e.expanded),delete e.expanded,s.prototype.fetch.call(this,e)},sync:function(e,t,r){if("read"===e){var n=r.success,i=this;r.success=function(e,t,r){var o=r.getResponseHeader("Content-Type"),s=h.exec(o);if(!s||!s[1])throw new Error("Unsupported response content type: "+o);i.type=s[1],n&&n(e,t,r)}}return s.prototype.sync.call(this,e,t,r)},save:function(e,t,r){var n;if(o.isUndefined(e)||o.isNull(e)||o.isObject(e)?(n=e||{},r=t):(n={})[e]=t,!this.type)throw new Error("Resource type is unspecified. It's not possible to save a resource without it's type specified");return o.defaults(r||(r={}),{headers:{Accept:"application/json","Content-Type":"application/repository."+this.type+"+json; charset=UTF-8"}}),r=this._getSaveUrlOptions(r),s.prototype.save.call(this,n,r)},_getSaveUrlOptions:function(e){var t=this.url()+"?createFolders="+(!0===e.createFolders);return t+="&overwrite="+(!0===e.overwrite),t+="&expanded="+(!0===e.expanded),t+="&dry-run="+(!0===e.dryRun),e=o.omit(e,["createFolders","overwrite","expanded","dryRun"]),e=o.extend({},e,{url:t})},isWritable:function(){var e=this.get("permissionMask"),t=!1;return o.isUndefined(e)||(t=1===e||4&e),t},checkLabelExistenceOnServer:function(){var e=this.get("label"),t=this.get("parentFolderUri");return this.operationInProgress=i.Deferred(),c({type:"GET",dataType:"json",url:this.contextPath+"/rest_v2/resources?folderUri="+encodeURIComponent(t)+"&q="+encodeURIComponent(e)+"&recursive=false",headers:{Accept:"application/json"}}).done(this._checkLabelExistenceOnServerDone.bind(this)).fail(this._checkLabelExistenceOnServerFail.bind(this)),this.operationInProgress},_checkLabelExistenceOnServerDone:function(e,t,r){var n=[];e&&e.resourceLookup&&e.resourceLookup.length>0&&(n=e.resourceLookup),this.operationInProgress.resolve({foundResources:n})},_checkLabelExistenceOnServerFail:function(e){404===e.status?this.operationInProgress.resolve({foundResources:[]}):this.operationInProgress.reject(e)},copyTo:function(e,t,r){return n(this,"POST",e,!!t,arguments.length<3||r)},moveTo:function(e,t,r){return n(this,"PUT",e,!!t,arguments.length<3||r)}},{settings:p,getNameFromUri:function(e){if(e){var t=e.split("/");return t[t.length-1]}},getParentFolderFromUri:function(e){if(e){var t=e.split("/");return 2===t.length&&""!==t[1]?"/":t.slice(0,t.length-1).join("/")}},constructUri:function(e,t){if(t&&e)return-1!==e.indexOf("/",e.length-1)?e+t:e+"/"+t},generateResourceName:function(e){var t="";return e&&(t=e.replace(new RegExp("["+f.settings.NAME_NOT_SUPPORTED_SYMBOLS+"]","g"),"_")),t}});o.extend(f.prototype,a.mixin),r.exports=f});