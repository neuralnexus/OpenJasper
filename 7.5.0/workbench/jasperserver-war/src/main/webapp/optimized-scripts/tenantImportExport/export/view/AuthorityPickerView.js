define(["require","exports","module","jquery","backbone","text!../template/authorityPickerTemplate.htm","text!../template/authorityPickerOptionsTemplate.htm","underscore"],function(e,t,s){function i(e,t,s){return s<=Math.max(e,t)&&s>=Math.min(e,t)}var l=e("jquery"),n=e("backbone"),r=e("text!../template/authorityPickerTemplate.htm"),c=e("text!../template/authorityPickerOptionsTemplate.htm"),h=e("underscore");s.exports=n.View.extend({events:{"click .button.search":"search","click .button.searchClear":"clear","click .button-select-all":"_selectAllHandler","keydown input[type=text]":"keyHandler","mousedown li":"selectionStarted","mouseenter li":"mouseEntered","mouseleave li":"mouseLeave","mouseup ul":"selectionFinished","mouseenter ul":"stopScroll","mouseleave ul":"startScroll"},cursor:-1,baseCursor:-1,selecting:!1,scrollSpeed:30,initialize:function(e){this.model.on("change",h.bind(this.renderList,this)),this.model.on("error:server",h.bind(function(){this.trigger("error:server",arguments)},this)),this.upHandler=h.bind(function(e){this.stopScroll(e),this.selecting=!1},this),this.el=!1,this.initOptions=e},render:function(){return this.mainTemplate||(this.mainTemplate=h.template(r)),this.optionsTemplate||(this.optionsTemplate=h.template(c)),this.el||(this.$el=l("<div/>").html(this.mainTemplate(this.initOptions)).children(),this.el=this.$el[0],this.subEl=this.$el.find(".authorityPicker ul"),this.delegateEvents()),this.model.context||this.model.setContext(),this},renderList:function(){return this.subEl.html(this.optionsTemplate(this.model.attributes)).find("li").each(function(e,t){l(t).attr("index",e)}),this.cursor=-1,this.baseCursor=-1,this.scrollSpeed=this.subEl.find("li:eq(0)").height(),this.subEl.scrollTop(0),this.trigger("change:selection",[]),this},getSelected:function(){return h.reduce(this.subEl.find(".selected"),function(e,t){var s=h.map(l(t).find("span"),function(e){return l(e).html()});return e.push(s.join("|")),e},[])},search:function(){var e=this.$el.find("input[type=text]").val();this.model.setContext({searchString:e}),e?this.$el.find(".button.searchClear").addClass("up"):this.$el.find(".button.searchClear").removeClass("up")},_selectAllHandler:function(){this.selectAll()},clear:function(){this.$el.find("input[type=text]").val(""),this.search()},keyHandler:function(e){13===e.which&&this.search()},setDisabled:function(e){var t=this.$el.find(".button-select-all").children();e?(this.subEl.addClass("disabled"),t.addClass("disabled"),this.undelegateEvents()):(this.subEl.removeClass("disabled"),t.removeClass("disabled"),this.delegateEvents()),this.$el.find("input[type=text]").attr("disabled",e)},highlightSet:function(e){this.subEl.find("li").each(function(t,s){s=l(s);var i=h.map(s.find("span"),function(e){return l(e).html()});s.toggleClass("highlighted",h.contains(e,i.join("|")))})},selectAll:function(e){this.subEl.find("li").each(function(e,t){l(t).addClass("selected")}),e||this.trigger("change:selection",this.getSelected())},selectNone:function(e){this.subEl.find("li").each(function(e,t){l(t).removeClass("selected")}),e||this.trigger("change:selection",this.getSelected())},selectInverse:function(e){this.subEl.find("li").each(function(e,t){l(t).toggleClass("selected")}),e||this.trigger("change:selection",this.getSelected())},selectItem:function(e,t){this.subEl.find("li[index="+e+"]").addClass("selected"),t||this.trigger("change:selection",this.getSelected())},unSelectItem:function(e,t){this.subEl.find("li[index="+e+"]").removeClass("selected"),t||this.trigger("change:selection",this.getSelected())},selectRange:function(e,t,s){var i=Math.min(e,t),n=Math.max(e,t);this.subEl.find("li:lt("+(n+1)+")").each(function(e,t){e>=i&&l(t).addClass("selected")}),s||this.trigger("change:selection",this.getSelected())},selectionStarted:function(e){this.selecting=!0,e.ctrlKey||e.metaKey||this.selectNone(!0);var t=+l(e.target).parents("li").toggleClass("selected").attr("index");e.shiftKey?-1!=this.cursor&&this.selectRange(this.cursor,t,!0):(this.cursor=t,this.baseCursor=this.cursor)},mouseEntered:function(e){this.selecting&&(this.cursor=+l(e.target).parents("li").addClass("selected").attr("index"))},mouseLeave:function(e){if(this.selecting){var t=l(e.target).parents("li"),s=l(e.relatedTarget).parents("li");i(this.cursor,this.baseCursor,+s.attr("index"))&&t.removeClass("selected")}},selectionFinished:function(e){this.selecting=!1,this.trigger("change:selection",this.getSelected())},startScroll:function(e){if(this.selecting){if(l(e.relatedTarget).hasClass("upper"))this.direction=-1;else{if(!l(e.relatedTarget).hasClass("lower"))return void(this.selecting=!1);this.direction=1}l(document.body).on("mouseup",this.upHandler),this.scrollTimer=setInterval(h.bind(this.scrollList,this),200)}},stopScroll:function(e){this.selecting&&(clearInterval(this.scrollTimer),this.direction=0,l(document.body).off("mouseup",this.upHandler))},scrollList:function(){this.subEl.scrollTop(+this.subEl.scrollTop()+this.scrollSpeed*this.direction),i(this.cursor,this.baseCursor,this.cursor+this.direction)?this.unSelectItem(this.cursor,!0):this.selectItem(this.cursor+this.direction,!0),this.cursor=this.cursor+this.direction}})});