define(["require","exports","module","dragdropextra","prototype","../core/core.layout","../core/core.events.bis","../util/utils.common","../util/touch.controller","./components.tooltip","underscore","runtime_dependencies/js-sdk/src/common/util/xssUtil","jquery"],function(e,t,s){var i=e("dragdropextra"),n=i.Draggables,o=i.Draggable,l=e("prototype"),r=l.$,d=l.Template,m=e("../core/core.layout"),a=e("../core/core.events.bis"),h=e("../util/utils.common"),c=h.isNotNullORUndefined,u=h.matchAny,_=h.deepClone,g=h.isArray,E=h.isShiftHeld,p=h.disableSelectionWithoutCursorStyle,I=h.cloneCustomAttributes,L=h.matchMeOrUp,f=h.isMetaHeld,v=h.isRightClick,C=h.isSupportsTouch,T=h.isIPad,S=e("../util/touch.controller"),b=e("./components.tooltip"),N=b.JSTooltip,M=e("underscore"),O=e("runtime_dependencies/js-sdk/src/common/util/xssUtil"),D=e("jquery"),A={isResponsive:function(e){return r(e.up(0)).hasClassName(m.RESPONSIVE_CLASS)},isCollapsible:function(e){return r(e.up(0)).hasClassName(m.COLLAPSIBLE_CLASS)},selectItem:function(e){if(this._allowSelections){if(this.isItemDisabled(e))return;r(e).addClassName(m.SELECTED_CLASS)}},deselectItem:function(e){r(e).removeClassName(m.SELECTED_CLASS)},isItemSelected:function(e){return r(e).hasClassName(m.SELECTED_CLASS)},disableItem:function(e){a.disable(e)},enableItem:function(e){a.enable(e)},isItemDisabled:function(e){return a.isDisabled(e)},openItem:function(e){r(e).removeClassName(m.CLOSED_CLASS).addClassName(m.OPEN_CLASS).isOpen=!0},isItemOpen:function(e){return r(e).hasClassName(m.OPEN_CLASS)||r(e).isOpen&&!r(e).hasClassName(m.CLOSED_CLASS)},closeItem:function(e){r(e).removeClassName(m.OPEN_CLASS).addClassName(m.CLOSED_CLASS).isOpen=!1}},x={lists:{},activeListId:null,_templateHash:{},messages:{listNItemsSelected:"#{count} items selected"},getDynamicListForElement:function(e){var t=r(e);return t.match("ul,ol")||(t=t.up("ul,ol"),0!==t.length)?x.lists[t.id]:null}};x.ListItem=function(e){this._itemId=void 0,this._list=void 0,this.first=!1,this.last=!1,e&&(this._value=e.value?e.value:{},this._label=e.label?e.label:"",this._subList=e.subList,this._cssClassName="cssClassName"in e?e.cssClassName:void 0,this._templateDomId="templateDomId"in e?e.templateDomId:void 0,this._respondOnItemEvents=!!Object.isUndefined(e.respondOnItemEvents)||e.respondOnItemEvents,this._excludeFromEventHandling="excludeFromEventHandling"in e?e.excludeFromEventHandling:void 0,this._excludeFromSelectionTriggers="excludeFromSelectionTriggers"in e?e.excludeFromSelectionTriggers:void 0)},x.ListItem.addVar("DEFAULT_TEMPLATE_DOM_ID","dynamicListItemTemplate"),x.ListItem.addVar("DEFAULT_ITEM_ID_PREFIX","item"),x.ListItem.addVar("DEFAULT_SUB_LIST_ID_SUFFIX","SubList"),x.ListItem.addMethod("getId",function(){return this._itemId}),x.ListItem.addMethod("setList",function(e){this._list=e,this.getList()&&(this._itemId=this.getList().getNextItemId())}),x.ListItem.addMethod("unsetList",function(){this._list=null,this._itemId=void 0}),x.ListItem.addMethod("getList",function(){return this._list}),x.ListItem.addMethod("setValue",function(e){return this._value=e}),x.ListItem.addMethod("getValue",function(){return this._value}),x.ListItem.addMethod("setLabel",function(e){return this._label=e}),x.ListItem.addMethod("getLabel",function(){return this._label}),x.ListItem.addMethod("setCssClassName",function(e){this._cssClassName=e}).addMethod("getCssClassName",function(){return this._cssClassName}),x.ListItem.addMethod("setTemplateDomId",function(e){this._templateDomId=e}),x.ListItem.addMethod("getTemplateDomId",function(){return this._templateDomId}),x.ListItem.addMethod("show",function(e){if(e){this._element=this.processTemplate(this._getTemplate()),this._getElement().setAttribute("id",this._generateId()),this._getElement().setAttribute("tabindex",-1),this.first&&this.getList().tabindex&&this._getElement().writeAttribute("tabindex",this.getList().tabindex),this._getElement().listItem=this,this.refreshStyle();var t=e.childElements(),s=this.index(),i=s-1;i>-1&&i<t.length?this._getElement().insert({after:t[i]}):r(e).insert(this._getElement())}}),x.ListItem.addMethod("refresh",function(){var e=!1;this._getElement()&&(this.getList()?(document.activeElement===this._getElement()&&(e=!0),this._element=this.processTemplate(this._getElement()),this.refreshStyle(),e&&D(this._getElement()).focus()):(this._getElement().remove(),this._element=null))}),x.ListItem.addMethod("refreshStyle",function(){var e=this._getElement();e&&(e.templateClassName&&(e.className=e.templateClassName),this.first&&e.addClassName(m.FIRST_CLASS),this.last&&e.addClassName(m.LAST_CLASS),this.isSelected()&&e.addClassName(m.SELECTED_CLASS),this.isDisabled()&&e.addClassName(m.DISABLED_CLASS),this.getCssClassName()&&e.addClassName(this.getCssClassName()),this.isComposite||this===this.getList().cursor&&e.addClassName("cursor"))}),x.ListItem.addMethod("isRendered",function(){return c(this._getElement())}),x.ListItem.addMethod("disable",function(){A.disableItem(this._getElement())}).addMethod("enable",function(){A.enableItem(this._getElement())}).addMethod("isDisabled",function(){return A.isItemDisabled(this._getElement())}),x.ListItem.addMethod("processTemplate",function(e){var t=e.childElements()[0];t.cleanWhitespace();var s=t.childElements().length;return s==t.childNodes.length?t.insert(O.hardEscape(this.getLabel())):t.childNodes[s].data=this.getLabel(),e}),x.ListItem.addMethod("focus",function(){this._getElement().focus()}),x.ListItem.addMethod("remove",function(){this.getList().removeItems([this])}),x.ListItem.addMethod("isSelected",function(){return this.getList().isItemSelected(this)}),x.ListItem.addMethod("select",function(){this.getList().selectItem(this,!0)}),x.ListItem.addMethod("deselect",function(){this.getList().deselectItem(this)}),x.ListItem.addMethod("index",function(){this.getList().getItems().indexOf(this)}),x.ListItem.addMethod("_getElement",function(){if(!this._element){var e=r(this._generateId());this._element=Object.isElement(e)?e:void 0}return this._element}),x.ListItem.addMethod("_getTemplate",function(){var e=this._templateDomId;x._templateHash[e]||(x._templateHash[e]=e);var t=r(x._templateHash[e]).cloneNode(!0);return t.templateId=e,t.templateClassName=t.className,t}),x.ListItem.addMethod("_generateId",function(){return this.getList()&&this.getList().getId()?this.getList().getId()+"_"+this.DEFAULT_ITEM_ID_PREFIX+this.getId():null}),x.ListItem.addMethod("_isElementInExcluded",function(e,t){var s=e.element();return this._excludeFromEventHandling&&null!=u(s,this._excludeFromEventHandling)}),x.ListItem.addMethod("_isExcludedFromSelectionTriggers",function(e){var t=e.element();return this._excludeFromSelectionTriggers&&null!=u(t,this._excludeFromSelectionTriggers)}),x.CompositeItem=function(e){x.ListItem.call(this,e),this.isComposite=!0,this._items=e.items,this._openUp=e.openUp,this._subList=null,this._subListOptions=e.listOptions?e.listOptions:{},this._listTagName="ul",this.OPEN_HANDLER_PATTERN=e.openHandlerPattern?e.openHandlerPattern:this.OPEN_HANDLER_PATTERN,this.CLOSE_HANDLER_PATTERN=e.closeHandlerPattern?e.closeHandlerPattern:this.CLOSE_HANDLER_PATTERN},x.CompositeItem.prototype=_(x.ListItem.prototype),x.CompositeItem.addVar("OPEN_HANDLER_PATTERN","[openHandler=openHandler]"),x.CompositeItem.addVar("CLOSE_HANDLER_PATTERN","[closeHandler=closeHandler]"),x.CompositeItem.addMethod("getItems",function(){return this._items}),x.CompositeItem.addMethod("setItems",function(e){this._items=e}),x.CompositeItem.addMethod("addItem",function(e){this._items.push(e)}),x.CompositeItem.addMethod("removeItems",function(e){this._items=this._items.reject(function(t){return e.include(t)}),this._subList.removeItems(e)}),x.CompositeItem.addMethod("show",function(e){this._listTagName=e.tagName,x.ListItem.prototype.show.call(this,e),A.closeItem(this._getElement()),this._items&&this._showSubList()}),x.CompositeItem.addMethod("_showSubList",function(){var e=this._getSubListId(),t=new Element(this._listTagName,{id:e});this._getElement().insert(this._openUp?{top:t}:{bottom:t});var s=this._subListOptions;if(this._subList=new x.List(e,{allowSelections:"allowSelections"in s?s.allowSelections:this.getList()._allowSelections,responsive:"responsive"in s?s.responsive:this.getList()._responsive,selectionDefaultsToCursor:"selectionDefaultsToCursor"in s?s.selectionDefaultsToCursor:this.getList()._selectionDefaultsToCursor,collapsible:"collapsible"in s?s.collapsible:this.getList()._collapsible,multiSelect:"multiSelect"in s?s.multiSelect:this.getList()._multiSelect,cssClassName:"cssClassName"in s?s.cssClassName:this.getList()._cssClassName,listTemplateDomId:"listTemplateDomId"in s?s.listTemplateDomId:this.getList()._listTemplateDomId,itemTemplateDomId:"itemTemplateDomId"in s?s.itemTemplateDomId:this.getList()._itemTemplateDomId,itemCssClassName:"itemCssClassName"in s?s.itemCssClassName:this.getList()._itemCssClassName,comparator:"comparator"in s?s.comparator:this.getList()._comparator,items:this._items}),this._subList._initEvents=function(){},this._subList.show(),this._subList._parentList=this.getList(),this._subList.getItems().each(function(e){e.parentItem=this}.bind(this)),this===this.getList().cursor){var i=this.getFirstChild();if(i){if(this.deselect(),i.getList().setCursor(i),this._getElement()){var n=D(this._getElement());n.removeClass("cursor"),n.addClass("supercursor")}i._getElement()&&window.setTimeout(function(){D(i._getElement()).focus()},0)}}}),x.CompositeItem.addMethod("refresh",function(){x.ListItem.prototype.refresh.call(this),this._items&&(this._subList?this._subList.refresh():this._showSubList())}),x.CompositeItem.addMethod("getFirstChild",function(){return this._subList.getItems().length<1?null:this._subList.getItems()[0]}),x.CompositeItem.addMethod("refreshStyle",function(){x.ListItem.prototype.refreshStyle.call(this),this._getElement()&&(A.isItemOpen(this._getElement())?(A.openItem(this._getElement()),this===this.getList().cursor&&(this._subList&&this._subList.cursor?this._getElement().addClassName("supercursor"):this._getElement().addClassName("cursor"))):(A.closeItem(this._getElement()),this===this.getList().cursor&&this._getElement().addClassName("cursor")),this._subList&&this._subList.refreshStyle())}),x.CompositeItem.addMethod("_isOpenHandler",function(e){return e.match(this.OPEN_HANDLER_PATTERN)}).addMethod("_isCloseHandler",function(e){return e.match(this.CLOSE_HANDLER_PATTERN)}),x.CompositeItem.addMethod("_getSubListId",function(){return this._generateId()+"_"+this.DEFAULT_SUB_LIST_ID_SUFFIX}),x.TemplatedListItem=function(e){e&&(this.tooltipText="tooltipText"in e?e.tooltipText:null),x.ListItem.call(this,e)};var y=function(){};y.prototype=x.ListItem.prototype,x.TemplatedListItem.prototype=new y,x.TemplatedListItem.prototype.constructor=x.TemplatedListItem,x.TemplatedListItem.prototype.processTemplate=function(e){},x.UnderscoreTemplatedListItem=function(e){x.TemplatedListItem.call(this,e),e&&(this._template="template"in e?e.template:"")};var y=function(){};y.prototype=x.TemplatedListItem.prototype,x.UnderscoreTemplatedListItem.prototype=new y,x.UnderscoreTemplatedListItem.prototype.constructor=x.UnderscoreTemplatedListItem,x.UnderscoreTemplatedListItem.prototype._getTemplate=function(){return this._template},x.UnderscoreTemplatedListItem.prototype.processTemplate=function(){var e=D(M.template(this._template,O.hardEscape(this.getValue())))[0];return e.templateClassName=e.className,null!=this.tooltipText&&new N(e,{text:O.hardEscape(this.tooltipText)}),e},x.List=function(e,t){this._id=e,this._items=[],this._selectedItems=[],this._lastSelectedItem=null,this.cursor=null,this._nextId=1,this.draggables=[],this._parentList=null,t&&(this._selectionDefaultsToCursor=!("selectionDefaultsToCursor"in t)||t.selectionDefaultsToCursor,this._allowSelections=!("allowSelections"in t)||t.allowSelections,this._cssClassName="cssClassName"in t?t.cssClassName:"",this._excludeFromEventHandling="excludeFromEventHandling"in t&&t.excludeFromEventHandling,this._excludeFromSelectionTriggers="excludeFromSelectionTriggers"in t&&t.excludeFromSelectionTriggers,this._multiSelect="multiSelect"in t&&t.multiSelect,this._selectOnMousedown=!("selectOnMousedown"in t)||t.selectOnMousedown,this._setCursorOnMousedown=!("setCursorOnMousedown"in t)||t.setCursorOnMousedown,this._listTemplateDomId=t.listTemplateDomId,this._itemTemplateDomId=t.itemTemplateDomId,this._itemCssClassName=t.itemCssClassName,this._comparator=t.comparator,this.dragPattern=t.dragPattern,this.scroll=t.scroll,this.setItems(t.items)),this._createFromTemplate(),this._registerCustomScroll(),x.activeListId=this.getId(),this._msgNItemsSelected=new d(x.messages.listNItemsSelected),x.lists[this._id]=this},x.List.addVar("Event",{ITEM_SELECTED:"item:selected",ITEM_UNSELECTED:"item:unselected",ITEM_MOUSEUP:"item:mouseup",ITEM_MOUSEDOWN:"item:mousedown",ITEM_CLICK:"item:click",ITEM_DBLCLICK:"item:dblclick",ITEM_OPEN:"item:open",ITEM_CLOSED:"item:closed",ITEM_CONTEXTMENU:"item:contextmenu",ITEM_BEFORE_SELECT_OR_UNSELECT:"item:beforeSelectOrUnselect"}),x.List.addVar("DND_WRAPPER_TEMPLATE","column_two"),x.List.addVar("DND_ITEM_TEMPLATE","column_two:resourceName"),x.List.addMethod("getNextItemId",function(){return this._nextId++}),x.List.addMethod("getId",function(){return this._id}),x.List.addMethod("getItems",function(){return this._items}),x.List.addMethod("setItems",function(e){if(e){var t=this.cursor,s=this._getElement(),i=!1;s&&(s===document.activeElement||D.contains(s,document.activeElement))&&(i=!0),this._items=[],this.resetSelected(),this.addItems(e);var n;t&&(n=this.getCursor()),i&&(n&&n._getElement()?D(n._getElement()).focus():s&&D(s).focus())}}),x.List.addMethod("addItems",function(e){e&&(e=M.isArray(e)?e:[e],e.compact().each(function(e){this._prepareListItem(e),this._items.push(e)}.bind(this)),this._comparator&&(this._items=this._items.sort(this._comparator)))}),x.List.addMethod("insertItems",function(e,t){t&&(t=M.isArray(t)?t:[t],t=t.compact(),t.each(function(e){this._prepareListItem(e)}.bind(this)),this._items.splice.apply(this._items,[e,0].concat(t)),this._comparator&&(this._items=this._items.sort(this._comparator)))}),x.List.addMethod("_prepareListItem",function(e){e&&(e.setList(this),this._itemTemplateDomId&&!e.getTemplateDomId()&&e.setTemplateDomId(this._itemTemplateDomId),this._itemCssClassName&&!e.getCssClassName()&&e.setCssClassName(this._itemCssClassName),this._excludeFromEventHandling&&!e._excludeFromEventHandling&&(e._excludeFromEventHandling=this._excludeFromEventHandling),this._excludeFromSelectionTriggers&&!e._excludeFromSelectionTriggers&&(e._excludeFromSelectionTriggers=this._excludeFromSelectionTriggers))}),x.List.addMethod("removeItems",function(e){if(e&&g(e)){var t=this.getCursor();e.each(function(e){this._removeItemFromSelected(e),t===e&&((t=this.getNextItem(e))||(t=this.getPreviousItem(e)))}.bind(this)),this._items=this._items.reject(function(t){return e.include(t)}),e.each(function(e){e.unsetList(),e.refresh()}),t!==this.getCursor()&&this.setCursor(t)}}),x.List.addMethod("sort",function(e){e&&(this._comparator=e),this._comparator&&this.getItems().sort(this._comparator)}),x.List.addMethod("setCursor",function(e){var t=!1;document.activeElement&&D.contains(this._getElement(),document.activeElement)&&(t=!0),this.cursor&&this.cursor.getList()&&this.cursor._getElement()&&D(this.cursor._getElement()).removeClass("cursor"),this.cursor=e,e&&e.getList()&&e._getElement()&&(this.scrollUpTo(e),this._allowSelections&&this._selectionDefaultsToCursor&&this.getSelectedItems().length<1&&this.selectItem(e),t&&D(this.cursor._getElement()).focus(),D(this.cursor._getElement()).addClass("cursor"))}),x.List.addMethod("getCursor",function(){return this.cursor&&this.cursor.getList()&&this.cursor._getElement()&&D(this.cursor._getElement()).closest("BODY").length>0?this.cursor:this._selectedItems.length>0&&this._selectedItems[this._selectedItems.length-1]._getElement()&&(this.setCursor(this._selectedItems[this._selectedItems.length-1]),D(this.cursor._getElement()).closest("BODY").length>0)?this.cursor:this._items.length>0?(this.setCursor(this._items[0]),this.cursor):null}),x.List.addMethod("getCursorElement",function(){return this.getCursor()?this.getCursor()._getElement():null}),x.List.addMethod("getSelectedItems",function(){return this._selectedItems}),x.List.addMethod("isItemSelected",function(e){return this.getSelectedItems().include(e)}),x.List.addMethod("selectItem",function(e,t,s,i){if(!this.fire(this.Event.ITEM_BEFORE_SELECT_OR_UNSELECT,{item:e}).stopSelectOrUnselect&&(!(this._multiSelect&&this._selectedItems.length>1&&this.isItemSelected(e))||t||s||i)){var n=this.isItemSelected(e)&&i,o=!(this._multiSelect&&t||n),l=this.isItemSelected(e)&&t&&!n,r=this._multiSelect&&!l&&c(this._lastSelectedItem)&&s,d=!l&&!r;if(o&&this.resetSelected(),l&&!o&&this._removeItemFromSelected(e),r){var m=this._items.indexOf(this._lastSelectedItem),a=this._items.indexOf(e),h=Math.min(m,a),u=Math.max(m,a);if(h>-1)for(var _=h;_<=u;_++)this._addItemToSelected(this._items[_],!1);else this._addItemToSelected(this._items[u],!1)}d&&this._addItemToSelected(e,!(s&&this._multiSelect)),this.setCursor(e)}}),x.List.addMethod("deselectItem",function(e){this._removeItemFromSelected(e),this.setCursor(e)}),x.List.addMethod("deselectOthers",function(e,t,s,i){!this.fire(this.Event.ITEM_BEFORE_SELECT_OR_UNSELECT,{item:e}).stopSelectOrUnselect&&this._multiSelect&&this._selectedItems.length>1&&this.isItemSelected(e)&&!(t||s||i)&&this._selectedItems.findAll(function(t){return t!=e}).each(function(e){this._removeItemFromSelected(e)}.bind(this))}),x.List.addMethod("resetSelected",function(e){var t=this._selectedItems;this._selectedItems=[],t.each(function(e){var t=e.getList();t&&t!==this&&t.resetSelected(!0),e.refreshStyle(),this.fire(this.Event.ITEM_UNSELECTED,{item:e})}.bind(this)),this._parentList&&!e&&this._parentList.resetSelected()}),x.List.addMethod("scrollDownTo",function(e){var t=this._getElement().parentNode;if(t&&e&&e._getElement()){var s=t.scrollTop,i=t.offsetHeight,n=e._getElement().offsetTop,o=e._getElement().offsetHeight,l=n+o-(s+i);l>0&&(t.scrollTop+=l)}}),x.List.addMethod("scrollUpTo",function(e){var t=this._getElement().parentNode;if(t&&e&&e._getElement()){var s=t.scrollTop,i=(t.offsetHeight,e._getElement().offsetTop),n=(e._getElement().offsetHeight,e._getElement().offsetHeight),o=s+n-i;o>0&&(t.scrollTop-=o)}}),x.List.addMethod("getNextItem",function(e){var t=this.getItems(),s=t.indexOf(e);return~s?this.getItems()[s+1]:null}),x.List.addMethod("getPreviousItem",function(e){var t=this.getItems(),s=t.indexOf(e);return~s?this.getItems()[s-1]:null}),x.List.addMethod("selectNext",function(e){var t=e.memo.targetEvent,s=this.getCursor(),i=null,n=null;if(s._subList&&s._getElement()&&D(s._getElement()).hasClass(m.OPEN_CLASS)){if(!D(s._getElement()).hasClass("supercursor")&&s._subList.getItems().length>0)return n=s._subList.getItems()[0],D(s._getElement()).addClass("supercursor"),t.preventDefault(),t.stopPropagation(),s._subList.setCursor(n),void D(s._subList.cursor._getElement()).focus();if(i=s._subList.getCursor(),n=i.getList().getNextItem(i))return i.getList().selectNext(e)}D(s._getElement()).removeClass("supercursor"),s._subList&&(s._subList.cursor=null),n=s.getList().getNextItem(s),n&&(this._multiSelect&&E(t)?this.isItemSelected(n)?s.getList().deselectItem(s):this._addItemToSelected(n,!1):(this.resetSelected(),s.getList().selectItem(n)),this.setCursor(n)),t.preventDefault(),t.stopPropagation()}),x.List.addMethod("selectPrevious",function(e){var t=e.memo.targetEvent,s=this.getCursor(),i=null,n=null;if(D(s._getElement()).hasClass("supercursor")){if(i=s._subList.getCursor(),n=i.getList().getPreviousItem(i))return i.getList().selectPrevious(e);s._subList.cursor&&(s._subList.cursor._element&&D(s._subList.cursor._element).removeClass("cursor"),s._subList.cursor=null),E(t)&&this._multiSelect||s._subList.resetSelected(),D(s._getElement()).removeClass("supercursor"),this.setCursor(s),D(s._getElement()).focus()}else(n=s.getList().getPreviousItem(s))&&(this._multiSelect&&E(t)?this.isItemSelected(n)?s.getList().deselectItem(s):this._addItemToSelected(n,!1):(this.resetSelected(),s.getList().selectItem(n)),this.setCursor(n));t.preventDefault(),t.stopPropagation()}),x.List.addMethod("selectPageDown",function(e){var t=e.memo.targetEvent;t.preventDefault(),t.stopPropagation();var s=this.getCursor(),i=s._getElement().offsetHeight,n=this._getElement().parentNode,o=n.scrollTop+(n.offsetHeight-i);o>n.offsetHeight&&(o=n.offsetHeight),n.scrollTop=o;for(var l=s,r=null;l&&l._getElement().offsetTop+l._getElement().offsetHeight<n.scrollTop+n.offsetHeight;)r=l,E(t)&&(this.isItemSelected(r)?s.getList().deselectItem(s):this._addItemToSelected(r,!1)),l=r.getList().getNextItem(r);r&&(this._multiSelect&&E(t)||(this.resetSelected(),s.getList().selectItem(r)),this.setCursor(r))}),x.List.addMethod("selectPageUp",function(e){var t=e.memo.targetEvent;t.preventDefault(),t.stopPropagation();var s=this.getCursor(),i=s._getElement().offsetHeight,n=this._getElement().parentNode,o=n.scrollTop+(n.offsetHeight-i);o>n.offsetHeight&&(o=n.offsetHeight),n.scrollTop=o;for(var l=s,r=null;l&&l._getElement().offsetTop>n.scrollTop-n.offsetHeight;)r=l,this._multiSelect&&E(t)&&(this.isItemSelected(r)?s.getList().deselectItem(s):this._addItemToSelected(r,!1)),l=r.getList().getPreviousItem(r);r&&(this._multiSelect&&E(t)||(this.resetSelected(),s.getList().selectItem(r)),this.setCursor(r))}),x.List.addMethod("selectOutwards",function(e){if(!(this.getSelectedItems().length<1)){var t=this.getSelectedItems()[0],s=t._getElement(),i=!A.isItemOpen(s)&&t.parentItem;i?(t.deselect(),i.select(),i._getElement().focus()):(A.closeItem(s),this.fire(this.Event.ITEM_CLOSED,{targetEvent:e,item:t}))}}),x.List.addMethod("selectInwards",function(e){var t=this.cursor;if(!t){if(this.getSelectedItems().length<1)return;t=this.getSelectedItems()[0]}if(t.isComposite){var s=t._getElement();if(A.isItemOpen(s)){var i=t.getFirstChild();if(i){if(t.deselect(),i.getList().setCursor(i),t._getElement()){var n=D(t._getElement());n.is(".cursor")&&(n.removeClass("cursor"),n.addClass("supercursor"))}i._getElement()&&D(i._getElement()).focus()}}else A.openItem(s),this.fire(this.Event.ITEM_OPEN,{targetEvent:e,item:t})}}),x.List.addMethod("show",function(){x.activeListId=this.getId(),this._getElement().update();var e=this.getItems(),t=e.length;e.each(function(e,s){e.first=0===s,e.last=s===t-1,e.show(this._getElement())}.bind(this)),this.draggables=[],this.scroll&&this.scroll.refresh(),this._initEvents()}),x.List.addMethod("refresh",function(){if(this._getElement()){this.getCursor();var e,t=this._getElement().parentNode;e=t?t.scrollTop:0,this.refreshStyle();var s=this._getElement().childElements(),i=[],n=this.getCursor(),o=!1;n&&n.getList()&&n._getElement()&&(document.activeElement===n._getElement()||D.contains(n._getElement(),document.activeElement))&&(o=!0),this.getItems().each(function(e,t){if(e.first=0===t,e.last=t===this.getItems().length-1,e.isRendered())if(e.index()!=s.indexOf(e._getElement())){var n=A.isItemOpen(e._getElement());e._getElement().remove(),e.show(this._getElement()),n&&A.openItem(e._getElement())}else e.refresh();else e.show(this._getElement());i.push(e._getElement())}.bind(this)),s.each(function(e){!i.include(e)&&e.parentNode&&e.remove()}),this.setCursor(n),o&&r(this.getCursorElement()).focus(),t&&(t.scrollTop=e)}}),x.List.addMethod("refreshStyle",function(e){var t=this._getElement();t&&(t.templateClassName&&(t.className=t.templateClassName),this._cssClassName&&t.addClassName(this._cssClassName))}),x.List.addMethod("fire",function(e,t){var s=r(this._getElement());return s?s.fire(e,t):null}),x.List.addMethod("observe",function(e,t){this._getElement().observe(e,t)}),x.List.addMethod("stopObserving",function(e,t){this._getElement().stopObserving(e,t)}),x.List.addMethod("_getElement",function(){return this._element||(this._element=r(this.getId())),this._element}),x.List.addMethod("getItemByEvent",function(e){if(e)for(var t=Event.element(e);t&&t.readAttribute&&t.readAttribute("id")!==this.getId();){var s=t.listItem;if(s&&null!=s.getList()){var i=s.getList(),n=i.getId()==this.getId(),o=this._getElement().contains(i._getElement());if(n||o)return s._label=O.unescape(s._label),s;break}t=r(t.parentNode)}return null}),x.List.addMethod("_createFromTemplate",function(){var e=this._getElement().readAttribute("tabindex");this.tabindex=parseInt(e&&e.length>0?e:-1),this._getElement().insert({after:this._getTemplateElement(this._getElement())}),this._getElement().remove(),this._element=null,this._getElement().update(),this.tabindex&&this.tabindex.length>0&&this._getElement().writeAttribute("tabindex",this.tabindex),p(this._getElement())}),x.List.addMethod("_getTemplateElement",function(e){var t=this._listTemplateDomId;x._templateHash[t]||(x._templateHash[t]=t);var s=r(x._templateHash[t]).cloneNode(!0);return s.writeAttribute("id",this.getId()),s.templateId=t,s.templateClassName=s.className,I(e,s),s}),x.List.addMethod("_addItemToSelected",function(e,t){e&&!this.isItemSelected(e)&&(this._selectedItems.push(e),t&&(this._lastSelectedItem=e),e.refreshStyle(),this._parentList?this._parentList._addItemToSelected(e,t):this.fire(this.Event.ITEM_SELECTED,{item:e}))}),x.List.addMethod("_removeItemFromSelected",function(e){e&&this.isItemSelected(e)&&(this._selectedItems=this._selectedItems.without(e),e.refreshStyle(),this._parentList?this._parentList._removeItemFromSelected(e):this.fire(this.Event.ITEM_UNSELECTED,{item:e}))}),x.List.addMethod("_buildDnDOverlay",function(e){e.setStyle({width:null,height:null}),e.items.length>1?e.update(this._msgNItemsSelected.evaluate({count:e.items.length})):1==e.items.length&&e.update(O.hardEscape(e.items[0].getLabel()))}),x.List.addMethod("_registerCustomScroll",function(){if(!this.scroll&&this._getElement()){var e=this._getElement().up(m.SWIPE_SCROLL_PATTERN);if(e){var t=m.scrolls.get(e.identify());t&&(this.scroll=t)}}}),x.List.addMethod("createDraggableIfNeeded",function(e){var t=e.element();if(this.dragPattern&&!this.draggables[t.identify()]){var s=u(t,[this.dragPattern],!0);if(s){if(!s||this.draggables[s.identify()])return;var i=this.getItemByEvent(e);this.draggables[s.identify()]=new o(s,{superghosting:!0,mouseOffset:!0,onStart:this.setDragStartState.bind(this,i),onEnd:this.setDragEndState.bind(this,i)})}}}),x.List.addMethod("setDragStartState",function(e,t,s){var i=e._getElement().templateClassName;i&&t.element.addClassName(i),t.element.addClassName(m.DRAGGING_CLASS).addClassName(this.getId()),t.element.items=this.getSelectedItems().slice(0),this._buildDnDOverlay(t.element),t.options.scroll=this._getElement(),t.options.scrollSensitivity=m.SCROLL_SENSITIVITY,n.dragging=this.regionID||!0}),x.List.addMethod("setDragEndState",function(e,t,s){delete n.dragging}),x.List.addMethod("_mouseupHandler",function(e){var t=e.element(),s=L(t,m.BUTTON_PATTERN)&&this.getItemByEvent(e);if(s&&!s._isElementInExcluded(e)){if(e.listEvent=!0,s._respondOnItemEvents&&!e.isInvoked){if(this.fire(this.Event.ITEM_MOUSEUP,{targetEvent:e,item:s}),!s._isExcludedFromSelectionTriggers(e)){var i=f(e),n=E(e),o=v(e),l=!this._selectOnMousedown&&!S.element_scrolled&&(!C()||e.changedTouches.length>=1);if(l&&s.getList().selectItem(s,i,n,o),!l&&this._multiSelect&&this._selectedItems.length>1&&this.isItemSelected(s)&&!(i||n||o)&&(this._lastSelectedItem=s),s.getList().deselectOthers(s,f(e),E(e),v(e)),this.twofingers){this.twofingers=!1;D(t).parents("li:first").hasClass("selected")&&document.fire(m.ELEMENT_CONTEXTMENU,{targetEvent:e,node:t})}}this.createDraggableIfNeeded(e)}e.isInvoked=!0}}),x.List.addMethod("_mousedownHandler",function(e){e="dataavailable"==e.type?e.memo.targetEvent:e;var t=e.element(),s=L(t,m.BUTTON_PATTERN+","+m.LIST_ITEM_WRAP_PATTERN)&&this.getItemByEvent(e);s&&!s._isElementInExcluded(e)&&(e.listEvent=!0,e.touches&&2==e.touches.length?this.twofingers=!0:this.twofingers=!1,s.isComposite&&(s._isOpenHandler(e.target)||s._isCloseHandler(e.target))?(e.stopPropagation(),e.preventDefault()):s._respondOnItemEvents&&!e.isInvoked&&(this.fire(this.Event.ITEM_MOUSEDOWN,{targetEvent:e,item:s}),s._isExcludedFromSelectionTriggers(e)||(this._selectOnMousedown&&s.getList().selectItem(s,f(e),E(e),v(e)),this._setCursorOnMousedown&&!f(e)&&s.getList().setCursor(s)),s.focus()),e.isInvoked=!0)}),x.List.addMethod("_mouseoverHandler",function(e){L(e.element(),m.BUTTON_PATTERN)&&this.createDraggableIfNeeded(e)}),x.List.addMethod("_clickHandler",function(e){var t=L(e.element(),m.BUTTON_PATTERN)&&this.getItemByEvent(e);if(t&&!t._isElementInExcluded(e)){if(!e.isInvoked){if(t._respondOnItemEvents&&this.fire(this.Event.ITEM_CLICK,{targetEvent:e,item:t}),!t.isComposite)return;var s=t._getElement(),i=e.element();t._isCloseHandler(i)&&A.isItemOpen(s)?(A.closeItem(s),this.fire(this.Event.ITEM_CLOSED,{targetEvent:e,item:t})):t._isOpenHandler(i)&&!A.isItemOpen(s)&&(A.openItem(s),this.fire(this.Event.ITEM_OPEN,{targetEvent:e,item:t}))}e.isInvoked=!0}}),x.List.addMethod("_dblclickHandler",function(e){var t=L(e.element(),m.BUTTON_PATTERN)&&this.getItemByEvent(e);t&&!t._isElementInExcluded(e)&&(t._respondOnItemEvents&&!e.isInvoked&&this.fire(this.Event.ITEM_DBLCLICK,{targetEvent:e,item:t}),e.isInvoked=!0)}),x.List.addMethod("_initEvents",function(){var e=this._getElement();this.draggables=[],C()?(e.stopObserving("touchstart").observe("touchstart",this._mousedownHandler.bindAsEventListener(this)),e.stopObserving("drag:touchstart").observe("drag:touchstart",this._mousedownHandler.bindAsEventListener(this)),e.stopObserving("touchend").observe("touchend",this._mouseupHandler.bindAsEventListener(this))):(e.stopObserving("mouseup").observe("mouseup",this._mouseupHandler.bindAsEventListener(this)),e.stopObserving("mousedown").observe("mousedown",this._mousedownHandler.bindAsEventListener(this)),e.stopObserving("drag:mousedown").observe("drag:mousedown",this._mousedownHandler.bindAsEventListener(this))),T||e.stopObserving("mouseover").observe("mouseover",this._mouseoverHandler.bindAsEventListener(this)),e.stopObserving("click").observe("click",this._clickHandler.bindAsEventListener(this)),e.stopObserving("dblclick").observe("dblclick",this._dblclickHandler.bindAsEventListener(this)),e.stopObserving("key:down").observe("key:down",this.selectNext.bindAsEventListener(this)),e.stopObserving("key:up").observe("key:up",this.selectPrevious.bindAsEventListener(this)),e.stopObserving("key:right").observe("key:right",this.selectInwards.bindAsEventListener(this)),e.stopObserving("key:left").observe("key:left",this.selectOutwards.bindAsEventListener(this)),e.stopObserving("key:pagedown").observe("key:pagedown",this.selectPageDown.bindAsEventListener(this))}),x.UnderscoreTemplatedList=function(e,t){t&&(this._template="template"in t?t.template:""),x.List.apply(this,arguments)};var y=function(){};y.prototype=x.List.prototype,x.UnderscoreTemplatedList.prototype=new y,x.UnderscoreTemplatedList.prototype.constructor=x.UnderscoreTemplatedList,x.UnderscoreTemplatedList.prototype._getTemplateElement=function(e){var t=D(M.template(this._template,{}))[0];return t.writeAttribute("id",this.getId()),t.templateClassName=t.className,I(e,t),t},t.dynamicList=x,t.baseList=A});