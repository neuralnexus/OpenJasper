define(["require","exports","module","prototype","./resource.base","./resource.locate","../util/utils.common","jquery"],function(e,t,i){var r=e("prototype"),o=r.$,s=e("./resource.base"),a=e("./resource.locate"),l=e("../util/utils.common"),_=l.ValidationModule,n=l.isIE,d=l.isIE7,u=l.isIE8,c=l.isIE9,h=l.isIE10,E=e("jquery"),I={SET_UP_PAGE_ID:"addReport_SetUp",LABEL_ID:"label",RESOURCE_ID_ID:"resourceID",DESCRIPTION_ID:"reportUnit.description",FILE_PATH_ID:"filePath",RESOURCE_URI_ID:"resourceUri",FILE_SYSTEM_SOURCE_ID:"FILE_SYSTEM",CONTENT_REPOSITORY_SOURCE_ID:"CONTENT_REPOSITORY",RESOURCE_NAME_ID:"resourceName",EDIT_RESOURCE_BUTTON_ID:"editResourceButton",REMOVE_RESOURCE_BUTTON_ID:"removeResourceButton",ADD_RESOURCE_BUTTON_ID:"addResourceButton",EDIT_CONTROL_BUTTON_ID:"editControlButton",REMOVE_CONTROL_BUTTON_ID:"removeControlButton",ADD_CONTROL_BUTTON_ID:"addControlButton",FILE_NAME_ID:"fileName",FILE_UPLOAD_BUTTON_ID:"fake_upload_button",SAVE_BUTTON_ID:"done",JRXML_FILE_PATH_COOKIE:"jrxmlFilePath",_canGenerateId:!0,initialize:function(e){this._setUpPage=o(this.SET_UP_PAGE_ID),this._setUpPage&&(this._form=o(document.body).select("form")[0],this._label=o(this.LABEL_ID),this._resourceId=o(this.RESOURCE_ID_ID),this._description=o(this.DESCRIPTION_ID),this._filePath=o(this.FILE_PATH_ID),this._resourceUri=o(this.RESOURCE_URI_ID),this._fileName=o(this.FILE_NAME_ID),this._fileSystemSource=o(this.FILE_SYSTEM_SOURCE_ID),this._contentRepositorySource=o(this.CONTENT_REPOSITORY_SOURCE_ID),this._saveButton=o(this.SAVE_BUTTON_ID),this._isEditMode=!!e&&e.isEditMode,this._initialSource=this._fileSystemSource.checked?this._fileSystemSource:this._contentRepositorySource,this._jrxmlFileResourceAlreadyUploaded=e.jrxmlFileResourceAlreadyUploaded,this._label.validator=s.labelValidator.bind(this),this._resourceId.validator=s.resourceIdValidator.bind(this),this._description.validator=s.descriptionValidator.bind(this),this._filePath.validator=this._filePathValidator.bind(this),this._resourceUri.validator=this._resourceUriValidator.bind(this),this._initEvents(),this._adjustFileSelectorPosition(),this._fileName.value=this._jrxmlFileResourceAlreadyUploaded);var t={fileUploadInput:"filePath",fakeFileUploadInput:"fake_upload_button",fakeFileUploadInputText:"fileName",resourceInput:"resourceUri",browseButton:"browser_button",uploadButton:"upload_button",treeId:"resourceTreeRepoLocation",dialogTitle:s.messages["resource.Report.Title"],selectLeavesOnly:!0};e&&o(t.browseButton)&&("fileResource"==e.type?t.providerId="fileResourceTreeDataProvider":"jrxml"==e.type?t.providerId="jrxmlTreeDataProvider":"olapMondrianSchema"==e.type?t.providerId="olapSchemaTreeDataProvider":"folder"==e.type&&(t.treeId="addFileTreeRepoLocation",t.providerId="repositoryExplorerTreeFoldersProvider",t.resourceInput="folderUri"),a.initialize(t),a._updateResourceSelectorState(E("input[type=radio]:checked").attr("id")))},_initEvents:function(){var e=this;E("#"+this.FILE_UPLOAD_BUTTON_ID).click(function(t){t.preventDefault(),E("#"+e.FILE_PATH_ID).trigger("click")}),this._saveButton.observe("click",function(t){e._isDataValid()||t.stop()}),this._form.observe("keyup",function(t){var i=t.element();[e._label,e._resourceId,e._description].include(i)&&(_.validate(s.getValidationEntries([i])),i==e._resourceId&&e._resourceId.getValue()!=s.generateResourceId(e._label.getValue())&&(e._canGenerateId=!1),i==e._label&&!e._isEditMode&&e._canGenerateId&&(e._resourceId.setValue(s.generateResourceId(e._label.getValue())),_.validate(s.getValidationEntries([e._resourceId]))))}),this._filePath.observe("change",function(){n()?-1!=this.value.toLowerCase().indexOf("c:\\fakepath\\")?e._fileName.value=this.value.substring("c:\\fakepath\\".length,this.value.length):e._fileName.value=this.value:e._fileName.value=this.files[0].name,o("fileUpload").removeClassName("error"),e._adjustFileSelectorPosition()})},_isDataValid:function(){var e=[this._label,this._resourceId,this._description,this._filePath,this._resourceUri];return n()?this.file=this._filePath.value:this.file=this._filePath.files[0],this.html=E(this._filePath).html(),_.validate(s.getValidationEntries(e))},_filePathValidator:function(e){var t=!0,i="";return!this._fileSystemSource.checked||!e.blank()||this._isEditMode&&this._initialSource==this._fileSystemSource||this._jrxmlFileResourceAlreadyUploaded||(i=s.messages.filePathIsEmpty,t=!1),t?_.hideError(o("fileName")):_.showError(o("fileName"),i),{isValid:t,errorMessage:i}},_resourceUriValidator:function(e){var t=!0,i="";return this._contentRepositorySource.checked&&e.blank()&&(i=s.messages.resourceUriIsEmpty,t=!1),{isValid:t,errorMessage:i}},_adjustFileSelectorPosition:function(){var e=E("#filePath");if(d()||u()||c()||h()){var t=20;e.parents("label").hasClass("error")&&(t+=13),e.css({opacity:"0",position:"absolute",right:0,top:t,width:95,height:30})}else e.css({position:"fixed",right:"-1000px",top:"-1000px"})},editResource:function(e){o(this.RESOURCE_NAME_ID).setValue(e),o(this.EDIT_RESOURCE_BUTTON_ID).click()},removeResource:function(e){o(this.RESOURCE_NAME_ID).setValue(e),o(this.REMOVE_RESOURCE_BUTTON_ID).click()},addResource:function(){o(this.ADD_RESOURCE_BUTTON_ID).click()},editControl:function(e){o(this.RESOURCE_NAME_ID).setValue(e),o(this.EDIT_CONTROL_BUTTON_ID).click()},removeControl:function(e){o(this.RESOURCE_NAME_ID).setValue(e),o(this.REMOVE_CONTROL_BUTTON_ID).click()},addControl:function(){o(this.ADD_CONTROL_BUTTON_ID).click()}};void 0===e&&document.observe("dom:loaded",function(){I.initialize(window.localContext.initOptions)}),i.exports=I});