define(["require","exports","module","prototype","jquery","../components/components.dialogs","../util/utils.common","./core.ajax.utils","../namespace/namespace","runtime_dependencies/js-sdk/src/common/util/xssUtil","scriptaculous/src/builder"],function(require,exports,module){function AjaxRequester(e,t,a,r){this.url=e||document.location.toString(),this.params=t,this.xmlhttp=getXMLHTTP();var o=this.processResponse(this);this.xmlhttp.onreadystatechange=o,this.postData=a,this.async=!r,this.requestTime=+new Date}function handleResponse(e){checkForErrors(e)||e.responseHandler(e),ajaxRequestEnded(e),JRS&&JRS.vars&&(JRS.vars.ajax_in_progress=!1),document.getElementById("mainTableContainerOverlay")&&(document.getElementById("mainTableContainerOverlay").className="hidden")}function targettedResponseHandler(e){var t=e.xmlhttp,a=e.params[0],r=e.params[1],o=e.params[2],s=(e.params[3],$(a));if(r)jQuery(s).html(""),updateUsingResponseSubset(t,r,s);else{var n=t.responseText.trim();if(0===n.indexOf("<div")){var i=n.substring(0,n.indexOf(">")+1),p=n.substring(n.indexOf(">")+1,n.lastIndexOf("</")),d=n.substring(n.lastIndexOf("</")),l=jQuery(i+d);p=p.replace(/&quot;/g,"&amp;quot;"),l.text(xssUtil.hardEscape(p)),jQuery(s).html(l)}else jQuery(s).html(n)}invokeCallbacks(o,s)}function cumulativeResponseHandler(e){var t=e.xmlhttp,a=e.params[0],r=e.params[1],o=e.params[2],s=$(a);r?updateUsingResponseSubset(t,r,s):s.insert(t.responseText,{position:"after"}),invokeCallbacks(o)}function rowCopyResponseHandler(e){var t=e.xmlhttp,a=e.params[0],r=e.params[2],o=$(a);if("TABLE"!==o.tagName)return void alert("Ajax Exception: rowCopyResponseHandler will not work for container "+o.tagName);var s=Builder.node("DIV");jQuery(s).html(t.responseText),copyTable(s.getElementsByTagName("table")[0],o,!1,!1),invokeCallbacks(r)}function updateUsingResponseSubset(e,t,a){function r(){if(!(l>=d)){var e=jQuery(p.get(l));e.attr("src")?(l++,o(e.attr("data-custname"),e.attr("src"),r)):(l++,s(e.html(),r))}}function o(e,t,a){var r=a||!1,o=document.createElement("script");window.jr_scripts||(window.jr_scripts={}),window.jr_scripts[e]||"jr_jq_min"===e?r&&a():(o.setAttribute("type","text/javascript"),o.readyState?o.onreadystatechange=function(){"loaded"!==o.readyState&&"complete"!==o.readyState||(o.onreadystatechange=null,r&&a())}:o.onload=function(){r&&a()},o.src=t,document.getElementsByTagName("head")[0].appendChild(o),window.jr_scripts[e]=t)}function s(e,t){var a=t||!1;if(e){var r=e.match(/^.*((\r\n|\n|\r)|$)/gm);window.eval(r.join("\n")),a&&t()}}var n=jQuery(e.responseText),i=n.filter("#"+t);if("TABLE"==a.tagName&&"TABLE"==$(t).tagName?copyTableJquery(i,a,!0):jQuery(a).append(i.html()),void 0!==jQuery){var p=n.filter("script.jasperreports"),d=p.size(),l=0;r()}}function invokeCallbacks(callback,customArg){callback&&("string"==typeof callback?eval(callback):callback(customArg))}function ajaxClobberredUpdate(e,t){t.responseHandler=clobberingResponseHandler,ajaxUpdate(e,t)}function ajaxTargettedUpdate(url,options){var responseHandler;responseHandler=options.mode==AjaxRequester.prototype.CUMULATIVE_UPDATE?cumulativeResponseHandler:options.mode==AjaxRequester.prototype.ROW_COPY_UPDATE?rowCopyResponseHandler:options.mode==AjaxRequester.prototype.EVAL_JSON?evalJSONResponseHandler:targettedResponseHandler,options.responseHandler=function(requester,params){options.preFillAction?"string"==typeof options.preFillAction?eval(options.preFillAction):options.preFillAction(responseHandler(requester,params)):responseHandler(requester,options.params)},ajaxUpdate(url,options)}function ajaxNonReturningUpdate(e,t){t.responseHandler=null,ajaxUpdate(e,t)}function ajaxClobberedFormSubmit(e,t,a){var r=getPostData(e,window.extraPostData);a.postData=appendPostData(r,window.extraPostData),a.responseHandler=clobberingResponseHandler,ajaxUpdate(t,a)}function ajaxTargettedFormSubmit(e,t,a){var r=getPostData(e,a.extraPostData);a.postData=appendPostData(r,a.extraPostData),a.responseHandler=targettedResponseHandler,ajaxUpdate(t,a)}function ajaxErrorHandler(){showMessageDialog(window.ajaxError,window.ajaxErrorHeader)}function doNothing(){}function ajaxUpdate(e,t){var a=new AjaxRequester(e,[t.fillLocation,t.fromLocation,t.callback,t.isAutomaticRefresh],t.postData,t.synchronous);isIPad()&&"adhoc"==JRS.vars.current_flow&&(JRS.vars.ajax_in_progress||(JRS.vars.ajax_in_progress=!0)),a.busyCursor=!t.silent,a.showLoading=!t.silent&&!t.hideLoader,a.responseHandler=t.responseHandler||doNothing,a.responseHandler!=doNothing&&ajaxRequestStarted(a),t.errorHandler&&(a.errorHandler=t.errorHandler),a.xmlhttp&&(t.postData?a.doPost():a.doGet())}function checkForErrors(e){return(0,e.errorHandler)(e.xmlhttp)}function getPostData(e,t){"string"==typeof e&&(e=document.forms[e]);for(var a="",r=0;r<e.elements.length;++r){var o=e.elements[r];!o.name||t&&t[o.name]||(a=appendFormInput(a,o))}return a}function appendPostData(e,t){for(var a in t)e=appendFormValue(e,a,t[a]);return e}function appendFormInput(e,t){if(t.name){var a,r=!1;switch(t.type){case"checkbox":case"radio":r=t.checked,a=t.value;break;case"hidden":case"password":case"text":case"Textarea":r=!0,a=t.value;break;case"select-one":case"select-multiple":a=[];for(var o=0;o<t.options.length;++o){var s=t.options[o];s.selected&&(r=!0,a.push(s.value))}}if(r)if(a.shift)for(;a.length>0;)e=appendFormValue(e,t.name,a.shift());else e=appendFormValue(e,t.name,a)}return e}function appendFormValue(e,t,a){return e.length>0&&(e+="&"),e+=t+"="+encodeURIComponent(a)}function hideErrorPopup(){popOverlayObject(),document.getElementById(ERROR_POPUP_DIV).style.display="none"}function ajaxRequestStarted(e){++ajax.ajaxRequestCount,e.busyCursor&&(document.body.style.cursor="wait"),!isIPad()&&e.showLoading&&e.startResponseTimer()}function ajaxRequestEnded(e){e.cancelResponseTimer(),ajax.ajaxRequestCount<=1?(document.body.style.cursor="auto",ajax.ajaxRequestCount=0,dialogs.popup.hide($(ajax.LOADING_ID))):ajax.ajaxRequestCount--}function isValidJsonResponse(e){var t=e.getResponseHeader("Content-Type");return 200==e.status&&null!=t&&t.indexOf("application/json")>=0}function getXMLHTTP(){var e;if(!e)try{e=new XMLHttpRequest}catch(e){alert("You need a browser which supports an XMLHttpRequest Object.\nMozilla build 0.9.5 has this Object and IE5 and above, others may do, I don't know, any info jim@jibbering.com")}return e}var __disableStrictMode__="use strict",_prototype=require("prototype"),$=_prototype.$,Hash=_prototype.Hash,jQuery=require("jquery"),dialogs=require("../components/components.dialogs"),_utilUtilsCommon=require("../util/utils.common"),copyTable=_utilUtilsCommon.copyTable,copyTableJquery=_utilUtilsCommon.copyTableJquery,isIPad=_utilUtilsCommon.isIPad,popOverlayObject=_utilUtilsCommon.popOverlayObject,_coreAjaxUtils=require("./core.ajax.utils"),errorHandler=_coreAjaxUtils.errorHandler,showMessageDialog=_coreAjaxUtils.showMessageDialog,_namespaceNamespace=require("../namespace/namespace"),JRS=_namespaceNamespace.JRS,xssUtil=require("runtime_dependencies/js-sdk/src/common/util/xssUtil"),Builder=require("scriptaculous/src/builder"),ajax={};ajax.cancelRequestsBefore,ajax.LOADING_ID="loading",AjaxRequester.addVar("CUMULATIVE_UPDATE","c").addVar("ROW_COPY_UPDATE","r").addVar("TARGETTED_REPLACE_UPDATE","t").addVar("EVAL_JSON","j").addVar("DUMMY_POST_PARAM","dummyPostData").addVar("MAX_WAIT_TIME",2e3).addVar("errorHandler",function(){return!1}).addMethod("doGet",function(){return!!this.xmlhttp&&(this.xmlhttp.open("GET",this.url,this.async),this.xmlhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),this.xmlhttp.setRequestHeader("If-Modified-Since","Sat, 1 Jan 2000 00:00:00 GMT"),this.xmlhttp.setRequestHeader("x-requested-with","AJAXRequest"),this.xmlhttp.send(null),!0)}).addMethod("doPost",function(){return!!this.xmlhttp&&(this.postData===AjaxRequester.prototype.DUMMY_POST_PARAM&&(this.postData=null),this.xmlhttp.open("POST",this.url,this.async),this.xmlhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),this.xmlhttp.setRequestHeader("x-requested-with","AJAXRequest"),this.xmlhttp.send(this.postData),!0)}).addMethod("processResponse",function(e){return function(){if(4==e.xmlhttp.readyState){if(ajax.cancelRequestsBefore&&ajax.cancelRequestsBefore>e.requestTime)return void ajaxRequestEnded(e);handleResponse(e)}}}).addMethod("setErrorHandler",function(e){this.errorHandler=errorHandler}).addMethod("verifyAjaxResponse",function(){return this.xmlhttp.getResponseHeader("Server")||this.confirmContinue()}).addMethod("startResponseTimer",function(){this.responseTimer=window.setTimeout(function(){dialogs.popup.show($(ajax.LOADING_ID),!0)},this.MAX_WAIT_TIME)}).addMethod("cancelResponseTimer",function(){window.clearTimeout(this.responseTimer)}).addMethod("confirmContinue",function(){return confirm(window.serverIsNotResponding)});var clobberingResponseHandler=function(e){var t=e.params[2];jQuery(document.body).html(e.xmlhttp.responseText),document.fire("dom:loaded"),invokeCallbacks(t)},evalJSONResponseHandler=function(e){var t=null;try{t=e.xmlhttp.responseText.evalJSON()}catch(e){window.console&&console.log(e)}invokeCallbacks(e.params[2],t)},ERROR_POPUP_DIV="jsErrorPopup",ERROR_POPUP_CONTENTS="errorPopupContents",ERROR_POPUP_BACK_BUTTON="errorBack",ERROR_POPUP_CLOSE_BUTTON="errorPopupCloseButton";ajax.ajaxRequestCount=0,window.ajaxNonReturningUpdate=ajaxNonReturningUpdate,exports.ajaxErrorHandler=ajaxErrorHandler,exports.ajaxClobberredUpdate=ajaxClobberredUpdate,exports.isValidJsonResponse=isValidJsonResponse,exports.getPostData=getPostData,exports.checkForErrors=checkForErrors,exports.ajaxRequestStarted=ajaxRequestStarted,exports.ajaxTargettedFormSubmit=ajaxTargettedFormSubmit,exports.ajaxUpdate=ajaxUpdate,exports.evalJSONResponseHandler=evalJSONResponseHandler,exports.rowCopyResponseHandler=rowCopyResponseHandler,exports.cumulativeResponseHandler=cumulativeResponseHandler,exports.updateUsingResponseSubset=updateUsingResponseSubset,exports.targettedResponseHandler=targettedResponseHandler,exports.ajaxRequestEnded=ajaxRequestEnded,exports.handleResponse=handleResponse,exports.invokeCallbacks=invokeCallbacks,exports.getXMLHTTP=getXMLHTTP,exports.ajax=ajax,exports.ajaxTargettedUpdate=ajaxTargettedUpdate,exports.ajaxNonReturningUpdate=ajaxNonReturningUpdate,exports.appendPostData=appendPostData,exports.AjaxRequester=AjaxRequester});