define(["require","exports","module","../namespace/namespace","runtime_dependencies/js-sdk/src/jrs.configs","../components/components.dialogs","underscore","jquery","./controls.core","./controls.dataconverter"],function(e,t,r){var n=e("../namespace/namespace"),s=n.JRS,o=e("runtime_dependencies/js-sdk/src/jrs.configs"),i=e("../components/components.dialogs"),a=e("underscore"),u=e("jquery");e("./controls.core"),e("./controls.dataconverter"),s.Controls=function(e,t,r,n){function s(t){var s;try{try{s=e.parse(t.responseText)}catch(e){}if(s&&s.error)r.each(s.error,function(e){var t=n.getViewModel(),r=e.inputControlUri.replace("repo:",""),s=t.find({uri:r});e.errorCode?s.set({error:e.errorCode}):e.defaultMessage&&s.set({error:e.defaultMessage})});else if(t.getResponseHeader("LoginRequested")||401===t.status)document.location=o.urlContext;else if(500==t.status||t.getResponseHeader("JasperServerError")&&!t.getResponseHeader("SuppressError")){var a="";a=s?r.template("<div><b>{{-message}}</b></div><p>{{ if (parameters) for (var i = 0; i < parameters.length; i++) { }}<div>{{-parameters[i]}}</div>{{ } }}</p>")(s):window.statusText,i.errorPopup.show(a)}}catch(e){}}return r.extend(n,{DataTransfer:n.Base.extend({CONTROLS_STRUCTURE_TEMPLATE_URI:o.contextPath+"/rest_v2/reports{{=reportUri}}/inputControls/{{=controlIds}}",INITIAL_CONTROLS_VALUES_TEMPLATE_URL:o.contextPath+"/rest_v2/reports{{=reportUri}}/inputControls/values",CONTROLS_VALUES_TEMPLATE_URL:o.contextPath+"/rest_v2/reports{{=reportUri}}/inputControls/{{=controlIds}}/values",constructor:function(e){this.dataConverter=e.dataConverter,this.initialize(e)},initialize:function(e){},setReportUri:function(e){this.currentReportUri=e},buildUrl:function(e,t,s){return t=r.isArray(t)?t.join(";"):t||"",n.TemplateEngine.renderUrl(s,{reportUri:e,controlIds:t})},sendRequest:function(n,i,a){var u={url:n,type:"GET",dataType:"json",cache:!1};r.isEmpty(i)||r.extend(u,{type:"POST",processData:!1,data:e.stringify(i),contentType:"application/json"});var l=r.defaults(a||{},u);return l.headers||(l.headers={}),r.defaults(l.headers,{"X-Suppress-Basic":"true","Accept-Language":o.userLocale.replace(/_/g,"-")}),t.ajax(l).fail(s)},fetchControlsStructure:function(e,t){var s=this.buildUrl(this.currentReportUri,e,this.CONTROLS_STRUCTURE_TEMPLATE_URI),o=this.sendRequest(s,t).then(r.bind(this.dataConverter.structureFormater,this.dataConverter));return n.Utils.showLoadingDialogOn(o,null,!0),o},updateControlsStructure:function(e,t){var n=this.buildUrl(t||this.currentReportUri,null,this.CONTROLS_STRUCTURE_TEMPLATE_URI);return this.sendRequest(n,e,{type:"PUT"}).then(r.bind(this.dataConverter.structureFormater,this.dataConverter))},fetchInitialControlValues:function(e,t){var r=this.buildUrl(e,null,this.INITIAL_CONTROLS_VALUES_TEMPLATE_URL),s=this.sendRequest(r,t).then(this.dataConverter.convertResponseToControlsState);return n.Utils.showLoadingDialogOn(s,null,!0),s},fetchControlsUpdatedValues:function(e,s){var o=this.buildUrl(this.currentReportUri,e,this.CONTROLS_VALUES_TEMPLATE_URL),i=this.dataConverter;this.fullUpdateDeferred&&"pending"==this.fullUpdateDeferred.state()&&this.fullUpdateDeferred.reject();var a=new t.Deferred,u=n.Utils.wait(n.DataTransfer.FREQUENT_CHANGES_MIN_DELAY);return u.done(r.bind(function(){this.sendRequest(o,s).then(i.convertResponseToControlsState).done(function(e){"pending"==a.state()&&a.resolve(e)}).fail(function(){a.reject(this,arguments)})},this)),a.fail(function(){u.reject()}),n.Utils.showLoadingDialogOn(a,null,!0),this.fullUpdateDeferred=a,a}},{CONTROLS_STRUCTURE_TEMPLATE_URI:o.contextPath+"/rest_v2/reports{{=reportUri}}/inputControls/{{=controlIds}}",INITIAL_CONTROLS_VALUES_TEMPLATE_URL:o.contextPath+"/rest_v2/reports{{=reportUri}}/inputControls/values",CONTROLS_VALUES_TEMPLATE_URL:o.contextPath+"/rest_v2/reports{{=reportUri}}/inputControls/{{=controlIds}}/values",FREQUENT_CHANGES_MIN_DELAY:400})})}(JSON,u,a,s.Controls),r.exports=s.Controls});