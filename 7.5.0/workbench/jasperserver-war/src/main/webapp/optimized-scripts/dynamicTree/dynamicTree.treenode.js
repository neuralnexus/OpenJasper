define(["require","exports","module","prototype","./dynamicTree.tree","../util/utils.common","../core/core.layout","runtime_dependencies/js-sdk/src/common/util/xssUtil"],function(e,t,d){var i=e("prototype"),s=i.$,r=e("./dynamicTree.tree"),n=e("../util/utils.common"),o=n.isArray,h=n.isIPad,a=n.cancelEventBubbling,l=e("../core/core.layout"),N=e("runtime_dependencies/js-sdk/src/common/util/xssUtil");r.TreeNode=function(e){this.id=r.getNextId(),this.treeId=null,this.name=null!=e.name?e.name:this.DEFAULT_NAME,this.param=null!=e.param?e.param:{},this.orderNumber=null!=e.orderNumber?e.orderNumber:null,this.childs=[],this.parent=null,this.Types={Folder:new r.TreeNode.Type(this.FOLDER_TYPE_NAME)},this.isloaded=!1,this.delayedRendering=!0,this.haschilds=!1,this.editable=!1,this.isWaiting=!1,this.hidden=!1,this.isDropTarget=!1,r.nodes[this.id]=this},r.TreeNode.Type=function(e,t){this.name=e,t&&(this.cssClassName=t.cssClassName,this.templateDomId=t.templateDomId)},r.TreeNode.State={OPEN:"open",CLOSED:"closed"},r.TreeNode.addVar("FOLDER_TYPE_NAME","com.jaspersoft.jasperserver.api.metadata.common.domain.Folder"),r.TreeNode.addVar("DEFAULT_NAME","unset name"),r.TreeNode.addVar("NODE_ID_PREFIX","node"),r.TreeNode.addVar("SUB_NODE_ID_SUFFIX","sub"),r.TreeNode.addVar("HANDLER_ID_PREFIX","handler"),r.TreeNode.addVar("NODE_CLASS_NAME","node").addVar("LEAF_CLASS_NAME","leaf").addVar("OPEN_CLASS_NAME","open").addVar("CLOSED_CLASS_NAME","closed").addVar("SELECTED_CLASS_NAME","selected").addVar("LOADING_CLASS_NAME","loading").addVar("ROOTS_CLASS_NAME","roots"),r.TreeNode.addVar("nodeHeaderTemplateDomId","list_responsive_collapsible:leaf"),r.TreeNode.addVar("nodeFooterTemplateDomId","list_responsive_collapsible"),r.TreeNode.addVar("nodeInputTemplateDomId","list_responsive_collapsible:input"),r.TreeNode.addVar("isSelectable",!1),r.TreeNode.addMethod("getTreeId",function(){return this.treeId||this.parent&&this.parent.getTreeId()}),r.TreeNode.addMethod("getState",function(){return r.trees[this.getTreeId()].getState(this.id)}),r.TreeNode.addMethod("isParent",function(){return this.param.type==this.Types.Folder.name}),r.TreeNode.addMethod("addChild",function(e){if(this.isParent()){var t=this.childs[this.childs.length-1];t&&(t.nextSibling=e,e.prevSibling=t),this.childs.push(e),e.parent=this,this.resortChilds(),this.delayedRendering||(e.showNode(),e.render(this._getChildrenElement(),e.nextSibling))}}),r.TreeNode.addMethod("removeChild",function(e){for(var t=0;t<this.childs.length;t++)if(this.childs[t]==e){this.childs.splice(t,1);break}if(e.deselect(),!this.delayedRendering){var d=e._getElement();d&&d.remove()}}),r.TreeNode.addMethod("resortChilds",function(){var e=this.getTreeId(),t=r.trees[e];if(t&&t.sortNodes&&o(this.childs)){this.childs.sort(function(e,d){return t.comparer(e,d)});for(var d=this.childs.length;d--;){var i=this.childs[d];i.prevSibling=this.childs[d-1],i.nextSibling=this.childs[d+1]}}}),r.TreeNode.addMethod("resetChilds",function(){this.childs=[]}),r.TreeNode.addMethod("setHasChilds",function(e){this.haschilds=e}),r.TreeNode.addMethod("hasChilds",function(){return!!this.haschilds||this.getChildCount()>0}),r.TreeNode.addMethod("getChildCount",function(){return this.childs.length}),r.TreeNode.addMethod("getFirstChild",function(){return this.hasChilds()?this.childs[0]:null}),r.TreeNode.addMethod("getLastChild",function(){return this.hasChilds()?this.childs[this.childs.length-1]:null}),r.TreeNode.addMethod("_getElement",function(e){return this._element||(this._element=s(this.NODE_ID_PREFIX+this.id)),this._element}),r.TreeNode.addMethod("_getTitle",function(){var e=this._getElement().childElements()[0];e.cleanWhitespace();var t=e.childNodes[e.childNodes.length-1];return"#text"!==t.nodeName&&(t=document.createTextNode(""),e.appendChild(t)),t}),r.TreeNode.addMethod("_getTitleInputElement",function(){return s(this._getElement().getElementsByTagName("input")[0])}),r.TreeNode.addMethod("_getChildrenElement",function(){return this._childrenElement||(this._childrenElement=s(this.NODE_ID_PREFIX+this.id+this.SUB_NODE_ID_SUFFIX)),this._childrenElement}),r.TreeNode.addMethod("isOpen",function(){return this.getState()===r.TreeNode.State.OPEN}),r.TreeNode.addMethod("changeName",function(e){this.name=e,this._getTitle().data=this.name}),r.TreeNode.addMethod("getType",function(){for(var e in this.Types)if(this.param.type===this.Types[e].name)return this.Types[e]}),r.TreeNode.addMethod("refreshStyle",function(e){if(e=s(e)||this._getElement()){e.templateClassName&&(e.className=e.templateClassName),this.isParent()?(e.addClassName(this.NODE_CLASS_NAME).removeClassName(this.LEAF_CLASS_NAME),this.isWaiting||(this.isOpen()?e.addClassName(this.OPEN_CLASS_NAME).removeClassName(this.CLOSED_CLASS_NAME):e.addClassName(this.CLOSED_CLASS_NAME).removeClassName(this.OPEN_CLASS_NAME))):e.addClassName(this.LEAF_CLASS_NAME).removeClassName(this.NODE_CLASS_NAME),this.isWaiting?e.addClassName(this.LOADING_CLASS_NAME):e.removeClassName(this.LOADING_CLASS_NAME),this.isSelected()?e.addClassName(this.SELECTED_CLASS_NAME):e.removeClassName(this.SELECTED_CLASS_NAME),this.hidden?e.addClassName(l.HIDDEN_CLASS):e.removeClassName(l.HIDDEN_CLASS),this.param.cssClass&&e.addClassName(this.param.cssClass);var t=this.getType();t&&t.cssClassName&&e.addClassName(t.cssClassName);var d=e.down();this.isDropTarget&&d&&d.addClassName(l.DROP_TARGET_CLASS),!this.isDropTarget&&d&&d.removeClassName(l.DROP_TARGET_CLASS)}}),r.TreeNode.addMethod("_createNode",function(){var e=this.id,t=r.trees[this.getTreeId()],d=this._getHeaderTemplateElement();d.id=this.NODE_ID_PREFIX+e,d.tabIndex=-1,this.refreshStyle(d),this.treeId=t.id,d.treeNode=this;var i=d.childElements()[0];i.insert(N.softHtmlEscape(this.name,{whiteList:["a"]})),null!=this.tooltip&&this.tooltip.length>0&&(i.title=this.tooltip),i.childElements().each(function(t,d){0===d&&(t.id=this.HANDLER_ID_PREFIX+e);var i=this.iconTooltip;i&&(t.title=o(i)?i[d]:i)}.bind(this)),this._element=d}),r.TreeNode.addMethod("_createNodeChildren",function(){var e=this._getFooterTemplateElement();e.id=this.NODE_ID_PREFIX+this.id+this.SUB_NODE_ID_SUFFIX,this._childrenElement=e}),r.TreeNode.addMethod("showNode",function(e){var t=r.trees[this.getTreeId()];if(this._createNode(),this.isParent()){if(this.isOpen()||t.showAllNodesOnStartup){this._createNodeChildren();for(var d=0;d<this.getChildCount();d++)this.childs[d].showNode(this._getChildrenElement());this.delayedRendering=!1,t.fireOpenEvent(this)}}this.render(e)}),r.TreeNode.addMethod("render",function(e,t){if(!Object.isUndefined(e)){var d=s(e);d&&(this._getChildrenElement()&&this._getElement().insert(this._getChildrenElement()),t?d.insert(this._getElement(),{before:t._getElement()}):d.insert(this._getElement()))}}),r.TreeNode.addMethod("_renderChildren",function(){var e=this._getElement();e&&this._getChildrenElement()&&e.insert(this._getChildrenElement())}),r.TreeNode.addMethod("refreshNode",function(){if(this.refreshStyle(),this.isParent()&&this.isOpen()&&this.isloaded){this.delayedRendering?(this._createNodeChildren(),this._renderChildren()):this._getChildrenElement().update("");for(var e=0;e<this.getChildCount();e++)this.childs[e].showNode(this._getChildrenElement());this.delayedRendering=!1}r.trees[this.getTreeId()].refreshScroll()}),r.TreeNode.addMethod("wait",function(){this.isWaiting=!0,this.refreshStyle()}),r.TreeNode.addMethod("stopWaiting",function(){this.isWaiting=!1,this.refreshStyle()}),r.TreeNode.addMethod("isHiddenRootNode",function(){var e=r.trees[this.getTreeId()];return e.rootNode==this&&!e.bShowRoot}),r.TreeNode.addMethod("deselect",function(e){var t=r.trees[this.getTreeId()];return!(!t||!this.isSelected())&&(t.removeNodeFromSelected(this),this.refreshStyle(),e&&t.fireUnSelectEvent(this,e),!0)}),r.TreeNode.addMethod("select",function(e,t,d){if(d=d||{},!t&&this.focus(),this.isSelected())return!1;var i=r.trees[this.getTreeId()];return i.addNodeToSelected(this),this.refreshStyle(),!d.silent&&i.fireSelectEvent(this,e),!0}),r.TreeNode.addMethod("focus",function(){var e=this;!h()&&this._getElement()&&setTimeout(function(){e._getElement().focus()},100)}),r.TreeNode.addMethod("isSelected",function(){var e=r.trees[this.getTreeId()];return e&&e.isNodeSelected(this)}),r.TreeNode.addMethod("_removeTitle",function(){var e=this._getTitle();e.data="",s(e.parentNode).cleanWhitespace()}),r.TreeNode.addMethod("edit",function(e){if(this.editable){if(r.treeNodeEdited==this)return;r.treeNodeEdited=this;var t=this.name,d=s(this._getTitle().parentNode),i=this._getInputTemplateElement();this._getTitle().data="",d.cleanWhitespace(),d.insert(i),i.value=N.unescape(this.name),i.focus(),i.select(e),i.onclick=function(e){a(e)},i.ondblclick=function(e){a(e)},i.onmousedown=function(e){a(e)},i.onmouseup=function(e){a(e)},i.onkeydown=function(e){var d=window.event?window.event:e;13==d.keyCode?(i.onblur=null,this.doEndEdit(d)):27==d.keyCode&&(i.onblur=null,i.value=t,this.doEndEdit(d))}.bindAsEventListener(this),i.onblur=function(e){this.doEndEdit(e)}.bindAsEventListener(this),r.trees[this.getTreeId()].fireStartEditEvent(this,i)}}),r.TreeNode.addMethod("doEndEdit",function(e){this.editEnded(),r.trees[this.getTreeId()].fireEndEditEvent(this)}),r.TreeNode.addMethod("editEnded",function(){var e=r.trees[this.getTreeId()];if(null!=r.treeNodeEdited){var t=this._getTitleInputElement(),d=(s(t.parentNode),t.value);if(d==r.treeNodeEdited.name)return t.remove(),this._getTitle().data=r.treeNodeEdited.name,void(r.treeNodeEdited=null);e.fireEditEvent(r.treeNodeEdited,d),r.editaborted||(r.treeNodeEdited.name=d,t.remove(),this._getTitle().data=d),r.treeNodeEdited=null}}),r.TreeNode.addMethod("scroll",function(e){var t=r.trees[this.getTreeId()].rootNode._getElement(),d=s(e?e:t.parentNode),i=this._getElement();if(d){var n=d.clientHeight,o=d.clientWidth,h=d.scrollTop,a=d.scrollLeft,l=i.cumulativeOffset().top-d.cumulativeOffset().top,N=i.offsetLeft,c=i.clientHeight,m=i.clientWidth;l>h+n?d.scrollTop=l-(n/2-c/2):l+c<h&&(d.scrollTop=l-(n/2-c/2)),N>a+o?d.scrollLeft=N-(o/2-m/2):N+m<a&&(d.scrollTop=N-(o/2-m/2))}}),r.TreeNode.addMethod("handleNode",function(e){if(this.isParent()){var t=r.trees[this.getTreeId()];this.isOpen()?t.writeStates(this.id,r.TreeNode.State.CLOSED):(t.writeStates(this.id,r.TreeNode.State.OPEN),t.fireOpenEvent(this,e)),this.refreshNode()}}),r.TreeNode.addMethod("openNode",function(e){if(this.isParent()){var t=r.trees[this.getTreeId()];this.isOpen()||(t.writeStates(this.id,r.TreeNode.State.OPEN),t.fireOpenEvent(this,e)),this.refreshNode()}}),r.TreeNode.addMethod("_getHeaderTemplateElement",function(){var e=this.getType(),t=e&&e.templateDomId?e.templateDomId:this.nodeHeaderTemplateDomId,d=s(t).cloneNode(!0);return d.templateId=t,d.templateClassName=d.className,d}),r.TreeNode.addMethod("_getFooterTemplateElement",function(){var e=this.nodeFooterTemplateDomId,t=s(e).cloneNode(!0);return t.templateId=e,t.update(""),t}),r.TreeNode.addMethod("_getInputTemplateElement",function(){var e=this.nodeInputTemplateDomId,t=s(e).cloneNode(!0);return t.templateId=e,t}),d.exports=r});