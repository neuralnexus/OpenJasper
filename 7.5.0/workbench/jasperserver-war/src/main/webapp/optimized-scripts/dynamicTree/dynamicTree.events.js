define(["require","exports","module","dragdropextra","prototype","./dynamicTree.treenode","../core/core.layout","./dynamicTree.designerBase","../util/utils.common","../util/touch.controller","../namespace/namespace","jquery"],function(e,t,n){var i=e("dragdropextra"),r=i.Draggables,s=i.Draggable,d=i.Droppables,o=e("prototype"),a=o.$,l=o.Template,E=e("./dynamicTree.treenode"),c=e("../core/core.layout"),v=e("./dynamicTree.designerBase"),h=e("../util/utils.common"),g=h.matchMeOrUp,u=h.isSupportsTouch,f=h.isIPad,m=h.isMetaHeld,T=h.isShiftHeld,N=h.isRightClick,_=h.isIE7,b=h.isIE,p=h.matchAny,A=e("../util/touch.controller"),I=e("../namespace/namespace"),O=I.JRS,y=e("jquery");E.Tree.addVar("NODE_PATTERN",".node").addVar("NODE_WRAPPER_PATTERN",".node > .wrap").addVar("NODE_ICON_PATTERN",".node > .wrap .icon").addVar("NODE_CUSTOM_PATTERNS",[]),E.Tree.addVar("LEAF_PATTERN",".leaf").addVar("LEAF_WRAPPER_PATTERN",".leaf > .wrap").addVar("LEAF_ICON_PATTERN",".leaf > .wrap .icon").addVar("LEAF_CUSTOM_PATTERNS",[]),E.Tree.addVar("EXPANDING_TIME",1e3),E.Tree.addVar("draggables",[]),E.Tree.addMethod("getTreeNodeByEvent",function(e){var t=Event.element(e);return this.getTreeNodeByElement(t)}),E.Tree.addMethod("getTreeNodeByElement",function(e){for(;e&&e.readAttribute&&e.readAttribute("id")!==this.id;){var t=e.treeNode;if(t&&t.getTreeId()===this.getId())return t;e=a(e.parentNode)}return null}),E.Tree.addMethod("isNodeEvent",function(e){var t=g(e.element().parentNode,"LI");return t&&t.hasClassName(c.NODE_CLASS)}),E.Tree.addMethod("isLeafEvent",function(e){var t=g(e.element().parentNode,"LI");return t&&t.hasClassName(c.LEAF_CLASS)}),E.Tree.addMethod("isIconEvent",function(e){return e.element().hasClassName(c.ICON_CLASS)}),E.Tree.addMethod("_registerEvents",function(){this._cleanUpListeners(),this._registerClickEvents(),this._registerCustomEvents(),this._registerKeyEvents(),this._registerMouseEvents()}),E.Tree.addMethod("_cleanUpListeners",function(){var e=this._getElement();e.stopObserving("click"),e.stopObserving("dblclick"),u()?(e.stopObserving("touchstart"),e.stopObserving("drag:touchstart"),e.stopObserving("touchend")):(e.stopObserving("mousedown"),e.stopObserving("drag:mousedown"),e.stopObserving("mouseup")),e.stopObserving("mouseover"),e.stopObserving("mouseout")}),E.Tree.addMethod("_registerClickEvents",function(){var e=this._getElement();e.observe("click",function(t){var n=g(t.element(),c.BUTTON_PATTERN)&&this.getTreeNodeByEvent(t);if(n){var i=this.isIconEvent(t),r=this.isNodeEvent(t),s=this.isLeafEvent(t);r?(i&&e.fire("nodeIcon:click",{targetEvent:t,node:n}),e.fire("node:click",{targetEvent:t,node:n})):s&&(i&&e.fire("nodeIcon:click",{targetEvent:t,node:n}),e.fire("leaf:click",{targetEvent:t,node:n})),!f()&&r&&i&&n.handleNode(t)}}.bindAsEventListener(this)),e.observe("dblclick",function(t){var n=g(t.element(),c.BUTTON_PATTERN)&&this.getTreeNodeByEvent(t);if(n){var i=this.isIconEvent(t),r=this.isNodeEvent(t),s=this.isLeafEvent(t);r?(i&&e.fire("nodeIcon:dblclick",{targetEvent:t,node:n}),e.fire("node:dblclick",{targetEvent:t,node:n})):s&&(i&&e.fire("leafIcon:dblclick",{targetEvent:t,node:n}),e.fire("leaf:dblclick",{targetEvent:t,node:n})),this.handleNodeOnDblclick&&(r||s)&&!i&&n.handleNode(t)}}.bindAsEventListener(this))}),E.Tree.addMethod("_registerMouseEvents",function(){var e=this._getElement();e.observe(u()?"touchstart":"mousedown",function(t){var n=t.element(),i=g(n,c.BUTTON_PATTERN)&&this.getTreeNodeByEvent(t);if(i){t.treeEvent=!0;var r=this.isIconEvent(t),s=this.isNodeEvent(t),d=this.isLeafEvent(t);if(u())if(O.vars.ajax_in_progress)alert("please wait");else if(this.twofingers=!1,2==t.touches.length&&(this.twofingers=!0,this._selectOrEditNode(t,i,m(t),T(t),N(t)),i.isSelected()||v&&v.isInSelection(i))){var o=y(n).parents("li:first");return void(o.hasClass("selected")&&document.fire(c.ELEMENT_CONTEXTMENU,{targetEvent:t,node:n}))}u()&&O.vars.ajax_in_progress||(!this.selectOnMousedown||u()&&1!=t.touches.length||this._selectOrEditNode(t,i,m(t),T(t),N(t)),s?(r&&e.fire("nodeIcon:mousedown",{targetEvent:t,node:i}),e.fire("node:mousedown",{targetEvent:t,node:i})):d&&(r&&e.fire("leafIcon:mousedown",{targetEvent:t,node:i}),e.fire("leaf:mousedown",{targetEvent:t,node:i})))}}.bindAsEventListener(this)),e.observe(u()?"drag:touchstart":"drag:mousedown",function(t){var n=t.memo.targetEvent,i=g(n.element(),c.BUTTON_PATTERN)&&this.getTreeNodeByEvent(n);if(i){n.treeEvent=!0;var r=this.isIconEvent(n),s=this.isNodeEvent(n),d=this.isLeafEvent(n);this.selectOnMousedown&&!N(n)&&this._selectOrEditNode(n,i,m(n),T(n),N(n)),s?(r&&e.fire("nodeIcon.drag:mousedown",{targetEvent:n,node:i}),e.fire("node.drag:mousedown",{targetEvent:n,node:i})):d&&(r&&e.fire("leafIcon.drag:mousedown",{targetEvent:n,node:i}),e.fire("leaf.drag:mousedown",{targetEvent:n,node:i}))}}.bindAsEventListener(this)),e.observe(u()?"touchend":"mouseup",function(t){var n=g(t.element(),c.BUTTON_PATTERN)&&this.getTreeNodeByEvent(t);if(n){t.treeEvent=!0;var i=this.isIconEvent(t),r=this.isNodeEvent(t),s=this.isLeafEvent(t);if(this.twofingers&&(t.isEmulatedRightClick=!0),u()&&!this.twofingers&&(this.clickid==n.id&&!O.vars.ajax_in_progress&&t.timeStamp-this.clicktime<700&&(r?(i&&e.fire("nodeIcon:dblclick",{targetEvent:t,node:n}),e.fire("node:dblclick",{targetEvent:t,node:n})):s&&(i&&e.fire("leafIcon:dblclick",{targetEvent:t,node:n}),e.fire("leaf:dblclick",{targetEvent:t,node:n})),this.handleNodeOnDblclick&&(r||s)&&!i&&n.handleNode(t)),this.clicktime=t.timeStamp,this.clickid=n.id),!u()||!O.vars.ajax_in_progress){this.selectOnMousedown||A.element_scrolled||u()&&1!=t.changedTouches.length||this._selectOrEditNode(t,n,m(t),T(t),N(t)),this._deselectOthers(t,n,m(t),T(t),N(t));r?(i&&e.fire("nodeIcon:mouseup",{targetEvent:t,node:n}),e.fire("node:mouseup",{targetEvent:t,node:n})):s&&(i&&e.fire("leafIcon:mouseup",{targetEvent:t,node:n}),e.fire("leaf:mouseup",{targetEvent:t,node:n})),u()&&r&&i&&!A.element_scrolled&&n.handleNode(t)}}}.bindAsEventListener(this)),"createTouch"in document||(e.observe("mouseover",function(t){var n=t.element(),i=g(n,c.BUTTON_PATTERN)&&this.getTreeNodeByEvent(t);i&&(r.dragging&&(clearTimeout(this.timeout_id),this.timeout_id=setTimeout(function(e){i.openNode(e)},this.EXPANDING_TIME)),this.createDraggableIfNeeded(t,i),!_()&&e.fire("tree:mouseover",{targetEvent:t,node:i}))}.bindAsEventListener(this)),_()||e.observe("mouseout",function(t){var n=g(t.element(),c.BUTTON_PATTERN)&&this.getTreeNodeByEvent(t);n&&e.fire("tree:mouseout",{targetEvent:t,node:n})}.bindAsEventListener(this))),d.add(e,{accept:this.dropClasses,onDrop:function(e){this.elementDropped=e}.bind(this)})}),E.Tree.addMethod("_registerKeyEvents",function(){var e=this._getElement();e.observe("key:down",function(e){var t=this.getTreeNodeByEvent(e);E.treeNodeEdited!==t&&t&&this._selectNextNode(t,e.memo.targetEvent)}.bindAsEventListener(this)),e.observe("key:up",function(e){var t=this.getTreeNodeByEvent(e);E.treeNodeEdited!==t&&t&&this._selectPreviousNode(t,e.memo.targetEvent)}.bindAsEventListener(this)),e.observe("key:right",function(e){var t=this.getTreeNodeByEvent(e);E.treeNodeEdited!==t&&t&&this._selectInwards(t,e.memo.targetEvent)}.bindAsEventListener(this)),e.observe("key:left",function(e){var t=this.getTreeNodeByEvent(e);E.treeNodeEdited!==t&&t&&this._selectOutwards(t,e.memo.targetEvent)}.bindAsEventListener(this))}),E.Tree.addMethod("_registerCustomEvents",function(){var e=this._getElement();e.observe("mousedown",function(t){E.activeTreeId&&E.activeTreeId===this.getId()||(e.fire("tree:blur",{targetEvent:t,tree:E.getActiveTree()}),E.activeTreeId=this.getId(),e.fire("tree:focus",{targetEvent:t,tree:E.getActiveTree()}))}.bindAsEventListener(this)),e.observe("mouseover",function(t){this.getTreeNodeByEvent(t)||e.fire("tree:mouseover",{targetEvent:t,tree:this})}.bindAsEventListener(this)),e.observe("mouseout",function(t){this.getTreeNodeByEvent(t)||e.fire("tree:mouseout",{targetEvent:t,tree:this})}.bindAsEventListener(this))}),E.Tree.addMethod("fireOpenEvent",function(e,t){this._getElement().fire("node:open",{node:e,targetEvent:t})}),E.Tree.addMethod("fireSelectEvent",function(e,t){this._getElement().fire(e.isParent()?"node:selected":"leaf:selected",{node:e,targetEvent:t})}),E.Tree.addMethod("fireUnSelectEvent",function(e,t){this._getElement().fire(e.isParent()?"node:unselected":"leaf:unselected",{node:e,targetEvent:t})}),E.Tree.addMethod("fireUnSelectAllEvent",function(e){this._getElement().fire("items:unselected",{targetEvent:e})}),E.Tree.addMethod("fireEditEvent",function(e,t){this._getElement().fire(e.isParent()?"node:edit":"leaf:edit",{node:e,newValue:t})}),E.Tree.addMethod("fireStartEditEvent",function(e,t){this._getElement().fire(e.isParent()?"node:startEdit":"leaf:startEdit",{node:e,input:t})}),E.Tree.addMethod("fireEndEditEvent",function(e){this._getElement().fire(e.isParent()?"node:endEdit":"leaf:endEdit",{node:e})}),E.Tree.addMethod("observe",function(e,t){this._getElement().observe(e,t)}),E.Tree.addMethod("stopObserving",function(e,t){this._getElement().stopObserving(e,t)}),E.Tree.addMethod("createDraggableIfNeeded",function(e,t){var n=e?e.element():t._getElement().down(this.dragPattern),i=this.draggables[n.identify()];if(this.dragPattern&&!i){var r=p(n,[this.dragPattern],!0);if(r&&n.className.toLowerCase().indexOf("icon")<0&&!this.draggables[r.identify()])return this.draggables[r.identify()]=new s(n,{superghosting:!0,mouseOffset:!0,delay:b()||u()?200:0,onStart:this.setDragStartState.bind(this,t),onEnd:this.setDragEndState.bind(this,t)}),this.draggables[r.identify()]}return null}),E.Tree.addMethod("setDragStartState",function(e,t,n){var i=e._getElement().templateClassName;i&&t.element.addClassName(i),t.element.setStyle({width:null,height:null}),t.element.addClassName(c.DRAGGING_CLASS).addClassName(this.getId()),this.dragClasses&&t.element.addClassName(this.dragClasses),this.selectedNodes.length>1&&t.element.update(new l(this.TREE_NN_ITEMS_SELECTED).evaluate({count:this.selectedNodes.length})),t.element.node=e,t.element.nodes=this.selectedNodes,t.options.scroll=this._getElement(),t.options.scrollSensitivity=c.SCROLL_SENSITIVITY,r.dragging=this.regionID||!0}),E.Tree.addMethod("setDragEndState",function(e,t,n){delete r.dragging}),n.exports=E});